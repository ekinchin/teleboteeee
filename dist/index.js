"use strict";

var _http = _interopRequireDefault(require("http"));

var _url = require("url");

var _events = require("events");

var _keys = require("./keys");

var _httpRequest = _interopRequireDefault(require("./httpRequest"));

var _yandexmap = _interopRequireDefault(require("./yandexmap"));

var _yandexweather = _interopRequireDefault(require("./yandexweather"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const eventer = new _events.EventEmitter();
const map = new _yandexmap.default();
const weather = new _yandexweather.default(_keys.yandexWeatherToken);
const CMD = {
  setWebHook: 'setWebhook',
  getUpdates: 'getUpdates',
  sendMessage: 'sendMessage'
};
const telegramUrl = new _url.URL('https://api.telegram.org');
telegramUrl.pathname = `bot${_keys.telegramToken}/${CMD.sendMessage}`;
const botCommands = {
  '/start': {
    descripion: 'Начать работу с ботом',
    handler: async (chatId, data) => {
      const answer = `Hello, ${data.message.from.first_name}`;
      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  },
  '/help': {
    descripion: 'Помощь',
    handler: async chatId => {
      const answer = '/start - поздороваться\n/weather - текущая погода\n/help - эта справка';
      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  },
  '/weather': {
    descripion: 'Погода',
    handler: async (chatId, data) => {
      let city = 'Tyumen';
      let lat = 57;
      let lon = 65;
      let answer = '';

      if (data.message.text.split(' ')[1] !== undefined) {
        [city, lon, lat] = await map.getLocation(data.message.text.split(' ')[1]);
      }

      if (lon !== 0 || lat !== 0) {
        const [temp, tempFeel, wind] = await weather.getWeather(lon, lat);
        answer = `Погода в: ${city}\n` + `Текущая температура: ${temp}\n` + `Ощущается как: ${tempFeel}\n` + `Ветер: ${wind}`;
      } else {
        answer = 'Не удалось найти город';
      }

      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  },
  undefined: {
    descripion: 'Неизвестная команда',
    handler: async chatId => {
      const answer = 'Неизвестная команда, воспользуйтесь справкой /help';
      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  }
};

function reqParse(data) {
  const dataParse = JSON.parse(data);
  const entities = dataParse.message.entities[0] || '';

  if (entities.type === 'bot_command') {
    switch (dataParse.message.text.split(' ')[0].toLowerCase()) {
      case '/start':
      case '/help':
      case '/weather':
        eventer.emit(dataParse.message.text.split(' ')[0].toLowerCase(), dataParse.message.chat.id, dataParse);
        break;

      default:
        eventer.emit('undefined', dataParse.message.chat.id);
        break;
    }
  }

  return 0;
}

async function Server() {
  const server = _http.default.createServer();

  server.listen(process.env.PORT);
  server.on('request', (request, response) => {
    let requestData = '';
    request.on('data', data => {
      requestData += data;
    });
    request.on('end', () => {
      reqParse(requestData);
      response.end();
    });
  });
}

eventer.on('/weather', botCommands['/weather'].handler);
eventer.on('/start', botCommands['/start'].handler);
eventer.on('/help', botCommands['/help'].handler);
eventer.on('undefined', botCommands.undefined.handler);
const setWebHookUrl = new _url.URL('https://api.telegram.org/');
setWebHookUrl.pathname = `bot${_keys.telegramToken}${CMD.setWebHook}`;
setWebHookUrl.searchParams.append('url', 'https://teleboteeee.herokuapp.com/');
(0, _httpRequest.default)(setWebHookUrl, {}, null, 'GET').then(Server);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJldmVudGVyIiwiRXZlbnRFbWl0dGVyIiwibWFwIiwiWWFuZGV4TWFwIiwid2VhdGhlciIsIllhbmRleFdlYXRoZXIiLCJ5YW5kZXhXZWF0aGVyVG9rZW4iLCJDTUQiLCJzZXRXZWJIb29rIiwiZ2V0VXBkYXRlcyIsInNlbmRNZXNzYWdlIiwidGVsZWdyYW1VcmwiLCJVUkwiLCJwYXRobmFtZSIsInRlbGVncmFtVG9rZW4iLCJib3RDb21tYW5kcyIsImRlc2NyaXBpb24iLCJoYW5kbGVyIiwiY2hhdElkIiwiZGF0YSIsImFuc3dlciIsIm1lc3NhZ2UiLCJmcm9tIiwiZmlyc3RfbmFtZSIsIm1ldGhvZCIsImNoYXRfaWQiLCJ0ZXh0IiwiY2l0eSIsImxhdCIsImxvbiIsInNwbGl0IiwidW5kZWZpbmVkIiwiZ2V0TG9jYXRpb24iLCJ0ZW1wIiwidGVtcEZlZWwiLCJ3aW5kIiwiZ2V0V2VhdGhlciIsInJlcVBhcnNlIiwiZGF0YVBhcnNlIiwiSlNPTiIsInBhcnNlIiwiZW50aXRpZXMiLCJ0eXBlIiwidG9Mb3dlckNhc2UiLCJlbWl0IiwiY2hhdCIsImlkIiwiU2VydmVyIiwic2VydmVyIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsImxpc3RlbiIsInByb2Nlc3MiLCJlbnYiLCJQT1JUIiwib24iLCJyZXF1ZXN0IiwicmVzcG9uc2UiLCJyZXF1ZXN0RGF0YSIsImVuZCIsInNldFdlYkhvb2tVcmwiLCJzZWFyY2hQYXJhbXMiLCJhcHBlbmQiLCJ0aGVuIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsT0FBTyxHQUFHLElBQUlDLG9CQUFKLEVBQWhCO0FBQ0EsTUFBTUMsR0FBRyxHQUFHLElBQUlDLGtCQUFKLEVBQVo7QUFDQSxNQUFNQyxPQUFPLEdBQUcsSUFBSUMsc0JBQUosQ0FBa0JDLHdCQUFsQixDQUFoQjtBQUVBLE1BQU1DLEdB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QUNnQixTQUFaLENBQXNCZCxPQUE5QztBQUdBLE1BQU0yQyxhQUFhLEdBQUcsSUFBSWhELFFBQUosQ0FBUSwyQkFBUixDQUF0QjtBQUNBZ0QsYUFBYSxDQUFDL0MsUUFBZCxHQUEwQixNQUFLQyxtQkFBYyxHQUFFUCxHQUFHLENBQUNDLFVBQVcsRUFBOUQ7QUFDQW9ELGFBQWEsQ0FBQ0MsWUFBZCxDQUEyQkMsTUFBM0IsQ0FDRSxLQURGLEVBRUUsb0NBRkY7QUFJQSwwQkFBWUYsYUFBWixFQUEyQixFQUEzQixFQUErQixJQUEvQixFQUFxQyxLQUFyQyxFQUE0Q0csSUFBNUMsQ0FBaURoQixNQUFqRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyB0ZWxlZ3JhbVRva2VuLCB5YW5kZXhXZWF0aGVyVG9rZW4gfSBmcm9tICcuL2tleXMnO1xuaW1wb3J0IGh0dHBSZXF1ZXN0IGZyb20gJy4vaHR0cFJlcXVlc3QnO1xuaW1wb3J0IFlhbmRleE1hcCBmcm9tICcuL3lhbmRleG1hcCc7XG5pbXBvcnQgWWFuZGV4V2VhdGhlciBmcm9tICcuL3lhbmRleHdlYXRoZXInO1xuXG5jb25zdCBldmVudGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuY29uc3QgbWFwID0gbmV3IFlhbmRleE1hcCgpO1xuY29uc3Qgd2VhdGhlciA9IG5ldyBZYW5kZXhXZWF0aGVyKHlhbmRleFdlYXRoZXJUb2tlbik7XG5cbmNvbnN0IENNRCA9IHtcbiAgc2V0V2ViSG9vazogJ3NldFdlYmhvb2snLFxuICBnZXRVcGRhdGVzOiAnZ2V0VXBkYXRlcycsXG4gIHNlbmRNZXNzYWdlOiAnc2VuZE1lc3NhZ2UnLFxufTtcblxuY29uc3QgdGVsZWdyYW1VcmwgPSBuZXcgVVJMKCdodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcnKTtcbnRlbGVncmFtVXJsLnBhdGhuYW1lID0gYGJvdCR7dGVsZWdyYW1Ub2tlbn0vJHtDTUQuc2VuZE1lc3NhZ2V9YDtcblxuY29uc3QgYm90Q29tbWFuZHMgPSB7XG4gICcvc3RhcnQnOiB7XG4gICAgZGVzY3JpcGlvbjogJ9Cd0LDRh9Cw0YLRjCDRgNCw0LHQvtGC0YMg0YEg0LHQvtGC0L7QvCcsXG4gICAgaGFuZGxlcjpcbiAgICBhc3luYyAoY2hhdElkLCBkYXRhKSA9PiB7XG4gICAgICBjb25zdCBhbnN3ZXIgPSBgSGVsbG8sICR7ZGF0YS5tZXNzYWdlLmZyb20uZmlyc3RfbmFtZX1gO1xuICAgICAgYXdhaXQgaHR0cFJlcXVlc3QodGVsZWdyYW1VcmwsIHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LCB7IG1ldGhvZDogQ01ELnNlbmRNZXNzYWdlLCBjaGF0X2lkOiBjaGF0SWQsIHRleHQ6IGFuc3dlciB9LCAnUE9TVCcpO1xuICAgIH0sXG4gIH0sXG4gICcvaGVscCc6IHtcbiAgICBkZXNjcmlwaW9uOiAn0J/QvtC80L7RidGMJyxcbiAgICBoYW5kbGVyOlxuICAgIGFzeW5jIChjaGF0SWQpID0+IHtcbiAgICAgIGNvbnN0IGFuc3dlciA9ICcvc3RhcnQgLSDQv9C+0LfQtNC+0YDQvtCy0LDRgtGM0YHRj1xcbi93ZWF0aGVyIC0g0YLQtdC60YPRidCw0Y8g0L/QvtCz0L7QtNCwXFxuL2hlbHAgLSDRjdGC0LAg0YHQv9GA0LDQstC60LAnO1xuICAgICAgYXdhaXQgaHR0cFJlcXVlc3QodGVsZWdyYW1VcmwsIHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LCB7IG1ldGhvZDogQ01ELnNlbmRNZXNzYWdlLCBjaGF0X2lkOiBjaGF0SWQsIHRleHQ6IGFuc3dlciB9LCAnUE9TVCcpO1xuICAgIH0sXG4gIH0sXG4gICcvd2VhdGhlcic6IHtcbiAgICBkZXNjcmlwaW9uOiAn0J/QvtCz0L7QtNCwJyxcbiAgICBoYW5kbGVyOlxuICAgIGFzeW5jIChjaGF0SWQsIGRhdGEpID0+IHtcbiAgICAgIGxldCBjaXR5ID0gJ1R5dW1lbic7XG4gICAgICBsZXQgbGF0ID0gNTc7XG4gICAgICBsZXQgbG9uID0gNjU7XG4gICAgICBsZXQgYW5zd2VyID0gJyc7XG4gICAgICBpZiAoZGF0YS5tZXNzYWdlLnRleHQuc3BsaXQoJyAnKVsxXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIFtjaXR5LCBsb24sIGxhdF0gPSBhd2FpdCBtYXAuZ2V0TG9jYXRpb24oZGF0YS5tZXNzYWdlLnRleHQuc3BsaXQoJyAnKVsxXSk7XG4gICAgICB9XG4gICAgICBpZiAobG9uICE9PSAwIHx8IGxhdCAhPT0gMCkge1xuICAgICAgICBjb25zdCBbdGVtcCwgdGVtcEZlZWwsIHdpbmRdID0gYXdhaXQgd2VhdGhlci5nZXRXZWF0aGVyKGxvbiwgbGF0KTtcbiAgICAgICAgYW5zd2VyID0gYNCf0L7Qs9C+0LTQsCDQsjogJHtjaXR5fVxcbmBcbiAgICAgICAgKyBg0KLQtdC60YPRidCw0Y8g0YLQtdC80L/QtdGA0LDRgtGD0YDQsDogJHt0ZW1wfVxcbmBcbiAgICAgICAgKyBg0J7RidGD0YnQsNC10YLRgdGPINC60LDQujogJHt0ZW1wRmVlbH1cXG5gXG4gICAgICAgICsgYNCS0LXRgtC10YA6ICR7d2luZH1gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYW5zd2VyID0gJ9Cd0LUg0YPQtNCw0LvQvtGB0Ywg0L3QsNC50YLQuCDQs9C+0YDQvtC0JztcbiAgICAgIH1cbiAgICAgIGF3YWl0IGh0dHBSZXF1ZXN0KHRlbGVncmFtVXJsLCB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSwgeyBtZXRob2Q6IENNRC5zZW5kTWVzc2FnZSwgY2hhdF9pZDogY2hhdElkLCB0ZXh0OiBhbnN3ZXIgfSwgJ1BPU1QnKTtcbiAgICB9LFxuICB9LFxuICB1bmRlZmluZWQ6IHtcbiAgICBkZXNjcmlwaW9uOiAn0J3QtdC40LfQstC10YHRgtC90LDRjyDQutC+0LzQsNC90LTQsCcsXG4gICAgaGFuZGxlcjpcbiAgICBhc3luYyAoY2hhdElkKSA9PiB7XG4gICAgICBjb25zdCBhbnN3ZXIgPSAn0J3QtdC40LfQstC10YHRgtC90LDRjyDQutC+0LzQsNC90LTQsCwg0LLQvtGB0L/QvtC70YzQt9GD0LnRgtC10YHRjCDRgdC/0YDQsNCy0LrQvtC5IC9oZWxwJztcbiAgICAgIGF3YWl0IGh0dHBSZXF1ZXN0KHRlbGVncmFtVXJsLCB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSwgeyBtZXRob2Q6IENNRC5zZW5kTWVzc2FnZSwgY2hhdF9pZDogY2hhdElkLCB0ZXh0OiBhbnN3ZXIgfSwgJ1BPU1QnKTtcbiAgICB9LFxuICB9LFxufTtcblxuZnVuY3Rpb24gcmVxUGFyc2UoZGF0YSkge1xuICBjb25zdCBkYXRhUGFyc2UgPSBKU09OLnBhcnNlKGRhdGEpO1xuICBjb25zdCBlbnRpdGllcyA9IGRhdGFQYXJzZS5tZXNzYWdlLmVudGl0aWVzWzBdIHx8ICcnO1xuICBpZiAoZW50aXRpZXMudHlwZSA9PT0gJ2JvdF9jb21tYW5kJykge1xuICAgIHN3aXRjaCAoZGF0YVBhcnNlLm1lc3NhZ2UudGV4dC5zcGxpdCgnICcpWzBdLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgIGNhc2UgJy9zdGFydCc6XG4gICAgICBjYXNlICcvaGVscCc6XG4gICAgICBjYXNlICcvd2VhdGhlcic6XG4gICAgICAgIGV2ZW50ZXIuZW1pdChkYXRhUGFyc2UubWVzc2FnZS50ZXh0LnNwbGl0KCcgJylbMF0udG9Mb3dlckNhc2UoKSwgZGF0YVBhcnNlLm1lc3NhZ2UuY2hhdC5pZCwgZGF0YVBhcnNlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBldmVudGVyLmVtaXQoJ3VuZGVmaW5lZCcsIGRhdGFQYXJzZS5tZXNzYWdlLmNoYXQuaWQpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIDA7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIFNlcnZlcigpIHtcbiAgY29uc3Qgc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoKTtcbiAgc2VydmVyLmxpc3Rlbihwcm9jZXNzLmVudi5QT1JUKTtcbiAgc2VydmVyLm9uKCdyZXF1ZXN0JywgKHJlcXVlc3QsIHJlc3BvbnNlKSA9PiB7XG4gICAgbGV0IHJlcXVlc3REYXRhID0gJyc7XG4gICAgcmVxdWVzdC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICByZXF1ZXN0RGF0YSArPSBkYXRhO1xuICAgIH0pO1xuICAgIHJlcXVlc3Qub24oJ2VuZCcsICgpID0+IHtcbiAgICAgIHJlcVBhcnNlKHJlcXVlc3REYXRhKTtcbiAgICAgIHJlc3BvbnNlLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcbn1cblxuZXZlbnRlci5vbignL3dlYXRoZXInLCBib3RDb21tYW5kc1snL3dlYXRoZXInXS5oYW5kbGVyKTtcbmV2ZW50ZXIub24oJy9zdGFydCcsIGJvdENvbW1hbmRzWycvc3RhcnQnXS5oYW5kbGVyKTtcbmV2ZW50ZXIub24oJy9oZWxwJywgYm90Q29tbWFuZHNbJy9oZWxwJ10uaGFuZGxlcik7XG5ldmVudGVyLm9uKCd1bmRlZmluZWQnLCBib3RDb21tYW5kcy51bmRlZmluZWQuaGFuZGxlcik7XG5cblxuY29uc3Qgc2V0V2ViSG9va1VybCA9IG5ldyBVUkwoJ2h0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy8nKTtcbnNldFdlYkhvb2tVcmwucGF0aG5hbWUgPSBgYm90JHt0ZWxlZ3JhbVRva2VufSR7Q01ELnNldFdlYkhvb2t9YDtcbnNldFdlYkhvb2tVcmwuc2VhcmNoUGFyYW1zLmFwcGVuZChcbiAgJ3VybCcsXG4gICdodHRwczovL3RlbGVib3RlZWVlLmhlcm9rdWFwcC5jb20vJyxcbik7XG5odHRwUmVxdWVzdChzZXRXZWJIb29rVXJsLCB7fSwgbnVsbCwgJ0dFVCcpLnRoZW4oU2VydmVyKTtcbiJdfQ==