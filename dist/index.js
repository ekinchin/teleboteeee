"use strict";

var _http = _interopRequireDefault(require("http"));

var _url = require("url");

var _events = require("events");

var _httpRequest = _interopRequireDefault(require("./httpRequest"));

var _yandexmap = _interopRequireDefault(require("./yandexmap"));

var _yandexweather = _interopRequireDefault(require("./yandexweather"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const eventer = new _events.EventEmitter();
const map = new _yandexmap.default();
const weather = new _yandexweather.default('40f0e52b-168d-40a4-ba38-0c2bf4d98726');
const CMD = {
  setWebHook: 'setWebhook',
  getUpdates: 'getUpdates',
  sendMessage: 'sendMessage'
};
const token = '674082318:AAG4e5AXQu_SbJkYSVji4chwaiggtGrMLBc';
const telegramUrl = new _url.URL('https://api.telegram.org');
telegramUrl.pathname = `bot${token}/${CMD.sendMessage}`;
const botCommands = {
  '/start': {
    descripion: 'Начать работу с ботом',
    handler: async (chatId, data) => {
      const answer = `Hello, ${data.message.from.first_name}`;
      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  },
  '/help': {
    descripion: 'Помощь',
    handler: async chatId => {
      const answer = '/start - поздороваться\n/weather - текущая погода\n/help - эта справка';
      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  },
  '/weather': {
    descripion: 'Погода',
    handler: async (chatId, data) => {
      let city = 'Tyumen';
      let lat = 57;
      let lon = 65;
      let answer = '';

      if (data.message.text.split(' ')[1] !== undefined) {
        [city, lon, lat] = await map.getLocation(data.message.text.split(' ')[1]);
      }

      if (lon !== 0 || lat !== 0) {
        const [temp, tempFeel, wind] = await weather.getWeather(lon, lat);
        answer = `Погода в: ${city}\n` + `Текущая температура: ${temp}\n` + `Ощущается как: ${tempFeel}\n` + `Ветер: ${wind}`;
      } else {
        answer = 'Не удалось найти город';
      }

      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  },
  undefined: {
    descripion: 'Неизвестная команда',
    handler: async chatId => {
      const answer = 'Неизвестная команда, воспользуйтесь справкой /help';
      await (0, _httpRequest.default)(telegramUrl, {
        'Content-Type': 'application/json'
      }, {
        method: CMD.sendMessage,
        chat_id: chatId,
        text: answer
      }, 'POST');
    }
  }
};

function reqParse(data) {
  const dataParse = JSON.parse(data);
  const entities = dataParse.message.entities[0] || '';

  if (entities.type === 'bot_command') {
    switch (dataParse.message.text.split(' ')[0].toLowerCase()) {
      case '/start':
      case '/help':
      case '/weather':
        eventer.emit(dataParse.message.text.split(' ')[0].toLowerCase(), dataParse.message.chat.id, dataParse);
        break;

      default:
        eventer.emit('undefined', dataParse.message.chat.id);
        break;
    }
  }

  return 0;
}

async function Server() {
  const server = _http.default.createServer();

  server.listen(process.env.PORT);
  server.on('request', (request, response) => {
    let requestData = '';
    request.on('data', data => {
      requestData += data;
    });
    request.on('end', () => {
      reqParse(requestData);
      response.end();
    });
  });
}

eventer.on('/weather', botCommands['/weather'].handler);
eventer.on('/start', botCommands['/start'].handler);
eventer.on('/help', botCommands['/help'].handler);
eventer.on('undefined', botCommands.undefined.handler);
const setWebHookUrl = new _url.URL('https://api.telegram.org/');
setWebHookUrl.pathname = `bot${token}${CMD.setWebHook}`;
setWebHookUrl.searchParams.append('url', 'https://teleboteeee.herokuapp.com/');
(0, _httpRequest.default)(setWebHookUrl, {}, null, 'GET').then(Server);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJldmVudGVyIiwiRXZlbnRFbWl0dGVyIiwibWFwIiwiWWFuZGV4TWFwIiwid2VhdGhlciIsIllhbmRleFdlYXRoZXIiLCJDTUQiLCJzZXRXZWJIb29rIiwiZ2V0VXBkYXRlcyIsInNlbmRNZXNzYWdlIiwidG9rZW4iLCJ0ZWxlZ3JhbVVybCIsIlVSTCIsInBhdGhuYW1lIiwiYm90Q29tbWFuZHMiLCJkZXNjcmlwaW9uIiwiaGFuZGxlciIsImNoYXRJZCIsImRhdGEiLCJhbnN3ZXIiLCJtZXNzYWdlIiwiZnJvbSIsImZpcnN0X25hbWUiLCJtZXRob2QiLCJjaGF0X2lkIiwidGV4dCIsImNpdHkiLCJsYXQiLCJsb24iLCJzcGxpdCIsInVuZGVmaW5lZCIsImdldExvY2F0aW9uIiwidGVtcCIsInRlbXBGZWVsIiwid2luZCIsImdldFdlYXRoZXIiLCJyZXFQYXJzZSIsImRhdGFQYXJzZSIsIkpTT04iLCJwYXJzZSIsImVudGl0aWVzIiwidHlwZSIsInRvTG93ZXJDYXNlIiwiZW1pdCIsImNoYXQiLCJpZCIsIlNlcnZlciIsInNlcnZlciIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJsaXN0ZW4iLCJwcm9jZXNzIiwiZW52IiwiUE9SVCIsIm9uIiwicmVxdWVzdCIsInJlc3BvbnNlIiwicmVxdWVzdERhdGEiLCJlbmQiLCJzZXRXZWJIb29rVXJsIiwic2VhcmNoUGFyYW1zIiwiYXBwZW5kIiwidGhlbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLE9BQU8sR0FBRyxJQUFJQyxvQkFBSixFQUFoQjtBQUNBLE1BQU1DLEdBQUcsR0FBRyxJQUFJQyxrQkFBSixFQUFaO0FBQ0EsTUFBTUMsT0FBTyxHQUFHLElBQUlDLHNCQUFKLENBQWtCLHNDQUFsQixDQUFoQjtBQUVBLE1BQU1DLEdBQUcsR0FBRztBQUNWQyxFQUFBQSxVQUFVLEVBQUUsWUFERjtB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Q0FBc0JkLE9BQTlDO0FBR0EsTUFBTTJDLGFBQWEsR0FBRyxJQUFJL0MsUUFBSixDQUFRLDJCQUFSLENBQXRCO0FBQ0ErQyxhQUFhLENBQUM5QyxRQUFkLEdBQTBCLE1BQUtILEtBQU0sR0FBRUosR0FBRyxDQUFDQyxVQUFXLEVBQXREO0FBQ0FvRCxhQUFhLENBQUNDLFlBQWQsQ0FBMkJDLE1BQTNCLENBQ0UsS0FERixFQUVFLG9DQUZGO0FBSUEsMEJBQVlGLGFBQVosRUFBMkIsRUFBM0IsRUFBK0IsSUFBL0IsRUFBcUMsS0FBckMsRUFBNENHLElBQTVDLENBQWlEaEIsTUFBakQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IGh0dHBSZXF1ZXN0IGZyb20gJy4vaHR0cFJlcXVlc3QnO1xuaW1wb3J0IFlhbmRleE1hcCBmcm9tICcuL3lhbmRleG1hcCc7XG5pbXBvcnQgWWFuZGV4V2VhdGhlciBmcm9tICcuL3lhbmRleHdlYXRoZXInO1xuXG5jb25zdCBldmVudGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuY29uc3QgbWFwID0gbmV3IFlhbmRleE1hcCgpO1xuY29uc3Qgd2VhdGhlciA9IG5ldyBZYW5kZXhXZWF0aGVyKCc0MGYwZTUyYi0xNjhkLTQwYTQtYmEzOC0wYzJiZjRkOTg3MjYnKTtcblxuY29uc3QgQ01EID0ge1xuICBzZXRXZWJIb29rOiAnc2V0V2ViaG9vaycsXG4gIGdldFVwZGF0ZXM6ICdnZXRVcGRhdGVzJyxcbiAgc2VuZE1lc3NhZ2U6ICdzZW5kTWVzc2FnZScsXG59O1xuXG5jb25zdCB0b2tlbiA9ICc2NzQwODIzMTg6QUFHNGU1QVhRdV9TYkprWVNWamk0Y2h3YWlnZ3RHck1MQmMnO1xuY29uc3QgdGVsZWdyYW1VcmwgPSBuZXcgVVJMKCdodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcnKTtcbnRlbGVncmFtVXJsLnBhdGhuYW1lID0gYGJvdCR7dG9rZW59LyR7Q01ELnNlbmRNZXNzYWdlfWA7XG5cbmNvbnN0IGJvdENvbW1hbmRzID0ge1xuICAnL3N0YXJ0Jzoge1xuICAgIGRlc2NyaXBpb246ICfQndCw0YfQsNGC0Ywg0YDQsNCx0L7RgtGDINGBINCx0L7RgtC+0LwnLFxuICAgIGhhbmRsZXI6XG4gICAgYXN5bmMgKGNoYXRJZCwgZGF0YSkgPT4ge1xuICAgICAgY29uc3QgYW5zd2VyID0gYEhlbGxvLCAke2RhdGEubWVzc2FnZS5mcm9tLmZpcnN0X25hbWV9YDtcbiAgICAgIGF3YWl0IGh0dHBSZXF1ZXN0KHRlbGVncmFtVXJsLCB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSwgeyBtZXRob2Q6IENNRC5zZW5kTWVzc2FnZSwgY2hhdF9pZDogY2hhdElkLCB0ZXh0OiBhbnN3ZXIgfSwgJ1BPU1QnKTtcbiAgICB9LFxuICB9LFxuICAnL2hlbHAnOiB7XG4gICAgZGVzY3JpcGlvbjogJ9Cf0L7QvNC+0YnRjCcsXG4gICAgaGFuZGxlcjpcbiAgICBhc3luYyAoY2hhdElkKSA9PiB7XG4gICAgICBjb25zdCBhbnN3ZXIgPSAnL3N0YXJ0IC0g0L/QvtC30LTQvtGA0L7QstCw0YLRjNGB0Y9cXG4vd2VhdGhlciAtINGC0LXQutGD0YnQsNGPINC/0L7Qs9C+0LTQsFxcbi9oZWxwIC0g0Y3RgtCwINGB0L/RgNCw0LLQutCwJztcbiAgICAgIGF3YWl0IGh0dHBSZXF1ZXN0KHRlbGVncmFtVXJsLCB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSwgeyBtZXRob2Q6IENNRC5zZW5kTWVzc2FnZSwgY2hhdF9pZDogY2hhdElkLCB0ZXh0OiBhbnN3ZXIgfSwgJ1BPU1QnKTtcbiAgICB9LFxuICB9LFxuICAnL3dlYXRoZXInOiB7XG4gICAgZGVzY3JpcGlvbjogJ9Cf0L7Qs9C+0LTQsCcsXG4gICAgaGFuZGxlcjpcbiAgICBhc3luYyAoY2hhdElkLCBkYXRhKSA9PiB7XG4gICAgICBsZXQgY2l0eSA9ICdUeXVtZW4nO1xuICAgICAgbGV0IGxhdCA9IDU3O1xuICAgICAgbGV0IGxvbiA9IDY1O1xuICAgICAgbGV0IGFuc3dlciA9ICcnO1xuICAgICAgaWYgKGRhdGEubWVzc2FnZS50ZXh0LnNwbGl0KCcgJylbMV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBbY2l0eSwgbG9uLCBsYXRdID0gYXdhaXQgbWFwLmdldExvY2F0aW9uKGRhdGEubWVzc2FnZS50ZXh0LnNwbGl0KCcgJylbMV0pO1xuICAgICAgfVxuICAgICAgaWYgKGxvbiAhPT0gMCB8fCBsYXQgIT09IDApIHtcbiAgICAgICAgY29uc3QgW3RlbXAsIHRlbXBGZWVsLCB3aW5kXSA9IGF3YWl0IHdlYXRoZXIuZ2V0V2VhdGhlcihsb24sIGxhdCk7XG4gICAgICAgIGFuc3dlciA9IGDQn9C+0LPQvtC00LAg0LI6ICR7Y2l0eX1cXG5gXG4gICAgICAgICsgYNCi0LXQutGD0YnQsNGPINGC0LXQvNC/0LXRgNCw0YLRg9GA0LA6ICR7dGVtcH1cXG5gXG4gICAgICAgICsgYNCe0YnRg9GJ0LDQtdGC0YHRjyDQutCw0Lo6ICR7dGVtcEZlZWx9XFxuYFxuICAgICAgICArIGDQktC10YLQtdGAOiAke3dpbmR9YDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFuc3dlciA9ICfQndC1INGD0LTQsNC70L7RgdGMINC90LDQudGC0Lgg0LPQvtGA0L7QtCc7XG4gICAgICB9XG4gICAgICBhd2FpdCBodHRwUmVxdWVzdCh0ZWxlZ3JhbVVybCwgeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sIHsgbWV0aG9kOiBDTUQuc2VuZE1lc3NhZ2UsIGNoYXRfaWQ6IGNoYXRJZCwgdGV4dDogYW5zd2VyIH0sICdQT1NUJyk7XG4gICAgfSxcbiAgfSxcbiAgdW5kZWZpbmVkOiB7XG4gICAgZGVzY3JpcGlvbjogJ9Cd0LXQuNC30LLQtdGB0YLQvdCw0Y8g0LrQvtC80LDQvdC00LAnLFxuICAgIGhhbmRsZXI6XG4gICAgYXN5bmMgKGNoYXRJZCkgPT4ge1xuICAgICAgY29uc3QgYW5zd2VyID0gJ9Cd0LXQuNC30LLQtdGB0YLQvdCw0Y8g0LrQvtC80LDQvdC00LAsINCy0L7RgdC/0L7Qu9GM0LfRg9C50YLQtdGB0Ywg0YHQv9GA0LDQstC60L7QuSAvaGVscCc7XG4gICAgICBhd2FpdCBodHRwUmVxdWVzdCh0ZWxlZ3JhbVVybCwgeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sIHsgbWV0aG9kOiBDTUQuc2VuZE1lc3NhZ2UsIGNoYXRfaWQ6IGNoYXRJZCwgdGV4dDogYW5zd2VyIH0sICdQT1NUJyk7XG4gICAgfSxcbiAgfSxcbn07XG5cbmZ1bmN0aW9uIHJlcVBhcnNlKGRhdGEpIHtcbiAgY29uc3QgZGF0YVBhcnNlID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgY29uc3QgZW50aXRpZXMgPSBkYXRhUGFyc2UubWVzc2FnZS5lbnRpdGllc1swXSB8fCAnJztcbiAgaWYgKGVudGl0aWVzLnR5cGUgPT09ICdib3RfY29tbWFuZCcpIHtcbiAgICBzd2l0Y2ggKGRhdGFQYXJzZS5tZXNzYWdlLnRleHQuc3BsaXQoJyAnKVswXS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICBjYXNlICcvc3RhcnQnOlxuICAgICAgY2FzZSAnL2hlbHAnOlxuICAgICAgY2FzZSAnL3dlYXRoZXInOlxuICAgICAgICBldmVudGVyLmVtaXQoZGF0YVBhcnNlLm1lc3NhZ2UudGV4dC5zcGxpdCgnICcpWzBdLnRvTG93ZXJDYXNlKCksIGRhdGFQYXJzZS5tZXNzYWdlLmNoYXQuaWQsIGRhdGFQYXJzZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgZXZlbnRlci5lbWl0KCd1bmRlZmluZWQnLCBkYXRhUGFyc2UubWVzc2FnZS5jaGF0LmlkKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG4gIHJldHVybiAwO1xufVxuXG5hc3luYyBmdW5jdGlvbiBTZXJ2ZXIoKSB7XG4gIGNvbnN0IHNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKCk7XG4gIHNlcnZlci5saXN0ZW4ocHJvY2Vzcy5lbnYuUE9SVCk7XG4gIHNlcnZlci5vbigncmVxdWVzdCcsIChyZXF1ZXN0LCByZXNwb25zZSkgPT4ge1xuICAgIGxldCByZXF1ZXN0RGF0YSA9ICcnO1xuICAgIHJlcXVlc3Qub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgcmVxdWVzdERhdGEgKz0gZGF0YTtcbiAgICB9KTtcbiAgICByZXF1ZXN0Lm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICByZXFQYXJzZShyZXF1ZXN0RGF0YSk7XG4gICAgICByZXNwb25zZS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmV2ZW50ZXIub24oJy93ZWF0aGVyJywgYm90Q29tbWFuZHNbJy93ZWF0aGVyJ10uaGFuZGxlcik7XG5ldmVudGVyLm9uKCcvc3RhcnQnLCBib3RDb21tYW5kc1snL3N0YXJ0J10uaGFuZGxlcik7XG5ldmVudGVyLm9uKCcvaGVscCcsIGJvdENvbW1hbmRzWycvaGVscCddLmhhbmRsZXIpO1xuZXZlbnRlci5vbigndW5kZWZpbmVkJywgYm90Q29tbWFuZHMudW5kZWZpbmVkLmhhbmRsZXIpO1xuXG5cbmNvbnN0IHNldFdlYkhvb2tVcmwgPSBuZXcgVVJMKCdodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvJyk7XG5zZXRXZWJIb29rVXJsLnBhdGhuYW1lID0gYGJvdCR7dG9rZW59JHtDTUQuc2V0V2ViSG9va31gO1xuc2V0V2ViSG9va1VybC5zZWFyY2hQYXJhbXMuYXBwZW5kKFxuICAndXJsJyxcbiAgJ2h0dHBzOi8vdGVsZWJvdGVlZWUuaGVyb2t1YXBwLmNvbS8nLFxuKTtcbmh0dHBSZXF1ZXN0KHNldFdlYkhvb2tVcmwsIHt9LCBudWxsLCAnR0VUJykudGhlbihTZXJ2ZXIpO1xuIl19