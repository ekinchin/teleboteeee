"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

function _assert() {
  const data = _interopRequireDefault(require("assert"));

  _assert = function () {
    return data;
  };

  return data;
}

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

var _importBuilder = _interopRequireDefault(require("./import-builder"));

var _isModule = _interopRequireDefault(require("./is-module"));

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

class ImportInjector {
  constructor(path, importedSource, opts) {
    this._defaultOpts = {
      importedSource: null,
      importedType: "commonjs",
      importedInterop: "babel",
      importingInterop: "babel",
      ensureLiveReference: false,
      ensureNoContext: false
    };
    const programPath = path.find(p => p.isProgram());
    this._programPath = programPath;
    this._programScope = programPath.scope;
    this._hub = programPath.hub;
    this._defaultOpts = this._applyDefaults(importedSource, opts, true);
  }

  addDefault(importedSourceIn, opts) {
    return this.addNamed("default", importedSourceIn, opts);
  }

  addNamed(importName, importedSourceIn, opts) {
    (0, _assert().default)(typeof importName === "string");
    return this._generateImport(this._applyDefaults(importedSourceIn, opts), importName);
  }

  addNamespace(importedSourceIn, opts) {
    return this._generateImport(this._applyDefaults(importedSourceIn, opts), null);
  }

  addSideEffect(importedSourceIn, opts) {
    return this._generateImport(this._applyDefaults(importedSourceIn, opts), false);
  }

  _applyDefaults(importedSource, opts, isInit = false) {
    const optsList = [];

    if (typeof importedSource === "string") {
      optsList.push({
        importedSource
      });
      optsList.push(opts);
    } else {
      (0, _assert().default)(!opts, "Unexpected secondary arguments.");
      optsList.push(importedSource);
    }

    const newOpts = Object.assign({}, this._defaultOpts);

    for (const opts of optsList) {
      if (!opts) continue;
      Object.keys(newOpts).forEach(key => {
        if (opts[key] !== undefined) newOpts[key] = opts[key];
      });

      if (!isInit) {
        if (opts.nameHint !== undefined) newOpts.nameHint = opts.nameHint;
        if (opts.blockHoist !== undefined) newOpts.blockHoist = opts.blockHoist;
      }
    }

    return newOpts;
  }

  _generateImport(opts, importName) {
    const isDefault = importName === "default";
    const isNamed = !!importName && !isDefault;
    const isNamespace = importName === null;
    const {
      importedSource,
      importedType,
      importedInterop,
      importingInterop,
      ensureLiveReference,
      ensureNoContext,
      nameHint,
      blockHoist
    } = opts;
    let name = nameHint || importName;
    const isMod = (0, _isModule.default)(this._programPath);
    const isModuleForNode = isMod && importingInterop === "node";
    const isModuleForBabel = isMod && importingInterop === "babel";
    const builder = new _importBuilder.default(importedSource, this._programScope, this._hub);

    if (importedType === "es6") {
      if (!isModuleForNode && !isModuleForBabel) {
        throw new Error("Cannot import an ES6 module from CommonJS");
      }

      builder.import();

      if (isNamespace) {
        builder.namespace(nameHint || importedSource);
      } else if (isDefault || isNamed) {
        builder.named(name, importName);
      }
    } else if (importedType !== "commonjs") {
      throw new Error(`Unexpected interopType "${importedType}"`);
    } else if (importedInterop === "babel") {
      if (isModuleForNode) {
        name = name !== "default" ? name : importedSource;
        const es6Default = `${importedSource}$es6Default`;
        builder.import();

        if (isNamespace) {
          builder.default(es6Default).var(name || importedSource).wildcardInterop();
        } else if (isDefault) {
          if (ensureLiveReference) {
            builder.default(es6Default).var(name || importedSource).defaultInterop().read("default");
          } else {
            builder.default(es6Default).var(name).defaultInterop().prop(importName);
          }
        } else if (isNamed) {
          builder.default(es6Default).read(importName);
        }
      } else if (isModuleForBabel) {
        builder.import();

        if (isNamespace) {
          builder.namespace(name || importedSource);
        } else if (isDefault || isNamed) {
          builder.named(name, importName);
        }
      } else {
        builder.require();

        if (isNamespace) {
          builder.var(name || importedSource).wildcardInterop();
        } else if ((isDefault || isNamed) && ensureLiveReference) {
          if (isDefault) {
            name = name !== "default" ? name : importedSource;
            builder.var(name).read(importName);
            builder.defaultInterop();
          } else {
            builder.var(importedSource).read(importName);
          }
        } else if (isDefault) {
          builder.var(name).defaultInterop().prop(importName);
        } else if (isNamed) {
          builder.var(name).prop(importName);
        }
      }
    } else if (importedInterop === "compiled") {
      if (isModuleForNode) {
        builder.import();

        if (isNamespace) {
          builder.default(name || importedSource);
        } else if (isDefault || isNamed) {
          builder.default(importedSource).read(name);
        }
      } else if (isModuleForBabel) {
        builder.import();

        if (isNamespace) {
          builder.namespace(name || importedSource);
        } else if (isDefault || isNamed) {
          builder.named(name, importName);
        }
      } else {
        builder.require();

        if (isNamespace) {
          builder.var(name || importedSource);
        } else if (isDefault || isNamed) {
          if (ensureLiveReference) {
            builder.var(importedSource).read(name);
          } else {
            builder.prop(importName).var(name);
          }
        }
      }
    } else if (importedInterop === "uncompiled") {
      if (isDefault && ensureLiveReference) {
        throw new Error("No live reference for commonjs default");
      }

      if (isModuleForNode) {
        builder.import();

        if (isNamespace) {
          builder.default(name || importedSource);
        } else if (isDefault) {
          builder.default(name);
        } else if (isNamed) {
          builder.default(importedSource).read(name);
        }
      } else if (isModuleForBabel) {
        builder.import();

        if (isNamespace) {
          builder.default(name || importedSource);
        } else if (isDefault) {
          builder.default(name);
        } else if (isNamed) {
          builder.named(name, importName);
        }
      } else {
        builder.require();

        if (isNamespace) {
          builder.var(name || importedSource);
        } else if (isDefault) {
          builder.var(name);
        } else if (isNamed) {
          if (ensureLiveReference) {
            builder.var(importedSource).read(name);
          } else {
            builder.var(name).prop(importName);
          }
        }
      }
    } else {
      throw new Error(`Unknown importedInterop "${importedInterop}".`);
    }

    const {
      statements,
      resultName
    } = builder.done();

    this._insertStatements(statements, blockHoist);

    if ((isDefault || isNamed) && ensureNoContext && resultName.type !== "Identifier") {
      return t().sequenceExpression([t().numericLiteral(0), resultName]);
    }

    return resultName;
  }

  _insertStatements(statements, blockHoist = 3) {
    statements.forEach(node => {
      node._blockHoist = blockHoist;
    });

    const targetPath = this._programPath.get("body").filter(p => {
      const val = p.node._blockHoist;
      return Number.isFinite(val) && val < 4;
    })[0];

    if (targetPath) {
      targetPath.insertBefore(statements);
    } else {
      this._programPath.unshiftContainer("body", statements);
    }
  }

}

exports.default = ImportInjector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvaGVscGVyLW1vZHVsZS1pbXBvcnRzL2xpYi9pbXBvcnQtaW5qZWN0b3IuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0IiwiX2Fzc2VydCIsImRhdGEiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsInQiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsIl9pbXBvcnRCdWlsZGVyIiwiX2lzTW9kdWxlIiwib2JqIiwiX19lc01vZHVsZSIsIm5ld09iaiIsImtleSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImRlc2MiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJnZXQiLCJzZXQiLCJJbXBvcnRJbmplY3RvciIsImNvbnN0cnVjdG9yIiwicGF0aCIsImltcG9ydGVkU291cmNlIiwib3B0cyIsIl9kZWZhdWx0T3B0cyIsImltcG9ydGVkVHlwZSIsImltcG9ydGVkSW50ZXJvcCIsImltcG9ydGluZ0ludGVyb3AiLCJlbnN1cmVMaXZlUmVmZXJlbmNlIiwiZW5zdXJlTm9Db250ZXh0IiwicHJvZ3JhbVBhdGgiLCJmaW5kIiwicCIsImlzUHJvZ3JhbSIsIl9wcm9ncmFtUGF0aCIsIl9wcm9ncmFtU2NvcGUiLCJzY29wZSIsIl9odWIiLCJodWIiLCJfYXBwbHlEZWZhdWx0cyIsImFkZERlZmF1bHQiLCJpbXBvcnRlZFNvdXJjZUluIiwiYWRkTmFtZWQiLCJpbXBvcnROYW1lIiwiX2dlbmVyYXRlSW1wb3J0IiwiYWRkTmFtZXNwYWNlIiwiYWRkU2lkZUVmZmVjdCIsImlzSW5pdCIsIm9wdHNMaXN0IiwicHVzaCIsIm5ld09wdHMiLCJhc3NpZ24iLCJrZXlzIiwiZm9yRWFjaCIsInVuZGVmaW5lZCIsIm5hbWVIaW50IiwiYmxvY2tIb2lzdCIsImlzRGVmYXVsdCIsImlzTmFtZWQiLCJpc05hbWVzcGFjZSIsIm5hbWUiLCJpc01vZCIsImlzTW9kdWxlRm9yTm9kZSIsImlzTW9kdWxlRm9yQmFiZWwiLCJidWlsZGVyIiwiRXJyb3IiLCJpbXBvcnQiLCJuYW1lc3BhY2UiLCJuYW1lZCIsImVzNkRlZmF1bHQiLCJ2YXIiLCJ3aWxkY2FyZEludGVyb3AiLCJkZWZhdWx0SW50ZXJvcCIsInJlYWQiLCJwcm9wIiwic3RhdGVtZW50cyIsInJlc3VsdE5hbWUiLCJkb25lIiwiX2luc2VydFN0YXRlbWVudHMiLCJ0eXBlIiwic2VxdWVuY2VFeHByZXNzaW9uIiwibnVtZXJpY0xpdGVyYWwiLCJub2RlIiwiX2Jsb2NrSG9pc3QiLCJ0YXJnZXRQYXRoIiwiZmlsdGVyIiwidmFsIiwiTnVtYmVyIiwiaXNGaW5pdGUiLCJpbnNlcnRCZWZvcmUiLCJ1bnNoaWZ0Q29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFrQixLQUFLLENBQXZCOztBQUVBLFNBQVNDLE9BQVQsR0FBbUI7QUFDakIsUUFBTUMsSUFBSSxHQUFHQyxzQkFBc0IsQ0FBQ0MsT0FBTyxDQUFDLFFBQUQsQ0FBUixDQUFuQzs7QUFFQUgsRUFBQUEsT0FBTyxHQUFHLFlBQVk7QUFDcEIsV0FBT0MsSUFBUDtBQUNELEdBRkQ7O0FBSUEsU0FBT0EsSUFBUDtBQUNEOztBQUVELFNBQVNHLENBQVQsR0FBYTtBQUNYLFFBQU1ILElBQUksR0FBR0ksdUJBQXVCLENBQUNGLE9BQU8sQ0FBQyxjQUFELENBQVIsQ0FBcEM7O0FBRUFDLEVBQUFBLENBQUMsR0FBRyxZQUFZO0FBQ2QsV0FBT0gsSUFBUDtBQUNELEdBRkQ7O0FBSUEsU0FBT0EsSUFBUDtBQUNEOztBQUVELElBQUlLLGNBQWMsR0FBR0osc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxrQkFBRCxDQUFSLENBQTNDOztBQUVBLElBQUlJLFNBQVMsR0FBR0wsc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxhQUFELENBQVIsQ0FBdEM7O0FBRUEsU0FBU0UsdUJBQVQsQ0FBaUNHLEdBQWpDLEVBQXNDO0FBQUUsTUFBSUEsR0FBRyxJQUFJQSxHQUFHLENBQUNDLFVBQWYsRUFBMkI7QUFBRSxXQUFPRCxHQUFQO0FBQWEsR0FBMUMsTUFBZ0Q7QUFBRSxRQUFJRSxNQUFNLEdBQUcsRUFBYjs7QUFBaUIsUUFBSUYsR0FBRyxJQUFJLElBQVgsRUFBaUI7QUFBRSxXQUFLLElBQUlHLEdBQVQsSUFBZ0JILEdBQWhCLEVBQXFCO0FBQUUsWUFBSWIsTUFBTSxDQUFDaUIsU0FBUCxDQUFpQkMsY0FBakIsQ0FBZ0NDLElBQWhDLENBQXFDTixHQUFyQyxFQUEwQ0csR0FBMUMsQ0FBSixFQUFvRDtBQUFFLGNBQUlJLElBQUksR0FBR3BCLE1BQU0sQ0FBQ0MsY0FBUCxJQUF5QkQsTUFBTSxDQUFDcUIsd0JBQWhDLEdBQTJEckIsTUFBTSxDQUFDcUIsd0JBQVAsQ0FBZ0NSLEdBQWhDLEVBQXFDRyxHQUFyQyxDQUEzRCxHQUF1RyxFQUFsSDs7QUFBc0gsY0FBSUksSUFBSSxDQUFDRSxHQUFMLElBQVlGLElBQUksQ0FBQ0csR0FBckIsRUFBMEI7QUFBRXZCLFlBQUFBLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQmMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DSSxJQUFuQztBQUEyQyxXQUF2RSxNQUE2RTtBQUFFTCxZQUFBQSxNQUFNLENBQUNDLEdBQUQsQ0FBTixHQUFjSCxHQUFHLENBQUNHLEdBQUQsQ0FBakI7QUFBeUI7QUFBRTtBQUFFO0FBQUU7O0FBQUNELElBQUFBLE1BQU0sQ0FBQ1gsT0FBUCxHQUFpQlMsR0FBakI7QUFBc0IsV0FBT0UsTUFBUDtBQUFnQjtBQUFFOztBQUV4ZCxTQUFTUixzQkFBVCxDQUFnQ00sR0FBaEMsRUFBcUM7QUFBRSxTQUFPQSxHQUFHLElBQUlBLEdBQUcsQ0FBQ0MsVUFBWCxHQUF3QkQsR0FBeEIsR0FBOEI7QUFBRVQsSUFBQUEsT0FBTyxFQUFFUztBQUFYLEdBQXJDO0FBQXdEOztBQUUvRixNQUFNVyxjQUFOLENBQXFCO0FBQ25CQyxFQUFBQSxXQUFXLENBQUNDLElBQUQsRUFBT0MsY0FBUCxFQUF1QkMsSUFBdkIsRUFBNkI7QUFDdEMsU0FBS0MsWUFBTCxHQUFvQjtBQUNsQkYsTUFBQUEsY0FBYyxFQUFFLElBREU7QUFFbEJHLE1BQUFBLFlBQVksRUFBRSxVQUZJO0FBR2xCQyxNQUFBQSxlQUFlLEVBQUUsT0FIQztBQUlsQkMsTUFBQUEsZ0JBQWdCLEVBQUUsT0FKQTtBQUtsQkMsTUFBQUEsbUJBQW1CLEVBQUUsS0FMSDtBQU1sQkMsTUFBQUEsZUFBZSxFQUFFO0FBTkMsS0FBcEI7QUFRQSxVQUFNQyxXQUFXLEdBQUdULElBQUksQ0FBQ1UsSUFBTCxDQUFVQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsU0FBRixFQUFmLENBQXBCO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQkosV0FBcEI7QUFDQSxTQUFLSyxhQUFMLEdBQXFCTCxXQUFXLENBQUNNLEtBQWpDO0FBQ0EsU0FBS0MsSUFBTCxHQUFZUCxXQUFXLENBQUNRLEdBQXhCO0FBQ0EsU0FBS2QsWUFBTCxHQUFvQixLQUFLZSxjQUFMLENBQW9CakIsY0FBcEIsRUFBb0NDLElBQXBDLEVBQTBDLElBQTFDLENBQXBCO0FBQ0Q7O0FBRURpQixFQUFBQSxVQUFVLENBQUNDLGdCQUFELEVBQW1CbEIsSUFBbkIsRUFBeUI7QUFDakMsV0FBTyxLQUFLbUIsUUFBTCxDQUFjLFNBQWQsRUFBeUJELGdCQUF6QixFQUEyQ2xCLElBQTNDLENBQVA7QUFDRDs7QUFFRG1CLEVBQUFBLFFBQVEsQ0FBQ0MsVUFBRCxFQUFhRixnQkFBYixFQUErQmxCLElBQS9CLEVBQXFDO0FBQzNDLEtBQUMsR0FBR3ZCLE9BQU8sR0FBR0QsT0FBZCxFQUF1QixPQUFPNEMsVUFBUCxLQUFzQixRQUE3QztBQUNBLFdBQU8sS0FBS0MsZUFBTCxDQUFxQixLQUFLTCxjQUFMLENBQW9CRSxnQkFBcEIsRUFBc0NsQixJQUF0QyxDQUFyQixFQUFrRW9CLFVBQWxFLENBQVA7QUFDRDs7QUFFREUsRUFBQUEsWUFBWSxDQUFDSixnQkFBRCxFQUFtQmxCLElBQW5CLEVBQXlCO0FBQ25DLFdBQU8sS0FBS3FCLGVBQUwsQ0FBcUIsS0FBS0wsY0FBTCxDQUFvQkUsZ0JBQXBCLEVBQXNDbEIsSUFBdEMsQ0FBckIsRUFBa0UsSUFBbEUsQ0FBUDtBQUNEOztBQUVEdUIsRUFBQUEsYUFBYSxDQUFDTCxnQkFBRCxFQUFtQmxCLElBQW5CLEVBQXlCO0FBQ3BDLFdBQU8sS0FBS3FCLGVBQUwsQ0FBcUIsS0FBS0wsY0FBTCxDQUFvQkUsZ0JBQXBCLEVBQXNDbEIsSUFBdEMsQ0FBckIsRUFBa0UsS0FBbEUsQ0FBUDtBQUNEOztBQUVEZ0IsRUFBQUEsY0FBYyxDQUFDakIsY0FBRCxFQUFpQkMsSUFBakIsRUFBdUJ3QixNQUFNLEdBQUcsS0FBaEMsRUFBdUM7QUFDbkQsVUFBTUMsUUFBUSxHQUFHLEVBQWpCOztBQUVBLFFBQUksT0FBTzFCLGNBQVAsS0FBMEIsUUFBOUIsRUFBd0M7QUFDdEMwQixNQUFBQSxRQUFRLENBQUNDLElBQVQsQ0FBYztBQUNaM0IsUUFBQUE7QUFEWSxPQUFkO0FBR0EwQixNQUFBQSxRQUFRLENBQUNDLElBQVQsQ0FBYzFCLElBQWQ7QUFDRCxLQUxELE1BS087QUFDTCxPQUFDLEdBQUd2QixPQUFPLEdBQUdELE9BQWQsRUFBdUIsQ0FBQ3dCLElBQXhCLEVBQThCLGlDQUE5QjtBQUNBeUIsTUFBQUEsUUFBUSxDQUFDQyxJQUFULENBQWMzQixjQUFkO0FBQ0Q7O0FBRUQsVUFBTTRCLE9BQU8sR0FBR3ZELE1BQU0sQ0FBQ3dELE1BQVAsQ0FBYyxFQUFkLEVBQWtCLEtBQUszQixZQUF2QixDQUFoQjs7QUFFQSxTQUFLLE1BQU1ELElBQVgsSUFBbUJ5QixRQUFuQixFQUE2QjtBQUMzQixVQUFJLENBQUN6QixJQUFMLEVBQVc7QUFDWDVCLE1BQUFBLE1BQU0sQ0FBQ3lELElBQVAsQ0FBWUYsT0FBWixFQUFxQkcsT0FBckIsQ0FBNkIxQyxHQUFHLElBQUk7QUFDbEMsWUFBSVksSUFBSSxDQUFDWixHQUFELENBQUosS0FBYzJDLFNBQWxCLEVBQTZCSixPQUFPLENBQUN2QyxHQUFELENBQVAsR0FBZVksSUFBSSxDQUFDWixHQUFELENBQW5CO0FBQzlCLE9BRkQ7O0FBSUEsVUFBSSxDQUFDb0MsTUFBTCxFQUFhO0FBQ1gsWUFBSXhCLElBQUksQ0FBQ2dDLFFBQUwsS0FBa0JELFNBQXRCLEVBQWlDSixPQUFPLENBQUNLLFFBQVIsR0FBbUJoQyxJQUFJLENBQUNnQyxRQUF4QjtBQUNqQyxZQUFJaEMsSUFBSSxDQUFDaUMsVUFBTCxLQUFvQkYsU0FBeEIsRUFBbUNKLE9BQU8sQ0FBQ00sVUFBUixHQUFxQmpDLElBQUksQ0FBQ2lDLFVBQTFCO0FBQ3BDO0FBQ0Y7O0FBRUQsV0FBT04sT0FBUDtBQUNEOztBQUVETixFQUFBQSxlQUFlLENBQUNyQixJQUFELEVBQU9vQixVQUFQLEVBQW1CO0FBQ2hDLFVBQU1jLFNBQVMsR0FBR2QsVUFBVSxLQUFLLFNBQWpDO0FBQ0EsVUFBTWUsT0FBTyxHQUFHLENBQUMsQ0FBQ2YsVUFBRixJQUFnQixDQUFDYyxTQUFqQztBQUNBLFVBQU1FLFdBQVcsR0FBR2hCLFVBQVUsS0FBSyxJQUFuQztBQUNBLFVBQU07QUFDSnJCLE1BQUFBLGNBREk7QUFFSkcsTUFBQUEsWUFGSTtBQUdKQyxNQUFBQSxlQUhJO0FBSUpDLE1BQUFBLGdCQUpJO0FBS0pDLE1BQUFBLG1CQUxJO0FBTUpDLE1BQUFBLGVBTkk7QUFPSjBCLE1BQUFBLFFBUEk7QUFRSkMsTUFBQUE7QUFSSSxRQVNGakMsSUFUSjtBQVVBLFFBQUlxQyxJQUFJLEdBQUdMLFFBQVEsSUFBSVosVUFBdkI7QUFDQSxVQUFNa0IsS0FBSyxHQUFHLENBQUMsR0FBR3RELFNBQVMsQ0FBQ1IsT0FBZCxFQUF1QixLQUFLbUMsWUFBNUIsQ0FBZDtBQUNBLFVBQU00QixlQUFlLEdBQUdELEtBQUssSUFBSWxDLGdCQUFnQixLQUFLLE1BQXREO0FBQ0EsVUFBTW9DLGdCQUFnQixHQUFHRixLQUFLLElBQUlsQyxnQkFBZ0IsS0FBSyxPQUF2RDtBQUNBLFVBQU1xQyxPQUFPLEdBQUcsSUFBSTFELGNBQWMsQ0FBQ1AsT0FBbkIsQ0FBMkJ1QixjQUEzQixFQUEyQyxLQUFLYSxhQUFoRCxFQUErRCxLQUFLRSxJQUFwRSxDQUFoQjs7QUFFQSxRQUFJWixZQUFZLEtBQUssS0FBckIsRUFBNEI7QUFDMUIsVUFBSSxDQUFDcUMsZUFBRCxJQUFvQixDQUFDQyxnQkFBekIsRUFBMkM7QUFDekMsY0FBTSxJQUFJRSxLQUFKLENBQVUsMkNBQVYsQ0FBTjtBQUNEOztBQUVERCxNQUFBQSxPQUFPLENBQUNFLE1BQVI7O0FBRUEsVUFBSVAsV0FBSixFQUFpQjtBQUNmSyxRQUFBQSxPQUFPLENBQUNHLFNBQVIsQ0FBa0JaLFFBQVEsSUFBSWpDLGNBQTlCO0FBQ0QsT0FGRCxNQUVPLElBQUltQyxTQUFTLElBQUlDLE9BQWpCLEVBQTBCO0FBQy9CTSxRQUFBQSxPQUFPLENBQUNJLEtBQVIsQ0FBY1IsSUFBZCxFQUFvQmpCLFVBQXBCO0FBQ0Q7QUFDRixLQVpELE1BWU8sSUFBSWxCLFlBQVksS0FBSyxVQUFyQixFQUFpQztBQUN0QyxZQUFNLElBQUl3QyxLQUFKLENBQVcsMkJBQTBCeEMsWUFBYSxHQUFsRCxDQUFOO0FBQ0QsS0FGTSxNQUVBLElBQUlDLGVBQWUsS0FBSyxPQUF4QixFQUFpQztBQUN0QyxVQUFJb0MsZUFBSixFQUFxQjtBQUNuQkYsUUFBQUEsSUFBSSxHQUFHQSxJQUFJLEtBQUssU0FBVCxHQUFxQkEsSUFBckIsR0FBNEJ0QyxjQUFuQztBQUNBLGNBQU0rQyxVQUFVLEdBQUksR0FBRS9DLGNBQWUsYUFBckM7QUFDQTBDLFFBQUFBLE9BQU8sQ0FBQ0UsTUFBUjs7QUFFQSxZQUFJUCxXQUFKLEVBQWlCO0FBQ2ZLLFVBQUFBLE9BQU8sQ0FBQ2pFLE9BQVIsQ0FBZ0JzRSxVQUFoQixFQUE0QkMsR0FBNUIsQ0FBZ0NWLElBQUksSUFBSXRDLGNBQXhDLEVBQXdEaUQsZUFBeEQ7QUFDRCxTQUZELE1BRU8sSUFBSWQsU0FBSixFQUFlO0FBQ3BCLGNBQUk3QixtQkFBSixFQUF5QjtBQUN2Qm9DLFlBQUFBLE9BQU8sQ0FBQ2pFLE9BQVIsQ0FBZ0JzRSxVQUFoQixFQUE0QkMsR0FBNUIsQ0FBZ0NWLElBQUksSUFBSXRDLGNBQXhDLEVBQXdEa0QsY0FBeEQsR0FBeUVDLElBQXpFLENBQThFLFNBQTlFO0FBQ0QsV0FGRCxNQUVPO0FBQ0xULFlBQUFBLE9BQU8sQ0FBQ2pFLE9BQVIsQ0FBZ0JzRSxVQUFoQixFQUE0QkMsR0FBNUIsQ0FBZ0NWLElBQWhDLEVBQXNDWSxjQUF0QyxHQUF1REUsSUFBdkQsQ0FBNEQvQixVQUE1RDtBQUNEO0FBQ0YsU0FOTSxNQU1BLElBQUllLE9BQUosRUFBYTtBQUNsQk0sVUFBQUEsT0FBTyxDQUFDakUsT0FBUixDQUFnQnNFLFVBQWhCLEVBQTRCSSxJQUE1QixDQUFpQzlCLFVBQWpDO0FBQ0Q7QUFDRixPQWhCRCxNQWdCTyxJQUFJb0IsZ0JBQUosRUFBc0I7QUFDM0JDLFFBQUFBLE9BQU8sQ0FBQ0UsTUFBUjs7QUFFQSxZQUFJUCxXQUFKLEVBQWlCO0FBQ2ZLLFVBQUFBLE9BQU8sQ0FBQ0csU0FBUixDQUFrQlAsSUFBSSxJQUFJdEMsY0FBMUI7QUFDRCxTQUZELE1BRU8sSUFBSW1DLFNBQVMsSUFBSUMsT0FBakIsRUFBMEI7QUFDL0JNLFVBQUFBLE9BQU8sQ0FBQ0ksS0FBUixDQUFjUixJQUFkLEVBQW9CakIsVUFBcEI7QUFDRDtBQUNGLE9BUk0sTUFRQTtBQUNMcUIsUUFBQUEsT0FBTyxDQUFDN0QsT0FBUjs7QUFFQSxZQUFJd0QsV0FBSixFQUFpQjtBQUNmSyxVQUFBQSxPQUFPLENBQUNNLEdBQVIsQ0FBWVYsSUFBSSxJQUFJdEMsY0FBcEIsRUFBb0NpRCxlQUFwQztBQUNELFNBRkQsTUFFTyxJQUFJLENBQUNkLFNBQVMsSUFBSUMsT0FBZCxLQUEwQjlCLG1CQUE5QixFQUFtRDtBQUN4RCxjQUFJNkIsU0FBSixFQUFlO0FBQ2JHLFlBQUFBLElBQUksR0FBR0EsSUFBSSxLQUFLLFNBQVQsR0FBcUJBLElBQXJCLEdBQTRCdEMsY0FBbkM7QUFDQTBDLFlBQUFBLE9BQU8sQ0FBQ00sR0FBUixDQUFZVixJQUFaLEVBQWtCYSxJQUFsQixDQUF1QjlCLFVBQXZCO0FBQ0FxQixZQUFBQSxPQUFPLENBQUNRLGNBQVI7QUFDRCxXQUpELE1BSU87QUFDTFIsWUFBQUEsT0FBTyxDQUFDTSxHQUFSLENBQVloRCxjQUFaLEVBQTRCbUQsSUFBNUIsQ0FBaUM5QixVQUFqQztBQUNEO0FBQ0YsU0FSTSxNQVFBLElBQUljLFNBQUosRUFBZTtBQUNwQk8sVUFBQUEsT0FBTyxDQUFDTSxHQUFSLENBQVlWLElBQVosRUFBa0JZLGNBQWxCLEdBQW1DRSxJQUFuQyxDQUF3Qy9CLFVBQXhDO0FBQ0QsU0FGTSxNQUVBLElBQUllLE9BQUosRUFBYTtBQUNsQk0sVUFBQUEsT0FBTyxDQUFDTSxHQUFSLENBQVlWLElBQVosRUFBa0JjLElBQWxCLENBQXVCL0IsVUFBdkI7QUFDRDtBQUNGO0FBQ0YsS0E1Q00sTUE0Q0EsSUFBSWpCLGVBQWUsS0FBSyxVQUF4QixFQUFvQztBQUN6QyxVQUFJb0MsZUFBSixFQUFxQjtBQUNuQkUsUUFBQUEsT0FBTyxDQUFDRSxNQUFSOztBQUVBLFlBQUlQLFdBQUosRUFBaUI7QUFDZkssVUFBQUEsT0FBTyxDQUFDakUsT0FBUixDQUFnQjZELElBQUksSUFBSXRDLGNBQXhCO0FBQ0QsU0FGRCxNQUVPLElBQUltQyxTQUFTLElBQUlDLE9BQWpCLEVBQTBCO0FBQy9CTSxVQUFBQSxPQUFPLENBQUNqRSxPQUFSLENBQWdCdUIsY0FBaEIsRUFBZ0NtRCxJQUFoQyxDQUFxQ2IsSUFBckM7QUFDRDtBQUNGLE9BUkQsTUFRTyxJQUFJRyxnQkFBSixFQUFzQjtBQUMzQkMsUUFBQUEsT0FBTyxDQUFDRSxNQUFSOztBQUVBLFlBQUlQLFdBQUosRUFBaUI7QUFDZkssVUFBQUEsT0FBTyxDQUFDRyxTQUFSLENBQWtCUCxJQUFJLElBQUl0QyxjQUExQjtBQUNELFNBRkQsTUFFTyxJQUFJbUMsU0FBUyxJQUFJQyxPQUFqQixFQUEwQjtBQUMvQk0sVUFBQUEsT0FBTyxDQUFDSSxLQUFSLENBQWNSLElBQWQsRUFBb0JqQixVQUFwQjtBQUNEO0FBQ0YsT0FSTSxNQVFBO0FBQ0xxQixRQUFBQSxPQUFPLENBQUM3RCxPQUFSOztBQUVBLFlBQUl3RCxXQUFKLEVBQWlCO0FBQ2ZLLFVBQUFBLE9BQU8sQ0FBQ00sR0FBUixDQUFZVixJQUFJLElBQUl0QyxjQUFwQjtBQUNELFNBRkQsTUFFTyxJQUFJbUMsU0FBUyxJQUFJQyxPQUFqQixFQUEwQjtBQUMvQixjQUFJOUIsbUJBQUosRUFBeUI7QUFDdkJvQyxZQUFBQSxPQUFPLENBQUNNLEdBQVIsQ0FBWWhELGNBQVosRUFBNEJtRCxJQUE1QixDQUFpQ2IsSUFBakM7QUFDRCxXQUZELE1BRU87QUFDTEksWUFBQUEsT0FBTyxDQUFDVSxJQUFSLENBQWEvQixVQUFiLEVBQXlCMkIsR0FBekIsQ0FBNkJWLElBQTdCO0FBQ0Q7QUFDRjtBQUNGO0FBQ0YsS0E5Qk0sTUE4QkEsSUFBSWxDLGVBQWUsS0FBSyxZQUF4QixFQUFzQztBQUMzQyxVQUFJK0IsU0FBUyxJQUFJN0IsbUJBQWpCLEVBQXNDO0FBQ3BDLGNBQU0sSUFBSXFDLEtBQUosQ0FBVSx3Q0FBVixDQUFOO0FBQ0Q7O0FBRUQsVUFBSUgsZUFBSixFQUFxQjtBQUNuQkUsUUFBQUEsT0FBTyxDQUFDRSxNQUFSOztBQUVBLFlBQUlQLFdBQUosRUFBaUI7QUFDZkssVUFBQUEsT0FBTyxDQUFDakUsT0FBUixDQUFnQjZELElBQUksSUFBSXRDLGNBQXhCO0FBQ0QsU0FGRCxNQUVPLElBQUltQyxTQUFKLEVBQWU7QUFDcEJPLFVBQUFBLE9BQU8sQ0FBQ2pFLE9BQVIsQ0FBZ0I2RCxJQUFoQjtBQUNELFNBRk0sTUFFQSxJQUFJRixPQUFKLEVBQWE7QUFDbEJNLFVBQUFBLE9BQU8sQ0FBQ2pFLE9BQVIsQ0FBZ0J1QixjQUFoQixFQUFnQ21ELElBQWhDLENBQXFDYixJQUFyQztBQUNEO0FBQ0YsT0FWRCxNQVVPLElBQUlHLGdCQUFKLEVBQXNCO0FBQzNCQyxRQUFBQSxPQUFPLENBQUNFLE1BQVI7O0FBRUEsWUFBSVAsV0FBSixFQUFpQjtBQUNmSyxVQUFBQSxPQUFPLENBQUNqRSxPQUFSLENBQWdCNkQsSUFBSSxJQUFJdEMsY0FBeEI7QUFDRCxTQUZELE1BRU8sSUFBSW1DLFNBQUosRUFBZTtBQUNwQk8sVUFBQUEsT0FBTyxDQUFDakUsT0FBUixDQUFnQjZELElBQWhCO0FBQ0QsU0FGTSxNQUVBLElBQUlGLE9BQUosRUFBYTtBQUNsQk0sVUFBQUEsT0FBTyxDQUFDSSxLQUFSLENBQWNSLElBQWQsRUFBb0JqQixVQUFwQjtBQUNEO0FBQ0YsT0FWTSxNQVVBO0FBQ0xxQixRQUFBQSxPQUFPLENBQUM3RCxPQUFSOztBQUVBLFlBQUl3RCxXQUFKLEVBQWlCO0FBQ2ZLLFVBQUFBLE9BQU8sQ0FBQ00sR0FBUixDQUFZVixJQUFJLElBQUl0QyxjQUFwQjtBQUNELFNBRkQsTUFFTyxJQUFJbUMsU0FBSixFQUFlO0FBQ3BCTyxVQUFBQSxPQUFPLENBQUNNLEdBQVIsQ0FBWVYsSUFBWjtBQUNELFNBRk0sTUFFQSxJQUFJRixPQUFKLEVBQWE7QUFDbEIsY0FBSTlCLG1CQUFKLEVBQXlCO0FBQ3ZCb0MsWUFBQUEsT0FBTyxDQUFDTSxHQUFSLENBQVloRCxjQUFaLEVBQTRCbUQsSUFBNUIsQ0FBaUNiLElBQWpDO0FBQ0QsV0FGRCxNQUVPO0FBQ0xJLFlBQUFBLE9BQU8sQ0FBQ00sR0FBUixDQUFZVixJQUFaLEVBQWtCYyxJQUFsQixDQUF1Qi9CLFVBQXZCO0FBQ0Q7QUFDRjtBQUNGO0FBQ0YsS0F4Q00sTUF3Q0E7QUFDTCxZQUFNLElBQUlzQixLQUFKLENBQVcsNEJBQTJCdkMsZUFBZ0IsSUFBdEQsQ0FBTjtBQUNEOztBQUVELFVBQU07QUFDSmlELE1BQUFBLFVBREk7QUFFSkMsTUFBQUE7QUFGSSxRQUdGWixPQUFPLENBQUNhLElBQVIsRUFISjs7QUFLQSxTQUFLQyxpQkFBTCxDQUF1QkgsVUFBdkIsRUFBbUNuQixVQUFuQzs7QUFFQSxRQUFJLENBQUNDLFNBQVMsSUFBSUMsT0FBZCxLQUEwQjdCLGVBQTFCLElBQTZDK0MsVUFBVSxDQUFDRyxJQUFYLEtBQW9CLFlBQXJFLEVBQW1GO0FBQ2pGLGFBQU8zRSxDQUFDLEdBQUc0RSxrQkFBSixDQUF1QixDQUFDNUUsQ0FBQyxHQUFHNkUsY0FBSixDQUFtQixDQUFuQixDQUFELEVBQXdCTCxVQUF4QixDQUF2QixDQUFQO0FBQ0Q7O0FBRUQsV0FBT0EsVUFBUDtBQUNEOztBQUVERSxFQUFBQSxpQkFBaUIsQ0FBQ0gsVUFBRCxFQUFhbkIsVUFBVSxHQUFHLENBQTFCLEVBQTZCO0FBQzVDbUIsSUFBQUEsVUFBVSxDQUFDdEIsT0FBWCxDQUFtQjZCLElBQUksSUFBSTtBQUN6QkEsTUFBQUEsSUFBSSxDQUFDQyxXQUFMLEdBQW1CM0IsVUFBbkI7QUFDRCxLQUZEOztBQUlBLFVBQU00QixVQUFVLEdBQUcsS0FBS2xELFlBQUwsQ0FBa0JqQixHQUFsQixDQUFzQixNQUF0QixFQUE4Qm9FLE1BQTlCLENBQXFDckQsQ0FBQyxJQUFJO0FBQzNELFlBQU1zRCxHQUFHLEdBQUd0RCxDQUFDLENBQUNrRCxJQUFGLENBQU9DLFdBQW5CO0FBQ0EsYUFBT0ksTUFBTSxDQUFDQyxRQUFQLENBQWdCRixHQUFoQixLQUF3QkEsR0FBRyxHQUFHLENBQXJDO0FBQ0QsS0FIa0IsRUFHaEIsQ0FIZ0IsQ0FBbkI7O0FBS0EsUUFBSUYsVUFBSixFQUFnQjtBQUNkQSxNQUFBQSxVQUFVLENBQUNLLFlBQVgsQ0FBd0JkLFVBQXhCO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsV0FBS3pDLFlBQUwsQ0FBa0J3RCxnQkFBbEIsQ0FBbUMsTUFBbkMsRUFBMkNmLFVBQTNDO0FBQ0Q7QUFDRjs7QUFyUGtCOztBQXlQckI5RSxPQUFPLENBQUNFLE9BQVIsR0FBa0JvQixjQUFsQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwO1xuXG5mdW5jdGlvbiBfYXNzZXJ0KCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiYXNzZXJ0XCIpKTtcblxuICBfYXNzZXJ0ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiB0KCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZShcIkBiYWJlbC90eXBlc1wiKSk7XG5cbiAgdCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxudmFyIF9pbXBvcnRCdWlsZGVyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9pbXBvcnQtYnVpbGRlclwiKSk7XG5cbnZhciBfaXNNb2R1bGUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL2lzLW1vZHVsZVwiKSk7XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaikgeyBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7IHJldHVybiBvYmo7IH0gZWxzZSB7IHZhciBuZXdPYmogPSB7fTsgaWYgKG9iaiAhPSBudWxsKSB7IGZvciAodmFyIGtleSBpbiBvYmopIHsgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsgdmFyIGRlc2MgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDoge307IGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSB9IG5ld09iai5kZWZhdWx0ID0gb2JqOyByZXR1cm4gbmV3T2JqOyB9IH1cblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuY2xhc3MgSW1wb3J0SW5qZWN0b3Ige1xuICBjb25zdHJ1Y3RvcihwYXRoLCBpbXBvcnRlZFNvdXJjZSwgb3B0cykge1xuICAgIHRoaXMuX2RlZmF1bHRPcHRzID0ge1xuICAgICAgaW1wb3J0ZWRTb3VyY2U6IG51bGwsXG4gICAgICBpbXBvcnRlZFR5cGU6IFwiY29tbW9uanNcIixcbiAgICAgIGltcG9ydGVkSW50ZXJvcDogXCJiYWJlbFwiLFxuICAgICAgaW1wb3J0aW5nSW50ZXJvcDogXCJiYWJlbFwiLFxuICAgICAgZW5zdXJlTGl2ZVJlZmVyZW5jZTogZmFsc2UsXG4gICAgICBlbnN1cmVOb0NvbnRleHQ6IGZhbHNlXG4gICAgfTtcbiAgICBjb25zdCBwcm9ncmFtUGF0aCA9IHBhdGguZmluZChwID0+IHAuaXNQcm9ncmFtKCkpO1xuICAgIHRoaXMuX3Byb2dyYW1QYXRoID0gcHJvZ3JhbVBhdGg7XG4gICAgdGhpcy5fcHJvZ3JhbVNjb3BlID0gcHJvZ3JhbVBhdGguc2NvcGU7XG4gICAgdGhpcy5faHViID0gcHJvZ3JhbVBhdGguaHViO1xuICAgIHRoaXMuX2RlZmF1bHRPcHRzID0gdGhpcy5fYXBwbHlEZWZhdWx0cyhpbXBvcnRlZFNvdXJjZSwgb3B0cywgdHJ1ZSk7XG4gIH1cblxuICBhZGREZWZhdWx0KGltcG9ydGVkU291cmNlSW4sIG9wdHMpIHtcbiAgICByZXR1cm4gdGhpcy5hZGROYW1lZChcImRlZmF1bHRcIiwgaW1wb3J0ZWRTb3VyY2VJbiwgb3B0cyk7XG4gIH1cblxuICBhZGROYW1lZChpbXBvcnROYW1lLCBpbXBvcnRlZFNvdXJjZUluLCBvcHRzKSB7XG4gICAgKDAsIF9hc3NlcnQoKS5kZWZhdWx0KSh0eXBlb2YgaW1wb3J0TmFtZSA9PT0gXCJzdHJpbmdcIik7XG4gICAgcmV0dXJuIHRoaXMuX2dlbmVyYXRlSW1wb3J0KHRoaXMuX2FwcGx5RGVmYXVsdHMoaW1wb3J0ZWRTb3VyY2VJbiwgb3B0cyksIGltcG9ydE5hbWUpO1xuICB9XG5cbiAgYWRkTmFtZXNwYWNlKGltcG9ydGVkU291cmNlSW4sIG9wdHMpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2VuZXJhdGVJbXBvcnQodGhpcy5fYXBwbHlEZWZhdWx0cyhpbXBvcnRlZFNvdXJjZUluLCBvcHRzKSwgbnVsbCk7XG4gIH1cblxuICBhZGRTaWRlRWZmZWN0KGltcG9ydGVkU291cmNlSW4sIG9wdHMpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2VuZXJhdGVJbXBvcnQodGhpcy5fYXBwbHlEZWZhdWx0cyhpbXBvcnRlZFNvdXJjZUluLCBvcHRzKSwgZmFsc2UpO1xuICB9XG5cbiAgX2FwcGx5RGVmYXVsdHMoaW1wb3J0ZWRTb3VyY2UsIG9wdHMsIGlzSW5pdCA9IGZhbHNlKSB7XG4gICAgY29uc3Qgb3B0c0xpc3QgPSBbXTtcblxuICAgIGlmICh0eXBlb2YgaW1wb3J0ZWRTb3VyY2UgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIG9wdHNMaXN0LnB1c2goe1xuICAgICAgICBpbXBvcnRlZFNvdXJjZVxuICAgICAgfSk7XG4gICAgICBvcHRzTGlzdC5wdXNoKG9wdHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICAoMCwgX2Fzc2VydCgpLmRlZmF1bHQpKCFvcHRzLCBcIlVuZXhwZWN0ZWQgc2Vjb25kYXJ5IGFyZ3VtZW50cy5cIik7XG4gICAgICBvcHRzTGlzdC5wdXNoKGltcG9ydGVkU291cmNlKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdPcHRzID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fZGVmYXVsdE9wdHMpO1xuXG4gICAgZm9yIChjb25zdCBvcHRzIG9mIG9wdHNMaXN0KSB7XG4gICAgICBpZiAoIW9wdHMpIGNvbnRpbnVlO1xuICAgICAgT2JqZWN0LmtleXMobmV3T3B0cykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBpZiAob3B0c1trZXldICE9PSB1bmRlZmluZWQpIG5ld09wdHNba2V5XSA9IG9wdHNba2V5XTtcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWlzSW5pdCkge1xuICAgICAgICBpZiAob3B0cy5uYW1lSGludCAhPT0gdW5kZWZpbmVkKSBuZXdPcHRzLm5hbWVIaW50ID0gb3B0cy5uYW1lSGludDtcbiAgICAgICAgaWYgKG9wdHMuYmxvY2tIb2lzdCAhPT0gdW5kZWZpbmVkKSBuZXdPcHRzLmJsb2NrSG9pc3QgPSBvcHRzLmJsb2NrSG9pc3Q7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld09wdHM7XG4gIH1cblxuICBfZ2VuZXJhdGVJbXBvcnQob3B0cywgaW1wb3J0TmFtZSkge1xuICAgIGNvbnN0IGlzRGVmYXVsdCA9IGltcG9ydE5hbWUgPT09IFwiZGVmYXVsdFwiO1xuICAgIGNvbnN0IGlzTmFtZWQgPSAhIWltcG9ydE5hbWUgJiYgIWlzRGVmYXVsdDtcbiAgICBjb25zdCBpc05hbWVzcGFjZSA9IGltcG9ydE5hbWUgPT09IG51bGw7XG4gICAgY29uc3Qge1xuICAgICAgaW1wb3J0ZWRTb3VyY2UsXG4gICAgICBpbXBvcnRlZFR5cGUsXG4gICAgICBpbXBvcnRlZEludGVyb3AsXG4gICAgICBpbXBvcnRpbmdJbnRlcm9wLFxuICAgICAgZW5zdXJlTGl2ZVJlZmVyZW5jZSxcbiAgICAgIGVuc3VyZU5vQ29udGV4dCxcbiAgICAgIG5hbWVIaW50LFxuICAgICAgYmxvY2tIb2lzdFxuICAgIH0gPSBvcHRzO1xuICAgIGxldCBuYW1lID0gbmFtZUhpbnQgfHwgaW1wb3J0TmFtZTtcbiAgICBjb25zdCBpc01vZCA9ICgwLCBfaXNNb2R1bGUuZGVmYXVsdCkodGhpcy5fcHJvZ3JhbVBhdGgpO1xuICAgIGNvbnN0IGlzTW9kdWxlRm9yTm9kZSA9IGlzTW9kICYmIGltcG9ydGluZ0ludGVyb3AgPT09IFwibm9kZVwiO1xuICAgIGNvbnN0IGlzTW9kdWxlRm9yQmFiZWwgPSBpc01vZCAmJiBpbXBvcnRpbmdJbnRlcm9wID09PSBcImJhYmVsXCI7XG4gICAgY29uc3QgYnVpbGRlciA9IG5ldyBfaW1wb3J0QnVpbGRlci5kZWZhdWx0KGltcG9ydGVkU291cmNlLCB0aGlzLl9wcm9ncmFtU2NvcGUsIHRoaXMuX2h1Yik7XG5cbiAgICBpZiAoaW1wb3J0ZWRUeXBlID09PSBcImVzNlwiKSB7XG4gICAgICBpZiAoIWlzTW9kdWxlRm9yTm9kZSAmJiAhaXNNb2R1bGVGb3JCYWJlbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgaW1wb3J0IGFuIEVTNiBtb2R1bGUgZnJvbSBDb21tb25KU1wiKTtcbiAgICAgIH1cblxuICAgICAgYnVpbGRlci5pbXBvcnQoKTtcblxuICAgICAgaWYgKGlzTmFtZXNwYWNlKSB7XG4gICAgICAgIGJ1aWxkZXIubmFtZXNwYWNlKG5hbWVIaW50IHx8IGltcG9ydGVkU291cmNlKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNEZWZhdWx0IHx8IGlzTmFtZWQpIHtcbiAgICAgICAgYnVpbGRlci5uYW1lZChuYW1lLCBpbXBvcnROYW1lKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGltcG9ydGVkVHlwZSAhPT0gXCJjb21tb25qc1wiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaW50ZXJvcFR5cGUgXCIke2ltcG9ydGVkVHlwZX1cImApO1xuICAgIH0gZWxzZSBpZiAoaW1wb3J0ZWRJbnRlcm9wID09PSBcImJhYmVsXCIpIHtcbiAgICAgIGlmIChpc01vZHVsZUZvck5vZGUpIHtcbiAgICAgICAgbmFtZSA9IG5hbWUgIT09IFwiZGVmYXVsdFwiID8gbmFtZSA6IGltcG9ydGVkU291cmNlO1xuICAgICAgICBjb25zdCBlczZEZWZhdWx0ID0gYCR7aW1wb3J0ZWRTb3VyY2V9JGVzNkRlZmF1bHRgO1xuICAgICAgICBidWlsZGVyLmltcG9ydCgpO1xuXG4gICAgICAgIGlmIChpc05hbWVzcGFjZSkge1xuICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChlczZEZWZhdWx0KS52YXIobmFtZSB8fCBpbXBvcnRlZFNvdXJjZSkud2lsZGNhcmRJbnRlcm9wKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNEZWZhdWx0KSB7XG4gICAgICAgICAgaWYgKGVuc3VyZUxpdmVSZWZlcmVuY2UpIHtcbiAgICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChlczZEZWZhdWx0KS52YXIobmFtZSB8fCBpbXBvcnRlZFNvdXJjZSkuZGVmYXVsdEludGVyb3AoKS5yZWFkKFwiZGVmYXVsdFwiKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnVpbGRlci5kZWZhdWx0KGVzNkRlZmF1bHQpLnZhcihuYW1lKS5kZWZhdWx0SW50ZXJvcCgpLnByb3AoaW1wb3J0TmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGlzTmFtZWQpIHtcbiAgICAgICAgICBidWlsZGVyLmRlZmF1bHQoZXM2RGVmYXVsdCkucmVhZChpbXBvcnROYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChpc01vZHVsZUZvckJhYmVsKSB7XG4gICAgICAgIGJ1aWxkZXIuaW1wb3J0KCk7XG5cbiAgICAgICAgaWYgKGlzTmFtZXNwYWNlKSB7XG4gICAgICAgICAgYnVpbGRlci5uYW1lc3BhY2UobmFtZSB8fCBpbXBvcnRlZFNvdXJjZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNEZWZhdWx0IHx8IGlzTmFtZWQpIHtcbiAgICAgICAgICBidWlsZGVyLm5hbWVkKG5hbWUsIGltcG9ydE5hbWUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBidWlsZGVyLnJlcXVpcmUoKTtcblxuICAgICAgICBpZiAoaXNOYW1lc3BhY2UpIHtcbiAgICAgICAgICBidWlsZGVyLnZhcihuYW1lIHx8IGltcG9ydGVkU291cmNlKS53aWxkY2FyZEludGVyb3AoKTtcbiAgICAgICAgfSBlbHNlIGlmICgoaXNEZWZhdWx0IHx8IGlzTmFtZWQpICYmIGVuc3VyZUxpdmVSZWZlcmVuY2UpIHtcbiAgICAgICAgICBpZiAoaXNEZWZhdWx0KSB7XG4gICAgICAgICAgICBuYW1lID0gbmFtZSAhPT0gXCJkZWZhdWx0XCIgPyBuYW1lIDogaW1wb3J0ZWRTb3VyY2U7XG4gICAgICAgICAgICBidWlsZGVyLnZhcihuYW1lKS5yZWFkKGltcG9ydE5hbWUpO1xuICAgICAgICAgICAgYnVpbGRlci5kZWZhdWx0SW50ZXJvcCgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBidWlsZGVyLnZhcihpbXBvcnRlZFNvdXJjZSkucmVhZChpbXBvcnROYW1lKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoaXNEZWZhdWx0KSB7XG4gICAgICAgICAgYnVpbGRlci52YXIobmFtZSkuZGVmYXVsdEludGVyb3AoKS5wcm9wKGltcG9ydE5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzTmFtZWQpIHtcbiAgICAgICAgICBidWlsZGVyLnZhcihuYW1lKS5wcm9wKGltcG9ydE5hbWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChpbXBvcnRlZEludGVyb3AgPT09IFwiY29tcGlsZWRcIikge1xuICAgICAgaWYgKGlzTW9kdWxlRm9yTm9kZSkge1xuICAgICAgICBidWlsZGVyLmltcG9ydCgpO1xuXG4gICAgICAgIGlmIChpc05hbWVzcGFjZSkge1xuICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChuYW1lIHx8IGltcG9ydGVkU291cmNlKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0RlZmF1bHQgfHwgaXNOYW1lZCkge1xuICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChpbXBvcnRlZFNvdXJjZSkucmVhZChuYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChpc01vZHVsZUZvckJhYmVsKSB7XG4gICAgICAgIGJ1aWxkZXIuaW1wb3J0KCk7XG5cbiAgICAgICAgaWYgKGlzTmFtZXNwYWNlKSB7XG4gICAgICAgICAgYnVpbGRlci5uYW1lc3BhY2UobmFtZSB8fCBpbXBvcnRlZFNvdXJjZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNEZWZhdWx0IHx8IGlzTmFtZWQpIHtcbiAgICAgICAgICBidWlsZGVyLm5hbWVkKG5hbWUsIGltcG9ydE5hbWUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBidWlsZGVyLnJlcXVpcmUoKTtcblxuICAgICAgICBpZiAoaXNOYW1lc3BhY2UpIHtcbiAgICAgICAgICBidWlsZGVyLnZhcihuYW1lIHx8IGltcG9ydGVkU291cmNlKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0RlZmF1bHQgfHwgaXNOYW1lZCkge1xuICAgICAgICAgIGlmIChlbnN1cmVMaXZlUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICBidWlsZGVyLnZhcihpbXBvcnRlZFNvdXJjZSkucmVhZChuYW1lKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnVpbGRlci5wcm9wKGltcG9ydE5hbWUpLnZhcihuYW1lKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGltcG9ydGVkSW50ZXJvcCA9PT0gXCJ1bmNvbXBpbGVkXCIpIHtcbiAgICAgIGlmIChpc0RlZmF1bHQgJiYgZW5zdXJlTGl2ZVJlZmVyZW5jZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyBsaXZlIHJlZmVyZW5jZSBmb3IgY29tbW9uanMgZGVmYXVsdFwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTW9kdWxlRm9yTm9kZSkge1xuICAgICAgICBidWlsZGVyLmltcG9ydCgpO1xuXG4gICAgICAgIGlmIChpc05hbWVzcGFjZSkge1xuICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChuYW1lIHx8IGltcG9ydGVkU291cmNlKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0RlZmF1bHQpIHtcbiAgICAgICAgICBidWlsZGVyLmRlZmF1bHQobmFtZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNOYW1lZCkge1xuICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChpbXBvcnRlZFNvdXJjZSkucmVhZChuYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChpc01vZHVsZUZvckJhYmVsKSB7XG4gICAgICAgIGJ1aWxkZXIuaW1wb3J0KCk7XG5cbiAgICAgICAgaWYgKGlzTmFtZXNwYWNlKSB7XG4gICAgICAgICAgYnVpbGRlci5kZWZhdWx0KG5hbWUgfHwgaW1wb3J0ZWRTb3VyY2UpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzRGVmYXVsdCkge1xuICAgICAgICAgIGJ1aWxkZXIuZGVmYXVsdChuYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc05hbWVkKSB7XG4gICAgICAgICAgYnVpbGRlci5uYW1lZChuYW1lLCBpbXBvcnROYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYnVpbGRlci5yZXF1aXJlKCk7XG5cbiAgICAgICAgaWYgKGlzTmFtZXNwYWNlKSB7XG4gICAgICAgICAgYnVpbGRlci52YXIobmFtZSB8fCBpbXBvcnRlZFNvdXJjZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNEZWZhdWx0KSB7XG4gICAgICAgICAgYnVpbGRlci52YXIobmFtZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXNOYW1lZCkge1xuICAgICAgICAgIGlmIChlbnN1cmVMaXZlUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICBidWlsZGVyLnZhcihpbXBvcnRlZFNvdXJjZSkucmVhZChuYW1lKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnVpbGRlci52YXIobmFtZSkucHJvcChpbXBvcnROYW1lKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGltcG9ydGVkSW50ZXJvcCBcIiR7aW1wb3J0ZWRJbnRlcm9wfVwiLmApO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIHN0YXRlbWVudHMsXG4gICAgICByZXN1bHROYW1lXG4gICAgfSA9IGJ1aWxkZXIuZG9uZSgpO1xuXG4gICAgdGhpcy5faW5zZXJ0U3RhdGVtZW50cyhzdGF0ZW1lbnRzLCBibG9ja0hvaXN0KTtcblxuICAgIGlmICgoaXNEZWZhdWx0IHx8IGlzTmFtZWQpICYmIGVuc3VyZU5vQ29udGV4dCAmJiByZXN1bHROYW1lLnR5cGUgIT09IFwiSWRlbnRpZmllclwiKSB7XG4gICAgICByZXR1cm4gdCgpLnNlcXVlbmNlRXhwcmVzc2lvbihbdCgpLm51bWVyaWNMaXRlcmFsKDApLCByZXN1bHROYW1lXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdE5hbWU7XG4gIH1cblxuICBfaW5zZXJ0U3RhdGVtZW50cyhzdGF0ZW1lbnRzLCBibG9ja0hvaXN0ID0gMykge1xuICAgIHN0YXRlbWVudHMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgIG5vZGUuX2Jsb2NrSG9pc3QgPSBibG9ja0hvaXN0O1xuICAgIH0pO1xuXG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHRoaXMuX3Byb2dyYW1QYXRoLmdldChcImJvZHlcIikuZmlsdGVyKHAgPT4ge1xuICAgICAgY29uc3QgdmFsID0gcC5ub2RlLl9ibG9ja0hvaXN0O1xuICAgICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZSh2YWwpICYmIHZhbCA8IDQ7XG4gICAgfSlbMF07XG5cbiAgICBpZiAodGFyZ2V0UGF0aCkge1xuICAgICAgdGFyZ2V0UGF0aC5pbnNlcnRCZWZvcmUoc3RhdGVtZW50cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3Byb2dyYW1QYXRoLnVuc2hpZnRDb250YWluZXIoXCJib2R5XCIsIHN0YXRlbWVudHMpO1xuICAgIH1cbiAgfVxuXG59XG5cbmV4cG9ydHMuZGVmYXVsdCA9IEltcG9ydEluamVjdG9yOyJdfQ==