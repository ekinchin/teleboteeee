"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

function _convertSourceMap() {
  const data = _interopRequireDefault(require("convert-source-map"));

  _convertSourceMap = function () {
    return data;
  };

  return data;
}

function _defaults() {
  const data = _interopRequireDefault(require("lodash/defaults"));

  _defaults = function () {
    return data;
  };

  return data;
}

function _sourceMap() {
  const data = _interopRequireDefault(require("source-map"));

  _sourceMap = function () {
    return data;
  };

  return data;
}

function _slash() {
  const data = _interopRequireDefault(require("slash"));

  _slash = function () {
    return data;
  };

  return data;
}

function _path() {
  const data = _interopRequireDefault(require("path"));

  _path = function () {
    return data;
  };

  return data;
}

function _fs() {
  const data = _interopRequireDefault(require("fs"));

  _fs = function () {
    return data;
  };

  return data;
}

var util = _interopRequireWildcard(require("./util"));

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg);
    var value = info.value;
  } catch (error) {
    reject(error);
    return;
  }

  if (info.done) {
    resolve(value);
  } else {
    Promise.resolve(value).then(_next, _throw);
  }
}

function _asyncToGenerator(fn) {
  return function () {
    var self = this,
        args = arguments;
    return new Promise(function (resolve, reject) {
      var gen = fn.apply(self, args);

      function _next(value) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
      }

      function _throw(err) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
      }

      _next(undefined);
    });
  };
}

function _default(_x) {
  return _ref.apply(this, arguments);
}

function _ref() {
  _ref = _asyncToGenerator(function* ({
    cliOptions,
    babelOptions
  }) {
    function buildResult(fileResults) {
      const map = new (_sourceMap().default.SourceMapGenerator)({
        file: cliOptions.sourceMapTarget || _path().default.basename(cliOptions.outFile || "") || "stdout",
        sourceRoot: babelOptions.sourceRoot
      });
      let code = "";
      let offset = 0;

      for (const result of fileResults) {
        if (!result) continue;
        code += result.code + "\n";

        if (result.map) {
          const consumer = new (_sourceMap().default.SourceMapConsumer)(result.map);
          const sources = new Set();
          consumer.eachMapping(function (mapping) {
            if (mapping.source != null) sources.add(mapping.source);
            map.addMapping({
              generated: {
                line: mapping.generatedLine + offset,
                column: mapping.generatedColumn
              },
              source: mapping.source,
              original: mapping.source == null ? null : {
                line: mapping.originalLine,
                column: mapping.originalColumn
              }
            });
          });
          sources.forEach(source => {
            const content = consumer.sourceContentFor(source, true);

            if (content !== null) {
              map.setSourceContent(source, content);
            }
          });
          offset = code.split("\n").length - 1;
        }
      }

      if (babelOptions.sourceMaps === "inline" || !cliOptions.outFile && babelOptions.sourceMaps) {
        code += "\n" + _convertSourceMap().default.fromObject(map).toComment();
      }

      return {
        map: map,
        code: code
      };
    }

    function output(fileResults) {
      const result = buildResult(fileResults);

      if (cliOptions.outFile) {
        if (babelOptions.sourceMaps && babelOptions.sourceMaps !== "inline") {
          const mapLoc = cliOptions.outFile + ".map";
          result.code = util.addSourceMappingUrl(result.code, mapLoc);

          _fs().default.writeFileSync(mapLoc, JSON.stringify(result.map));
        }

        _fs().default.writeFileSync(cliOptions.outFile, result.code);
      } else {
        process.stdout.write(result.code + "\n");
      }
    }

    function readStdin() {
      return new Promise((resolve, reject) => {
        let code = "";
        process.stdin.setEncoding("utf8");
        process.stdin.on("readable", function () {
          const chunk = process.stdin.read();
          if (chunk !== null) code += chunk;
        });
        process.stdin.on("end", function () {
          resolve(code);
        });
        process.stdin.on("error", reject);
      });
    }

    function stdin() {
      return _stdin.apply(this, arguments);
    }

    function _stdin() {
      _stdin = _asyncToGenerator(function* () {
        const code = yield readStdin();
        const res = yield util.transform(cliOptions.filename, code, (0, _defaults().default)({
          sourceFileName: "stdin"
        }, babelOptions));
        output([res]);
      });
      return _stdin.apply(this, arguments);
    }

    function walk(_x2) {
      return _walk.apply(this, arguments);
    }

    function _walk() {
      _walk = _asyncToGenerator(function* (filenames) {
        const _filenames = [];
        filenames.forEach(function (filename) {
          if (!_fs().default.existsSync(filename)) return;

          const stat = _fs().default.statSync(filename);

          if (stat.isDirectory()) {
            const dirname = filename;
            util.readdirForCompilable(filename, cliOptions.includeDotfiles).forEach(function (filename) {
              _filenames.push(_path().default.join(dirname, filename));
            });
          } else {
            _filenames.push(filename);
          }
        });
        const results = yield Promise.all(_filenames.map(function () {
          var _ref2 = _asyncToGenerator(function* (filename) {
            let sourceFilename = filename;

            if (cliOptions.outFile) {
              sourceFilename = _path().default.relative(_path().default.dirname(cliOptions.outFile), sourceFilename);
            }

            sourceFilename = (0, _slash().default)(sourceFilename);

            try {
              return yield util.compile(filename, (0, _defaults().default)({
                sourceFileName: sourceFilename,
                sourceMaps: babelOptions.sourceMaps === "inline" ? true : babelOptions.sourceMaps
              }, babelOptions));
            } catch (err) {
              if (!cliOptions.watch) {
                throw err;
              }

              console.error(err);
              return null;
            }
          });

          return function (_x4) {
            return _ref2.apply(this, arguments);
          };
        }()));
        output(results);
      });
      return _walk.apply(this, arguments);
    }

    function files(_x3) {
      return _files.apply(this, arguments);
    }

    function _files() {
      _files = _asyncToGenerator(function* (filenames) {
        if (!cliOptions.skipInitialBuild) {
          yield walk(filenames);
        }

        if (cliOptions.watch) {
          const chokidar = util.requireChokidar();
          chokidar.watch(filenames, {
            persistent: true,
            ignoreInitial: true,
            awaitWriteFinish: {
              stabilityThreshold: 50,
              pollInterval: 10
            }
          }).on("all", function (type, filename) {
            if (!util.isCompilableExtension(filename, cliOptions.extensions)) {
              return;
            }

            if (type === "add" || type === "change") {
              if (cliOptions.verbose) {
                console.log(type + " " + filename);
              }

              walk(filenames).catch(err => {
                console.error(err);
              });
            }
          });
        }
      });
      return _files.apply(this, arguments);
    }

    if (cliOptions.filenames.length) {
      yield files(cliOptions.filenames);
    } else {
      yield stdin();
    }
  });
  return _ref.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY2xpL2xpYi9iYWJlbC9maWxlLmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVmYXVsdCIsIl9kZWZhdWx0IiwiX2NvbnZlcnRTb3VyY2VNYXAiLCJkYXRhIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZGVmYXVsdHMiLCJfc291cmNlTWFwIiwiX3NsYXNoIiwiX3BhdGgiLCJfZnMiLCJ1dGlsIiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImdldCIsInNldCIsImFzeW5jR2VuZXJhdG9yU3RlcCIsImdlbiIsInJlc29sdmUiLCJyZWplY3QiLCJfbmV4dCIsIl90aHJvdyIsImFyZyIsImluZm8iLCJlcnJvciIsImRvbmUiLCJQcm9taXNlIiwidGhlbiIsIl9hc3luY1RvR2VuZXJhdG9yIiwiZm4iLCJzZWxmIiwiYXJncyIsImFyZ3VtZW50cyIsImFwcGx5IiwiZXJyIiwidW5kZWZpbmVkIiwiX3giLCJfcmVmIiwiY2xpT3B0aW9ucyIsImJhYmVsT3B0aW9ucyIsImJ1aWxkUmVzdWx0IiwiZmlsZVJlc3VsdHMiLCJtYXAiLCJTb3VyY2VNYXBHZW5lcmF0b3IiLCJmaWxlIiwic291cmNlTWFwVGFyZ2V0IiwiYmFzZW5hbWUiLCJvdXRGaWxlIiwic291cmNlUm9vdCIsImNvZGUiLCJvZmZzZXQiLCJyZXN1bHQiLCJjb25zdW1lciIsIlNvdXJjZU1hcENvbnN1bWVyIiwic291cmNlcyIsIlNldCIsImVhY2hNYXBwaW5nIiwibWFwcGluZyIsInNvdXJjZSIsImFkZCIsImFkZE1hcHBpbmciLCJnZW5lcmF0ZWQiLCJsaW5lIiwiZ2VuZXJhdGVkTGluZSIsImNvbHVtbiIsImdlbmVyYXRlZENvbHVtbiIsIm9yaWdpbmFsIiwib3JpZ2luYWxMaW5lIiwib3JpZ2luYWxDb2x1bW4iLCJmb3JFYWNoIiwiY29udGVudCIsInNvdXJjZUNvbnRlbnRGb3IiLCJzZXRTb3VyY2VDb250ZW50Iiwic3BsaXQiLCJsZW5ndGgiLCJzb3VyY2VNYXBzIiwiZnJvbU9iamVjdCIsInRvQ29tbWVudCIsIm91dHB1dCIsIm1hcExvYyIsImFkZFNvdXJjZU1hcHBpbmdVcmwiLCJ3cml0ZUZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsInByb2Nlc3MiLCJzdGRvdXQiLCJ3cml0ZSIsInJlYWRTdGRpbiIsInN0ZGluIiwic2V0RW5jb2RpbmciLCJvbiIsImNodW5rIiwicmVhZCIsIl9zdGRpbiIsInJlcyIsInRyYW5zZm9ybSIsImZpbGVuYW1lIiwic291cmNlRmlsZU5hbWUiLCJ3YWxrIiwiX3gyIiwiX3dhbGsiLCJmaWxlbmFtZXMiLCJfZmlsZW5hbWVzIiwiZXhpc3RzU3luYyIsInN0YXQiLCJzdGF0U3luYyIsImlzRGlyZWN0b3J5IiwiZGlybmFtZSIsInJlYWRkaXJGb3JDb21waWxhYmxlIiwiaW5jbHVkZURvdGZpbGVzIiwicHVzaCIsImpvaW4iLCJyZXN1bHRzIiwiYWxsIiwiX3JlZjIiLCJzb3VyY2VGaWxlbmFtZSIsInJlbGF0aXZlIiwiY29tcGlsZSIsIndhdGNoIiwiY29uc29sZSIsIl94NCIsImZpbGVzIiwiX3gzIiwiX2ZpbGVzIiwic2tpcEluaXRpYWxCdWlsZCIsImNob2tpZGFyIiwicmVxdWlyZUNob2tpZGFyIiwicGVyc2lzdGVudCIsImlnbm9yZUluaXRpYWwiLCJhd2FpdFdyaXRlRmluaXNoIiwic3RhYmlsaXR5VGhyZXNob2xkIiwicG9sbEludGVydmFsIiwidHlwZSIsImlzQ29tcGlsYWJsZUV4dGVuc2lvbiIsImV4dGVuc2lvbnMiLCJ2ZXJib3NlIiwibG9nIiwiY2F0Y2giXSwibWFwcGluZ3MiOiJBQUFBOztBQUVB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IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7XG5cbmZ1bmN0aW9uIF9jb252ZXJ0U291cmNlTWFwKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiY29udmVydC1zb3VyY2UtbWFwXCIpKTtcblxuICBfY29udmVydFNvdXJjZU1hcCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX2RlZmF1bHRzKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwibG9kYXNoL2RlZmF1bHRzXCIpKTtcblxuICBfZGVmYXVsdHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9zb3VyY2VNYXAoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJzb3VyY2UtbWFwXCIpKTtcblxuICBfc291cmNlTWFwID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfc2xhc2goKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJzbGFzaFwiKSk7XG5cbiAgX3NsYXNoID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfcGF0aCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcInBhdGhcIikpO1xuXG4gIF9wYXRoID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfZnMoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJmc1wiKSk7XG5cbiAgX2ZzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG52YXIgdXRpbCA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCIuL3V0aWxcIikpO1xuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGVsc2UgeyB2YXIgbmV3T2JqID0ge307IGlmIChvYmogIT0gbnVsbCkgeyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KSA6IHt9OyBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iaiwga2V5LCBkZXNjKTsgfSBlbHNlIHsgbmV3T2JqW2tleV0gPSBvYmpba2V5XTsgfSB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgcmV0dXJuIG5ld09iajsgfSB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywga2V5LCBhcmcpIHsgdHJ5IHsgdmFyIGluZm8gPSBnZW5ba2V5XShhcmcpOyB2YXIgdmFsdWUgPSBpbmZvLnZhbHVlOyB9IGNhdGNoIChlcnJvcikgeyByZWplY3QoZXJyb3IpOyByZXR1cm47IH0gaWYgKGluZm8uZG9uZSkgeyByZXNvbHZlKHZhbHVlKTsgfSBlbHNlIHsgUHJvbWlzZS5yZXNvbHZlKHZhbHVlKS50aGVuKF9uZXh0LCBfdGhyb3cpOyB9IH1cblxuZnVuY3Rpb24gX2FzeW5jVG9HZW5lcmF0b3IoZm4pIHsgcmV0dXJuIGZ1bmN0aW9uICgpIHsgdmFyIHNlbGYgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOyByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyB2YXIgZ2VuID0gZm4uYXBwbHkoc2VsZiwgYXJncyk7IGZ1bmN0aW9uIF9uZXh0KHZhbHVlKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgXCJuZXh0XCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgXCJ0aHJvd1wiLCBlcnIpOyB9IF9uZXh0KHVuZGVmaW5lZCk7IH0pOyB9OyB9XG5cbmZ1bmN0aW9uIF9kZWZhdWx0KF94KSB7XG4gIHJldHVybiBfcmVmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG59XG5cbmZ1bmN0aW9uIF9yZWYoKSB7XG4gIF9yZWYgPSBfYXN5bmNUb0dlbmVyYXRvcihmdW5jdGlvbiogKHtcbiAgICBjbGlPcHRpb25zLFxuICAgIGJhYmVsT3B0aW9uc1xuICB9KSB7XG4gICAgZnVuY3Rpb24gYnVpbGRSZXN1bHQoZmlsZVJlc3VsdHMpIHtcbiAgICAgIGNvbnN0IG1hcCA9IG5ldyAoX3NvdXJjZU1hcCgpLmRlZmF1bHQuU291cmNlTWFwR2VuZXJhdG9yKSh7XG4gICAgICAgIGZpbGU6IGNsaU9wdGlvbnMuc291cmNlTWFwVGFyZ2V0IHx8IF9wYXRoKCkuZGVmYXVsdC5iYXNlbmFtZShjbGlPcHRpb25zLm91dEZpbGUgfHwgXCJcIikgfHwgXCJzdGRvdXRcIixcbiAgICAgICAgc291cmNlUm9vdDogYmFiZWxPcHRpb25zLnNvdXJjZVJvb3RcbiAgICAgIH0pO1xuICAgICAgbGV0IGNvZGUgPSBcIlwiO1xuICAgICAgbGV0IG9mZnNldCA9IDA7XG5cbiAgICAgIGZvciAoY29uc3QgcmVzdWx0IG9mIGZpbGVSZXN1bHRzKSB7XG4gICAgICAgIGlmICghcmVzdWx0KSBjb250aW51ZTtcbiAgICAgICAgY29kZSArPSByZXN1bHQuY29kZSArIFwiXFxuXCI7XG5cbiAgICAgICAgaWYgKHJlc3VsdC5tYXApIHtcbiAgICAgICAgICBjb25zdCBjb25zdW1lciA9IG5ldyAoX3NvdXJjZU1hcCgpLmRlZmF1bHQuU291cmNlTWFwQ29uc3VtZXIpKHJlc3VsdC5tYXApO1xuICAgICAgICAgIGNvbnN0IHNvdXJjZXMgPSBuZXcgU2V0KCk7XG4gICAgICAgICAgY29uc3VtZXIuZWFjaE1hcHBpbmcoZnVuY3Rpb24gKG1hcHBpbmcpIHtcbiAgICAgICAgICAgIGlmIChtYXBwaW5nLnNvdXJjZSAhPSBudWxsKSBzb3VyY2VzLmFkZChtYXBwaW5nLnNvdXJjZSk7XG4gICAgICAgICAgICBtYXAuYWRkTWFwcGluZyh7XG4gICAgICAgICAgICAgIGdlbmVyYXRlZDoge1xuICAgICAgICAgICAgICAgIGxpbmU6IG1hcHBpbmcuZ2VuZXJhdGVkTGluZSArIG9mZnNldCxcbiAgICAgICAgICAgICAgICBjb2x1bW46IG1hcHBpbmcuZ2VuZXJhdGVkQ29sdW1uXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHNvdXJjZTogbWFwcGluZy5zb3VyY2UsXG4gICAgICAgICAgICAgIG9yaWdpbmFsOiBtYXBwaW5nLnNvdXJjZSA9PSBudWxsID8gbnVsbCA6IHtcbiAgICAgICAgICAgICAgICBsaW5lOiBtYXBwaW5nLm9yaWdpbmFsTGluZSxcbiAgICAgICAgICAgICAgICBjb2x1bW46IG1hcHBpbmcub3JpZ2luYWxDb2x1bW5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgc291cmNlcy5mb3JFYWNoKHNvdXJjZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gY29uc3VtZXIuc291cmNlQ29udGVudEZvcihzb3VyY2UsIHRydWUpO1xuXG4gICAgICAgICAgICBpZiAoY29udGVudCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICBtYXAuc2V0U291cmNlQ29udGVudChzb3VyY2UsIGNvbnRlbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIG9mZnNldCA9IGNvZGUuc3BsaXQoXCJcXG5cIikubGVuZ3RoIC0gMTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoYmFiZWxPcHRpb25zLnNvdXJjZU1hcHMgPT09IFwiaW5saW5lXCIgfHwgIWNsaU9wdGlvbnMub3V0RmlsZSAmJiBiYWJlbE9wdGlvbnMuc291cmNlTWFwcykge1xuICAgICAgICBjb2RlICs9IFwiXFxuXCIgKyBfY29udmVydFNvdXJjZU1hcCgpLmRlZmF1bHQuZnJvbU9iamVjdChtYXApLnRvQ29tbWVudCgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBtYXA6IG1hcCxcbiAgICAgICAgY29kZTogY29kZVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBvdXRwdXQoZmlsZVJlc3VsdHMpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1aWxkUmVzdWx0KGZpbGVSZXN1bHRzKTtcblxuICAgICAgaWYgKGNsaU9wdGlvbnMub3V0RmlsZSkge1xuICAgICAgICBpZiAoYmFiZWxPcHRpb25zLnNvdXJjZU1hcHMgJiYgYmFiZWxPcHRpb25zLnNvdXJjZU1hcHMgIT09IFwiaW5saW5lXCIpIHtcbiAgICAgICAgICBjb25zdCBtYXBMb2MgPSBjbGlPcHRpb25zLm91dEZpbGUgKyBcIi5tYXBcIjtcbiAgICAgICAgICByZXN1bHQuY29kZSA9IHV0aWwuYWRkU291cmNlTWFwcGluZ1VybChyZXN1bHQuY29kZSwgbWFwTG9jKTtcblxuICAgICAgICAgIF9mcygpLmRlZmF1bHQud3JpdGVGaWxlU3luYyhtYXBMb2MsIEpTT04uc3RyaW5naWZ5KHJlc3VsdC5tYXApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIF9mcygpLmRlZmF1bHQud3JpdGVGaWxlU3luYyhjbGlPcHRpb25zLm91dEZpbGUsIHJlc3VsdC5jb2RlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKHJlc3VsdC5jb2RlICsgXCJcXG5cIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcmVhZFN0ZGluKCkge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgbGV0IGNvZGUgPSBcIlwiO1xuICAgICAgICBwcm9jZXNzLnN0ZGluLnNldEVuY29kaW5nKFwidXRmOFwiKTtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5vbihcInJlYWRhYmxlXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBjb25zdCBjaHVuayA9IHByb2Nlc3Muc3RkaW4ucmVhZCgpO1xuICAgICAgICAgIGlmIChjaHVuayAhPT0gbnVsbCkgY29kZSArPSBjaHVuaztcbiAgICAgICAgfSk7XG4gICAgICAgIHByb2Nlc3Muc3RkaW4ub24oXCJlbmRcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHJlc29sdmUoY29kZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBwcm9jZXNzLnN0ZGluLm9uKFwiZXJyb3JcIiwgcmVqZWN0KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHN0ZGluKCkge1xuICAgICAgcmV0dXJuIF9zdGRpbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIF9zdGRpbigpIHtcbiAgICAgIF9zdGRpbiA9IF9hc3luY1RvR2VuZXJhdG9yKGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgIGNvbnN0IGNvZGUgPSB5aWVsZCByZWFkU3RkaW4oKTtcbiAgICAgICAgY29uc3QgcmVzID0geWllbGQgdXRpbC50cmFuc2Zvcm0oY2xpT3B0aW9ucy5maWxlbmFtZSwgY29kZSwgKDAsIF9kZWZhdWx0cygpLmRlZmF1bHQpKHtcbiAgICAgICAgICBzb3VyY2VGaWxlTmFtZTogXCJzdGRpblwiXG4gICAgICAgIH0sIGJhYmVsT3B0aW9ucykpO1xuICAgICAgICBvdXRwdXQoW3Jlc10pO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gX3N0ZGluLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gd2FsayhfeDIpIHtcbiAgICAgIHJldHVybiBfd2Fsay5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIF93YWxrKCkge1xuICAgICAgX3dhbGsgPSBfYXN5bmNUb0dlbmVyYXRvcihmdW5jdGlvbiogKGZpbGVuYW1lcykge1xuICAgICAgICBjb25zdCBfZmlsZW5hbWVzID0gW107XG4gICAgICAgIGZpbGVuYW1lcy5mb3JFYWNoKGZ1bmN0aW9uIChmaWxlbmFtZSkge1xuICAgICAgICAgIGlmICghX2ZzKCkuZGVmYXVsdC5leGlzdHNTeW5jKGZpbGVuYW1lKSkgcmV0dXJuO1xuXG4gICAgICAgICAgY29uc3Qgc3RhdCA9IF9mcygpLmRlZmF1bHQuc3RhdFN5bmMoZmlsZW5hbWUpO1xuXG4gICAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgY29uc3QgZGlybmFtZSA9IGZpbGVuYW1lO1xuICAgICAgICAgICAgdXRpbC5yZWFkZGlyRm9yQ29tcGlsYWJsZShmaWxlbmFtZSwgY2xpT3B0aW9ucy5pbmNsdWRlRG90ZmlsZXMpLmZvckVhY2goZnVuY3Rpb24gKGZpbGVuYW1lKSB7XG4gICAgICAgICAgICAgIF9maWxlbmFtZXMucHVzaChfcGF0aCgpLmRlZmF1bHQuam9pbihkaXJuYW1lLCBmaWxlbmFtZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIF9maWxlbmFtZXMucHVzaChmaWxlbmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHlpZWxkIFByb21pc2UuYWxsKF9maWxlbmFtZXMubWFwKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB2YXIgX3JlZjIgPSBfYXN5bmNUb0dlbmVyYXRvcihmdW5jdGlvbiogKGZpbGVuYW1lKSB7XG4gICAgICAgICAgICBsZXQgc291cmNlRmlsZW5hbWUgPSBmaWxlbmFtZTtcblxuICAgICAgICAgICAgaWYgKGNsaU9wdGlvbnMub3V0RmlsZSkge1xuICAgICAgICAgICAgICBzb3VyY2VGaWxlbmFtZSA9IF9wYXRoKCkuZGVmYXVsdC5yZWxhdGl2ZShfcGF0aCgpLmRlZmF1bHQuZGlybmFtZShjbGlPcHRpb25zLm91dEZpbGUpLCBzb3VyY2VGaWxlbmFtZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNvdXJjZUZpbGVuYW1lID0gKDAsIF9zbGFzaCgpLmRlZmF1bHQpKHNvdXJjZUZpbGVuYW1lKTtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHV0aWwuY29tcGlsZShmaWxlbmFtZSwgKDAsIF9kZWZhdWx0cygpLmRlZmF1bHQpKHtcbiAgICAgICAgICAgICAgICBzb3VyY2VGaWxlTmFtZTogc291cmNlRmlsZW5hbWUsXG4gICAgICAgICAgICAgICAgc291cmNlTWFwczogYmFiZWxPcHRpb25zLnNvdXJjZU1hcHMgPT09IFwiaW5saW5lXCIgPyB0cnVlIDogYmFiZWxPcHRpb25zLnNvdXJjZU1hcHNcbiAgICAgICAgICAgICAgfSwgYmFiZWxPcHRpb25zKSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgaWYgKCFjbGlPcHRpb25zLndhdGNoKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3g0KSB7XG4gICAgICAgICAgICByZXR1cm4gX3JlZjIuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9KCkpKTtcbiAgICAgICAgb3V0cHV0KHJlc3VsdHMpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gX3dhbGsuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBmaWxlcyhfeDMpIHtcbiAgICAgIHJldHVybiBfZmlsZXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBfZmlsZXMoKSB7XG4gICAgICBfZmlsZXMgPSBfYXN5bmNUb0dlbmVyYXRvcihmdW5jdGlvbiogKGZpbGVuYW1lcykge1xuICAgICAgICBpZiAoIWNsaU9wdGlvbnMuc2tpcEluaXRpYWxCdWlsZCkge1xuICAgICAgICAgIHlpZWxkIHdhbGsoZmlsZW5hbWVzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjbGlPcHRpb25zLndhdGNoKSB7XG4gICAgICAgICAgY29uc3QgY2hva2lkYXIgPSB1dGlsLnJlcXVpcmVDaG9raWRhcigpO1xuICAgICAgICAgIGNob2tpZGFyLndhdGNoKGZpbGVuYW1lcywge1xuICAgICAgICAgICAgcGVyc2lzdGVudDogdHJ1ZSxcbiAgICAgICAgICAgIGlnbm9yZUluaXRpYWw6IHRydWUsXG4gICAgICAgICAgICBhd2FpdFdyaXRlRmluaXNoOiB7XG4gICAgICAgICAgICAgIHN0YWJpbGl0eVRocmVzaG9sZDogNTAsXG4gICAgICAgICAgICAgIHBvbGxJbnRlcnZhbDogMTBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KS5vbihcImFsbFwiLCBmdW5jdGlvbiAodHlwZSwgZmlsZW5hbWUpIHtcbiAgICAgICAgICAgIGlmICghdXRpbC5pc0NvbXBpbGFibGVFeHRlbnNpb24oZmlsZW5hbWUsIGNsaU9wdGlvbnMuZXh0ZW5zaW9ucykpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gXCJhZGRcIiB8fCB0eXBlID09PSBcImNoYW5nZVwiKSB7XG4gICAgICAgICAgICAgIGlmIChjbGlPcHRpb25zLnZlcmJvc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0eXBlICsgXCIgXCIgKyBmaWxlbmFtZSk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICB3YWxrKGZpbGVuYW1lcykuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBfZmlsZXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBpZiAoY2xpT3B0aW9ucy5maWxlbmFtZXMubGVuZ3RoKSB7XG4gICAgICB5aWVsZCBmaWxlcyhjbGlPcHRpb25zLmZpbGVuYW1lcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHlpZWxkIHN0ZGluKCk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIF9yZWYuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn0iXX0=