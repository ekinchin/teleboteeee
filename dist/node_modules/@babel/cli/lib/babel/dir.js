"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

function _defaults() {
  const data = _interopRequireDefault(require("lodash/defaults"));

  _defaults = function () {
    return data;
  };

  return data;
}

function _outputFileSync() {
  const data = _interopRequireDefault(require("output-file-sync"));

  _outputFileSync = function () {
    return data;
  };

  return data;
}

function _mkdirp() {
  const data = require("mkdirp");

  _mkdirp = function () {
    return data;
  };

  return data;
}

function _slash() {
  const data = _interopRequireDefault(require("slash"));

  _slash = function () {
    return data;
  };

  return data;
}

function _path() {
  const data = _interopRequireDefault(require("path"));

  _path = function () {
    return data;
  };

  return data;
}

function _fs() {
  const data = _interopRequireDefault(require("fs"));

  _fs = function () {
    return data;
  };

  return data;
}

var util = _interopRequireWildcard(require("./util"));

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
  try {
    var info = gen[key](arg);
    var value = info.value;
  } catch (error) {
    reject(error);
    return;
  }

  if (info.done) {
    resolve(value);
  } else {
    Promise.resolve(value).then(_next, _throw);
  }
}

function _asyncToGenerator(fn) {
  return function () {
    var self = this,
        args = arguments;
    return new Promise(function (resolve, reject) {
      var gen = fn.apply(self, args);

      function _next(value) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
      }

      function _throw(err) {
        asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
      }

      _next(undefined);
    });
  };
}

function _default(_x) {
  return _ref.apply(this, arguments);
}

function _ref() {
  _ref = _asyncToGenerator(function* ({
    cliOptions,
    babelOptions
  }) {
    const filenames = cliOptions.filenames;

    function write(_x2, _x3) {
      return _write.apply(this, arguments);
    }

    function _write() {
      _write = _asyncToGenerator(function* (src, base) {
        let relative = _path().default.relative(base, src);

        if (!util.isCompilableExtension(relative, cliOptions.extensions)) {
          return false;
        }

        relative = util.adjustRelative(relative, cliOptions.keepFileExtension);
        const dest = getDest(relative, base);

        try {
          const res = yield util.compile(src, (0, _defaults().default)({
            sourceFileName: (0, _slash().default)(_path().default.relative(dest + "/..", src))
          }, babelOptions));
          if (!res) return false;

          if (res.map && babelOptions.sourceMaps && babelOptions.sourceMaps !== "inline") {
            const mapLoc = dest + ".map";
            res.code = util.addSourceMappingUrl(res.code, mapLoc);
            res.map.file = _path().default.basename(relative);
            (0, _outputFileSync().default)(mapLoc, JSON.stringify(res.map));
          }

          (0, _outputFileSync().default)(dest, res.code);
          util.chmod(src, dest);

          if (cliOptions.verbose) {
            console.log(src + " -> " + dest);
          }

          return true;
        } catch (err) {
          if (cliOptions.watch) {
            console.error(err);
            return false;
          }

          throw err;
        }
      });
      return _write.apply(this, arguments);
    }

    function getDest(filename, base) {
      if (cliOptions.relative) {
        return _path().default.join(base, cliOptions.outDir, filename);
      }

      return _path().default.join(cliOptions.outDir, filename);
    }

    function handleFile(_x4, _x5) {
      return _handleFile.apply(this, arguments);
    }

    function _handleFile() {
      _handleFile = _asyncToGenerator(function* (src, base) {
        const written = yield write(src, base);

        if (!written && cliOptions.copyFiles) {
          const filename = _path().default.relative(base, src);

          const dest = getDest(filename, base);
          (0, _outputFileSync().default)(dest, _fs().default.readFileSync(src));
          util.chmod(src, dest);
        }

        return written;
      });
      return _handleFile.apply(this, arguments);
    }

    function handle(_x6) {
      return _handle.apply(this, arguments);
    }

    function _handle() {
      _handle = _asyncToGenerator(function* (filenameOrDir) {
        if (!_fs().default.existsSync(filenameOrDir)) return 0;

        const stat = _fs().default.statSync(filenameOrDir);

        if (stat.isDirectory()) {
          const dirname = filenameOrDir;
          let count = 0;
          const files = util.readdir(dirname, cliOptions.includeDotfiles);

          for (const filename of files) {
            const src = _path().default.join(dirname, filename);

            const written = yield handleFile(src, dirname);
            if (written) count += 1;
          }

          return count;
        } else {
          const filename = filenameOrDir;
          const written = yield handleFile(filename, _path().default.dirname(filename));
          return written ? 1 : 0;
        }
      });
      return _handle.apply(this, arguments);
    }

    if (!cliOptions.skipInitialBuild) {
      if (cliOptions.deleteDirOnStart) {
        util.deleteDir(cliOptions.outDir);
      }

      (0, _mkdirp().sync)(cliOptions.outDir);
      let compiledFiles = 0;

      for (const filename of cliOptions.filenames) {
        compiledFiles += yield handle(filename);
      }

      console.log(`Successfully compiled ${compiledFiles} ${compiledFiles !== 1 ? "files" : "file"} with Babel.`);
    }

    if (cliOptions.watch) {
      const chokidar = util.requireChokidar();
      filenames.forEach(function (filenameOrDir) {
        const watcher = chokidar.watch(filenameOrDir, {
          persistent: true,
          ignoreInitial: true,
          awaitWriteFinish: {
            stabilityThreshold: 50,
            pollInterval: 10
          }
        });
        ["add", "change"].forEach(function (type) {
          watcher.on(type, function (filename) {
            handleFile(filename, filename === filenameOrDir ? _path().default.dirname(filenameOrDir) : filenameOrDir).catch(err => {
              console.error(err);
            });
          });
        });
      });
    }
  });
  return _ref.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY2xpL2xpYi9iYWJlbC9kaXIuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0IiwiX2RlZmF1bHQiLCJfZGVmYXVsdHMiLCJkYXRhIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfb3V0cHV0RmlsZVN5bmMiLCJfbWtkaXJwIiwiX3NsYXNoIiwiX3BhdGgiLCJfZnMiLCJ1dGlsIiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImdldCIsInNldCIsImFzeW5jR2VuZXJhdG9yU3RlcCIsImdlbiIsInJlc29sdmUiLCJyZWplY3QiLCJfbmV4dCIsIl90aHJvdyIsImFyZyIsImluZm8iLCJlcnJvciIsImRvbmUiLCJQcm9taXNlIiwidGhlbiIsIl9hc3luY1RvR2VuZXJhdG9yIiwiZm4iLCJzZWxmIiwiYXJncyIsImFyZ3VtZW50cyIsImFwcGx5IiwiZXJyIiwidW5kZWZpbmVkIiwiX3giLCJfcmVmIiwiY2xpT3B0aW9ucyIsImJhYmVsT3B0aW9ucyIsImZpbGVuYW1lcyIsIndyaXRlIiwiX3gyIiwiX3gzIiwiX3dyaXRlIiwic3JjIiwiYmFzZSIsInJlbGF0aXZlIiwiaXNDb21waWxhYmxlRXh0ZW5zaW9uIiwiZXh0ZW5zaW9ucyIsImFkanVzdFJlbGF0aXZlIiwia2VlcEZpbGVFeHRlbnNpb24iLCJkZXN0IiwiZ2V0RGVzdCIsInJlcyIsImNvbXBpbGUiLCJzb3VyY2VGaWxlTmFtZSIsIm1hcCIsInNvdXJjZU1hcHMiLCJtYXBMb2MiLCJjb2RlIiwiYWRkU291cmNlTWFwcGluZ1VybCIsImZpbGUiLCJiYXNlbmFtZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJjaG1vZCIsInZlcmJvc2UiLCJjb25zb2xlIiwibG9nIiwid2F0Y2giLCJmaWxlbmFtZSIsImpvaW4iLCJvdXREaXIiLCJoYW5kbGVGaWxlIiwiX3g0IiwiX3g1IiwiX2hhbmRsZUZpbGUiLCJ3cml0dGVuIiwiY29weUZpbGVzIiwicmVhZEZpbGVTeW5jIiwiaGFuZGxlIiwiX3g2IiwiX2hhbmRsZSIsImZpbGVuYW1lT3JEaXIiLCJleGlzdHNTeW5jIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJkaXJuYW1lIiwiY291bnQiLCJmaWxlcyIsInJlYWRkaXIiLCJpbmNsdWRlRG90ZmlsZXMiLCJza2lwSW5pdGlhbEJ1aWxkIiwiZGVsZXRlRGlyT25TdGFydCIsImRlbGV0ZURpciIsInN5bmMiLCJjb21waWxlZEZpbGVzIiwiY2hva2lkYXIiLCJyZXF1aXJlQ2hva2lkYXIiLCJmb3JFYWNoIiwid2F0Y2hlciIsInBlcnNpc3RlbnQiLCJpZ25vcmVJbml0aWFsIiwiYXdhaXRXcml0ZUZpbmlzaCIsInN0YWJpbGl0eVRocmVzaG9sZCIsInBvbGxJbnRlcnZhbCIsInR5cGUiLCJvbiIsImNhdGNoIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFrQkMsUUFBbEI7O0FBRUEsU0FBU0MsU0FBVCxHQUFxQjtBQUNuQixRQUFNQyxJQUFJLEdBQUdDLHNCQUFzQixDQUFDQyxPQUFPLENBQUMsaUJBQUQsQ0FBUixDQUFuQzs7QUFFQUgsRUFBQUEsU0FBUyxHQUFHLFlBQVk7QUFDdEIsV0FBT0MsSUFBUDtBQUNELEdBRkQ7O0FBSUEsU0FBT0EsSUFBUDtBQUNEOztBQUVELFNBQVNHLGVBQVQsR0FBMkI7QUFDekIsUUFBTUgsSUFBSSxHQUFHQyxzQkFBc0IsQ0FBQ0MsT0FB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T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0O1xuXG5mdW5jdGlvbiBfZGVmYXVsdHMoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJsb2Rhc2gvZGVmYXVsdHNcIikpO1xuXG4gIF9kZWZhdWx0cyA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX291dHB1dEZpbGVTeW5jKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwib3V0cHV0LWZpbGUtc3luY1wiKSk7XG5cbiAgX291dHB1dEZpbGVTeW5jID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfbWtkaXJwKCkge1xuICBjb25zdCBkYXRhID0gcmVxdWlyZShcIm1rZGlycFwiKTtcblxuICBfbWtkaXJwID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfc2xhc2goKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJzbGFzaFwiKSk7XG5cbiAgX3NsYXNoID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfcGF0aCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcInBhdGhcIikpO1xuXG4gIF9wYXRoID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfZnMoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJmc1wiKSk7XG5cbiAgX2ZzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG52YXIgdXRpbCA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCIuL3V0aWxcIikpO1xuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGVsc2UgeyB2YXIgbmV3T2JqID0ge307IGlmIChvYmogIT0gbnVsbCkgeyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KSA6IHt9OyBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iaiwga2V5LCBkZXNjKTsgfSBlbHNlIHsgbmV3T2JqW2tleV0gPSBvYmpba2V5XTsgfSB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgcmV0dXJuIG5ld09iajsgfSB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywga2V5LCBhcmcpIHsgdHJ5IHsgdmFyIGluZm8gPSBnZW5ba2V5XShhcmcpOyB2YXIgdmFsdWUgPSBpbmZvLnZhbHVlOyB9IGNhdGNoIChlcnJvcikgeyByZWplY3QoZXJyb3IpOyByZXR1cm47IH0gaWYgKGluZm8uZG9uZSkgeyByZXNvbHZlKHZhbHVlKTsgfSBlbHNlIHsgUHJvbWlzZS5yZXNvbHZlKHZhbHVlKS50aGVuKF9uZXh0LCBfdGhyb3cpOyB9IH1cblxuZnVuY3Rpb24gX2FzeW5jVG9HZW5lcmF0b3IoZm4pIHsgcmV0dXJuIGZ1bmN0aW9uICgpIHsgdmFyIHNlbGYgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOyByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyB2YXIgZ2VuID0gZm4uYXBwbHkoc2VsZiwgYXJncyk7IGZ1bmN0aW9uIF9uZXh0KHZhbHVlKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgXCJuZXh0XCIsIHZhbHVlKTsgfSBmdW5jdGlvbiBfdGhyb3coZXJyKSB7IGFzeW5jR2VuZXJhdG9yU3RlcChnZW4sIHJlc29sdmUsIHJlamVjdCwgX25leHQsIF90aHJvdywgXCJ0aHJvd1wiLCBlcnIpOyB9IF9uZXh0KHVuZGVmaW5lZCk7IH0pOyB9OyB9XG5cbmZ1bmN0aW9uIF9kZWZhdWx0KF94KSB7XG4gIHJldHVybiBfcmVmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG59XG5cbmZ1bmN0aW9uIF9yZWYoKSB7XG4gIF9yZWYgPSBfYXN5bmNUb0dlbmVyYXRvcihmdW5jdGlvbiogKHtcbiAgICBjbGlPcHRpb25zLFxuICAgIGJhYmVsT3B0aW9uc1xuICB9KSB7XG4gICAgY29uc3QgZmlsZW5hbWVzID0gY2xpT3B0aW9ucy5maWxlbmFtZXM7XG5cbiAgICBmdW5jdGlvbiB3cml0ZShfeDIsIF94Mykge1xuICAgICAgcmV0dXJuIF93cml0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIF93cml0ZSgpIHtcbiAgICAgIF93cml0ZSA9IF9hc3luY1RvR2VuZXJhdG9yKGZ1bmN0aW9uKiAoc3JjLCBiYXNlKSB7XG4gICAgICAgIGxldCByZWxhdGl2ZSA9IF9wYXRoKCkuZGVmYXVsdC5yZWxhdGl2ZShiYXNlLCBzcmMpO1xuXG4gICAgICAgIGlmICghdXRpbC5pc0NvbXBpbGFibGVFeHRlbnNpb24ocmVsYXRpdmUsIGNsaU9wdGlvbnMuZXh0ZW5zaW9ucykpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZWxhdGl2ZSA9IHV0aWwuYWRqdXN0UmVsYXRpdmUocmVsYXRpdmUsIGNsaU9wdGlvbnMua2VlcEZpbGVFeHRlbnNpb24pO1xuICAgICAgICBjb25zdCBkZXN0ID0gZ2V0RGVzdChyZWxhdGl2ZSwgYmFzZSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXMgPSB5aWVsZCB1dGlsLmNvbXBpbGUoc3JjLCAoMCwgX2RlZmF1bHRzKCkuZGVmYXVsdCkoe1xuICAgICAgICAgICAgc291cmNlRmlsZU5hbWU6ICgwLCBfc2xhc2goKS5kZWZhdWx0KShfcGF0aCgpLmRlZmF1bHQucmVsYXRpdmUoZGVzdCArIFwiLy4uXCIsIHNyYykpXG4gICAgICAgICAgfSwgYmFiZWxPcHRpb25zKSk7XG4gICAgICAgICAgaWYgKCFyZXMpIHJldHVybiBmYWxzZTtcblxuICAgICAgICAgIGlmIChyZXMubWFwICYmIGJhYmVsT3B0aW9ucy5zb3VyY2VNYXBzICYmIGJhYmVsT3B0aW9ucy5zb3VyY2VNYXBzICE9PSBcImlubGluZVwiKSB7XG4gICAgICAgICAgICBjb25zdCBtYXBMb2MgPSBkZXN0ICsgXCIubWFwXCI7XG4gICAgICAgICAgICByZXMuY29kZSA9IHV0aWwuYWRkU291cmNlTWFwcGluZ1VybChyZXMuY29kZSwgbWFwTG9jKTtcbiAgICAgICAgICAgIHJlcy5tYXAuZmlsZSA9IF9wYXRoKCkuZGVmYXVsdC5iYXNlbmFtZShyZWxhdGl2ZSk7XG4gICAgICAgICAgICAoMCwgX291dHB1dEZpbGVTeW5jKCkuZGVmYXVsdCkobWFwTG9jLCBKU09OLnN0cmluZ2lmeShyZXMubWFwKSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgKDAsIF9vdXRwdXRGaWxlU3luYygpLmRlZmF1bHQpKGRlc3QsIHJlcy5jb2RlKTtcbiAgICAgICAgICB1dGlsLmNobW9kKHNyYywgZGVzdCk7XG5cbiAgICAgICAgICBpZiAoY2xpT3B0aW9ucy52ZXJib3NlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhzcmMgKyBcIiAtPiBcIiArIGRlc3QpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAoY2xpT3B0aW9ucy53YXRjaCkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gX3dyaXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0RGVzdChmaWxlbmFtZSwgYmFzZSkge1xuICAgICAgaWYgKGNsaU9wdGlvbnMucmVsYXRpdmUpIHtcbiAgICAgICAgcmV0dXJuIF9wYXRoKCkuZGVmYXVsdC5qb2luKGJhc2UsIGNsaU9wdGlvbnMub3V0RGlyLCBmaWxlbmFtZSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBfcGF0aCgpLmRlZmF1bHQuam9pbihjbGlPcHRpb25zLm91dERpciwgZmlsZW5hbWUpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGhhbmRsZUZpbGUoX3g0LCBfeDUpIHtcbiAgICAgIHJldHVybiBfaGFuZGxlRmlsZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIF9oYW5kbGVGaWxlKCkge1xuICAgICAgX2hhbmRsZUZpbGUgPSBfYXN5bmNUb0dlbmVyYXRvcihmdW5jdGlvbiogKHNyYywgYmFzZSkge1xuICAgICAgICBjb25zdCB3cml0dGVuID0geWllbGQgd3JpdGUoc3JjLCBiYXNlKTtcblxuICAgICAgICBpZiAoIXdyaXR0ZW4gJiYgY2xpT3B0aW9ucy5jb3B5RmlsZXMpIHtcbiAgICAgICAgICBjb25zdCBmaWxlbmFtZSA9IF9wYXRoKCkuZGVmYXVsdC5yZWxhdGl2ZShiYXNlLCBzcmMpO1xuXG4gICAgICAgICAgY29uc3QgZGVzdCA9IGdldERlc3QoZmlsZW5hbWUsIGJhc2UpO1xuICAgICAgICAgICgwLCBfb3V0cHV0RmlsZVN5bmMoKS5kZWZhdWx0KShkZXN0LCBfZnMoKS5kZWZhdWx0LnJlYWRGaWxlU3luYyhzcmMpKTtcbiAgICAgICAgICB1dGlsLmNobW9kKHNyYywgZGVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gd3JpdHRlbjtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIF9oYW5kbGVGaWxlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaGFuZGxlKF94Nikge1xuICAgICAgcmV0dXJuIF9oYW5kbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBfaGFuZGxlKCkge1xuICAgICAgX2hhbmRsZSA9IF9hc3luY1RvR2VuZXJhdG9yKGZ1bmN0aW9uKiAoZmlsZW5hbWVPckRpcikge1xuICAgICAgICBpZiAoIV9mcygpLmRlZmF1bHQuZXhpc3RzU3luYyhmaWxlbmFtZU9yRGlyKSkgcmV0dXJuIDA7XG5cbiAgICAgICAgY29uc3Qgc3RhdCA9IF9mcygpLmRlZmF1bHQuc3RhdFN5bmMoZmlsZW5hbWVPckRpcik7XG5cbiAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgIGNvbnN0IGRpcm5hbWUgPSBmaWxlbmFtZU9yRGlyO1xuICAgICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgICAgY29uc3QgZmlsZXMgPSB1dGlsLnJlYWRkaXIoZGlybmFtZSwgY2xpT3B0aW9ucy5pbmNsdWRlRG90ZmlsZXMpO1xuXG4gICAgICAgICAgZm9yIChjb25zdCBmaWxlbmFtZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgY29uc3Qgc3JjID0gX3BhdGgoKS5kZWZhdWx0LmpvaW4oZGlybmFtZSwgZmlsZW5hbWUpO1xuXG4gICAgICAgICAgICBjb25zdCB3cml0dGVuID0geWllbGQgaGFuZGxlRmlsZShzcmMsIGRpcm5hbWUpO1xuICAgICAgICAgICAgaWYgKHdyaXR0ZW4pIGNvdW50ICs9IDE7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGNvdW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gZmlsZW5hbWVPckRpcjtcbiAgICAgICAgICBjb25zdCB3cml0dGVuID0geWllbGQgaGFuZGxlRmlsZShmaWxlbmFtZSwgX3BhdGgoKS5kZWZhdWx0LmRpcm5hbWUoZmlsZW5hbWUpKTtcbiAgICAgICAgICByZXR1cm4gd3JpdHRlbiA/IDEgOiAwO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBfaGFuZGxlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgaWYgKCFjbGlPcHRpb25zLnNraXBJbml0aWFsQnVpbGQpIHtcbiAgICAgIGlmIChjbGlPcHRpb25zLmRlbGV0ZURpck9uU3RhcnQpIHtcbiAgICAgICAgdXRpbC5kZWxldGVEaXIoY2xpT3B0aW9ucy5vdXREaXIpO1xuICAgICAgfVxuXG4gICAgICAoMCwgX21rZGlycCgpLnN5bmMpKGNsaU9wdGlvbnMub3V0RGlyKTtcbiAgICAgIGxldCBjb21waWxlZEZpbGVzID0gMDtcblxuICAgICAgZm9yIChjb25zdCBmaWxlbmFtZSBvZiBjbGlPcHRpb25zLmZpbGVuYW1lcykge1xuICAgICAgICBjb21waWxlZEZpbGVzICs9IHlpZWxkIGhhbmRsZShmaWxlbmFtZSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgY29tcGlsZWQgJHtjb21waWxlZEZpbGVzfSAke2NvbXBpbGVkRmlsZXMgIT09IDEgPyBcImZpbGVzXCIgOiBcImZpbGVcIn0gd2l0aCBCYWJlbC5gKTtcbiAgICB9XG5cbiAgICBpZiAoY2xpT3B0aW9ucy53YXRjaCkge1xuICAgICAgY29uc3QgY2hva2lkYXIgPSB1dGlsLnJlcXVpcmVDaG9raWRhcigpO1xuICAgICAgZmlsZW5hbWVzLmZvckVhY2goZnVuY3Rpb24gKGZpbGVuYW1lT3JEaXIpIHtcbiAgICAgICAgY29uc3Qgd2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKGZpbGVuYW1lT3JEaXIsIHtcbiAgICAgICAgICBwZXJzaXN0ZW50OiB0cnVlLFxuICAgICAgICAgIGlnbm9yZUluaXRpYWw6IHRydWUsXG4gICAgICAgICAgYXdhaXRXcml0ZUZpbmlzaDoge1xuICAgICAgICAgICAgc3RhYmlsaXR5VGhyZXNob2xkOiA1MCxcbiAgICAgICAgICAgIHBvbGxJbnRlcnZhbDogMTBcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBbXCJhZGRcIiwgXCJjaGFuZ2VcIl0uZm9yRWFjaChmdW5jdGlvbiAodHlwZSkge1xuICAgICAgICAgIHdhdGNoZXIub24odHlwZSwgZnVuY3Rpb24gKGZpbGVuYW1lKSB7XG4gICAgICAgICAgICBoYW5kbGVGaWxlKGZpbGVuYW1lLCBmaWxlbmFtZSA9PT0gZmlsZW5hbWVPckRpciA/IF9wYXRoKCkuZGVmYXVsdC5kaXJuYW1lKGZpbGVuYW1lT3JEaXIpIDogZmlsZW5hbWVPckRpcikuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIF9yZWYuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn0iXX0=