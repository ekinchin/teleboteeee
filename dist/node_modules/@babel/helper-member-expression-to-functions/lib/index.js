"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = memberExpressionToFunctions;

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

class AssignmentMemoiser {
  constructor() {
    this._map = new WeakMap();
  }

  has(key) {
    return this._map.has(key);
  }

  get(key) {
    if (!this.has(key)) return;

    const record = this._map.get(key);

    const {
      value
    } = record;
    record.count--;

    if (record.count === 0) {
      return t().assignmentExpression("=", value, key);
    }

    return value;
  }

  set(key, value, count) {
    return this._map.set(key, {
      count,
      value
    });
  }

}

const handle = {
  memoise() {},

  handle(member) {
    const {
      node,
      parent,
      parentPath
    } = member;

    if (parentPath.isUpdateExpression({
      argument: node
    })) {
      const {
        operator,
        prefix
      } = parent;
      this.memoise(member, 2);
      const value = t().binaryExpression(operator[0], t().unaryExpression("+", this.get(member)), t().numericLiteral(1));

      if (prefix) {
        parentPath.replaceWith(this.set(member, value));
      } else {
        const {
          scope
        } = member;
        const ref = scope.generateUidIdentifierBasedOnNode(node);
        scope.push({
          id: ref
        });
        value.left = t().assignmentExpression("=", t().cloneNode(ref), value.left);
        parentPath.replaceWith(t().sequenceExpression([this.set(member, value), t().cloneNode(ref)]));
      }

      return;
    }

    if (parentPath.isAssignmentExpression({
      left: node
    })) {
      const {
        operator,
        right
      } = parent;
      let value = right;

      if (operator !== "=") {
        this.memoise(member, 2);
        value = t().binaryExpression(operator.slice(0, -1), this.get(member), value);
      }

      parentPath.replaceWith(this.set(member, value));
      return;
    }

    if (parentPath.isCallExpression({
      callee: node
    })) {
      const {
        arguments: args
      } = parent;
      parentPath.replaceWith(this.call(member, args));
      return;
    }

    member.replaceWith(this.get(member));
  }

};

function memberExpressionToFunctions(path, visitor, state) {
  path.traverse(visitor, Object.assign({}, handle, state, {
    memoiser: new AssignmentMemoiser()
  }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvaGVscGVyLW1lbWJlci1leHByZXNzaW9uLXRvLWZ1bmN0aW9ucy9saWIvaW5kZXguanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0IiwibWVtYmVyRXhwcmVzc2lvblRvRnVuY3Rpb25zIiwidCIsImRhdGEiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsInJlcXVpcmUiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImdldCIsInNldCIsIkFzc2lnbm1lbnRNZW1vaXNlciIsImNvbnN0cnVjdG9yIiwiX21hcCIsIldlYWtNYXAiLCJoYXMiLCJyZWNvcmQiLCJjb3VudCIsImFzc2lnbm1lbnRFeHByZXNzaW9uIiwiaGFuZGxlIiwibWVtb2lzZSIsIm1lbWJlciIsIm5vZGUiLCJwYXJlbnQiLCJwYXJlbnRQYXRoIiwiaXNVcGRhdGVFeHByZXNzaW9uIiwiYXJndW1lbnQiLCJvcGVyYXRvciIsInByZWZpeCIsImJpbmFyeUV4cHJlc3Npb24iLCJ1bmFyeUV4cHJlc3Npb24iLCJudW1lcmljTGl0ZXJhbCIsInJlcGxhY2VXaXRoIiwic2NvcGUiLCJyZWYiLCJnZW5lcmF0ZVVpZElkZW50aWZpZXJCYXNlZE9uTm9kZSIsInB1c2giLCJpZCIsImxlZnQiLCJjbG9uZU5vZGUiLCJzZXF1ZW5jZUV4cHJlc3Npb24iLCJpc0Fzc2lnbm1lbnRFeHByZXNzaW9uIiwicmlnaHQiLCJzbGljZSIsImlzQ2FsbEV4cHJlc3Npb24iLCJjYWxsZWUiLCJhcmd1bWVudHMiLCJhcmdzIiwicGF0aCIsInZpc2l0b3IiLCJzdGF0ZSIsInRyYXZlcnNlIiwiYXNzaWduIiwibWVtb2lzZXIiXSwibWFwcGluZ3Mi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Q0FBbUIsS0FBS3ZCLEdBQUwsQ0FBU1ksTUFBVCxDQUFuQjtBQUNEOztBQWxFWSxDQUFmOztBQXNFQSxTQUFTMUIsMkJBQVQsQ0FBcUNxRCxJQUFyQyxFQUEyQ0MsT0FBM0MsRUFBb0RDLEtBQXBELEVBQTJEO0FBQ3pERixFQUFBQSxJQUFJLENBQUNHLFFBQUwsQ0FBY0YsT0FBZCxFQUF1QjNELE1BQU0sQ0FBQzhELE1BQVAsQ0FBYyxFQUFkLEVBQWtCakMsTUFBbEIsRUFBMEIrQixLQUExQixFQUFpQztBQUN0REcsSUFBQUEsUUFBUSxFQUFFLElBQUkxQyxrQkFBSjtBQUQ0QyxHQUFqQyxDQUF2QjtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLmRlZmF1bHQgPSBtZW1iZXJFeHByZXNzaW9uVG9GdW5jdGlvbnM7XG5cbmZ1bmN0aW9uIHQoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChyZXF1aXJlKFwiQGJhYmVsL3R5cGVzXCIpKTtcblxuICB0ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGVsc2UgeyB2YXIgbmV3T2JqID0ge307IGlmIChvYmogIT0gbnVsbCkgeyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KSA6IHt9OyBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iaiwga2V5LCBkZXNjKTsgfSBlbHNlIHsgbmV3T2JqW2tleV0gPSBvYmpba2V5XTsgfSB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgcmV0dXJuIG5ld09iajsgfSB9XG5cbmNsYXNzIEFzc2lnbm1lbnRNZW1vaXNlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuX21hcCA9IG5ldyBXZWFrTWFwKCk7XG4gIH1cblxuICBoYXMoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMuX21hcC5oYXMoa2V5KTtcbiAgfVxuXG4gIGdldChrZXkpIHtcbiAgICBpZiAoIXRoaXMuaGFzKGtleSkpIHJldHVybjtcblxuICAgIGNvbnN0IHJlY29yZCA9IHRoaXMuX21hcC5nZXQoa2V5KTtcblxuICAgIGNvbnN0IHtcbiAgICAgIHZhbHVlXG4gICAgfSA9IHJlY29yZDtcbiAgICByZWNvcmQuY291bnQtLTtcblxuICAgIGlmIChyZWNvcmQuY291bnQgPT09IDApIHtcbiAgICAgIHJldHVybiB0KCkuYXNzaWdubWVudEV4cHJlc3Npb24oXCI9XCIsIHZhbHVlLCBrZXkpO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIHNldChrZXksIHZhbHVlLCBjb3VudCkge1xuICAgIHJldHVybiB0aGlzLl9tYXAuc2V0KGtleSwge1xuICAgICAgY291bnQsXG4gICAgICB2YWx1ZVxuICAgIH0pO1xuICB9XG5cbn1cblxuY29uc3QgaGFuZGxlID0ge1xuICBtZW1vaXNlKCkge30sXG5cbiAgaGFuZGxlKG1lbWJlcikge1xuICAgIGNvbnN0IHtcbiAgICAgIG5vZGUsXG4gICAgICBwYXJlbnQsXG4gICAgICBwYXJlbnRQYXRoXG4gICAgfSA9IG1lbWJlcjtcblxuICAgIGlmIChwYXJlbnRQYXRoLmlzVXBkYXRlRXhwcmVzc2lvbih7XG4gICAgICBhcmd1bWVudDogbm9kZVxuICAgIH0pKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIG9wZXJhdG9yLFxuICAgICAgICBwcmVmaXhcbiAgICAgIH0gPSBwYXJlbnQ7XG4gICAgICB0aGlzLm1lbW9pc2UobWVtYmVyLCAyKTtcbiAgICAgIGNvbnN0IHZhbHVlID0gdCgpLmJpbmFyeUV4cHJlc3Npb24ob3BlcmF0b3JbMF0sIHQoKS51bmFyeUV4cHJlc3Npb24oXCIrXCIsIHRoaXMuZ2V0KG1lbWJlcikpLCB0KCkubnVtZXJpY0xpdGVyYWwoMSkpO1xuXG4gICAgICBpZiAocHJlZml4KSB7XG4gICAgICAgIHBhcmVudFBhdGgucmVwbGFjZVdpdGgodGhpcy5zZXQobWVtYmVyLCB2YWx1ZSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIHNjb3BlXG4gICAgICAgIH0gPSBtZW1iZXI7XG4gICAgICAgIGNvbnN0IHJlZiA9IHNjb3BlLmdlbmVyYXRlVWlkSWRlbnRpZmllckJhc2VkT25Ob2RlKG5vZGUpO1xuICAgICAgICBzY29wZS5wdXNoKHtcbiAgICAgICAgICBpZDogcmVmXG4gICAgICAgIH0pO1xuICAgICAgICB2YWx1ZS5sZWZ0ID0gdCgpLmFzc2lnbm1lbnRFeHByZXNzaW9uKFwiPVwiLCB0KCkuY2xvbmVOb2RlKHJlZiksIHZhbHVlLmxlZnQpO1xuICAgICAgICBwYXJlbnRQYXRoLnJlcGxhY2VXaXRoKHQoKS5zZXF1ZW5jZUV4cHJlc3Npb24oW3RoaXMuc2V0KG1lbWJlciwgdmFsdWUpLCB0KCkuY2xvbmVOb2RlKHJlZildKSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAocGFyZW50UGF0aC5pc0Fzc2lnbm1lbnRFeHByZXNzaW9uKHtcbiAgICAgIGxlZnQ6IG5vZGVcbiAgICB9KSkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBvcGVyYXRvcixcbiAgICAgICAgcmlnaHRcbiAgICAgIH0gPSBwYXJlbnQ7XG4gICAgICBsZXQgdmFsdWUgPSByaWdodDtcblxuICAgICAgaWYgKG9wZXJhdG9yICE9PSBcIj1cIikge1xuICAgICAgICB0aGlzLm1lbW9pc2UobWVtYmVyLCAyKTtcbiAgICAgICAgdmFsdWUgPSB0KCkuYmluYXJ5RXhwcmVzc2lvbihvcGVyYXRvci5zbGljZSgwLCAtMSksIHRoaXMuZ2V0KG1lbWJlciksIHZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgcGFyZW50UGF0aC5yZXBsYWNlV2l0aCh0aGlzLnNldChtZW1iZXIsIHZhbHVlKSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHBhcmVudFBhdGguaXNDYWxsRXhwcmVzc2lvbih7XG4gICAgICBjYWxsZWU6IG5vZGVcbiAgICB9KSkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBhcmd1bWVudHM6IGFyZ3NcbiAgICAgIH0gPSBwYXJlbnQ7XG4gICAgICBwYXJlbnRQYXRoLnJlcGxhY2VXaXRoKHRoaXMuY2FsbChtZW1iZXIsIGFyZ3MpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBtZW1iZXIucmVwbGFjZVdpdGgodGhpcy5nZXQobWVtYmVyKSk7XG4gIH1cblxufTtcblxuZnVuY3Rpb24gbWVtYmVyRXhwcmVzc2lvblRvRnVuY3Rpb25zKHBhdGgsIHZpc2l0b3IsIHN0YXRlKSB7XG4gIHBhdGgudHJhdmVyc2UodmlzaXRvciwgT2JqZWN0LmFzc2lnbih7fSwgaGFuZGxlLCBzdGF0ZSwge1xuICAgIG1lbW9pc2VyOiBuZXcgQXNzaWdubWVudE1lbW9pc2VyKClcbiAgfSkpO1xufSJdfQ==