"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.rewriteModuleStatementsAndPrepareHeader = rewriteModuleStatementsAndPrepareHeader;
exports.ensureStatementsHoisted = ensureStatementsHoisted;
exports.wrapInterop = wrapInterop;
exports.buildNamespaceInitStatements = buildNamespaceInitStatements;
Object.defineProperty(exports, "isModule", {
  enumerable: true,
  get: function () {
    return _helperModuleImports().isModule;
  }
});
Object.defineProperty(exports, "hasExports", {
  enumerable: true,
  get: function () {
    return _normalizeAndLoadMetadata.hasExports;
  }
});
Object.defineProperty(exports, "isSideEffectImport", {
  enumerable: true,
  get: function () {
    return _normalizeAndLoadMetadata.isSideEffectImport;
  }
});

function _assert() {
  const data = _interopRequireDefault(require("assert"));

  _assert = function () {
    return data;
  };

  return data;
}

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

function _template() {
  const data = _interopRequireDefault(require("@babel/template"));

  _template = function () {
    return data;
  };

  return data;
}

function _chunk() {
  const data = _interopRequireDefault(require("lodash/chunk"));

  _chunk = function () {
    return data;
  };

  return data;
}

function _helperModuleImports() {
  const data = require("@babel/helper-module-imports");

  _helperModuleImports = function () {
    return data;
  };

  return data;
}

var _rewriteThis = _interopRequireDefault(require("./rewrite-this"));

var _rewriteLiveReferences = _interopRequireDefault(require("./rewrite-live-references"));

var _normalizeAndLoadMetadata = _interopRequireWildcard(require("./normalize-and-load-metadata"));

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function rewriteModuleStatementsAndPrepareHeader(path, {
  exportName,
  strict,
  allowTopLevelThis,
  strictMode,
  loose,
  noInterop,
  lazy,
  esNamespaceOnly
}) {
  (0, _assert().default)((0, _helperModuleImports().isModule)(path), "Cannot process module statements in a script");
  path.node.sourceType = "script";
  const meta = (0, _normalizeAndLoadMetadata.default)(path, exportName, {
    noInterop,
    loose,
    lazy,
    esNamespaceOnly
  });

  if (!allowTopLevelThis) {
    (0, _rewriteThis.default)(path);
  }

  (0, _rewriteLiveReferences.default)(path, meta);

  if (strictMode !== false) {
    const hasStrict = path.node.directives.some(directive => {
      return directive.value.value === "use strict";
    });

    if (!hasStrict) {
      path.unshiftContainer("directives", t().directive(t().directiveLiteral("use strict")));
    }
  }

  const headers = [];

  if ((0, _normalizeAndLoadMetadata.hasExports)(meta) && !strict) {
    headers.push(buildESModuleHeader(meta, loose));
  }

  const nameList = buildExportNameListDeclaration(path, meta);

  if (nameList) {
    meta.exportNameListName = nameList.name;
    headers.push(nameList.statement);
  }

  headers.push(...buildExportInitializationStatements(path, meta, loose));
  return {
    meta,
    headers
  };
}

function ensureStatementsHoisted(statements) {
  statements.forEach(header => {
    header._blockHoist = 3;
  });
}

function wrapInterop(programPath, expr, type) {
  if (type === "none") {
    return null;
  }

  let helper;

  if (type === "default") {
    helper = "interopRequireDefault";
  } else if (type === "namespace") {
    helper = "interopRequireWildcard";
  } else {
    throw new Error(`Unknown interop: ${type}`);
  }

  return t().callExpression(programPath.hub.addHelper(helper), [expr]);
}

function buildNamespaceInitStatements(metadata, sourceMetadata, loose = false) {
  const statements = [];
  let srcNamespace = t().identifier(sourceMetadata.name);
  if (sourceMetadata.lazy) srcNamespace = t().callExpression(srcNamespace, []);

  for (const localName of sourceMetadata.importsNamespace) {
    if (localName === sourceMetadata.name) continue;
    statements.push(_template().default.statement`var NAME = SOURCE;`({
      NAME: localName,
      SOURCE: t().cloneNode(srcNamespace)
    }));
  }

  if (loose) {
    statements.push(...buildReexportsFromMeta(metadata, sourceMetadata, loose));
  }

  for (const exportName of sourceMetadata.reexportNamespace) {
    statements.push((sourceMetadata.lazy ? _template().default.statement`
            Object.defineProperty(EXPORTS, "NAME", {
              enumerable: true,
              get: function() {
                return NAMESPACE;
              }
            });
          ` : _template().default.statement`EXPORTS.NAME = NAMESPACE;`)({
      EXPORTS: metadata.exportName,
      NAME: exportName,
      NAMESPACE: t().cloneNode(srcNamespace)
    }));
  }

  if (sourceMetadata.reexportAll) {
    const statement = buildNamespaceReexport(metadata, t().cloneNode(srcNamespace), loose);
    statement.loc = sourceMetadata.reexportAll.loc;
    statements.push(statement);
  }

  return statements;
}

const getTemplateForReexport = loose => {
  return loose ? _template().default.statement`EXPORTS.EXPORT_NAME = NAMESPACE.IMPORT_NAME;` : _template().default`
      Object.defineProperty(EXPORTS, "EXPORT_NAME", {
        enumerable: true,
        get: function() {
          return NAMESPACE.IMPORT_NAME;
        },
      });
    `;
};

const buildReexportsFromMeta = (meta, metadata, loose) => {
  const namespace = metadata.lazy ? t().callExpression(t().identifier(metadata.name), []) : t().identifier(metadata.name);
  const templateForCurrentMode = getTemplateForReexport(loose);
  return Array.from(metadata.reexports, ([exportName, importName]) => templateForCurrentMode({
    EXPORTS: meta.exportName,
    EXPORT_NAME: exportName,
    NAMESPACE: t().cloneNode(namespace),
    IMPORT_NAME: importName
  }));
};

function buildESModuleHeader(metadata, enumerable = false) {
  return (enumerable ? _template().default.statement`
        EXPORTS.__esModule = true;
      ` : _template().default.statement`
        Object.defineProperty(EXPORTS, "__esModule", {
          value: true,
        });
      `)({
    EXPORTS: metadata.exportName
  });
}

function buildNamespaceReexport(metadata, namespace, loose) {
  return (loose ? _template().default.statement`
        Object.keys(NAMESPACE).forEach(function(key) {
          if (key === "default" || key === "__esModule") return;
          VERIFY_NAME_LIST;

          EXPORTS[key] = NAMESPACE[key];
        });
      ` : _template().default.statement`
        Object.keys(NAMESPACE).forEach(function(key) {
          if (key === "default" || key === "__esModule") return;
          VERIFY_NAME_LIST;

          Object.defineProperty(EXPORTS, key, {
            enumerable: true,
            get: function() {
              return NAMESPACE[key];
            },
          });
        });
    `)({
    NAMESPACE: namespace,
    EXPORTS: metadata.exportName,
    VERIFY_NAME_LIST: metadata.exportNameListName ? _template().default`
            if (Object.prototype.hasOwnProperty.call(EXPORTS_LIST, key)) return;
          `({
      EXPORTS_LIST: metadata.exportNameListName
    }) : null
  });
}

function buildExportNameListDeclaration(programPath, metadata) {
  const exportedVars = Object.create(null);

  for (const data of metadata.local.values()) {
    for (const name of data.names) {
      exportedVars[name] = true;
    }
  }

  let hasReexport = false;

  for (const data of metadata.source.values()) {
    for (const exportName of data.reexports.keys()) {
      exportedVars[exportName] = true;
    }

    for (const exportName of data.reexportNamespace) {
      exportedVars[exportName] = true;
    }

    hasReexport = hasReexport || data.reexportAll;
  }

  if (!hasReexport || Object.keys(exportedVars).length === 0) return null;
  const name = programPath.scope.generateUidIdentifier("exportNames");
  delete exportedVars.default;
  return {
    name: name.name,
    statement: t().variableDeclaration("var", [t().variableDeclarator(name, t().valueToNode(exportedVars))])
  };
}

function buildExportInitializationStatements(programPath, metadata, loose = false) {
  const initStatements = [];
  const exportNames = [];

  for (const [localName, data] of metadata.local) {
    if (data.kind === "import") {} else if (data.kind === "hoisted") {
      initStatements.push(buildInitStatement(metadata, data.names, t().identifier(localName)));
    } else {
      exportNames.push(...data.names);
    }
  }

  for (const data of metadata.source.values()) {
    if (!loose) {
      initStatements.push(...buildReexportsFromMeta(metadata, data, loose));
    }

    for (const exportName of data.reexportNamespace) {
      exportNames.push(exportName);
    }
  }

  initStatements.push(...(0, _chunk().default)(exportNames, 100).map(members => {
    return buildInitStatement(metadata, members, programPath.scope.buildUndefinedNode());
  }));
  return initStatements;
}

function buildInitStatement(metadata, exportNames, initExpr) {
  return t().expressionStatement(exportNames.reduce((acc, exportName) => _template().default.expression`EXPORTS.NAME = VALUE`({
    EXPORTS: metadata.exportName,
    NAME: exportName,
    VALUE: acc
  }), initExpr));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvaGVscGVyLW1vZHVsZS10cmFuc2Zvcm1zL2xpYi9pbmRleC5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInJld3JpdGVNb2R1bGVTdGF0ZW1lbnRzQW5kUHJlcGFyZUhlYWRlciIsImVuc3VyZVN0YXRlbWVudHNIb2lzdGVkIiwid3JhcEludGVyb3AiLCJidWlsZE5hbWVzcGFjZUluaXRTdGF0ZW1lbnRzIiwiZW51bWVyYWJsZSIsImdldCIsIl9oZWxwZXJNb2R1bGVJbXBvcnRzIiwiaXNNb2R1bGUiLCJfbm9ybWFsaXplQW5kTG9hZE1ldGFkYXRhIiwiaGFzRXhwb3J0cyIsImlzU2lkZUVmZmVjdEltcG9ydCIsIl9hc3NlcnQiLCJkYXRhIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJ0IiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJfdGVtcGxhdGUiLCJfY2h1bmsiLCJfcmV3cml0ZVRoaXMiLCJfcmV3cml0ZUxpdmVSZWZlcmVuY2VzIiwib2JqIiwiX19lc01vZHVsZSIsIm5ld09iaiIsImtleSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImRlc2MiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJzZXQiLCJkZWZhdWx0IiwicGF0aCIsImV4cG9ydE5hbWUiLCJzdHJpY3QiLCJhbGxvd1RvcExldmVsVGhpcyIsInN0cmljdE1vZGUiLCJsb29zZSIsIm5vSW50ZXJvcCIsImxhenkiLCJlc05hbWVzcGFjZU9ubHkiLCJub2RlIiwic291cmNlVHlwZSIsIm1ldGEiLCJoYXNTdHJpY3QiLCJkaXJlY3RpdmVzIiwic29tZSIsImRpcmVjdGl2ZSIsInVuc2hpZnRDb250YWluZXIiLCJkaXJlY3RpdmVMaXRlcmFsIiwiaGVhZGVycyIsInB1c2giLCJidWlsZEVTTW9kdWxlSGVhZGVyIiwibmFtZUxpc3QiLCJidWlsZEV4cG9ydE5hbWVMaXN0RGVjbGFyYXRpb24iLCJleHBvcnROYW1lTGlzdE5hbWUiLCJuYW1lIiwic3RhdGVtZW50IiwiYnVpbGRFeHBvcnRJbml0aWFsaXphdGlvblN0YXRlbWVudHMiLCJzdGF0ZW1lbnRzIiwiZm9yRWFjaCIsImhlYWRlciIsIl9ibG9ja0hvaXN0IiwicHJvZ3JhbVBhdGgiLCJleHByIiwidHlwZSIsImhlbHBlciIsIkVycm9yIiwiY2FsbEV4cHJlc3Npb24iLCJodWIiLCJhZGRIZWxwZXIiLCJtZXRhZGF0YSIsInNvdXJjZU1ldGFkYXRhIiwic3JjTmFtZXNwYWNlIiwiaWRlbnRpZmllciIsImxvY2FsTmFtZSIsImltcG9ydHNOYW1lc3BhY2UiLCJOQU1FIiwiU09VUkNFIiwiY2xvbmVOb2RlIiwiYnVpbGRSZWV4cG9ydHNGcm9tTWV0YSIsInJlZXhwb3J0TmFtZXNwYWNlIiwiRVhQT1JUUyIsIk5BTUVTUEFDRSIsInJlZXhwb3J0QWxsIiwiYnVpbGROYW1lc3BhY2VSZWV4cG9ydCIsImxvYyIsImdldFRlbXBsYXRlRm9yUmVleHBvcnQiLCJuYW1lc3BhY2UiLCJ0ZW1wbGF0ZUZvckN1cnJlbnRNb2RlIiwiQXJyYXkiLCJmcm9tIiwicmVleHBvcnRzIiwiaW1wb3J0TmFtZSIsIkVYUE9SVF9OQU1FIiwiSU1QT1JUX05BTUUiLCJWRVJJRllfTkFNRV9MSVNUIiwiRVhQT1JUU19MSVNUIiwiZXhwb3J0ZWRWYXJzIiwiY3JlYXRlIiwibG9jYWwiLCJ2YWx1ZXMiLCJuYW1lcyIsImhhc1JlZXhwb3J0Iiwic291cmNlIiwia2V5cyIsImxlbmd0aCIsInNjb3BlIiwiZ2VuZXJhdGVVaWRJZGVudGlmaWVyIiwidmFyaWFibGVEZWNsYXJhdGlvbiIsInZhcmlhYmxlRGVjbGFyYXRvciIsInZhbHVlVG9Ob2RlIiwiaW5pdFN0YXRlbWVudHMiLCJleHBvcnROYW1lcyIsImtpbmQiLCJidWlsZEluaXRTdGF0ZW1lbnQiLCJtYXAiLCJtZW1iZXJzIiwiYnVpbGRVbmRlZmluZWROb2RlIiwiaW5pdEV4cHIiLCJleHByZXNzaW9uU3RhdGVtZW50IiwicmVkdWNlIiwiYWNjIiwiZXhwcmVzc2lvbiIsIlZBTFVFIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsdUNBQVIsR0FBa0RBLHVDQUFsRDtBQUNBRixPQUFPLENBQUNHLHVCQUFSLEdBQWtDQSx1QkFBbEM7QUFDQUgsT0FBTyxDQUFDSSxXQUFSLEdBQXNCQSxXQUF0QjtBQUNBSixPQUFPLENBQUNLLDRCQUFSLEdBQXVDQSw0QkFBdkM7QUFDQVAsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixVQUEvQixFQUEyQztBQUN6Q00sRUFBQUEsVUFBVSxFQUFFLElBRDZCO0FBRXpDQyxFQUFBQSxHQUFHLEVBQUUsWUFBWTtBQUNmLFdBQU9DLG9CQUFvQixHQUFHQyxRQUE5QjtBQUNEO0FBSndDLENBQTNDO0FBTUFYLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFDM0NNLEVBQUFBLFVBQVUsRUFBRSxJQUQrQjtBQUUzQ0MsRUFBQUEsR0FBRyxFQUFFLFlBQVk7QUFDZixXQUFPRyx5QkFBeUIsQ0FBQ0MsVUFBakM7QUFDRDtBQUowQyxDQUE3QztBQU1BYixNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLG9CQUEvQixFQUFxRDtBQUNuRE0sRUFBQUEsVUFBVSxFQUFFLElBRHVDO0FBRW5EQyxFQUFBQSxHQUFHLEVBQUUsWUFBWTtBQUNmLFdBQU9HLHlCQUF5QixDQUFDRSxrQkFBakM7QUFDRDtBQUprRCxDQUFyRDs7QUFPQSxTQUFTQyxPQUFULEdBQW1CO0FBQ2pCLFFBQU1DLElBQUksR0FBR0Msc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxRQUFELENBQVIsQ0FBbkM7O0FBRUFILEVB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WixDQUFvQjRGLFVBQVcsc0JBQS9CLENBQXFEO0FBQzFIekMsSUFBQUEsT0FBTyxFQUFFWCxRQUFRLENBQUN0QyxVQUR3RztBQUUxSDRDLElBQUFBLElBQUksRUFBRTVDLFVBRm9IO0FBRzFIMkYsSUFBQUEsS0FBSyxFQUFFRjtBQUhtSCxHQUFyRCxDQUF4QyxFQUkzQkgsUUFKMkIsQ0FBeEIsQ0FBUDtBQUtEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLnJld3JpdGVNb2R1bGVTdGF0ZW1lbnRzQW5kUHJlcGFyZUhlYWRlciA9IHJld3JpdGVNb2R1bGVTdGF0ZW1lbnRzQW5kUHJlcGFyZUhlYWRlcjtcbmV4cG9ydHMuZW5zdXJlU3RhdGVtZW50c0hvaXN0ZWQgPSBlbnN1cmVTdGF0ZW1lbnRzSG9pc3RlZDtcbmV4cG9ydHMud3JhcEludGVyb3AgPSB3cmFwSW50ZXJvcDtcbmV4cG9ydHMuYnVpbGROYW1lc3BhY2VJbml0U3RhdGVtZW50cyA9IGJ1aWxkTmFtZXNwYWNlSW5pdFN0YXRlbWVudHM7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJpc01vZHVsZVwiLCB7XG4gIGVudW1lcmFibGU6IHRydWUsXG4gIGdldDogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBfaGVscGVyTW9kdWxlSW1wb3J0cygpLmlzTW9kdWxlO1xuICB9XG59KTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcImhhc0V4cG9ydHNcIiwge1xuICBlbnVtZXJhYmxlOiB0cnVlLFxuICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gX25vcm1hbGl6ZUFuZExvYWRNZXRhZGF0YS5oYXNFeHBvcnRzO1xuICB9XG59KTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcImlzU2lkZUVmZmVjdEltcG9ydFwiLCB7XG4gIGVudW1lcmFibGU6IHRydWUsXG4gIGdldDogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBfbm9ybWFsaXplQW5kTG9hZE1ldGFkYXRhLmlzU2lkZUVmZmVjdEltcG9ydDtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIF9hc3NlcnQoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJhc3NlcnRcIikpO1xuXG4gIF9hc3NlcnQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIHQoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChyZXF1aXJlKFwiQGJhYmVsL3R5cGVzXCIpKTtcblxuICB0ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfdGVtcGxhdGUoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJAYmFiZWwvdGVtcGxhdGVcIikpO1xuXG4gIF90ZW1wbGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX2NodW5rKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwibG9kYXNoL2NodW5rXCIpKTtcblxuICBfY2h1bmsgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9oZWxwZXJNb2R1bGVJbXBvcnRzKCkge1xuICBjb25zdCBkYXRhID0gcmVxdWlyZShcIkBiYWJlbC9oZWxwZXItbW9kdWxlLWltcG9ydHNcIik7XG5cbiAgX2hlbHBlck1vZHVsZUltcG9ydHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbnZhciBfcmV3cml0ZVRoaXMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL3Jld3JpdGUtdGhpc1wiKSk7XG5cbnZhciBfcmV3cml0ZUxpdmVSZWZlcmVuY2VzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9yZXdyaXRlLWxpdmUtcmVmZXJlbmNlc1wiKSk7XG5cbnZhciBfbm9ybWFsaXplQW5kTG9hZE1ldGFkYXRhID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZShcIi4vbm9ybWFsaXplLWFuZC1sb2FkLW1ldGFkYXRhXCIpKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQob2JqKSB7IGlmIChvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsgcmV0dXJuIG9iajsgfSBlbHNlIHsgdmFyIG5ld09iaiA9IHt9OyBpZiAob2JqICE9IG51bGwpIHsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yID8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSkgOiB7fTsgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7IH0gZWxzZSB7IG5ld09ialtrZXldID0gb2JqW2tleV07IH0gfSB9IH0gbmV3T2JqLmRlZmF1bHQgPSBvYmo7IHJldHVybiBuZXdPYmo7IH0gfVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfVxuXG5mdW5jdGlvbiByZXdyaXRlTW9kdWxlU3RhdGVtZW50c0FuZFByZXBhcmVIZWFkZXIocGF0aCwge1xuICBleHBvcnROYW1lLFxuICBzdHJpY3QsXG4gIGFsbG93VG9wTGV2ZWxUaGlzLFxuICBzdHJpY3RNb2RlLFxuICBsb29zZSxcbiAgbm9JbnRlcm9wLFxuICBsYXp5LFxuICBlc05hbWVzcGFjZU9ubHlcbn0pIHtcbiAgKDAsIF9hc3NlcnQoKS5kZWZhdWx0KSgoMCwgX2hlbHBlck1vZHVsZUltcG9ydHMoKS5pc01vZHVsZSkocGF0aCksIFwiQ2Fubm90IHByb2Nlc3MgbW9kdWxlIHN0YXRlbWVudHMgaW4gYSBzY3JpcHRcIik7XG4gIHBhdGgubm9kZS5zb3VyY2VUeXBlID0gXCJzY3JpcHRcIjtcbiAgY29uc3QgbWV0YSA9ICgwLCBfbm9ybWFsaXplQW5kTG9hZE1ldGFkYXRhLmRlZmF1bHQpKHBhdGgsIGV4cG9ydE5hbWUsIHtcbiAgICBub0ludGVyb3AsXG4gICAgbG9vc2UsXG4gICAgbGF6eSxcbiAgICBlc05hbWVzcGFjZU9ubHlcbiAgfSk7XG5cbiAgaWYgKCFhbGxvd1RvcExldmVsVGhpcykge1xuICAgICgwLCBfcmV3cml0ZVRoaXMuZGVmYXVsdCkocGF0aCk7XG4gIH1cblxuICAoMCwgX3Jld3JpdGVMaXZlUmVmZXJlbmNlcy5kZWZhdWx0KShwYXRoLCBtZXRhKTtcblxuICBpZiAoc3RyaWN0TW9kZSAhPT0gZmFsc2UpIHtcbiAgICBjb25zdCBoYXNTdHJpY3QgPSBwYXRoLm5vZGUuZGlyZWN0aXZlcy5zb21lKGRpcmVjdGl2ZSA9PiB7XG4gICAgICByZXR1cm4gZGlyZWN0aXZlLnZhbHVlLnZhbHVlID09PSBcInVzZSBzdHJpY3RcIjtcbiAgICB9KTtcblxuICAgIGlmICghaGFzU3RyaWN0KSB7XG4gICAgICBwYXRoLnVuc2hpZnRDb250YWluZXIoXCJkaXJlY3RpdmVzXCIsIHQoKS5kaXJlY3RpdmUodCgpLmRpcmVjdGl2ZUxpdGVyYWwoXCJ1c2Ugc3RyaWN0XCIpKSk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgaGVhZGVycyA9IFtdO1xuXG4gIGlmICgoMCwgX25vcm1hbGl6ZUFuZExvYWRNZXRhZGF0YS5oYXNFeHBvcnRzKShtZXRhKSAmJiAhc3RyaWN0KSB7XG4gICAgaGVhZGVycy5wdXNoKGJ1aWxkRVNNb2R1bGVIZWFkZXIobWV0YSwgbG9vc2UpKTtcbiAgfVxuXG4gIGNvbnN0IG5hbWVMaXN0ID0gYnVpbGRFeHBvcnROYW1lTGlzdERlY2xhcmF0aW9uKHBhdGgsIG1ldGEpO1xuXG4gIGlmIChuYW1lTGlzdCkge1xuICAgIG1ldGEuZXhwb3J0TmFtZUxpc3ROYW1lID0gbmFtZUxpc3QubmFtZTtcbiAgICBoZWFkZXJzLnB1c2gobmFtZUxpc3Quc3RhdGVtZW50KTtcbiAgfVxuXG4gIGhlYWRlcnMucHVzaCguLi5idWlsZEV4cG9ydEluaXRpYWxpemF0aW9uU3RhdGVtZW50cyhwYXRoLCBtZXRhLCBsb29zZSkpO1xuICByZXR1cm4ge1xuICAgIG1ldGEsXG4gICAgaGVhZGVyc1xuICB9O1xufVxuXG5mdW5jdGlvbiBlbnN1cmVTdGF0ZW1lbnRzSG9pc3RlZChzdGF0ZW1lbnRzKSB7XG4gIHN0YXRlbWVudHMuZm9yRWFjaChoZWFkZXIgPT4ge1xuICAgIGhlYWRlci5fYmxvY2tIb2lzdCA9IDM7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB3cmFwSW50ZXJvcChwcm9ncmFtUGF0aCwgZXhwciwgdHlwZSkge1xuICBpZiAodHlwZSA9PT0gXCJub25lXCIpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGxldCBoZWxwZXI7XG5cbiAgaWYgKHR5cGUgPT09IFwiZGVmYXVsdFwiKSB7XG4gICAgaGVscGVyID0gXCJpbnRlcm9wUmVxdWlyZURlZmF1bHRcIjtcbiAgfSBlbHNlIGlmICh0eXBlID09PSBcIm5hbWVzcGFjZVwiKSB7XG4gICAgaGVscGVyID0gXCJpbnRlcm9wUmVxdWlyZVdpbGRjYXJkXCI7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGludGVyb3A6ICR7dHlwZX1gKTtcbiAgfVxuXG4gIHJldHVybiB0KCkuY2FsbEV4cHJlc3Npb24ocHJvZ3JhbVBhdGguaHViLmFkZEhlbHBlcihoZWxwZXIpLCBbZXhwcl0pO1xufVxuXG5mdW5jdGlvbiBidWlsZE5hbWVzcGFjZUluaXRTdGF0ZW1lbnRzKG1ldGFkYXRhLCBzb3VyY2VNZXRhZGF0YSwgbG9vc2UgPSBmYWxzZSkge1xuICBjb25zdCBzdGF0ZW1lbnRzID0gW107XG4gIGxldCBzcmNOYW1lc3BhY2UgPSB0KCkuaWRlbnRpZmllcihzb3VyY2VNZXRhZGF0YS5uYW1lKTtcbiAgaWYgKHNvdXJjZU1ldGFkYXRhLmxhenkpIHNyY05hbWVzcGFjZSA9IHQoKS5jYWxsRXhwcmVzc2lvbihzcmNOYW1lc3BhY2UsIFtdKTtcblxuICBmb3IgKGNvbnN0IGxvY2FsTmFtZSBvZiBzb3VyY2VNZXRhZGF0YS5pbXBvcnRzTmFtZXNwYWNlKSB7XG4gICAgaWYgKGxvY2FsTmFtZSA9PT0gc291cmNlTWV0YWRhdGEubmFtZSkgY29udGludWU7XG4gICAgc3RhdGVtZW50cy5wdXNoKF90ZW1wbGF0ZSgpLmRlZmF1bHQuc3RhdGVtZW50YHZhciBOQU1FID0gU09VUkNFO2Aoe1xuICAgICAgTkFNRTogbG9jYWxOYW1lLFxuICAgICAgU09VUkNFOiB0KCkuY2xvbmVOb2RlKHNyY05hbWVzcGFjZSlcbiAgICB9KSk7XG4gIH1cblxuICBpZiAobG9vc2UpIHtcbiAgICBzdGF0ZW1lbnRzLnB1c2goLi4uYnVpbGRSZWV4cG9ydHNGcm9tTWV0YShtZXRhZGF0YSwgc291cmNlTWV0YWRhdGEsIGxvb3NlKSk7XG4gIH1cblxuICBmb3IgKGNvbnN0IGV4cG9ydE5hbWUgb2Ygc291cmNlTWV0YWRhdGEucmVleHBvcnROYW1lc3BhY2UpIHtcbiAgICBzdGF0ZW1lbnRzLnB1c2goKHNvdXJjZU1ldGFkYXRhLmxhenkgPyBfdGVtcGxhdGUoKS5kZWZhdWx0LnN0YXRlbWVudGBcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFWFBPUlRTLCBcIk5BTUVcIiwge1xuICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBOQU1FU1BBQ0U7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIGAgOiBfdGVtcGxhdGUoKS5kZWZhdWx0LnN0YXRlbWVudGBFWFBPUlRTLk5BTUUgPSBOQU1FU1BBQ0U7YCkoe1xuICAgICAgRVhQT1JUUzogbWV0YWRhdGEuZXhwb3J0TmFtZSxcbiAgICAgIE5BTUU6IGV4cG9ydE5hbWUsXG4gICAgICBOQU1FU1BBQ0U6IHQoKS5jbG9uZU5vZGUoc3JjTmFtZXNwYWNlKVxuICAgIH0pKTtcbiAgfVxuXG4gIGlmIChzb3VyY2VNZXRhZGF0YS5yZWV4cG9ydEFsbCkge1xuICAgIGNvbnN0IHN0YXRlbWVudCA9IGJ1aWxkTmFtZXNwYWNlUmVleHBvcnQobWV0YWRhdGEsIHQoKS5jbG9uZU5vZGUoc3JjTmFtZXNwYWNlKSwgbG9vc2UpO1xuICAgIHN0YXRlbWVudC5sb2MgPSBzb3VyY2VNZXRhZGF0YS5yZWV4cG9ydEFsbC5sb2M7XG4gICAgc3RhdGVtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gIH1cblxuICByZXR1cm4gc3RhdGVtZW50cztcbn1cblxuY29uc3QgZ2V0VGVtcGxhdGVGb3JSZWV4cG9ydCA9IGxvb3NlID0+IHtcbiAgcmV0dXJuIGxvb3NlID8gX3RlbXBsYXRlKCkuZGVmYXVsdC5zdGF0ZW1lbnRgRVhQT1JUUy5FWFBPUlRfTkFNRSA9IE5BTUVTUEFDRS5JTVBPUlRfTkFNRTtgIDogX3RlbXBsYXRlKCkuZGVmYXVsdGBcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFWFBPUlRTLCBcIkVYUE9SVF9OQU1FXCIsIHtcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICByZXR1cm4gTkFNRVNQQUNFLklNUE9SVF9OQU1FO1xuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgYDtcbn07XG5cbmNvbnN0IGJ1aWxkUmVleHBvcnRzRnJvbU1ldGEgPSAobWV0YSwgbWV0YWRhdGEsIGxvb3NlKSA9PiB7XG4gIGNvbnN0IG5hbWVzcGFjZSA9IG1ldGFkYXRhLmxhenkgPyB0KCkuY2FsbEV4cHJlc3Npb24odCgpLmlkZW50aWZpZXIobWV0YWRhdGEubmFtZSksIFtdKSA6IHQoKS5pZGVudGlmaWVyKG1ldGFkYXRhLm5hbWUpO1xuICBjb25zdCB0ZW1wbGF0ZUZvckN1cnJlbnRNb2RlID0gZ2V0VGVtcGxhdGVGb3JSZWV4cG9ydChsb29zZSk7XG4gIHJldHVybiBBcnJheS5mcm9tKG1ldGFkYXRhLnJlZXhwb3J0cywgKFtleHBvcnROYW1lLCBpbXBvcnROYW1lXSkgPT4gdGVtcGxhdGVGb3JDdXJyZW50TW9kZSh7XG4gICAgRVhQT1JUUzogbWV0YS5leHBvcnROYW1lLFxuICAgIEVYUE9SVF9OQU1FOiBleHBvcnROYW1lLFxuICAgIE5BTUVTUEFDRTogdCgpLmNsb25lTm9kZShuYW1lc3BhY2UpLFxuICAgIElNUE9SVF9OQU1FOiBpbXBvcnROYW1lXG4gIH0pKTtcbn07XG5cbmZ1bmN0aW9uIGJ1aWxkRVNNb2R1bGVIZWFkZXIobWV0YWRhdGEsIGVudW1lcmFibGUgPSBmYWxzZSkge1xuICByZXR1cm4gKGVudW1lcmFibGUgPyBfdGVtcGxhdGUoKS5kZWZhdWx0LnN0YXRlbWVudGBcbiAgICAgICAgRVhQT1JUUy5fX2VzTW9kdWxlID0gdHJ1ZTtcbiAgICAgIGAgOiBfdGVtcGxhdGUoKS5kZWZhdWx0LnN0YXRlbWVudGBcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVYUE9SVFMsIFwiX19lc01vZHVsZVwiLCB7XG4gICAgICAgICAgdmFsdWU6IHRydWUsXG4gICAgICAgIH0pO1xuICAgICAgYCkoe1xuICAgIEVYUE9SVFM6IG1ldGFkYXRhLmV4cG9ydE5hbWVcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkTmFtZXNwYWNlUmVleHBvcnQobWV0YWRhdGEsIG5hbWVzcGFjZSwgbG9vc2UpIHtcbiAgcmV0dXJuIChsb29zZSA/IF90ZW1wbGF0ZSgpLmRlZmF1bHQuc3RhdGVtZW50YFxuICAgICAgICBPYmplY3Qua2V5cyhOQU1FU1BBQ0UpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgICAgaWYgKGtleSA9PT0gXCJkZWZhdWx0XCIgfHwga2V5ID09PSBcIl9fZXNNb2R1bGVcIikgcmV0dXJuO1xuICAgICAgICAgIFZFUklGWV9OQU1FX0xJU1Q7XG5cbiAgICAgICAgICBFWFBPUlRTW2tleV0gPSBOQU1FU1BBQ0Vba2V5XTtcbiAgICAgICAgfSk7XG4gICAgICBgIDogX3RlbXBsYXRlKCkuZGVmYXVsdC5zdGF0ZW1lbnRgXG4gICAgICAgIE9iamVjdC5rZXlzKE5BTUVTUEFDRSkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgICBpZiAoa2V5ID09PSBcImRlZmF1bHRcIiB8fCBrZXkgPT09IFwiX19lc01vZHVsZVwiKSByZXR1cm47XG4gICAgICAgICAgVkVSSUZZX05BTUVfTElTVDtcblxuICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFWFBPUlRTLCBrZXksIHtcbiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICByZXR1cm4gTkFNRVNQQUNFW2tleV07XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICBgKSh7XG4gICAgTkFNRVNQQUNFOiBuYW1lc3BhY2UsXG4gICAgRVhQT1JUUzogbWV0YWRhdGEuZXhwb3J0TmFtZSxcbiAgICBWRVJJRllfTkFNRV9MSVNUOiBtZXRhZGF0YS5leHBvcnROYW1lTGlzdE5hbWUgPyBfdGVtcGxhdGUoKS5kZWZhdWx0YFxuICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChFWFBPUlRTX0xJU1QsIGtleSkpIHJldHVybjtcbiAgICAgICAgICBgKHtcbiAgICAgIEVYUE9SVFNfTElTVDogbWV0YWRhdGEuZXhwb3J0TmFtZUxpc3ROYW1lXG4gICAgfSkgOiBudWxsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBidWlsZEV4cG9ydE5hbWVMaXN0RGVjbGFyYXRpb24ocHJvZ3JhbVBhdGgsIG1ldGFkYXRhKSB7XG4gIGNvbnN0IGV4cG9ydGVkVmFycyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgZm9yIChjb25zdCBkYXRhIG9mIG1ldGFkYXRhLmxvY2FsLnZhbHVlcygpKSB7XG4gICAgZm9yIChjb25zdCBuYW1lIG9mIGRhdGEubmFtZXMpIHtcbiAgICAgIGV4cG9ydGVkVmFyc1tuYW1lXSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgbGV0IGhhc1JlZXhwb3J0ID0gZmFsc2U7XG5cbiAgZm9yIChjb25zdCBkYXRhIG9mIG1ldGFkYXRhLnNvdXJjZS52YWx1ZXMoKSkge1xuICAgIGZvciAoY29uc3QgZXhwb3J0TmFtZSBvZiBkYXRhLnJlZXhwb3J0cy5rZXlzKCkpIHtcbiAgICAgIGV4cG9ydGVkVmFyc1tleHBvcnROYW1lXSA9IHRydWU7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBleHBvcnROYW1lIG9mIGRhdGEucmVleHBvcnROYW1lc3BhY2UpIHtcbiAgICAgIGV4cG9ydGVkVmFyc1tleHBvcnROYW1lXSA9IHRydWU7XG4gICAgfVxuXG4gICAgaGFzUmVleHBvcnQgPSBoYXNSZWV4cG9ydCB8fCBkYXRhLnJlZXhwb3J0QWxsO1xuICB9XG5cbiAgaWYgKCFoYXNSZWV4cG9ydCB8fCBPYmplY3Qua2V5cyhleHBvcnRlZFZhcnMpLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG4gIGNvbnN0IG5hbWUgPSBwcm9ncmFtUGF0aC5zY29wZS5nZW5lcmF0ZVVpZElkZW50aWZpZXIoXCJleHBvcnROYW1lc1wiKTtcbiAgZGVsZXRlIGV4cG9ydGVkVmFycy5kZWZhdWx0O1xuICByZXR1cm4ge1xuICAgIG5hbWU6IG5hbWUubmFtZSxcbiAgICBzdGF0ZW1lbnQ6IHQoKS52YXJpYWJsZURlY2xhcmF0aW9uKFwidmFyXCIsIFt0KCkudmFyaWFibGVEZWNsYXJhdG9yKG5hbWUsIHQoKS52YWx1ZVRvTm9kZShleHBvcnRlZFZhcnMpKV0pXG4gIH07XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRXhwb3J0SW5pdGlhbGl6YXRpb25TdGF0ZW1lbnRzKHByb2dyYW1QYXRoLCBtZXRhZGF0YSwgbG9vc2UgPSBmYWxzZSkge1xuICBjb25zdCBpbml0U3RhdGVtZW50cyA9IFtdO1xuICBjb25zdCBleHBvcnROYW1lcyA9IFtdO1xuXG4gIGZvciAoY29uc3QgW2xvY2FsTmFtZSwgZGF0YV0gb2YgbWV0YWRhdGEubG9jYWwpIHtcbiAgICBpZiAoZGF0YS5raW5kID09PSBcImltcG9ydFwiKSB7fSBlbHNlIGlmIChkYXRhLmtpbmQgPT09IFwiaG9pc3RlZFwiKSB7XG4gICAgICBpbml0U3RhdGVtZW50cy5wdXNoKGJ1aWxkSW5pdFN0YXRlbWVudChtZXRhZGF0YSwgZGF0YS5uYW1lcywgdCgpLmlkZW50aWZpZXIobG9jYWxOYW1lKSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBleHBvcnROYW1lcy5wdXNoKC4uLmRhdGEubmFtZXMpO1xuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgZGF0YSBvZiBtZXRhZGF0YS5zb3VyY2UudmFsdWVzKCkpIHtcbiAgICBpZiAoIWxvb3NlKSB7XG4gICAgICBpbml0U3RhdGVtZW50cy5wdXNoKC4uLmJ1aWxkUmVleHBvcnRzRnJvbU1ldGEobWV0YWRhdGEsIGRhdGEsIGxvb3NlKSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBleHBvcnROYW1lIG9mIGRhdGEucmVleHBvcnROYW1lc3BhY2UpIHtcbiAgICAgIGV4cG9ydE5hbWVzLnB1c2goZXhwb3J0TmFtZSk7XG4gICAgfVxuICB9XG5cbiAgaW5pdFN0YXRlbWVudHMucHVzaCguLi4oMCwgX2NodW5rKCkuZGVmYXVsdCkoZXhwb3J0TmFtZXMsIDEwMCkubWFwKG1lbWJlcnMgPT4ge1xuICAgIHJldHVybiBidWlsZEluaXRTdGF0ZW1lbnQobWV0YWRhdGEsIG1lbWJlcnMsIHByb2dyYW1QYXRoLnNjb3BlLmJ1aWxkVW5kZWZpbmVkTm9kZSgpKTtcbiAgfSkpO1xuICByZXR1cm4gaW5pdFN0YXRlbWVudHM7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkSW5pdFN0YXRlbWVudChtZXRhZGF0YSwgZXhwb3J0TmFtZXMsIGluaXRFeHByKSB7XG4gIHJldHVybiB0KCkuZXhwcmVzc2lvblN0YXRlbWVudChleHBvcnROYW1lcy5yZWR1Y2UoKGFjYywgZXhwb3J0TmFtZSkgPT4gX3RlbXBsYXRlKCkuZGVmYXVsdC5leHByZXNzaW9uYEVYUE9SVFMuTkFNRSA9IFZBTFVFYCh7XG4gICAgRVhQT1JUUzogbWV0YWRhdGEuZXhwb3J0TmFtZSxcbiAgICBOQU1FOiBleHBvcnROYW1lLFxuICAgIFZBTFVFOiBhY2NcbiAgfSksIGluaXRFeHByKSk7XG59Il19