"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = rewriteLiveReferences;

function _assert() {
  const data = _interopRequireDefault(require("assert"));

  _assert = function () {
    return data;
  };

  return data;
}

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

function _template() {
  const data = _interopRequireDefault(require("@babel/template"));

  _template = function () {
    return data;
  };

  return data;
}

function _helperSimpleAccess() {
  const data = _interopRequireDefault(require("@babel/helper-simple-access"));

  _helperSimpleAccess = function () {
    return data;
  };

  return data;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function rewriteLiveReferences(programPath, metadata) {
  const imported = new Map();
  const exported = new Map();

  const requeueInParent = path => {
    programPath.requeue(path);
  };

  for (const [source, data] of metadata.source) {
    for (const [localName, importName] of data.imports) {
      imported.set(localName, [source, importName, null]);
    }

    for (const localName of data.importsNamespace) {
      imported.set(localName, [source, null, localName]);
    }
  }

  for (const [local, data] of metadata.local) {
    let exportMeta = exported.get(local);

    if (!exportMeta) {
      exportMeta = [];
      exported.set(local, exportMeta);
    }

    exportMeta.push(...data.names);
  }

  programPath.traverse(rewriteBindingInitVisitor, {
    metadata,
    requeueInParent,
    scope: programPath.scope,
    exported
  });
  (0, _helperSimpleAccess().default)(programPath, new Set([...Array.from(imported.keys()), ...Array.from(exported.keys())]));
  programPath.traverse(rewriteReferencesVisitor, {
    seen: new WeakSet(),
    metadata,
    requeueInParent,
    scope: programPath.scope,
    imported,
    exported,
    buildImportReference: ([source, importName, localName], identNode) => {
      const meta = metadata.source.get(source);

      if (localName) {
        if (meta.lazy) identNode = t().callExpression(identNode, []);
        return identNode;
      }

      let namespace = t().identifier(meta.name);
      if (meta.lazy) namespace = t().callExpression(namespace, []);
      return t().memberExpression(namespace, t().identifier(importName));
    }
  });
}

const rewriteBindingInitVisitor = {
  ClassProperty(path) {
    path.skip();
  },

  Function(path) {
    path.skip();
  },

  ClassDeclaration(path) {
    const {
      requeueInParent,
      exported,
      metadata
    } = this;
    const {
      id
    } = path.node;
    if (!id) throw new Error("Expected class to have a name");
    const localName = id.name;
    const exportNames = exported.get(localName) || [];

    if (exportNames.length > 0) {
      const statement = t().expressionStatement(buildBindingExportAssignmentExpression(metadata, exportNames, t().identifier(localName)));
      statement._blockHoist = path.node._blockHoist;
      requeueInParent(path.insertAfter(statement)[0]);
    }
  },

  VariableDeclaration(path) {
    const {
      requeueInParent,
      exported,
      metadata
    } = this;
    Object.keys(path.getOuterBindingIdentifiers()).forEach(localName => {
      const exportNames = exported.get(localName) || [];

      if (exportNames.length > 0) {
        const statement = t().expressionStatement(buildBindingExportAssignmentExpression(metadata, exportNames, t().identifier(localName)));
        statement._blockHoist = path.node._blockHoist;
        requeueInParent(path.insertAfter(statement)[0]);
      }
    });
  }

};

const buildBindingExportAssignmentExpression = (metadata, exportNames, localExpr) => {
  return (exportNames || []).reduce((expr, exportName) => {
    return t().assignmentExpression("=", t().memberExpression(t().identifier(metadata.exportName), t().identifier(exportName)), expr);
  }, localExpr);
};

const buildImportThrow = localName => {
  return _template().default.expression.ast`
    (function() {
      throw new Error('"' + '${localName}' + '" is read-only.');
    })()
  `;
};

const rewriteReferencesVisitor = {
  ReferencedIdentifier(path) {
    const {
      seen,
      buildImportReference,
      scope,
      imported,
      requeueInParent
    } = this;
    if (seen.has(path.node)) return;
    seen.add(path.node);
    const localName = path.node.name;
    const localBinding = path.scope.getBinding(localName);
    const rootBinding = scope.getBinding(localName);
    if (rootBinding !== localBinding) return;
    const importData = imported.get(localName);

    if (importData) {
      const ref = buildImportReference(importData, path.node);
      ref.loc = path.node.loc;

      if (path.parentPath.isCallExpression({
        callee: path.node
      }) && t().isMemberExpression(ref)) {
        path.replaceWith(t().sequenceExpression([t().numericLiteral(0), ref]));
      } else if (path.isJSXIdentifier() && t().isMemberExpression(ref)) {
        const {
          object,
          property
        } = ref;
        path.replaceWith(t().JSXMemberExpression(t().JSXIdentifier(object.name), t().JSXIdentifier(property.name)));
      } else {
        path.replaceWith(ref);
      }

      requeueInParent(path);
      path.skip();
    }
  },

  AssignmentExpression: {
    exit(path) {
      const {
        scope,
        seen,
        imported,
        exported,
        requeueInParent,
        buildImportReference
      } = this;
      if (seen.has(path.node)) return;
      seen.add(path.node);
      const left = path.get("left");

      if (left.isIdentifier()) {
        const localName = left.node.name;

        if (scope.getBinding(localName) !== path.scope.getBinding(localName)) {
          return;
        }

        const exportedNames = exported.get(localName) || [];
        const importData = imported.get(localName);

        if (exportedNames.length > 0 || importData) {
          (0, _assert().default)(path.node.operator === "=", "Path was not simplified");
          const assignment = path.node;

          if (importData) {
            assignment.left = buildImportReference(importData, assignment.left);
            assignment.right = t().sequenceExpression([assignment.right, buildImportThrow(localName)]);
          }

          path.replaceWith(buildBindingExportAssignmentExpression(this.metadata, exportedNames, assignment));
          requeueInParent(path);
        }
      } else if (left.isMemberExpression()) {} else {
        const ids = left.getOuterBindingIdentifiers();
        const id = Object.keys(ids).filter(localName => imported.has(localName)).pop();

        if (id) {
          path.node.right = t().sequenceExpression([path.node.right, buildImportThrow(id)]);
        }

        const items = [];
        Object.keys(ids).forEach(localName => {
          if (scope.getBinding(localName) !== path.scope.getBinding(localName)) {
            return;
          }

          const exportedNames = exported.get(localName) || [];

          if (exportedNames.length > 0) {
            items.push(buildBindingExportAssignmentExpression(this.metadata, exportedNames, t().identifier(localName)));
          }
        });

        if (items.length > 0) {
          let node = t().sequenceExpression(items);

          if (path.parentPath.isExpressionStatement()) {
            node = t().expressionStatement(node);
            node._blockHoist = path.parentPath.node._blockHoist;
          }

          const statement = path.insertAfter(node)[0];
          requeueInParent(statement);
        }
      }
    }

  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvaGVscGVyLW1vZHVsZS10cmFuc2Zvcm1zL2xpYi9yZXdyaXRlLWxpdmUtcmVmZXJlbmNlcy5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImRlZmF1bHQiLCJyZXdyaXRlTGl2ZVJlZmVyZW5jZXMiLCJfYXNzZXJ0IiwiZGF0YSIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwidCIsIl9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkIiwiX3RlbXBsYXRlIiwiX2hlbHBlclNpbXBsZUFjY2VzcyIsIm9iaiIsIl9fZXNNb2R1bGUiLCJuZXdPYmoiLCJrZXkiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJkZXNjIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZ2V0Iiwic2V0IiwicHJvZ3JhbVBhdGgiLCJtZXRhZGF0YSIsImltcG9ydGVkIiwiTWFwIiwiZXhwb3J0ZWQiLCJyZXF1ZXVlSW5QYXJlbnQiLCJwYXRoIiwicmVxdWV1ZSIsInNvdXJjZSIsImxvY2FsTmFtZSIsImltcG9ydE5hbWUiLCJpbXBvcnRzIiwiaW1wb3J0c05hbWVzcGFjZSIsImxvY2FsIiwiZXhwb3J0TWV0YSIsInB1c2giLCJuYW1lcyIsInRyYXZlcnNlIiwicmV3cml0ZUJpbmRpbmdJbml0VmlzaXRvciIsInNjb3BlIiwiU2V0IiwiQXJyYXkiLCJmcm9tIiwia2V5cyIsInJld3JpdGVSZWZlcmVuY2VzVmlzaXRvciIsInNlZW4iLCJXZWFrU2V0IiwiYnVpbGRJbXBvcnRSZWZlcmVuY2UiLCJpZGVudE5vZGUiLCJtZXRhIiwibGF6eSIsImNhbGxFeHByZXNzaW9uIiwibmFtZXNwYWNlIiwiaWRlbnRpZmllciIsIm5hbWUiLCJtZW1iZXJFeHByZXNzaW9uIiwiQ2xhc3NQcm9wZXJ0eSIsInNraXAiLCJGdW5jdGlvbiIsIkNsYXNzRGVjbGFyYXRpb24iLCJpZCIsIm5vZGUiLCJFcnJvciIsImV4cG9ydE5hbWVzIiwibGVuZ3RoIiwic3RhdGVtZW50IiwiZXhwcmVzc2lvblN0YXRlbWVudCIsImJ1aWxkQmluZGluZ0V4cG9ydEFzc2lnbm1lbnRFeHByZXNzaW9uIiwiX2Jsb2NrSG9pc3QiLCJpbnNlcnRBZnRlciIsIlZhcmlhYmxlRGVjbGFyYXRpb24iLCJnZXRPdXRlckJpbmRpbmdJZGVudGlmaWVycyIsImZvckVhY2giLCJsb2NhbEV4cHIiLCJyZWR1Y2UiLCJleHByIiwiZXhwb3J0TmFtZSIsImFzc2lnbm1lbnRFeHByZXNzaW9uIiwiYnVpbGRJbXBvcnRUaHJvdyIsImV4cHJlc3Npb24iLCJhc3QiLCJSZWZlcmVuY2VkSWRlbnRpZmllciIsImhhcyIsImFkZCIsImxvY2FsQmluZGluZyIsImdldEJpbmRpbmciLCJyb290QmluZGluZyIsImltcG9ydERhdGEiLCJyZWYiLCJsb2MiLCJwYXJlbnRQYXRoIiwiaXNDYWxsRXhwcmVzc2lvbiIsImNhbGxlZSIsImlzTWVtYmVyRXhwcmVzc2lvbiIsInJlcGxhY2VXaXRoIiwic2VxdWVuY2VFeHByZXNzaW9uIiwibnVtZXJpY0xpdGVyYWwiLCJpc0pTWElkZW50aWZpZXIiLCJvYmplY3QiLCJwcm9wZXJ0eSIsIkpTWE1lbWJlckV4cHJlc3Npb24iLCJKU1hJZGVudGlmaWVyIiwiQXNzaWdubWVudEV4cHJlc3Npb24iLCJleGl0IiwibGVmdCIsImlzSWRlbnRpZmllciIsImV4cG9ydGVkTmFtZXMiLCJvcGVyYXRvciIsImFzc2lnbm1lbnQiLCJyaWdodCIsImlkcyIsImZpbHRlciIsInBvcCIsIml0ZW1zIiwiaXNFeHByZXNzaW9uU3RhdGVtZW50Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFr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QWIsS0FBMkIsRUFBakQ7O0FBRUEsY0FBSTZFLGFBQWEsQ0FBQzFDLE1BQWQsR0FBdUIsQ0FBM0IsRUFBOEI7QUFDNUJpRCxZQUFBQSxLQUFLLENBQUM5RSxJQUFOLENBQVdnQyxzQ0FBc0MsQ0FBQyxLQUFLOUMsUUFBTixFQUFnQnFGLGFBQWhCLEVBQStCckcsQ0FBQyxHQUFHZ0QsVUFBSixDQUFleEIsU0FBZixDQUEvQixDQUFqRDtBQUNEO0FBQ0YsU0FWRDs7QUFZQSxZQUFJb0YsS0FBSyxDQUFDakQsTUFBTixHQUFlLENBQW5CLEVBQXNCO0FBQ3BCLGNBQUlILElBQUksR0FBR3hELENBQUMsR0FBRzBGLGtCQUFKLENBQXVCa0IsS0FBdkIsQ0FBWDs7QUFFQSxjQUFJdkYsSUFBSSxDQUFDZ0UsVUFBTCxDQUFnQndCLHFCQUFoQixFQUFKLEVBQTZDO0FBQzNDckQsWUFBQUEsSUFBSSxHQUFHeEQsQ0FBQyxHQUFHNkQsbUJBQUosQ0FBd0JMLElBQXhCLENBQVA7QUFDQUEsWUFBQUEsSUFBSSxDQUFDTyxXQUFMLEdBQW1CMUMsSUFBSSxDQUFDZ0UsVUFBTCxDQUFnQjdCLElBQWhCLENBQXFCTyxXQUF4QztBQUNEOztBQUVELGdCQUFNSCxTQUFTLEdBQUd2QyxJQUFJLENBQUMyQyxXQUFMLENBQWlCUixJQUFqQixFQUF1QixDQUF2QixDQUFsQjtBQUNBcEMsVUFBQUEsZUFBZSxDQUFDd0MsU0FBRCxDQUFmO0FBQ0Q7QUFDRjtBQUNGOztBQXJFbUI7QUF4Q1MsQ0FBakMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMuZGVmYXVsdCA9IHJld3JpdGVMaXZlUmVmZXJlbmNlcztcblxuZnVuY3Rpb24gX2Fzc2VydCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcImFzc2VydFwiKSk7XG5cbiAgX2Fzc2VydCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gdCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCJAYmFiZWwvdHlwZXNcIikpO1xuXG4gIHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF90ZW1wbGF0ZSgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIkBiYWJlbC90ZW1wbGF0ZVwiKSk7XG5cbiAgX3RlbXBsYXRlID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfaGVscGVyU2ltcGxlQWNjZXNzKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiQGJhYmVsL2hlbHBlci1zaW1wbGUtYWNjZXNzXCIpKTtcblxuICBfaGVscGVyU2ltcGxlQWNjZXNzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGVsc2UgeyB2YXIgbmV3T2JqID0ge307IGlmIChvYmogIT0gbnVsbCkgeyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KSA6IHt9OyBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iaiwga2V5LCBkZXNjKTsgfSBlbHNlIHsgbmV3T2JqW2tleV0gPSBvYmpba2V5XTsgfSB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgcmV0dXJuIG5ld09iajsgfSB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIHJld3JpdGVMaXZlUmVmZXJlbmNlcyhwcm9ncmFtUGF0aCwgbWV0YWRhdGEpIHtcbiAgY29uc3QgaW1wb3J0ZWQgPSBuZXcgTWFwKCk7XG4gIGNvbnN0IGV4cG9ydGVkID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0IHJlcXVldWVJblBhcmVudCA9IHBhdGggPT4ge1xuICAgIHByb2dyYW1QYXRoLnJlcXVldWUocGF0aCk7XG4gIH07XG5cbiAgZm9yIChjb25zdCBbc291cmNlLCBkYXRhXSBvZiBtZXRhZGF0YS5zb3VyY2UpIHtcbiAgICBmb3IgKGNvbnN0IFtsb2NhbE5hbWUsIGltcG9ydE5hbWVdIG9mIGRhdGEuaW1wb3J0cykge1xuICAgICAgaW1wb3J0ZWQuc2V0KGxvY2FsTmFtZSwgW3NvdXJjZSwgaW1wb3J0TmFtZSwgbnVsbF0pO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgbG9jYWxOYW1lIG9mIGRhdGEuaW1wb3J0c05hbWVzcGFjZSkge1xuICAgICAgaW1wb3J0ZWQuc2V0KGxvY2FsTmFtZSwgW3NvdXJjZSwgbnVsbCwgbG9jYWxOYW1lXSk7XG4gICAgfVxuICB9XG5cbiAgZm9yIChjb25zdCBbbG9jYWwsIGRhdGFdIG9mIG1ldGFkYXRhLmxvY2FsKSB7XG4gICAgbGV0IGV4cG9ydE1ldGEgPSBleHBvcnRlZC5nZXQobG9jYWwpO1xuXG4gICAgaWYgKCFleHBvcnRNZXRhKSB7XG4gICAgICBleHBvcnRNZXRhID0gW107XG4gICAgICBleHBvcnRlZC5zZXQobG9jYWwsIGV4cG9ydE1ldGEpO1xuICAgIH1cblxuICAgIGV4cG9ydE1ldGEucHVzaCguLi5kYXRhLm5hbWVzKTtcbiAgfVxuXG4gIHByb2dyYW1QYXRoLnRyYXZlcnNlKHJld3JpdGVCaW5kaW5nSW5pdFZpc2l0b3IsIHtcbiAgICBtZXRhZGF0YSxcbiAgICByZXF1ZXVlSW5QYXJlbnQsXG4gICAgc2NvcGU6IHByb2dyYW1QYXRoLnNjb3BlLFxuICAgIGV4cG9ydGVkXG4gIH0pO1xuICAoMCwgX2hlbHBlclNpbXBsZUFjY2VzcygpLmRlZmF1bHQpKHByb2dyYW1QYXRoLCBuZXcgU2V0KFsuLi5BcnJheS5mcm9tKGltcG9ydGVkLmtleXMoKSksIC4uLkFycmF5LmZyb20oZXhwb3J0ZWQua2V5cygpKV0pKTtcbiAgcHJvZ3JhbVBhdGgudHJhdmVyc2UocmV3cml0ZVJlZmVyZW5jZXNWaXNpdG9yLCB7XG4gICAgc2VlbjogbmV3IFdlYWtTZXQoKSxcbiAgICBtZXRhZGF0YSxcbiAgICByZXF1ZXVlSW5QYXJlbnQsXG4gICAgc2NvcGU6IHByb2dyYW1QYXRoLnNjb3BlLFxuICAgIGltcG9ydGVkLFxuICAgIGV4cG9ydGVkLFxuICAgIGJ1aWxkSW1wb3J0UmVmZXJlbmNlOiAoW3NvdXJjZSwgaW1wb3J0TmFtZSwgbG9jYWxOYW1lXSwgaWRlbnROb2RlKSA9PiB7XG4gICAgICBjb25zdCBtZXRhID0gbWV0YWRhdGEuc291cmNlLmdldChzb3VyY2UpO1xuXG4gICAgICBpZiAobG9jYWxOYW1lKSB7XG4gICAgICAgIGlmIChtZXRhLmxhenkpIGlkZW50Tm9kZSA9IHQoKS5jYWxsRXhwcmVzc2lvbihpZGVudE5vZGUsIFtdKTtcbiAgICAgICAgcmV0dXJuIGlkZW50Tm9kZTtcbiAgICAgIH1cblxuICAgICAgbGV0IG5hbWVzcGFjZSA9IHQoKS5pZGVudGlmaWVyKG1ldGEubmFtZSk7XG4gICAgICBpZiAobWV0YS5sYXp5KSBuYW1lc3BhY2UgPSB0KCkuY2FsbEV4cHJlc3Npb24obmFtZXNwYWNlLCBbXSk7XG4gICAgICByZXR1cm4gdCgpLm1lbWJlckV4cHJlc3Npb24obmFtZXNwYWNlLCB0KCkuaWRlbnRpZmllcihpbXBvcnROYW1lKSk7XG4gICAgfVxuICB9KTtcbn1cblxuY29uc3QgcmV3cml0ZUJpbmRpbmdJbml0VmlzaXRvciA9IHtcbiAgQ2xhc3NQcm9wZXJ0eShwYXRoKSB7XG4gICAgcGF0aC5za2lwKCk7XG4gIH0sXG5cbiAgRnVuY3Rpb24ocGF0aCkge1xuICAgIHBhdGguc2tpcCgpO1xuICB9LFxuXG4gIENsYXNzRGVjbGFyYXRpb24ocGF0aCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHJlcXVldWVJblBhcmVudCxcbiAgICAgIGV4cG9ydGVkLFxuICAgICAgbWV0YWRhdGFcbiAgICB9ID0gdGhpcztcbiAgICBjb25zdCB7XG4gICAgICBpZFxuICAgIH0gPSBwYXRoLm5vZGU7XG4gICAgaWYgKCFpZCkgdGhyb3cgbmV3IEVycm9yKFwiRXhwZWN0ZWQgY2xhc3MgdG8gaGF2ZSBhIG5hbWVcIik7XG4gICAgY29uc3QgbG9jYWxOYW1lID0gaWQubmFtZTtcbiAgICBjb25zdCBleHBvcnROYW1lcyA9IGV4cG9ydGVkLmdldChsb2NhbE5hbWUpIHx8IFtdO1xuXG4gICAgaWYgKGV4cG9ydE5hbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHN0YXRlbWVudCA9IHQoKS5leHByZXNzaW9uU3RhdGVtZW50KGJ1aWxkQmluZGluZ0V4cG9ydEFzc2lnbm1lbnRFeHByZXNzaW9uKG1ldGFkYXRhLCBleHBvcnROYW1lcywgdCgpLmlkZW50aWZpZXIobG9jYWxOYW1lKSkpO1xuICAgICAgc3RhdGVtZW50Ll9ibG9ja0hvaXN0ID0gcGF0aC5ub2RlLl9ibG9ja0hvaXN0O1xuICAgICAgcmVxdWV1ZUluUGFyZW50KHBhdGguaW5zZXJ0QWZ0ZXIoc3RhdGVtZW50KVswXSk7XG4gICAgfVxuICB9LFxuXG4gIFZhcmlhYmxlRGVjbGFyYXRpb24ocGF0aCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHJlcXVldWVJblBhcmVudCxcbiAgICAgIGV4cG9ydGVkLFxuICAgICAgbWV0YWRhdGFcbiAgICB9ID0gdGhpcztcbiAgICBPYmplY3Qua2V5cyhwYXRoLmdldE91dGVyQmluZGluZ0lkZW50aWZpZXJzKCkpLmZvckVhY2gobG9jYWxOYW1lID0+IHtcbiAgICAgIGNvbnN0IGV4cG9ydE5hbWVzID0gZXhwb3J0ZWQuZ2V0KGxvY2FsTmFtZSkgfHwgW107XG5cbiAgICAgIGlmIChleHBvcnROYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlbWVudCA9IHQoKS5leHByZXNzaW9uU3RhdGVtZW50KGJ1aWxkQmluZGluZ0V4cG9ydEFzc2lnbm1lbnRFeHByZXNzaW9uKG1ldGFkYXRhLCBleHBvcnROYW1lcywgdCgpLmlkZW50aWZpZXIobG9jYWxOYW1lKSkpO1xuICAgICAgICBzdGF0ZW1lbnQuX2Jsb2NrSG9pc3QgPSBwYXRoLm5vZGUuX2Jsb2NrSG9pc3Q7XG4gICAgICAgIHJlcXVldWVJblBhcmVudChwYXRoLmluc2VydEFmdGVyKHN0YXRlbWVudClbMF0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbn07XG5cbmNvbnN0IGJ1aWxkQmluZGluZ0V4cG9ydEFzc2lnbm1lbnRFeHByZXNzaW9uID0gKG1ldGFkYXRhLCBleHBvcnROYW1lcywgbG9jYWxFeHByKSA9PiB7XG4gIHJldHVybiAoZXhwb3J0TmFtZXMgfHwgW10pLnJlZHVjZSgoZXhwciwgZXhwb3J0TmFtZSkgPT4ge1xuICAgIHJldHVybiB0KCkuYXNzaWdubWVudEV4cHJlc3Npb24oXCI9XCIsIHQoKS5tZW1iZXJFeHByZXNzaW9uKHQoKS5pZGVudGlmaWVyKG1ldGFkYXRhLmV4cG9ydE5hbWUpLCB0KCkuaWRlbnRpZmllcihleHBvcnROYW1lKSksIGV4cHIpO1xuICB9LCBsb2NhbEV4cHIpO1xufTtcblxuY29uc3QgYnVpbGRJbXBvcnRUaHJvdyA9IGxvY2FsTmFtZSA9PiB7XG4gIHJldHVybiBfdGVtcGxhdGUoKS5kZWZhdWx0LmV4cHJlc3Npb24uYXN0YFxuICAgIChmdW5jdGlvbigpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignXCInICsgJyR7bG9jYWxOYW1lfScgKyAnXCIgaXMgcmVhZC1vbmx5LicpO1xuICAgIH0pKClcbiAgYDtcbn07XG5cbmNvbnN0IHJld3JpdGVSZWZlcmVuY2VzVmlzaXRvciA9IHtcbiAgUmVmZXJlbmNlZElkZW50aWZpZXIocGF0aCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHNlZW4sXG4gICAgICBidWlsZEltcG9ydFJlZmVyZW5jZSxcbiAgICAgIHNjb3BlLFxuICAgICAgaW1wb3J0ZWQsXG4gICAgICByZXF1ZXVlSW5QYXJlbnRcbiAgICB9ID0gdGhpcztcbiAgICBpZiAoc2Vlbi5oYXMocGF0aC5ub2RlKSkgcmV0dXJuO1xuICAgIHNlZW4uYWRkKHBhdGgubm9kZSk7XG4gICAgY29uc3QgbG9jYWxOYW1lID0gcGF0aC5ub2RlLm5hbWU7XG4gICAgY29uc3QgbG9jYWxCaW5kaW5nID0gcGF0aC5zY29wZS5nZXRCaW5kaW5nKGxvY2FsTmFtZSk7XG4gICAgY29uc3Qgcm9vdEJpbmRpbmcgPSBzY29wZS5nZXRCaW5kaW5nKGxvY2FsTmFtZSk7XG4gICAgaWYgKHJvb3RCaW5kaW5nICE9PSBsb2NhbEJpbmRpbmcpIHJldHVybjtcbiAgICBjb25zdCBpbXBvcnREYXRhID0gaW1wb3J0ZWQuZ2V0KGxvY2FsTmFtZSk7XG5cbiAgICBpZiAoaW1wb3J0RGF0YSkge1xuICAgICAgY29uc3QgcmVmID0gYnVpbGRJbXBvcnRSZWZlcmVuY2UoaW1wb3J0RGF0YSwgcGF0aC5ub2RlKTtcbiAgICAgIHJlZi5sb2MgPSBwYXRoLm5vZGUubG9jO1xuXG4gICAgICBpZiAocGF0aC5wYXJlbnRQYXRoLmlzQ2FsbEV4cHJlc3Npb24oe1xuICAgICAgICBjYWxsZWU6IHBhdGgubm9kZVxuICAgICAgfSkgJiYgdCgpLmlzTWVtYmVyRXhwcmVzc2lvbihyZWYpKSB7XG4gICAgICAgIHBhdGgucmVwbGFjZVdpdGgodCgpLnNlcXVlbmNlRXhwcmVzc2lvbihbdCgpLm51bWVyaWNMaXRlcmFsKDApLCByZWZdKSk7XG4gICAgICB9IGVsc2UgaWYgKHBhdGguaXNKU1hJZGVudGlmaWVyKCkgJiYgdCgpLmlzTWVtYmVyRXhwcmVzc2lvbihyZWYpKSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICBvYmplY3QsXG4gICAgICAgICAgcHJvcGVydHlcbiAgICAgICAgfSA9IHJlZjtcbiAgICAgICAgcGF0aC5yZXBsYWNlV2l0aCh0KCkuSlNYTWVtYmVyRXhwcmVzc2lvbih0KCkuSlNYSWRlbnRpZmllcihvYmplY3QubmFtZSksIHQoKS5KU1hJZGVudGlmaWVyKHByb3BlcnR5Lm5hbWUpKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXRoLnJlcGxhY2VXaXRoKHJlZik7XG4gICAgICB9XG5cbiAgICAgIHJlcXVldWVJblBhcmVudChwYXRoKTtcbiAgICAgIHBhdGguc2tpcCgpO1xuICAgIH1cbiAgfSxcblxuICBBc3NpZ25tZW50RXhwcmVzc2lvbjoge1xuICAgIGV4aXQocGF0aCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBzY29wZSxcbiAgICAgICAgc2VlbixcbiAgICAgICAgaW1wb3J0ZWQsXG4gICAgICAgIGV4cG9ydGVkLFxuICAgICAgICByZXF1ZXVlSW5QYXJlbnQsXG4gICAgICAgIGJ1aWxkSW1wb3J0UmVmZXJlbmNlXG4gICAgICB9ID0gdGhpcztcbiAgICAgIGlmIChzZWVuLmhhcyhwYXRoLm5vZGUpKSByZXR1cm47XG4gICAgICBzZWVuLmFkZChwYXRoLm5vZGUpO1xuICAgICAgY29uc3QgbGVmdCA9IHBhdGguZ2V0KFwibGVmdFwiKTtcblxuICAgICAgaWYgKGxlZnQuaXNJZGVudGlmaWVyKCkpIHtcbiAgICAgICAgY29uc3QgbG9jYWxOYW1lID0gbGVmdC5ub2RlLm5hbWU7XG5cbiAgICAgICAgaWYgKHNjb3BlLmdldEJpbmRpbmcobG9jYWxOYW1lKSAhPT0gcGF0aC5zY29wZS5nZXRCaW5kaW5nKGxvY2FsTmFtZSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBleHBvcnRlZE5hbWVzID0gZXhwb3J0ZWQuZ2V0KGxvY2FsTmFtZSkgfHwgW107XG4gICAgICAgIGNvbnN0IGltcG9ydERhdGEgPSBpbXBvcnRlZC5nZXQobG9jYWxOYW1lKTtcblxuICAgICAgICBpZiAoZXhwb3J0ZWROYW1lcy5sZW5ndGggPiAwIHx8IGltcG9ydERhdGEpIHtcbiAgICAgICAgICAoMCwgX2Fzc2VydCgpLmRlZmF1bHQpKHBhdGgubm9kZS5vcGVyYXRvciA9PT0gXCI9XCIsIFwiUGF0aCB3YXMgbm90IHNpbXBsaWZpZWRcIik7XG4gICAgICAgICAgY29uc3QgYXNzaWdubWVudCA9IHBhdGgubm9kZTtcblxuICAgICAgICAgIGlmIChpbXBvcnREYXRhKSB7XG4gICAgICAgICAgICBhc3NpZ25tZW50LmxlZnQgPSBidWlsZEltcG9ydFJlZmVyZW5jZShpbXBvcnREYXRhLCBhc3NpZ25tZW50LmxlZnQpO1xuICAgICAgICAgICAgYXNzaWdubWVudC5yaWdodCA9IHQoKS5zZXF1ZW5jZUV4cHJlc3Npb24oW2Fzc2lnbm1lbnQucmlnaHQsIGJ1aWxkSW1wb3J0VGhyb3cobG9jYWxOYW1lKV0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHBhdGgucmVwbGFjZVdpdGgoYnVpbGRCaW5kaW5nRXhwb3J0QXNzaWdubWVudEV4cHJlc3Npb24odGhpcy5tZXRhZGF0YSwgZXhwb3J0ZWROYW1lcywgYXNzaWdubWVudCkpO1xuICAgICAgICAgIHJlcXVldWVJblBhcmVudChwYXRoKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChsZWZ0LmlzTWVtYmVyRXhwcmVzc2lvbigpKSB7fSBlbHNlIHtcbiAgICAgICAgY29uc3QgaWRzID0gbGVmdC5nZXRPdXRlckJpbmRpbmdJZGVudGlmaWVycygpO1xuICAgICAgICBjb25zdCBpZCA9IE9iamVjdC5rZXlzKGlkcykuZmlsdGVyKGxvY2FsTmFtZSA9PiBpbXBvcnRlZC5oYXMobG9jYWxOYW1lKSkucG9wKCk7XG5cbiAgICAgICAgaWYgKGlkKSB7XG4gICAgICAgICAgcGF0aC5ub2RlLnJpZ2h0ID0gdCgpLnNlcXVlbmNlRXhwcmVzc2lvbihbcGF0aC5ub2RlLnJpZ2h0LCBidWlsZEltcG9ydFRocm93KGlkKV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgaXRlbXMgPSBbXTtcbiAgICAgICAgT2JqZWN0LmtleXMoaWRzKS5mb3JFYWNoKGxvY2FsTmFtZSA9PiB7XG4gICAgICAgICAgaWYgKHNjb3BlLmdldEJpbmRpbmcobG9jYWxOYW1lKSAhPT0gcGF0aC5zY29wZS5nZXRCaW5kaW5nKGxvY2FsTmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBleHBvcnRlZE5hbWVzID0gZXhwb3J0ZWQuZ2V0KGxvY2FsTmFtZSkgfHwgW107XG5cbiAgICAgICAgICBpZiAoZXhwb3J0ZWROYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpdGVtcy5wdXNoKGJ1aWxkQmluZGluZ0V4cG9ydEFzc2lnbm1lbnRFeHByZXNzaW9uKHRoaXMubWV0YWRhdGEsIGV4cG9ydGVkTmFtZXMsIHQoKS5pZGVudGlmaWVyKGxvY2FsTmFtZSkpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgbGV0IG5vZGUgPSB0KCkuc2VxdWVuY2VFeHByZXNzaW9uKGl0ZW1zKTtcblxuICAgICAgICAgIGlmIChwYXRoLnBhcmVudFBhdGguaXNFeHByZXNzaW9uU3RhdGVtZW50KCkpIHtcbiAgICAgICAgICAgIG5vZGUgPSB0KCkuZXhwcmVzc2lvblN0YXRlbWVudChub2RlKTtcbiAgICAgICAgICAgIG5vZGUuX2Jsb2NrSG9pc3QgPSBwYXRoLnBhcmVudFBhdGgubm9kZS5fYmxvY2tIb2lzdDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBzdGF0ZW1lbnQgPSBwYXRoLmluc2VydEFmdGVyKG5vZGUpWzBdO1xuICAgICAgICAgIHJlcXVldWVJblBhcmVudChzdGF0ZW1lbnQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gIH1cbn07Il19