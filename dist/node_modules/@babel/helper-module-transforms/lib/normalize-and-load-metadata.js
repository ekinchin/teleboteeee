"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.hasExports = hasExports;
exports.isSideEffectImport = isSideEffectImport;
exports.default = normalizeModuleAndLoadMetadata;

function _path() {
  const data = require("path");

  _path = function () {
    return data;
  };

  return data;
}

function _helperSplitExportDeclaration() {
  const data = _interopRequireDefault(require("@babel/helper-split-export-declaration"));

  _helperSplitExportDeclaration = function () {
    return data;
  };

  return data;
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function hasExports(metadata) {
  const {
    local,
    source
  } = metadata;
  return local.size > 0 || Array.from(source).some(([, meta]) => {
    return meta.reexports.size > 0 || meta.reexportNamespace.size > 0 || !!meta.reexportAll;
  });
}

function isSideEffectImport(source) {
  return source.imports.size === 0 && source.importsNamespace.size === 0 && source.reexports.size === 0 && source.reexportNamespace.size === 0 && !source.reexportAll;
}

function normalizeModuleAndLoadMetadata(programPath, exportName, {
  noInterop = false,
  loose = false,
  lazy = false,
  esNamespaceOnly = false
} = {}) {
  if (!exportName) {
    exportName = programPath.scope.generateUidIdentifier("exports").name;
  }

  nameAnonymousExports(programPath);
  const {
    local,
    source
  } = getModuleMetadata(programPath, {
    loose,
    lazy
  });
  removeModuleDeclarations(programPath);

  for (const [, metadata] of source) {
    if (metadata.importsNamespace.size > 0) {
      metadata.name = metadata.importsNamespace.values().next().value;
    }

    if (noInterop) metadata.interop = "none";else if (esNamespaceOnly) {
      if (metadata.interop === "namespace") {
        metadata.interop = "default";
      }
    }
  }

  return {
    exportName,
    exportNameListName: null,
    local,
    source
  };
}

function getModuleMetadata(programPath, {
  loose,
  lazy
}) {
  const localData = getLocalExportMetadata(programPath, loose);
  const sourceData = new Map();

  const getData = sourceNode => {
    const source = sourceNode.value;
    let data = sourceData.get(source);

    if (!data) {
      data = {
        name: programPath.scope.generateUidIdentifier((0, _path().basename)(source, (0, _path().extname)(source))).name,
        interop: "none",
        loc: null,
        imports: new Map(),
        importsNamespace: new Set(),
        reexports: new Map(),
        reexportNamespace: new Set(),
        reexportAll: null,
        lazy: false
      };
      sourceData.set(source, data);
    }

    return data;
  };

  programPath.get("body").forEach(child => {
    if (child.isImportDeclaration()) {
      const data = getData(child.node.source);
      if (!data.loc) data.loc = child.node.loc;
      child.get("specifiers").forEach(spec => {
        if (spec.isImportDefaultSpecifier()) {
          const localName = spec.get("local").node.name;
          data.imports.set(localName, "default");
          const reexport = localData.get(localName);

          if (reexport) {
            localData.delete(localName);
            reexport.names.forEach(name => {
              data.reexports.set(name, "default");
            });
          }
        } else if (spec.isImportNamespaceSpecifier()) {
          const localName = spec.get("local").node.name;
          data.importsNamespace.add(localName);
          const reexport = localData.get(localName);

          if (reexport) {
            localData.delete(localName);
            reexport.names.forEach(name => {
              data.reexportNamespace.add(name);
            });
          }
        } else if (spec.isImportSpecifier()) {
          const importName = spec.get("imported").node.name;
          const localName = spec.get("local").node.name;
          data.imports.set(localName, importName);
          const reexport = localData.get(localName);

          if (reexport) {
            localData.delete(localName);
            reexport.names.forEach(name => {
              data.reexports.set(name, importName);
            });
          }
        }
      });
    } else if (child.isExportAllDeclaration()) {
      const data = getData(child.node.source);
      if (!data.loc) data.loc = child.node.loc;
      data.reexportAll = {
        loc: child.node.loc
      };
    } else if (child.isExportNamedDeclaration() && child.node.source) {
      const data = getData(child.node.source);
      if (!data.loc) data.loc = child.node.loc;
      child.get("specifiers").forEach(spec => {
        if (!spec.isExportSpecifier()) {
          throw spec.buildCodeFrameError("Unexpected export specifier type");
        }

        const importName = spec.get("local").node.name;
        const exportName = spec.get("exported").node.name;
        data.reexports.set(exportName, importName);

        if (exportName === "__esModule") {
          throw exportName.buildCodeFrameError('Illegal export "__esModule".');
        }
      });
    }
  });

  for (const metadata of sourceData.values()) {
    let needsDefault = false;
    let needsNamed = false;

    if (metadata.importsNamespace.size > 0) {
      needsDefault = true;
      needsNamed = true;
    }

    if (metadata.reexportAll) {
      needsNamed = true;
    }

    for (const importName of metadata.imports.values()) {
      if (importName === "default") needsDefault = true;else needsNamed = true;
    }

    for (const importName of metadata.reexports.values()) {
      if (importName === "default") needsDefault = true;else needsNamed = true;
    }

    if (needsDefault && needsNamed) {
      metadata.interop = "namespace";
    } else if (needsDefault) {
      metadata.interop = "default";
    }
  }

  for (const [source, metadata] of sourceData) {
    if (lazy !== false && !(isSideEffectImport(metadata) || metadata.reexportAll)) {
      if (lazy === true) {
        metadata.lazy = !/\./.test(source);
      } else if (Array.isArray(lazy)) {
        metadata.lazy = lazy.indexOf(source);
      } else if (typeof lazy === "function") {
        metadata.lazy = lazy(source);
      } else {
        throw new Error(`.lazy must be a boolean, string array, or function`);
      }
    }
  }

  return {
    local: localData,
    source: sourceData
  };
}

function getLocalExportMetadata(programPath, loose) {
  const bindingKindLookup = new Map();
  programPath.get("body").forEach(child => {
    let kind;

    if (child.isImportDeclaration()) {
      kind = "import";
    } else {
      if (child.isExportDefaultDeclaration()) child = child.get("declaration");

      if (child.isExportNamedDeclaration()) {
        if (child.node.declaration) {
          child = child.get("declaration");
        } else if (loose && child.node.source && child.get("source").isStringLiteral()) {
          child.node.specifiers.forEach(specifier => {
            bindingKindLookup.set(specifier.local.name, "block");
          });
          return;
        }
      }

      if (child.isFunctionDeclaration()) {
        kind = "hoisted";
      } else if (child.isClassDeclaration()) {
        kind = "block";
      } else if (child.isVariableDeclaration({
        kind: "var"
      })) {
        kind = "var";
      } else if (child.isVariableDeclaration()) {
        kind = "block";
      } else {
        return;
      }
    }

    Object.keys(child.getOuterBindingIdentifiers()).forEach(name => {
      bindingKindLookup.set(name, kind);
    });
  });
  const localMetadata = new Map();

  const getLocalMetadata = idPath => {
    const localName = idPath.node.name;
    let metadata = localMetadata.get(localName);

    if (!metadata) {
      const kind = bindingKindLookup.get(localName);

      if (kind === undefined) {
        throw idPath.buildCodeFrameError(`Exporting local "${localName}", which is not declared.`);
      }

      metadata = {
        names: [],
        kind
      };
      localMetadata.set(localName, metadata);
    }

    return metadata;
  };

  programPath.get("body").forEach(child => {
    if (child.isExportNamedDeclaration() && (loose || !child.node.source)) {
      if (child.node.declaration) {
        const declaration = child.get("declaration");
        const ids = declaration.getOuterBindingIdentifierPaths();
        Object.keys(ids).forEach(name => {
          if (name === "__esModule") {
            throw declaration.buildCodeFrameError('Illegal export "__esModule".');
          }

          getLocalMetadata(ids[name]).names.push(name);
        });
      } else {
        child.get("specifiers").forEach(spec => {
          const local = spec.get("local");
          const exported = spec.get("exported");

          if (exported.node.name === "__esModule") {
            throw exported.buildCodeFrameError('Illegal export "__esModule".');
          }

          getLocalMetadata(local).names.push(exported.node.name);
        });
      }
    } else if (child.isExportDefaultDeclaration()) {
      const declaration = child.get("declaration");

      if (declaration.isFunctionDeclaration() || declaration.isClassDeclaration()) {
        getLocalMetadata(declaration.get("id")).names.push("default");
      } else {
        throw declaration.buildCodeFrameError("Unexpected default expression export.");
      }
    }
  });
  return localMetadata;
}

function nameAnonymousExports(programPath) {
  programPath.get("body").forEach(child => {
    if (!child.isExportDefaultDeclaration()) return;
    (0, _helperSplitExportDeclaration().default)(child);
  });
}

function removeModuleDeclarations(programPath) {
  programPath.get("body").forEach(child => {
    if (child.isImportDeclaration()) {
      child.remove();
    } else if (child.isExportNamedDeclaration()) {
      if (child.node.declaration) {
        child.node.declaration._blockHoist = child.node._blockHoist;
        child.replaceWith(child.node.declaration);
      } else {
        child.remove();
      }
    } else if (child.isExportDefaultDeclaration()) {
      const declaration = child.get("declaration");

      if (declaration.isFunctionDeclaration() || declaration.isClassDeclaration()) {
        declaration._blockHoist = child.node._blockHoist;
        child.replaceWith(declaration);
      } else {
        throw declaration.buildCodeFrameError("Unexpected default expression export.");
      }
    } else if (child.isExportAllDeclaration()) {
      child.remove();
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvaGVscGVyLW1vZHVsZS10cmFuc2Zvcm1zL2xpYi9ub3JtYWxpemUtYW5kLWxvYWQtbWV0YWRhdGEuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJoYXNFeHBvcnRzIiwiaXNTaWRlRWZmZWN0SW1wb3J0IiwiZGVmYXVsdCIsIm5vcm1hbGl6ZU1vZHVsZUFuZExvYWRNZXRhZGF0YSIsIl9wYXRoIiwiZGF0YSIsInJlcXVpcmUiLCJfaGVscGVyU3BsaXRFeHBvcnREZWNsYXJhdGlvbiIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJvYmoiLCJfX2VzTW9kdWxlIiwibWV0YWRhdGEiLCJsb2NhbCIsInNvdXJjZSIsInNpemUiLCJBcnJheSIsImZyb20iLCJzb21lIiwibWV0YSIsInJlZXhwb3J0cyIsInJlZXhwb3J0TmFtZXNwYWNlIiwicmVleHBvcnRBbGwiLCJpbXBvcnRzIiwiaW1wb3J0c05hbWVzcGFjZSIsInByb2dyYW1QYXRoIiwiZXhwb3J0TmFtZSIsIm5vSW50ZXJvcCIsImxvb3NlIiwibGF6eSIsImVzTmFtZXNwYWNlT25seSIsInNjb3BlIiwiZ2VuZXJhdGVVaWRJZGVudGlmaWVyIiwibmFtZSIsIm5hbWVBbm9ueW1vdXNFeHBvcnRzIiwiZ2V0TW9kdWxlTWV0YWRhdGEiLCJyZW1vdmVNb2R1bGVEZWNsYXJhdGlvbnMiLCJ2YWx1ZXMiLCJuZXh0IiwiaW50ZXJvcCIsImV4cG9ydE5hbWVMaXN0TmFtZSIsImxvY2FsRGF0YSIsImdldExvY2FsRXhwb3J0TWV0YWRhdGEiLCJzb3VyY2VEYXRhIiwiTWFwIiwiZ2V0RGF0YSIsInNvdXJjZU5vZGUiLCJnZXQiLCJiYXNlbmFtZSIsImV4dG5hbWUiLCJsb2MiLCJTZXQiLCJzZXQiLCJmb3JFYWNoIiwiY2hpbGQiLCJpc0ltcG9ydERlY2xhcmF0aW9uIiwibm9kZSIsInNwZWMiLCJpc0ltcG9ydERlZmF1bHRTcGVjaWZpZXIiLCJsb2NhbE5hbWUiLCJyZWV4cG9ydCIsImRlbGV0ZSIsIm5hbWVzIiwiaXNJbXBvcnROYW1lc3BhY2VTcGVjaWZpZXIiLCJhZGQiLCJpc0ltcG9ydFNwZWNpZmllciIsImltcG9ydE5hbWUiLCJpc0V4cG9ydEFsbERlY2xhcmF0aW9uIiwiaXNFeHBvcnROYW1lZERlY2xhcmF0aW9uIiwiaXNFeHBvcnRTcGVjaWZpZXIiLCJidWlsZENvZGVGcmFtZUVycm9yIiwibmVlZHNEZWZhdWx0IiwibmVlZHNOYW1lZCIsInRlc3QiLCJpc0FycmF5IiwiaW5kZXhPZiIsIkVycm9yIiwiYmluZGluZ0tpbmRMb29rdXAiLCJraW5kIiwiaXNFeHBvcnREZWZhdWx0RGVjbGFyYXRpb24iLCJkZWNsYXJhdGlvbiIsImlzU3RyaW5nTGl0ZXJhbCIsInNwZWNpZmllcnMiLCJzcGVjaWZpZXIiLCJpc0Z1bmN0aW9uRGVjbGFyYXRpb24iLCJpc0NsYXNzRGVjbGFyYXRpb24iLCJpc1ZhcmlhYmxlRGVjbGFyYXRpb24iLCJrZXlzIiwiZ2V0T3V0ZXJCaW5kaW5nSWRlbnRpZmllcnMiLCJsb2NhbE1ldGFkYXRhIiwiZ2V0TG9jYWxNZXRhZGF0YSIsImlkUGF0aCIsInVuZGVmaW5lZCIsImlkcyIsImdldE91dGVyQmluZGluZ0lkZW50aWZpZXJQYXRocyIsInB1c2giLCJleHBvcnRlZCIsInJlbW92ZSIsIl9ibG9ja0hvaXN0IiwicmVwbGFjZVdpdGgiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQzNDQyxFQUFBQSxLQUFLLEVBQUU7QUFEb0MsQ0FBN0M7QUFHQUQsT0FBTyxDQUFDRSxVQUFSLEdBQXFCQSxVQUFyQjtBQUNBRixPQUFPLENBQUNHLGtCQUFSLEdBQTZCQSxrQkFBN0I7QUFDQUgsT0FBTyxDQUFDSSxPQUFSLEdBQWtCQyw4QkFBbEI7O0FBRUEsU0FBU0MsS0FBVCxHQUFpQjtBQUNm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ZSBzdHJpY3RcIjtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMuaGFzRXhwb3J0cyA9IGhhc0V4cG9ydHM7XG5leHBvcnRzLmlzU2lkZUVmZmVjdEltcG9ydCA9IGlzU2lkZUVmZmVjdEltcG9ydDtcbmV4cG9ydHMuZGVmYXVsdCA9IG5vcm1hbGl6ZU1vZHVsZUFuZExvYWRNZXRhZGF0YTtcblxuZnVuY3Rpb24gX3BhdGgoKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKFwicGF0aFwiKTtcblxuICBfcGF0aCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX2hlbHBlclNwbGl0RXhwb3J0RGVjbGFyYXRpb24oKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJAYmFiZWwvaGVscGVyLXNwbGl0LWV4cG9ydC1kZWNsYXJhdGlvblwiKSk7XG5cbiAgX2hlbHBlclNwbGl0RXhwb3J0RGVjbGFyYXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIGhhc0V4cG9ydHMobWV0YWRhdGEpIHtcbiAgY29uc3Qge1xuICAgIGxvY2FsLFxuICAgIHNvdXJjZVxuICB9ID0gbWV0YWRhdGE7XG4gIHJldHVybiBsb2NhbC5zaXplID4gMCB8fCBBcnJheS5mcm9tKHNvdXJjZSkuc29tZSgoWywgbWV0YV0pID0+IHtcbiAgICByZXR1cm4gbWV0YS5yZWV4cG9ydHMuc2l6ZSA+IDAgfHwgbWV0YS5yZWV4cG9ydE5hbWVzcGFjZS5zaXplID4gMCB8fCAhIW1ldGEucmVleHBvcnRBbGw7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpc1NpZGVFZmZlY3RJbXBvcnQoc291cmNlKSB7XG4gIHJldHVybiBzb3VyY2UuaW1wb3J0cy5zaXplID09PSAwICYmIHNvdXJjZS5pbXBvcnRzTmFtZXNwYWNlLnNpemUgPT09IDAgJiYgc291cmNlLnJlZXhwb3J0cy5zaXplID09PSAwICYmIHNvdXJjZS5yZWV4cG9ydE5hbWVzcGFjZS5zaXplID09PSAwICYmICFzb3VyY2UucmVleHBvcnRBbGw7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZU1vZHVsZUFuZExvYWRNZXRhZGF0YShwcm9ncmFtUGF0aCwgZXhwb3J0TmFtZSwge1xuICBub0ludGVyb3AgPSBmYWxzZSxcbiAgbG9vc2UgPSBmYWxzZSxcbiAgbGF6eSA9IGZhbHNlLFxuICBlc05hbWVzcGFjZU9ubHkgPSBmYWxzZVxufSA9IHt9KSB7XG4gIGlmICghZXhwb3J0TmFtZSkge1xuICAgIGV4cG9ydE5hbWUgPSBwcm9ncmFtUGF0aC5zY29wZS5nZW5lcmF0ZVVpZElkZW50aWZpZXIoXCJleHBvcnRzXCIpLm5hbWU7XG4gIH1cblxuICBuYW1lQW5vbnltb3VzRXhwb3J0cyhwcm9ncmFtUGF0aCk7XG4gIGNvbnN0IHtcbiAgICBsb2NhbCxcbiAgICBzb3VyY2VcbiAgfSA9IGdldE1vZHVsZU1ldGFkYXRhKHByb2dyYW1QYXRoLCB7XG4gICAgbG9vc2UsXG4gICAgbGF6eVxuICB9KTtcbiAgcmVtb3ZlTW9kdWxlRGVjbGFyYXRpb25zKHByb2dyYW1QYXRoKTtcblxuICBmb3IgKGNvbnN0IFssIG1ldGFkYXRhXSBvZiBzb3VyY2UpIHtcbiAgICBpZiAobWV0YWRhdGEuaW1wb3J0c05hbWVzcGFjZS5zaXplID4gMCkge1xuICAgICAgbWV0YWRhdGEubmFtZSA9IG1ldGFkYXRhLmltcG9ydHNOYW1lc3BhY2UudmFsdWVzKCkubmV4dCgpLnZhbHVlO1xuICAgIH1cblxuICAgIGlmIChub0ludGVyb3ApIG1ldGFkYXRhLmludGVyb3AgPSBcIm5vbmVcIjtlbHNlIGlmIChlc05hbWVzcGFjZU9ubHkpIHtcbiAgICAgIGlmIChtZXRhZGF0YS5pbnRlcm9wID09PSBcIm5hbWVzcGFjZVwiKSB7XG4gICAgICAgIG1ldGFkYXRhLmludGVyb3AgPSBcImRlZmF1bHRcIjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGV4cG9ydE5hbWUsXG4gICAgZXhwb3J0TmFtZUxpc3ROYW1lOiBudWxsLFxuICAgIGxvY2FsLFxuICAgIHNvdXJjZVxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRNb2R1bGVNZXRhZGF0YShwcm9ncmFtUGF0aCwge1xuICBsb29zZSxcbiAgbGF6eVxufSkge1xuICBjb25zdCBsb2NhbERhdGEgPSBnZXRMb2NhbEV4cG9ydE1ldGFkYXRhKHByb2dyYW1QYXRoLCBsb29zZSk7XG4gIGNvbnN0IHNvdXJjZURhdGEgPSBuZXcgTWFwKCk7XG5cbiAgY29uc3QgZ2V0RGF0YSA9IHNvdXJjZU5vZGUgPT4ge1xuICAgIGNvbnN0IHNvdXJjZSA9IHNvdXJjZU5vZGUudmFsdWU7XG4gICAgbGV0IGRhdGEgPSBzb3VyY2VEYXRhLmdldChzb3VyY2UpO1xuXG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICBkYXRhID0ge1xuICAgICAgICBuYW1lOiBwcm9ncmFtUGF0aC5zY29wZS5nZW5lcmF0ZVVpZElkZW50aWZpZXIoKDAsIF9wYXRoKCkuYmFzZW5hbWUpKHNvdXJjZSwgKDAsIF9wYXRoKCkuZXh0bmFtZSkoc291cmNlKSkpLm5hbWUsXG4gICAgICAgIGludGVyb3A6IFwibm9uZVwiLFxuICAgICAgICBsb2M6IG51bGwsXG4gICAgICAgIGltcG9ydHM6IG5ldyBNYXAoKSxcbiAgICAgICAgaW1wb3J0c05hbWVzcGFjZTogbmV3IFNldCgpLFxuICAgICAgICByZWV4cG9ydHM6IG5ldyBNYXAoKSxcbiAgICAgICAgcmVleHBvcnROYW1lc3BhY2U6IG5ldyBTZXQoKSxcbiAgICAgICAgcmVleHBvcnRBbGw6IG51bGwsXG4gICAgICAgIGxhenk6IGZhbHNlXG4gICAgICB9O1xuICAgICAgc291cmNlRGF0YS5zZXQoc291cmNlLCBkYXRhKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICBwcm9ncmFtUGF0aC5nZXQoXCJib2R5XCIpLmZvckVhY2goY2hpbGQgPT4ge1xuICAgIGlmIChjaGlsZC5pc0ltcG9ydERlY2xhcmF0aW9uKCkpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBnZXREYXRhKGNoaWxkLm5vZGUuc291cmNlKTtcbiAgICAgIGlmICghZGF0YS5sb2MpIGRhdGEubG9jID0gY2hpbGQubm9kZS5sb2M7XG4gICAgICBjaGlsZC5nZXQoXCJzcGVjaWZpZXJzXCIpLmZvckVhY2goc3BlYyA9PiB7XG4gICAgICAgIGlmIChzcGVjLmlzSW1wb3J0RGVmYXVsdFNwZWNpZmllcigpKSB7XG4gICAgICAgICAgY29uc3QgbG9jYWxOYW1lID0gc3BlYy5nZXQoXCJsb2NhbFwiKS5ub2RlLm5hbWU7XG4gICAgICAgICAgZGF0YS5pbXBvcnRzLnNldChsb2NhbE5hbWUsIFwiZGVmYXVsdFwiKTtcbiAgICAgICAgICBjb25zdCByZWV4cG9ydCA9IGxvY2FsRGF0YS5nZXQobG9jYWxOYW1lKTtcblxuICAgICAgICAgIGlmIChyZWV4cG9ydCkge1xuICAgICAgICAgICAgbG9jYWxEYXRhLmRlbGV0ZShsb2NhbE5hbWUpO1xuICAgICAgICAgICAgcmVleHBvcnQubmFtZXMuZm9yRWFjaChuYW1lID0+IHtcbiAgICAgICAgICAgICAgZGF0YS5yZWV4cG9ydHMuc2V0KG5hbWUsIFwiZGVmYXVsdFwiKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChzcGVjLmlzSW1wb3J0TmFtZXNwYWNlU3BlY2lmaWVyKCkpIHtcbiAgICAgICAgICBjb25zdCBsb2NhbE5hbWUgPSBzcGVjLmdldChcImxvY2FsXCIpLm5vZGUubmFtZTtcbiAgICAgICAgICBkYXRhLmltcG9ydHNOYW1lc3BhY2UuYWRkKGxvY2FsTmFtZSk7XG4gICAgICAgICAgY29uc3QgcmVleHBvcnQgPSBsb2NhbERhdGEuZ2V0KGxvY2FsTmFtZSk7XG5cbiAgICAgICAgICBpZiAocmVleHBvcnQpIHtcbiAgICAgICAgICAgIGxvY2FsRGF0YS5kZWxldGUobG9jYWxOYW1lKTtcbiAgICAgICAgICAgIHJlZXhwb3J0Lm5hbWVzLmZvckVhY2gobmFtZSA9PiB7XG4gICAgICAgICAgICAgIGRhdGEucmVleHBvcnROYW1lc3BhY2UuYWRkKG5hbWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHNwZWMuaXNJbXBvcnRTcGVjaWZpZXIoKSkge1xuICAgICAgICAgIGNvbnN0IGltcG9ydE5hbWUgPSBzcGVjLmdldChcImltcG9ydGVkXCIpLm5vZGUubmFtZTtcbiAgICAgICAgICBjb25zdCBsb2NhbE5hbWUgPSBzcGVjLmdldChcImxvY2FsXCIpLm5vZGUubmFtZTtcbiAgICAgICAgICBkYXRhLmltcG9ydHMuc2V0KGxvY2FsTmFtZSwgaW1wb3J0TmFtZSk7XG4gICAgICAgICAgY29uc3QgcmVleHBvcnQgPSBsb2NhbERhdGEuZ2V0KGxvY2FsTmFtZSk7XG5cbiAgICAgICAgICBpZiAocmVleHBvcnQpIHtcbiAgICAgICAgICAgIGxvY2FsRGF0YS5kZWxldGUobG9jYWxOYW1lKTtcbiAgICAgICAgICAgIHJlZXhwb3J0Lm5hbWVzLmZvckVhY2gobmFtZSA9PiB7XG4gICAgICAgICAgICAgIGRhdGEucmVleHBvcnRzLnNldChuYW1lLCBpbXBvcnROYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChjaGlsZC5pc0V4cG9ydEFsbERlY2xhcmF0aW9uKCkpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBnZXREYXRhKGNoaWxkLm5vZGUuc291cmNlKTtcbiAgICAgIGlmICghZGF0YS5sb2MpIGRhdGEubG9jID0gY2hpbGQubm9kZS5sb2M7XG4gICAgICBkYXRhLnJlZXhwb3J0QWxsID0ge1xuICAgICAgICBsb2M6IGNoaWxkLm5vZGUubG9jXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAoY2hpbGQuaXNFeHBvcnROYW1lZERlY2xhcmF0aW9uKCkgJiYgY2hpbGQubm9kZS5zb3VyY2UpIHtcbiAgICAgIGNvbnN0IGRhdGEgPSBnZXREYXRhKGNoaWxkLm5vZGUuc291cmNlKTtcbiAgICAgIGlmICghZGF0YS5sb2MpIGRhdGEubG9jID0gY2hpbGQubm9kZS5sb2M7XG4gICAgICBjaGlsZC5nZXQoXCJzcGVjaWZpZXJzXCIpLmZvckVhY2goc3BlYyA9PiB7XG4gICAgICAgIGlmICghc3BlYy5pc0V4cG9ydFNwZWNpZmllcigpKSB7XG4gICAgICAgICAgdGhyb3cgc3BlYy5idWlsZENvZGVGcmFtZUVycm9yKFwiVW5leHBlY3RlZCBleHBvcnQgc3BlY2lmaWVyIHR5cGVcIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbXBvcnROYW1lID0gc3BlYy5nZXQoXCJsb2NhbFwiKS5ub2RlLm5hbWU7XG4gICAgICAgIGNvbnN0IGV4cG9ydE5hbWUgPSBzcGVjLmdldChcImV4cG9ydGVkXCIpLm5vZGUubmFtZTtcbiAgICAgICAgZGF0YS5yZWV4cG9ydHMuc2V0KGV4cG9ydE5hbWUsIGltcG9ydE5hbWUpO1xuXG4gICAgICAgIGlmIChleHBvcnROYW1lID09PSBcIl9fZXNNb2R1bGVcIikge1xuICAgICAgICAgIHRocm93IGV4cG9ydE5hbWUuYnVpbGRDb2RlRnJhbWVFcnJvcignSWxsZWdhbCBleHBvcnQgXCJfX2VzTW9kdWxlXCIuJyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgZm9yIChjb25zdCBtZXRhZGF0YSBvZiBzb3VyY2VEYXRhLnZhbHVlcygpKSB7XG4gICAgbGV0IG5lZWRzRGVmYXVsdCA9IGZhbHNlO1xuICAgIGxldCBuZWVkc05hbWVkID0gZmFsc2U7XG5cbiAgICBpZiAobWV0YWRhdGEuaW1wb3J0c05hbWVzcGFjZS5zaXplID4gMCkge1xuICAgICAgbmVlZHNEZWZhdWx0ID0gdHJ1ZTtcbiAgICAgIG5lZWRzTmFtZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChtZXRhZGF0YS5yZWV4cG9ydEFsbCkge1xuICAgICAgbmVlZHNOYW1lZCA9IHRydWU7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBpbXBvcnROYW1lIG9mIG1ldGFkYXRhLmltcG9ydHMudmFsdWVzKCkpIHtcbiAgICAgIGlmIChpbXBvcnROYW1lID09PSBcImRlZmF1bHRcIikgbmVlZHNEZWZhdWx0ID0gdHJ1ZTtlbHNlIG5lZWRzTmFtZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgaW1wb3J0TmFtZSBvZiBtZXRhZGF0YS5yZWV4cG9ydHMudmFsdWVzKCkpIHtcbiAgICAgIGlmIChpbXBvcnROYW1lID09PSBcImRlZmF1bHRcIikgbmVlZHNEZWZhdWx0ID0gdHJ1ZTtlbHNlIG5lZWRzTmFtZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChuZWVkc0RlZmF1bHQgJiYgbmVlZHNOYW1lZCkge1xuICAgICAgbWV0YWRhdGEuaW50ZXJvcCA9IFwibmFtZXNwYWNlXCI7XG4gICAgfSBlbHNlIGlmIChuZWVkc0RlZmF1bHQpIHtcbiAgICAgIG1ldGFkYXRhLmludGVyb3AgPSBcImRlZmF1bHRcIjtcbiAgICB9XG4gIH1cblxuICBmb3IgKGNvbnN0IFtzb3VyY2UsIG1ldGFkYXRhXSBvZiBzb3VyY2VEYXRhKSB7XG4gICAgaWYgKGxhenkgIT09IGZhbHNlICYmICEoaXNTaWRlRWZmZWN0SW1wb3J0KG1ldGFkYXRhKSB8fCBtZXRhZGF0YS5yZWV4cG9ydEFsbCkpIHtcbiAgICAgIGlmIChsYXp5ID09PSB0cnVlKSB7XG4gICAgICAgIG1ldGFkYXRhLmxhenkgPSAhL1xcLi8udGVzdChzb3VyY2UpO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGxhenkpKSB7XG4gICAgICAgIG1ldGFkYXRhLmxhenkgPSBsYXp5LmluZGV4T2Yoc291cmNlKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxhenkgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBtZXRhZGF0YS5sYXp5ID0gbGF6eShzb3VyY2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAubGF6eSBtdXN0IGJlIGEgYm9vbGVhbiwgc3RyaW5nIGFycmF5LCBvciBmdW5jdGlvbmApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbG9jYWw6IGxvY2FsRGF0YSxcbiAgICBzb3VyY2U6IHNvdXJjZURhdGFcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0TG9jYWxFeHBvcnRNZXRhZGF0YShwcm9ncmFtUGF0aCwgbG9vc2UpIHtcbiAgY29uc3QgYmluZGluZ0tpbmRMb29rdXAgPSBuZXcgTWFwKCk7XG4gIHByb2dyYW1QYXRoLmdldChcImJvZHlcIikuZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgbGV0IGtpbmQ7XG5cbiAgICBpZiAoY2hpbGQuaXNJbXBvcnREZWNsYXJhdGlvbigpKSB7XG4gICAgICBraW5kID0gXCJpbXBvcnRcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGNoaWxkLmlzRXhwb3J0RGVmYXVsdERlY2xhcmF0aW9uKCkpIGNoaWxkID0gY2hpbGQuZ2V0KFwiZGVjbGFyYXRpb25cIik7XG5cbiAgICAgIGlmIChjaGlsZC5pc0V4cG9ydE5hbWVkRGVjbGFyYXRpb24oKSkge1xuICAgICAgICBpZiAoY2hpbGQubm9kZS5kZWNsYXJhdGlvbikge1xuICAgICAgICAgIGNoaWxkID0gY2hpbGQuZ2V0KFwiZGVjbGFyYXRpb25cIik7XG4gICAgICAgIH0gZWxzZSBpZiAobG9vc2UgJiYgY2hpbGQubm9kZS5zb3VyY2UgJiYgY2hpbGQuZ2V0KFwic291cmNlXCIpLmlzU3RyaW5nTGl0ZXJhbCgpKSB7XG4gICAgICAgICAgY2hpbGQubm9kZS5zcGVjaWZpZXJzLmZvckVhY2goc3BlY2lmaWVyID0+IHtcbiAgICAgICAgICAgIGJpbmRpbmdLaW5kTG9va3VwLnNldChzcGVjaWZpZXIubG9jYWwubmFtZSwgXCJibG9ja1wiKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNoaWxkLmlzRnVuY3Rpb25EZWNsYXJhdGlvbigpKSB7XG4gICAgICAgIGtpbmQgPSBcImhvaXN0ZWRcIjtcbiAgICAgIH0gZWxzZSBpZiAoY2hpbGQuaXNDbGFzc0RlY2xhcmF0aW9uKCkpIHtcbiAgICAgICAga2luZCA9IFwiYmxvY2tcIjtcbiAgICAgIH0gZWxzZSBpZiAoY2hpbGQuaXNWYXJpYWJsZURlY2xhcmF0aW9uKHtcbiAgICAgICAga2luZDogXCJ2YXJcIlxuICAgICAgfSkpIHtcbiAgICAgICAga2luZCA9IFwidmFyXCI7XG4gICAgICB9IGVsc2UgaWYgKGNoaWxkLmlzVmFyaWFibGVEZWNsYXJhdGlvbigpKSB7XG4gICAgICAgIGtpbmQgPSBcImJsb2NrXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgT2JqZWN0LmtleXMoY2hpbGQuZ2V0T3V0ZXJCaW5kaW5nSWRlbnRpZmllcnMoKSkuZm9yRWFjaChuYW1lID0+IHtcbiAgICAgIGJpbmRpbmdLaW5kTG9va3VwLnNldChuYW1lLCBraW5kKTtcbiAgICB9KTtcbiAgfSk7XG4gIGNvbnN0IGxvY2FsTWV0YWRhdGEgPSBuZXcgTWFwKCk7XG5cbiAgY29uc3QgZ2V0TG9jYWxNZXRhZGF0YSA9IGlkUGF0aCA9PiB7XG4gICAgY29uc3QgbG9jYWxOYW1lID0gaWRQYXRoLm5vZGUubmFtZTtcbiAgICBsZXQgbWV0YWRhdGEgPSBsb2NhbE1ldGFkYXRhLmdldChsb2NhbE5hbWUpO1xuXG4gICAgaWYgKCFtZXRhZGF0YSkge1xuICAgICAgY29uc3Qga2luZCA9IGJpbmRpbmdLaW5kTG9va3VwLmdldChsb2NhbE5hbWUpO1xuXG4gICAgICBpZiAoa2luZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IGlkUGF0aC5idWlsZENvZGVGcmFtZUVycm9yKGBFeHBvcnRpbmcgbG9jYWwgXCIke2xvY2FsTmFtZX1cIiwgd2hpY2ggaXMgbm90IGRlY2xhcmVkLmApO1xuICAgICAgfVxuXG4gICAgICBtZXRhZGF0YSA9IHtcbiAgICAgICAgbmFtZXM6IFtdLFxuICAgICAgICBraW5kXG4gICAgICB9O1xuICAgICAgbG9jYWxNZXRhZGF0YS5zZXQobG9jYWxOYW1lLCBtZXRhZGF0YSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1ldGFkYXRhO1xuICB9O1xuXG4gIHByb2dyYW1QYXRoLmdldChcImJvZHlcIikuZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgaWYgKGNoaWxkLmlzRXhwb3J0TmFtZWREZWNsYXJhdGlvbigpICYmIChsb29zZSB8fCAhY2hpbGQubm9kZS5zb3VyY2UpKSB7XG4gICAgICBpZiAoY2hpbGQubm9kZS5kZWNsYXJhdGlvbikge1xuICAgICAgICBjb25zdCBkZWNsYXJhdGlvbiA9IGNoaWxkLmdldChcImRlY2xhcmF0aW9uXCIpO1xuICAgICAgICBjb25zdCBpZHMgPSBkZWNsYXJhdGlvbi5nZXRPdXRlckJpbmRpbmdJZGVudGlmaWVyUGF0aHMoKTtcbiAgICAgICAgT2JqZWN0LmtleXMoaWRzKS5mb3JFYWNoKG5hbWUgPT4ge1xuICAgICAgICAgIGlmIChuYW1lID09PSBcIl9fZXNNb2R1bGVcIikge1xuICAgICAgICAgICAgdGhyb3cgZGVjbGFyYXRpb24uYnVpbGRDb2RlRnJhbWVFcnJvcignSWxsZWdhbCBleHBvcnQgXCJfX2VzTW9kdWxlXCIuJyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZ2V0TG9jYWxNZXRhZGF0YShpZHNbbmFtZV0pLm5hbWVzLnB1c2gobmFtZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2hpbGQuZ2V0KFwic3BlY2lmaWVyc1wiKS5mb3JFYWNoKHNwZWMgPT4ge1xuICAgICAgICAgIGNvbnN0IGxvY2FsID0gc3BlYy5nZXQoXCJsb2NhbFwiKTtcbiAgICAgICAgICBjb25zdCBleHBvcnRlZCA9IHNwZWMuZ2V0KFwiZXhwb3J0ZWRcIik7XG5cbiAgICAgICAgICBpZiAoZXhwb3J0ZWQubm9kZS5uYW1lID09PSBcIl9fZXNNb2R1bGVcIikge1xuICAgICAgICAgICAgdGhyb3cgZXhwb3J0ZWQuYnVpbGRDb2RlRnJhbWVFcnJvcignSWxsZWdhbCBleHBvcnQgXCJfX2VzTW9kdWxlXCIuJyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZ2V0TG9jYWxNZXRhZGF0YShsb2NhbCkubmFtZXMucHVzaChleHBvcnRlZC5ub2RlLm5hbWUpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGNoaWxkLmlzRXhwb3J0RGVmYXVsdERlY2xhcmF0aW9uKCkpIHtcbiAgICAgIGNvbnN0IGRlY2xhcmF0aW9uID0gY2hpbGQuZ2V0KFwiZGVjbGFyYXRpb25cIik7XG5cbiAgICAgIGlmIChkZWNsYXJhdGlvbi5pc0Z1bmN0aW9uRGVjbGFyYXRpb24oKSB8fCBkZWNsYXJhdGlvbi5pc0NsYXNzRGVjbGFyYXRpb24oKSkge1xuICAgICAgICBnZXRMb2NhbE1ldGFkYXRhKGRlY2xhcmF0aW9uLmdldChcImlkXCIpKS5uYW1lcy5wdXNoKFwiZGVmYXVsdFwiKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGRlY2xhcmF0aW9uLmJ1aWxkQ29kZUZyYW1lRXJyb3IoXCJVbmV4cGVjdGVkIGRlZmF1bHQgZXhwcmVzc2lvbiBleHBvcnQuXCIpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIHJldHVybiBsb2NhbE1ldGFkYXRhO1xufVxuXG5mdW5jdGlvbiBuYW1lQW5vbnltb3VzRXhwb3J0cyhwcm9ncmFtUGF0aCkge1xuICBwcm9ncmFtUGF0aC5nZXQoXCJib2R5XCIpLmZvckVhY2goY2hpbGQgPT4ge1xuICAgIGlmICghY2hpbGQuaXNFeHBvcnREZWZhdWx0RGVjbGFyYXRpb24oKSkgcmV0dXJuO1xuICAgICgwLCBfaGVscGVyU3BsaXRFeHBvcnREZWNsYXJhdGlvbigpLmRlZmF1bHQpKGNoaWxkKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZU1vZHVsZURlY2xhcmF0aW9ucyhwcm9ncmFtUGF0aCkge1xuICBwcm9ncmFtUGF0aC5nZXQoXCJib2R5XCIpLmZvckVhY2goY2hpbGQgPT4ge1xuICAgIGlmIChjaGlsZC5pc0ltcG9ydERlY2xhcmF0aW9uKCkpIHtcbiAgICAgIGNoaWxkLnJlbW92ZSgpO1xuICAgIH0gZWxzZSBpZiAoY2hpbGQuaXNFeHBvcnROYW1lZERlY2xhcmF0aW9uKCkpIHtcbiAgICAgIGlmIChjaGlsZC5ub2RlLmRlY2xhcmF0aW9uKSB7XG4gICAgICAgIGNoaWxkLm5vZGUuZGVjbGFyYXRpb24uX2Jsb2NrSG9pc3QgPSBjaGlsZC5ub2RlLl9ibG9ja0hvaXN0O1xuICAgICAgICBjaGlsZC5yZXBsYWNlV2l0aChjaGlsZC5ub2RlLmRlY2xhcmF0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNoaWxkLnJlbW92ZSgpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoY2hpbGQuaXNFeHBvcnREZWZhdWx0RGVjbGFyYXRpb24oKSkge1xuICAgICAgY29uc3QgZGVjbGFyYXRpb24gPSBjaGlsZC5nZXQoXCJkZWNsYXJhdGlvblwiKTtcblxuICAgICAgaWYgKGRlY2xhcmF0aW9uLmlzRnVuY3Rpb25EZWNsYXJhdGlvbigpIHx8IGRlY2xhcmF0aW9uLmlzQ2xhc3NEZWNsYXJhdGlvbigpKSB7XG4gICAgICAgIGRlY2xhcmF0aW9uLl9ibG9ja0hvaXN0ID0gY2hpbGQubm9kZS5fYmxvY2tIb2lzdDtcbiAgICAgICAgY2hpbGQucmVwbGFjZVdpdGgoZGVjbGFyYXRpb24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZGVjbGFyYXRpb24uYnVpbGRDb2RlRnJhbWVFcnJvcihcIlVuZXhwZWN0ZWQgZGVmYXVsdCBleHByZXNzaW9uIGV4cG9ydC5cIik7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChjaGlsZC5pc0V4cG9ydEFsbERlY2xhcmF0aW9uKCkpIHtcbiAgICAgIGNoaWxkLnJlbW92ZSgpO1xuICAgIH1cbiAgfSk7XG59Il19