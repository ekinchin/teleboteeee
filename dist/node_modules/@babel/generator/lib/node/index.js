"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.needsWhitespace = needsWhitespace;
exports.needsWhitespaceBefore = needsWhitespaceBefore;
exports.needsWhitespaceAfter = needsWhitespaceAfter;
exports.needsParens = needsParens;

var whitespace = _interopRequireWildcard(require("./whitespace"));

var parens = _interopRequireWildcard(require("./parentheses"));

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function expandAliases(obj) {
  const newObj = {};

  function add(type, func) {
    const fn = newObj[type];
    newObj[type] = fn ? function (node, parent, stack) {
      const result = fn(node, parent, stack);
      return result == null ? func(node, parent, stack) : result;
    } : func;
  }

  for (const type of Object.keys(obj)) {
    const aliases = t().FLIPPED_ALIAS_KEYS[type];

    if (aliases) {
      for (const alias of aliases) {
        add(alias, obj[type]);
      }
    } else {
      add(type, obj[type]);
    }
  }

  return newObj;
}

const expandedParens = expandAliases(parens);
const expandedWhitespaceNodes = expandAliases(whitespace.nodes);
const expandedWhitespaceList = expandAliases(whitespace.list);

function find(obj, node, parent, printStack) {
  const fn = obj[node.type];
  return fn ? fn(node, parent, printStack) : null;
}

function isOrHasCallExpression(node) {
  if (t().isCallExpression(node)) {
    return true;
  }

  if (t().isMemberExpression(node)) {
    return isOrHasCallExpression(node.object) || !node.computed && isOrHasCallExpression(node.property);
  } else {
    return false;
  }
}

function needsWhitespace(node, parent, type) {
  if (!node) return 0;

  if (t().isExpressionStatement(node)) {
    node = node.expression;
  }

  let linesInfo = find(expandedWhitespaceNodes, node, parent);

  if (!linesInfo) {
    const items = find(expandedWhitespaceList, node, parent);

    if (items) {
      for (let i = 0; i < items.length; i++) {
        linesInfo = needsWhitespace(items[i], node, type);
        if (linesInfo) break;
      }
    }
  }

  if (typeof linesInfo === "object" && linesInfo !== null) {
    return linesInfo[type] || 0;
  }

  return 0;
}

function needsWhitespaceBefore(node, parent) {
  return needsWhitespace(node, parent, "before");
}

function needsWhitespaceAfter(node, parent) {
  return needsWhitespace(node, parent, "after");
}

function needsParens(node, parent, printStack) {
  if (!parent) return false;

  if (t().isNewExpression(parent) && parent.callee === node) {
    if (isOrHasCallExpression(node)) return true;
  }

  return find(expandedParens, node, parent, printStack);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvZ2VuZXJhdG9yL2xpYi9ub2RlL2luZGV4LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwibmVlZHNXaGl0ZXNwYWNlIiwibmVlZHNXaGl0ZXNwYWNlQmVmb3JlIiwibmVlZHNXaGl0ZXNwYWNlQWZ0ZXIiLCJuZWVkc1BhcmVucyIsIndoaXRlc3BhY2UiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsInJlcXVpcmUiLCJwYXJlbnMiLCJ0IiwiZGF0YSIsIm9iaiIsIl9fZXNNb2R1bGUiLCJuZXdPYmoiLCJrZXkiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJkZXNjIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZ2V0Iiwic2V0IiwiZGVmYXVsdCIsImV4cGFuZEFsaWFzZXMiLCJhZGQiLCJ0eXBlIiwiZnVuYyIsImZuIiwibm9kZSIsInBhcmVudCIsInN0YWNrIiwicmVzdWx0Iiwia2V5cyIsImFsaWFzZXMiLCJGTElQUEVEX0FMSUFTX0tFWVMiLCJhbGlhcyIsImV4cGFuZGVkUGFyZW5zIiwiZXhwYW5kZWRXaGl0ZXNwYWNlTm9kZXMiLCJub2RlcyIsImV4cGFuZGVkV2hpdGVzcGFjZUxpc3QiLCJsaXN0IiwiZmluZCIsInByaW50U3RhY2siLCJpc09ySGFzQ2FsbEV4cHJlc3Npb24iLCJpc0NhbGxFeHByZXNzaW9uIiwiaXNNZW1iZXJFeHByZXNzaW9uIiwib2JqZWN0IiwiY29tcHV0ZWQiLCJwcm9wZXJ0eSIsImlzRXhwcmVzc2lvblN0YXRlbWVudCIsImV4cHJlc3Npb24iLCJsaW5lc0luZm8iLCJpdGVtcyIsImkiLCJsZW5ndGgiLCJpc05ld0V4cHJlc3Npb24iLCJjYWxsZWUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9C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Q0FBOEJ5QixJQUE5QixFQUFvQ0MsTUFBcEMsRUFBNEM7QUFDMUMsU0FBTzVCLGVBQWUsQ0FBQzJCLElBQUQsRUFBT0MsTUFBUCxFQUFlLE9BQWYsQ0FBdEI7QUFDRDs7QUFFRCxTQUFTekIsV0FBVCxDQUFxQndCLElBQXJCLEVBQTJCQyxNQUEzQixFQUFtQ2EsVUFBbkMsRUFBK0M7QUFDN0MsTUFBSSxDQUFDYixNQUFMLEVBQWEsT0FBTyxLQUFQOztBQUViLE1BQUlwQixDQUFDLEdBQUc4QyxlQUFKLENBQW9CMUIsTUFBcEIsS0FBK0JBLE1BQU0sQ0FBQzJCLE1BQVAsS0FBa0I1QixJQUFyRCxFQUEyRDtBQUN6RCxRQUFJZSxxQkFBcUIsQ0FBQ2YsSUFBRCxDQUF6QixFQUFpQyxPQUFPLElBQVA7QUFDbEM7O0FBRUQsU0FBT2EsSUFBSSxDQUFDTCxjQUFELEVBQWlCUixJQUFqQixFQUF1QkMsTUFBdkIsRUFBK0JhLFVBQS9CLENBQVg7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5uZWVkc1doaXRlc3BhY2UgPSBuZWVkc1doaXRlc3BhY2U7XG5leHBvcnRzLm5lZWRzV2hpdGVzcGFjZUJlZm9yZSA9IG5lZWRzV2hpdGVzcGFjZUJlZm9yZTtcbmV4cG9ydHMubmVlZHNXaGl0ZXNwYWNlQWZ0ZXIgPSBuZWVkc1doaXRlc3BhY2VBZnRlcjtcbmV4cG9ydHMubmVlZHNQYXJlbnMgPSBuZWVkc1BhcmVucztcblxudmFyIHdoaXRlc3BhY2UgPSBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChyZXF1aXJlKFwiLi93aGl0ZXNwYWNlXCIpKTtcblxudmFyIHBhcmVucyA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCIuL3BhcmVudGhlc2VzXCIpKTtcblxuZnVuY3Rpb24gdCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCJAYmFiZWwvdHlwZXNcIikpO1xuXG4gIHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaikgeyBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7IHJldHVybiBvYmo7IH0gZWxzZSB7IHZhciBuZXdPYmogPSB7fTsgaWYgKG9iaiAhPSBudWxsKSB7IGZvciAodmFyIGtleSBpbiBvYmopIHsgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsgdmFyIGRlc2MgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDoge307IGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSB9IG5ld09iai5kZWZhdWx0ID0gb2JqOyByZXR1cm4gbmV3T2JqOyB9IH1cblxuZnVuY3Rpb24gZXhwYW5kQWxpYXNlcyhvYmopIHtcbiAgY29uc3QgbmV3T2JqID0ge307XG5cbiAgZnVuY3Rpb24gYWRkKHR5cGUsIGZ1bmMpIHtcbiAgICBjb25zdCBmbiA9IG5ld09ialt0eXBlXTtcbiAgICBuZXdPYmpbdHlwZV0gPSBmbiA/IGZ1bmN0aW9uIChub2RlLCBwYXJlbnQsIHN0YWNrKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBmbihub2RlLCBwYXJlbnQsIHN0YWNrKTtcbiAgICAgIHJldHVybiByZXN1bHQgPT0gbnVsbCA/IGZ1bmMobm9kZSwgcGFyZW50LCBzdGFjaykgOiByZXN1bHQ7XG4gICAgfSA6IGZ1bmM7XG4gIH1cblxuICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXMob2JqKSkge1xuICAgIGNvbnN0IGFsaWFzZXMgPSB0KCkuRkxJUFBFRF9BTElBU19LRVlTW3R5cGVdO1xuXG4gICAgaWYgKGFsaWFzZXMpIHtcbiAgICAgIGZvciAoY29uc3QgYWxpYXMgb2YgYWxpYXNlcykge1xuICAgICAgICBhZGQoYWxpYXMsIG9ialt0eXBlXSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGFkZCh0eXBlLCBvYmpbdHlwZV0pO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBuZXdPYmo7XG59XG5cbmNvbnN0IGV4cGFuZGVkUGFyZW5zID0gZXhwYW5kQWxpYXNlcyhwYXJlbnMpO1xuY29uc3QgZXhwYW5kZWRXaGl0ZXNwYWNlTm9kZXMgPSBleHBhbmRBbGlhc2VzKHdoaXRlc3BhY2Uubm9kZXMpO1xuY29uc3QgZXhwYW5kZWRXaGl0ZXNwYWNlTGlzdCA9IGV4cGFuZEFsaWFzZXMod2hpdGVzcGFjZS5saXN0KTtcblxuZnVuY3Rpb24gZmluZChvYmosIG5vZGUsIHBhcmVudCwgcHJpbnRTdGFjaykge1xuICBjb25zdCBmbiA9IG9ialtub2RlLnR5cGVdO1xuICByZXR1cm4gZm4gPyBmbihub2RlLCBwYXJlbnQsIHByaW50U3RhY2spIDogbnVsbDtcbn1cblxuZnVuY3Rpb24gaXNPckhhc0NhbGxFeHByZXNzaW9uKG5vZGUpIHtcbiAgaWYgKHQoKS5pc0NhbGxFeHByZXNzaW9uKG5vZGUpKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpZiAodCgpLmlzTWVtYmVyRXhwcmVzc2lvbihub2RlKSkge1xuICAgIHJldHVybiBpc09ySGFzQ2FsbEV4cHJlc3Npb24obm9kZS5vYmplY3QpIHx8ICFub2RlLmNvbXB1dGVkICYmIGlzT3JIYXNDYWxsRXhwcmVzc2lvbihub2RlLnByb3BlcnR5KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZnVuY3Rpb24gbmVlZHNXaGl0ZXNwYWNlKG5vZGUsIHBhcmVudCwgdHlwZSkge1xuICBpZiAoIW5vZGUpIHJldHVybiAwO1xuXG4gIGlmICh0KCkuaXNFeHByZXNzaW9uU3RhdGVtZW50KG5vZGUpKSB7XG4gICAgbm9kZSA9IG5vZGUuZXhwcmVzc2lvbjtcbiAgfVxuXG4gIGxldCBsaW5lc0luZm8gPSBmaW5kKGV4cGFuZGVkV2hpdGVzcGFjZU5vZGVzLCBub2RlLCBwYXJlbnQpO1xuXG4gIGlmICghbGluZXNJbmZvKSB7XG4gICAgY29uc3QgaXRlbXMgPSBmaW5kKGV4cGFuZGVkV2hpdGVzcGFjZUxpc3QsIG5vZGUsIHBhcmVudCk7XG5cbiAgICBpZiAoaXRlbXMpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbGluZXNJbmZvID0gbmVlZHNXaGl0ZXNwYWNlKGl0ZW1zW2ldLCBub2RlLCB0eXBlKTtcbiAgICAgICAgaWYgKGxpbmVzSW5mbykgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHR5cGVvZiBsaW5lc0luZm8gPT09IFwib2JqZWN0XCIgJiYgbGluZXNJbmZvICE9PSBudWxsKSB7XG4gICAgcmV0dXJuIGxpbmVzSW5mb1t0eXBlXSB8fCAwO1xuICB9XG5cbiAgcmV0dXJuIDA7XG59XG5cbmZ1bmN0aW9uIG5lZWRzV2hpdGVzcGFjZUJlZm9yZShub2RlLCBwYXJlbnQpIHtcbiAgcmV0dXJuIG5lZWRzV2hpdGVzcGFjZShub2RlLCBwYXJlbnQsIFwiYmVmb3JlXCIpO1xufVxuXG5mdW5jdGlvbiBuZWVkc1doaXRlc3BhY2VBZnRlcihub2RlLCBwYXJlbnQpIHtcbiAgcmV0dXJuIG5lZWRzV2hpdGVzcGFjZShub2RlLCBwYXJlbnQsIFwiYWZ0ZXJcIik7XG59XG5cbmZ1bmN0aW9uIG5lZWRzUGFyZW5zKG5vZGUsIHBhcmVudCwgcHJpbnRTdGFjaykge1xuICBpZiAoIXBhcmVudCkgcmV0dXJuIGZhbHNlO1xuXG4gIGlmICh0KCkuaXNOZXdFeHByZXNzaW9uKHBhcmVudCkgJiYgcGFyZW50LmNhbGxlZSA9PT0gbm9kZSkge1xuICAgIGlmIChpc09ySGFzQ2FsbEV4cHJlc3Npb24obm9kZSkpIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcmV0dXJuIGZpbmQoZXhwYW5kZWRQYXJlbnMsIG5vZGUsIHBhcmVudCwgcHJpbnRTdGFjayk7XG59Il19