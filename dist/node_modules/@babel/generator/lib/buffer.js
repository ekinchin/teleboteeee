"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

function _trimRight() {
  const data = _interopRequireDefault(require("trim-right"));

  _trimRight = function () {
    return data;
  };

  return data;
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

const SPACES_RE = /^[ \t]+$/;

class Buffer {
  constructor(map) {
    this._map = null;
    this._buf = [];
    this._last = "";
    this._queue = [];
    this._position = {
      line: 1,
      column: 0
    };
    this._sourcePosition = {
      identifierName: null,
      line: null,
      column: null,
      filename: null
    };
    this._disallowedPop = null;
    this._map = map;
  }

  get() {
    this._flush();

    const map = this._map;
    const result = {
      code: (0, _trimRight().default)(this._buf.join("")),
      map: null,
      rawMappings: map && map.getRawMappings()
    };

    if (map) {
      Object.defineProperty(result, "map", {
        configurable: true,
        enumerable: true,

        get() {
          return this.map = map.get();
        },

        set(value) {
          Object.defineProperty(this, "map", {
            value,
            writable: true
          });
        }

      });
    }

    return result;
  }

  append(str) {
    this._flush();

    const {
      line,
      column,
      filename,
      identifierName,
      force
    } = this._sourcePosition;

    this._append(str, line, column, identifierName, filename, force);
  }

  queue(str) {
    if (str === "\n") {
      while (this._queue.length > 0 && SPACES_RE.test(this._queue[0][0])) {
        this._queue.shift();
      }
    }

    const {
      line,
      column,
      filename,
      identifierName,
      force
    } = this._sourcePosition;

    this._queue.unshift([str, line, column, identifierName, filename, force]);
  }

  _flush() {
    let item;

    while (item = this._queue.pop()) this._append(...item);
  }

  _append(str, line, column, identifierName, filename, force) {
    if (this._map && str[0] !== "\n") {
      this._map.mark(this._position.line, this._position.column, line, column, identifierName, filename, force);
    }

    this._buf.push(str);

    this._last = str[str.length - 1];

    for (let i = 0; i < str.length; i++) {
      if (str[i] === "\n") {
        this._position.line++;
        this._position.column = 0;
      } else {
        this._position.column++;
      }
    }
  }

  removeTrailingNewline() {
    if (this._queue.length > 0 && this._queue[0][0] === "\n") {
      this._queue.shift();
    }
  }

  removeLastSemicolon() {
    if (this._queue.length > 0 && this._queue[0][0] === ";") {
      this._queue.shift();
    }
  }

  endsWith(suffix) {
    if (suffix.length === 1) {
      let last;

      if (this._queue.length > 0) {
        const str = this._queue[0][0];
        last = str[str.length - 1];
      } else {
        last = this._last;
      }

      return last === suffix;
    }

    const end = this._last + this._queue.reduce((acc, item) => item[0] + acc, "");

    if (suffix.length <= end.length) {
      return end.slice(-suffix.length) === suffix;
    }

    return false;
  }

  hasContent() {
    return this._queue.length > 0 || !!this._last;
  }

  exactSource(loc, cb) {
    this.source("start", loc, true);
    cb();
    this.source("end", loc);

    this._disallowPop("start", loc);
  }

  source(prop, loc, force) {
    if (prop && !loc) return;

    this._normalizePosition(prop, loc, this._sourcePosition, force);
  }

  withSource(prop, loc, cb) {
    if (!this._map) return cb();
    const originalLine = this._sourcePosition.line;
    const originalColumn = this._sourcePosition.column;
    const originalFilename = this._sourcePosition.filename;
    const originalIdentifierName = this._sourcePosition.identifierName;
    this.source(prop, loc);
    cb();

    if ((!this._sourcePosition.force || this._sourcePosition.line !== originalLine || this._sourcePosition.column !== originalColumn || this._sourcePosition.filename !== originalFilename) && (!this._disallowedPop || this._disallowedPop.line !== originalLine || this._disallowedPop.column !== originalColumn || this._disallowedPop.filename !== originalFilename)) {
      this._sourcePosition.line = originalLine;
      this._sourcePosition.column = originalColumn;
      this._sourcePosition.filename = originalFilename;
      this._sourcePosition.identifierName = originalIdentifierName;
      this._sourcePosition.force = false;
      this._disallowedPop = null;
    }
  }

  _disallowPop(prop, loc) {
    if (prop && !loc) return;
    this._disallowedPop = this._normalizePosition(prop, loc);
  }

  _normalizePosition(prop, loc, targetObj, force) {
    const pos = loc ? loc[prop] : null;

    if (targetObj === undefined) {
      targetObj = {
        identifierName: null,
        line: null,
        column: null,
        filename: null,
        force: false
      };
    }

    const origLine = targetObj.line;
    const origColumn = targetObj.column;
    const origFilename = targetObj.filename;
    targetObj.identifierName = prop === "start" && loc && loc.identifierName || null;
    targetObj.line = pos ? pos.line : null;
    targetObj.column = pos ? pos.column : null;
    targetObj.filename = loc && loc.filename || null;

    if (force || targetObj.line !== origLine || targetObj.column !== origColumn || targetObj.filename !== origFilename) {
      targetObj.force = force;
    }

    return targetObj;
  }

  getCurrentColumn() {
    const extra = this._queue.reduce((acc, item) => item[0] + acc, "");

    const lastIndex = extra.lastIndexOf("\n");
    return lastIndex === -1 ? this._position.column + extra.length : extra.length - 1 - lastIndex;
  }

  getCurrentLine() {
    const extra = this._queue.reduce((acc, item) => item[0] + acc, "");

    let count = 0;

    for (let i = 0; i < extra.length; i++) {
      if (extra[i] === "\n") count++;
    }

    return this._position.line + count;
  }

}

exports.default = Buffer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvZ2VuZXJhdG9yL2xpYi9idWZmZXIuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0IiwiX3RyaW1SaWdodCIsImRhdGEiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIm9iaiIsIl9fZXNNb2R1bGUiLCJTUEFDRVNfUkUiLCJCdWZmZXIiLCJjb25zdHJ1Y3RvciIsIm1hcCIsIl9tYXAiLCJfYnVmIiwiX2xhc3QiLCJfcXVldWUiLCJfcG9zaXRpb24iLCJsaW5lIiwiY29sdW1uIiwiX3NvdXJjZVBvc2l0aW9uIiwiaWRlbnRpZmllck5hbWUiLCJmaWxlbmFtZSIsIl9kaXNhbGxvd2VkUG9wIiwiZ2V0IiwiX2ZsdXNoIiwicmVzdWx0IiwiY29kZSIsImpvaW4iLCJyYXdNYXBwaW5ncyIsImdldFJhd01hcHBpbmdzIiwiY29uZmlndXJhYmxlIiwiZW51bWVyYWJsZSIsInNldCIsIndyaXRhYmxlIiwiYXBwZW5kIiwic3RyIiwiZm9yY2UiLCJfYXBwZW5kIiwicXVldWUiLCJsZW5ndGgiLCJ0ZXN0Iiwic2hpZnQiLCJ1bnNoaWZ0IiwiaXRlbSIsInBvcCIsIm1hcmsiLCJwdXNoIiwiaSIsInJlbW92ZVRyYWlsaW5nTmV3bGluZSIsInJlbW92ZUxhc3RTZW1pY29sb24iLCJlbmRzV2l0aCIsInN1ZmZpeCIsImxhc3QiLCJlbmQiLCJyZWR1Y2UiLCJhY2MiLCJzbGljZSIsImhhc0NvbnRlbnQiLCJleGFjdFNvdXJjZSIsImxvYyIsImNiIiwic291cmNlIiwiX2Rpc2FsbG93UG9wIiwicHJvcCIsIl9ub3JtYWxpemVQb3NpdGlvbiIsIndpdGhTb3VyY2UiLCJvcmlnaW5hbExpbmUiLCJvcmlnaW5hbENvbHVtbiIsIm9yaWdpbmFsRmlsZW5hbWUiLCJvcmlnaW5hbElkZW50aWZpZXJOYW1lIiwidGFyZ2V0T2JqIiwicG9zIiwidW5kZWZpbmVkIiwib3JpZ0xpbmUiLCJvcmlnQ29sdW1uIiwib3JpZ0ZpbGVuYW1lIiwiZ2V0Q3VycmVudENvbHVtbiIsImV4dHJhIiwibGFzdEluZGV4IiwibGFzdEluZGV4T2YiLCJnZXRDdXJyZW50TGluZSIsImNvdW50Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFrQixLQUFLLENBQXZCOztBQUVBLFNBQVNDLFVBQVQsR0FBc0I7QUFDcEIsUUFBTUMsSUFBSSxHQUFHQyxzQkFBc0IsQ0FBQ0MsT0FBTyxDQUFDLFlBQUQsQ0FBUixDQUFuQzs7QUFFQUgsRUFBQUEsVUFBVSxHQUFHLFlBQVk7QUFDdkIsV0FBT0MsSUFBUDtBQUNELEdBRkQ7O0FBSUEsU0FBT0EsSUFBUDtBQUNEOztBQUVELFNBQVNDLHNCQUFULENBQWdDRSxHQUFoQyxFQUFxQztBQUFFLFNBQU9BLEdBQUcsSUFBSUEsR0FBRyxDQUFDQyxVQUFYLEdBQXdCRCxHQUF4QixHQUE4QjtBQUFFTCxJQUFBQSxPQUFPLEVBQUVLO0FBQVgsR0FBckM7QUFBd0Q7O0FBRS9GLE1BQU1FLFNBQVMsR0FBRyxVQUFsQjs7QUFFQSxNQUFNQyxNQUFOLENBQWE7QUFDWEMsRUFBQUEsV0FBVyxDQUFDQyxHQUFELEVBQU07QUFDZixTQUFLQyxJQUFMLEdBQVksSUFBWjtBQUNBLFNBQUtDLElBQUwsR0FBWSxFQUFaO0FBQ0EsU0FBS0MsS0FBTCxHQUFhLEVBQWI7QUFDQSxTQUFLQyxNQUFMLEdBQWMsRUFBZDtBQUNBLFNBQUtDLFNBQUwsR0FBaUI7QUFDZkMsTUFBQUEsSUFBSSxFQUFFLENBRFM7QUFFZkMsTUFBQUEsTUFBTSxFQUFFO0FBRk8sS0FBakI7QUFJQSxTQUFLQyxlQUFMLEdBQXVCO0FBQ3JCQyxNQUFBQSxjQUFjLEVBQUUsSUFESztBQUVy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TUFBZixHQUF3QjJELEtBQUssQ0FBQ3RDLE1BQWpELEdBQTBEc0MsS0FBSyxDQUFDdEMsTUFBTixHQUFlLENBQWYsR0FBbUJ1QyxTQUFwRjtBQUNEOztBQUVERSxFQUFBQSxjQUFjLEdBQUc7QUFDZixVQUFNSCxLQUFLLEdBQUcsS0FBSzlELE1BQUwsQ0FBWXVDLE1BQVosQ0FBbUIsQ0FBQ0MsR0FBRCxFQUFNWixJQUFOLEtBQWVBLElBQUksQ0FBQyxDQUFELENBQUosR0FBVVksR0FBNUMsRUFBaUQsRUFBakQsQ0FBZDs7QUFFQSxRQUFJMEIsS0FBSyxHQUFHLENBQVo7O0FBRUEsU0FBSyxJQUFJbEMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBRzhCLEtBQUssQ0FBQ3RDLE1BQTFCLEVBQWtDUSxDQUFDLEVBQW5DLEVBQXVDO0FBQ3JDLFVBQUk4QixLQUFLLENBQUM5QixDQUFELENBQUwsS0FBYSxJQUFqQixFQUF1QmtDLEtBQUs7QUFDN0I7O0FBRUQsV0FBTyxLQUFLakUsU0FBTCxDQUFlQyxJQUFmLEdBQXNCZ0UsS0FBN0I7QUFDRDs7QUF2T1U7O0FBMk9ibEYsT0FBTyxDQUFDRSxPQUFSLEdBQWtCUSxNQUFsQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwO1xuXG5mdW5jdGlvbiBfdHJpbVJpZ2h0KCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwidHJpbS1yaWdodFwiKSk7XG5cbiAgX3RyaW1SaWdodCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuY29uc3QgU1BBQ0VTX1JFID0gL15bIFxcdF0rJC87XG5cbmNsYXNzIEJ1ZmZlciB7XG4gIGNvbnN0cnVjdG9yKG1hcCkge1xuICAgIHRoaXMuX21hcCA9IG51bGw7XG4gICAgdGhpcy5fYnVmID0gW107XG4gICAgdGhpcy5fbGFzdCA9IFwiXCI7XG4gICAgdGhpcy5fcXVldWUgPSBbXTtcbiAgICB0aGlzLl9wb3NpdGlvbiA9IHtcbiAgICAgIGxpbmU6IDEsXG4gICAgICBjb2x1bW46IDBcbiAgICB9O1xuICAgIHRoaXMuX3NvdXJjZVBvc2l0aW9uID0ge1xuICAgICAgaWRlbnRpZmllck5hbWU6IG51bGwsXG4gICAgICBsaW5lOiBudWxsLFxuICAgICAgY29sdW1uOiBudWxsLFxuICAgICAgZmlsZW5hbWU6IG51bGxcbiAgICB9O1xuICAgIHRoaXMuX2Rpc2FsbG93ZWRQb3AgPSBudWxsO1xuICAgIHRoaXMuX21hcCA9IG1hcDtcbiAgfVxuXG4gIGdldCgpIHtcbiAgICB0aGlzLl9mbHVzaCgpO1xuXG4gICAgY29uc3QgbWFwID0gdGhpcy5fbWFwO1xuICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgIGNvZGU6ICgwLCBfdHJpbVJpZ2h0KCkuZGVmYXVsdCkodGhpcy5fYnVmLmpvaW4oXCJcIikpLFxuICAgICAgbWFwOiBudWxsLFxuICAgICAgcmF3TWFwcGluZ3M6IG1hcCAmJiBtYXAuZ2V0UmF3TWFwcGluZ3MoKVxuICAgIH07XG5cbiAgICBpZiAobWFwKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocmVzdWx0LCBcIm1hcFwiLCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcblxuICAgICAgICBnZXQoKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubWFwID0gbWFwLmdldCgpO1xuICAgICAgICB9LFxuXG4gICAgICAgIHNldCh2YWx1ZSkge1xuICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcIm1hcFwiLCB7XG4gICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFwcGVuZChzdHIpIHtcbiAgICB0aGlzLl9mbHVzaCgpO1xuXG4gICAgY29uc3Qge1xuICAgICAgbGluZSxcbiAgICAgIGNvbHVtbixcbiAgICAgIGZpbGVuYW1lLFxuICAgICAgaWRlbnRpZmllck5hbWUsXG4gICAgICBmb3JjZVxuICAgIH0gPSB0aGlzLl9zb3VyY2VQb3NpdGlvbjtcblxuICAgIHRoaXMuX2FwcGVuZChzdHIsIGxpbmUsIGNvbHVtbiwgaWRlbnRpZmllck5hbWUsIGZpbGVuYW1lLCBmb3JjZSk7XG4gIH1cblxuICBxdWV1ZShzdHIpIHtcbiAgICBpZiAoc3RyID09PSBcIlxcblwiKSB7XG4gICAgICB3aGlsZSAodGhpcy5fcXVldWUubGVuZ3RoID4gMCAmJiBTUEFDRVNfUkUudGVzdCh0aGlzLl9xdWV1ZVswXVswXSkpIHtcbiAgICAgICAgdGhpcy5fcXVldWUuc2hpZnQoKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICBsaW5lLFxuICAgICAgY29sdW1uLFxuICAgICAgZmlsZW5hbWUsXG4gICAgICBpZGVudGlmaWVyTmFtZSxcbiAgICAgIGZvcmNlXG4gICAgfSA9IHRoaXMuX3NvdXJjZVBvc2l0aW9uO1xuXG4gICAgdGhpcy5fcXVldWUudW5zaGlmdChbc3RyLCBsaW5lLCBjb2x1bW4sIGlkZW50aWZpZXJOYW1lLCBmaWxlbmFtZSwgZm9yY2VdKTtcbiAgfVxuXG4gIF9mbHVzaCgpIHtcbiAgICBsZXQgaXRlbTtcblxuICAgIHdoaWxlIChpdGVtID0gdGhpcy5fcXVldWUucG9wKCkpIHRoaXMuX2FwcGVuZCguLi5pdGVtKTtcbiAgfVxuXG4gIF9hcHBlbmQoc3RyLCBsaW5lLCBjb2x1bW4sIGlkZW50aWZpZXJOYW1lLCBmaWxlbmFtZSwgZm9yY2UpIHtcbiAgICBpZiAodGhpcy5fbWFwICYmIHN0clswXSAhPT0gXCJcXG5cIikge1xuICAgICAgdGhpcy5fbWFwLm1hcmsodGhpcy5fcG9zaXRpb24ubGluZSwgdGhpcy5fcG9zaXRpb24uY29sdW1uLCBsaW5lLCBjb2x1bW4sIGlkZW50aWZpZXJOYW1lLCBmaWxlbmFtZSwgZm9yY2UpO1xuICAgIH1cblxuICAgIHRoaXMuX2J1Zi5wdXNoKHN0cik7XG5cbiAgICB0aGlzLl9sYXN0ID0gc3RyW3N0ci5sZW5ndGggLSAxXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoc3RyW2ldID09PSBcIlxcblwiKSB7XG4gICAgICAgIHRoaXMuX3Bvc2l0aW9uLmxpbmUrKztcbiAgICAgICAgdGhpcy5fcG9zaXRpb24uY29sdW1uID0gMDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX3Bvc2l0aW9uLmNvbHVtbisrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJlbW92ZVRyYWlsaW5nTmV3bGluZSgpIHtcbiAgICBpZiAodGhpcy5fcXVldWUubGVuZ3RoID4gMCAmJiB0aGlzLl9xdWV1ZVswXVswXSA9PT0gXCJcXG5cIikge1xuICAgICAgdGhpcy5fcXVldWUuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVMYXN0U2VtaWNvbG9uKCkge1xuICAgIGlmICh0aGlzLl9xdWV1ZS5sZW5ndGggPiAwICYmIHRoaXMuX3F1ZXVlWzBdWzBdID09PSBcIjtcIikge1xuICAgICAgdGhpcy5fcXVldWUuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICBlbmRzV2l0aChzdWZmaXgpIHtcbiAgICBpZiAoc3VmZml4Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgbGV0IGxhc3Q7XG5cbiAgICAgIGlmICh0aGlzLl9xdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHN0ciA9IHRoaXMuX3F1ZXVlWzBdWzBdO1xuICAgICAgICBsYXN0ID0gc3RyW3N0ci5sZW5ndGggLSAxXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxhc3QgPSB0aGlzLl9sYXN0O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbGFzdCA9PT0gc3VmZml4O1xuICAgIH1cblxuICAgIGNvbnN0IGVuZCA9IHRoaXMuX2xhc3QgKyB0aGlzLl9xdWV1ZS5yZWR1Y2UoKGFjYywgaXRlbSkgPT4gaXRlbVswXSArIGFjYywgXCJcIik7XG5cbiAgICBpZiAoc3VmZml4Lmxlbmd0aCA8PSBlbmQubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gZW5kLnNsaWNlKC1zdWZmaXgubGVuZ3RoKSA9PT0gc3VmZml4O1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGhhc0NvbnRlbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3F1ZXVlLmxlbmd0aCA+IDAgfHwgISF0aGlzLl9sYXN0O1xuICB9XG5cbiAgZXhhY3RTb3VyY2UobG9jLCBjYikge1xuICAgIHRoaXMuc291cmNlKFwic3RhcnRcIiwgbG9jLCB0cnVlKTtcbiAgICBjYigpO1xuICAgIHRoaXMuc291cmNlKFwiZW5kXCIsIGxvYyk7XG5cbiAgICB0aGlzLl9kaXNhbGxvd1BvcChcInN0YXJ0XCIsIGxvYyk7XG4gIH1cblxuICBzb3VyY2UocHJvcCwgbG9jLCBmb3JjZSkge1xuICAgIGlmIChwcm9wICYmICFsb2MpIHJldHVybjtcblxuICAgIHRoaXMuX25vcm1hbGl6ZVBvc2l0aW9uKHByb3AsIGxvYywgdGhpcy5fc291cmNlUG9zaXRpb24sIGZvcmNlKTtcbiAgfVxuXG4gIHdpdGhTb3VyY2UocHJvcCwgbG9jLCBjYikge1xuICAgIGlmICghdGhpcy5fbWFwKSByZXR1cm4gY2IoKTtcbiAgICBjb25zdCBvcmlnaW5hbExpbmUgPSB0aGlzLl9zb3VyY2VQb3NpdGlvbi5saW5lO1xuICAgIGNvbnN0IG9yaWdpbmFsQ29sdW1uID0gdGhpcy5fc291cmNlUG9zaXRpb24uY29sdW1uO1xuICAgIGNvbnN0IG9yaWdpbmFsRmlsZW5hbWUgPSB0aGlzLl9zb3VyY2VQb3NpdGlvbi5maWxlbmFtZTtcbiAgICBjb25zdCBvcmlnaW5hbElkZW50aWZpZXJOYW1lID0gdGhpcy5fc291cmNlUG9zaXRpb24uaWRlbnRpZmllck5hbWU7XG4gICAgdGhpcy5zb3VyY2UocHJvcCwgbG9jKTtcbiAgICBjYigpO1xuXG4gICAgaWYgKCghdGhpcy5fc291cmNlUG9zaXRpb24uZm9yY2UgfHwgdGhpcy5fc291cmNlUG9zaXRpb24ubGluZSAhPT0gb3JpZ2luYWxMaW5lIHx8IHRoaXMuX3NvdXJjZVBvc2l0aW9uLmNvbHVtbiAhPT0gb3JpZ2luYWxDb2x1bW4gfHwgdGhpcy5fc291cmNlUG9zaXRpb24uZmlsZW5hbWUgIT09IG9yaWdpbmFsRmlsZW5hbWUpICYmICghdGhpcy5fZGlzYWxsb3dlZFBvcCB8fCB0aGlzLl9kaXNhbGxvd2VkUG9wLmxpbmUgIT09IG9yaWdpbmFsTGluZSB8fCB0aGlzLl9kaXNhbGxvd2VkUG9wLmNvbHVtbiAhPT0gb3JpZ2luYWxDb2x1bW4gfHwgdGhpcy5fZGlzYWxsb3dlZFBvcC5maWxlbmFtZSAhPT0gb3JpZ2luYWxGaWxlbmFtZSkpIHtcbiAgICAgIHRoaXMuX3NvdXJjZVBvc2l0aW9uLmxpbmUgPSBvcmlnaW5hbExpbmU7XG4gICAgICB0aGlzLl9zb3VyY2VQb3NpdGlvbi5jb2x1bW4gPSBvcmlnaW5hbENvbHVtbjtcbiAgICAgIHRoaXMuX3NvdXJjZVBvc2l0aW9uLmZpbGVuYW1lID0gb3JpZ2luYWxGaWxlbmFtZTtcbiAgICAgIHRoaXMuX3NvdXJjZVBvc2l0aW9uLmlkZW50aWZpZXJOYW1lID0gb3JpZ2luYWxJZGVudGlmaWVyTmFtZTtcbiAgICAgIHRoaXMuX3NvdXJjZVBvc2l0aW9uLmZvcmNlID0gZmFsc2U7XG4gICAgICB0aGlzLl9kaXNhbGxvd2VkUG9wID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBfZGlzYWxsb3dQb3AocHJvcCwgbG9jKSB7XG4gICAgaWYgKHByb3AgJiYgIWxvYykgcmV0dXJuO1xuICAgIHRoaXMuX2Rpc2FsbG93ZWRQb3AgPSB0aGlzLl9ub3JtYWxpemVQb3NpdGlvbihwcm9wLCBsb2MpO1xuICB9XG5cbiAgX25vcm1hbGl6ZVBvc2l0aW9uKHByb3AsIGxvYywgdGFyZ2V0T2JqLCBmb3JjZSkge1xuICAgIGNvbnN0IHBvcyA9IGxvYyA/IGxvY1twcm9wXSA6IG51bGw7XG5cbiAgICBpZiAodGFyZ2V0T2JqID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRhcmdldE9iaiA9IHtcbiAgICAgICAgaWRlbnRpZmllck5hbWU6IG51bGwsXG4gICAgICAgIGxpbmU6IG51bGwsXG4gICAgICAgIGNvbHVtbjogbnVsbCxcbiAgICAgICAgZmlsZW5hbWU6IG51bGwsXG4gICAgICAgIGZvcmNlOiBmYWxzZVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBvcmlnTGluZSA9IHRhcmdldE9iai5saW5lO1xuICAgIGNvbnN0IG9yaWdDb2x1bW4gPSB0YXJnZXRPYmouY29sdW1uO1xuICAgIGNvbnN0IG9yaWdGaWxlbmFtZSA9IHRhcmdldE9iai5maWxlbmFtZTtcbiAgICB0YXJnZXRPYmouaWRlbnRpZmllck5hbWUgPSBwcm9wID09PSBcInN0YXJ0XCIgJiYgbG9jICYmIGxvYy5pZGVudGlmaWVyTmFtZSB8fCBudWxsO1xuICAgIHRhcmdldE9iai5saW5lID0gcG9zID8gcG9zLmxpbmUgOiBudWxsO1xuICAgIHRhcmdldE9iai5jb2x1bW4gPSBwb3MgPyBwb3MuY29sdW1uIDogbnVsbDtcbiAgICB0YXJnZXRPYmouZmlsZW5hbWUgPSBsb2MgJiYgbG9jLmZpbGVuYW1lIHx8IG51bGw7XG5cbiAgICBpZiAoZm9yY2UgfHwgdGFyZ2V0T2JqLmxpbmUgIT09IG9yaWdMaW5lIHx8IHRhcmdldE9iai5jb2x1bW4gIT09IG9yaWdDb2x1bW4gfHwgdGFyZ2V0T2JqLmZpbGVuYW1lICE9PSBvcmlnRmlsZW5hbWUpIHtcbiAgICAgIHRhcmdldE9iai5mb3JjZSA9IGZvcmNlO1xuICAgIH1cblxuICAgIHJldHVybiB0YXJnZXRPYmo7XG4gIH1cblxuICBnZXRDdXJyZW50Q29sdW1uKCkge1xuICAgIGNvbnN0IGV4dHJhID0gdGhpcy5fcXVldWUucmVkdWNlKChhY2MsIGl0ZW0pID0+IGl0ZW1bMF0gKyBhY2MsIFwiXCIpO1xuXG4gICAgY29uc3QgbGFzdEluZGV4ID0gZXh0cmEubGFzdEluZGV4T2YoXCJcXG5cIik7XG4gICAgcmV0dXJuIGxhc3RJbmRleCA9PT0gLTEgPyB0aGlzLl9wb3NpdGlvbi5jb2x1bW4gKyBleHRyYS5sZW5ndGggOiBleHRyYS5sZW5ndGggLSAxIC0gbGFzdEluZGV4O1xuICB9XG5cbiAgZ2V0Q3VycmVudExpbmUoKSB7XG4gICAgY29uc3QgZXh0cmEgPSB0aGlzLl9xdWV1ZS5yZWR1Y2UoKGFjYywgaXRlbSkgPT4gaXRlbVswXSArIGFjYywgXCJcIik7XG5cbiAgICBsZXQgY291bnQgPSAwO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHRyYS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGV4dHJhW2ldID09PSBcIlxcblwiKSBjb3VudCsrO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9wb3NpdGlvbi5saW5lICsgY291bnQ7XG4gIH1cblxufVxuXG5leHBvcnRzLmRlZmF1bHQgPSBCdWZmZXI7Il19