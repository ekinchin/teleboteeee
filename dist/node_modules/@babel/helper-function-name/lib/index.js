"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

function _helperGetFunctionArity() {
  const data = _interopRequireDefault(require("@babel/helper-get-function-arity"));

  _helperGetFunctionArity = function () {
    return data;
  };

  return data;
}

function _template() {
  const data = _interopRequireDefault(require("@babel/template"));

  _template = function () {
    return data;
  };

  return data;
}

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

const buildPropertyMethodAssignmentWrapper = (0, _template().default)(`
  (function (FUNCTION_KEY) {
    function FUNCTION_ID() {
      return FUNCTION_KEY.apply(this, arguments);
    }

    FUNCTION_ID.toString = function () {
      return FUNCTION_KEY.toString();
    }

    return FUNCTION_ID;
  })(FUNCTION)
`);
const buildGeneratorPropertyMethodAssignmentWrapper = (0, _template().default)(`
  (function (FUNCTION_KEY) {
    function* FUNCTION_ID() {
      return yield* FUNCTION_KEY.apply(this, arguments);
    }

    FUNCTION_ID.toString = function () {
      return FUNCTION_KEY.toString();
    };

    return FUNCTION_ID;
  })(FUNCTION)
`);
const visitor = {
  "ReferencedIdentifier|BindingIdentifier"(path, state) {
    if (path.node.name !== state.name) return;
    const localDeclar = path.scope.getBindingIdentifier(state.name);
    if (localDeclar !== state.outerDeclar) return;
    state.selfReference = true;
    path.stop();
  }

};

function getNameFromLiteralId(id) {
  if (t().isNullLiteral(id)) {
    return "null";
  }

  if (t().isRegExpLiteral(id)) {
    return `_${id.pattern}_${id.flags}`;
  }

  if (t().isTemplateLiteral(id)) {
    return id.quasis.map(quasi => quasi.value.raw).join("");
  }

  if (id.value !== undefined) {
    return id.value + "";
  }

  return "";
}

function wrap(state, method, id, scope) {
  if (state.selfReference) {
    if (scope.hasBinding(id.name) && !scope.hasGlobal(id.name)) {
      scope.rename(id.name);
    } else {
      if (!t().isFunction(method)) return;
      let build = buildPropertyMethodAssignmentWrapper;

      if (method.generator) {
        build = buildGeneratorPropertyMethodAssignmentWrapper;
      }

      const template = build({
        FUNCTION: method,
        FUNCTION_ID: id,
        FUNCTION_KEY: scope.generateUidIdentifier(id.name)
      }).expression;
      const params = template.callee.body.body[0].params;

      for (let i = 0, len = (0, _helperGetFunctionArity().default)(method); i < len; i++) {
        params.push(scope.generateUidIdentifier("x"));
      }

      return template;
    }
  }

  method.id = id;
  scope.getProgramParent().references[id.name] = true;
}

function visit(node, name, scope) {
  const state = {
    selfAssignment: false,
    selfReference: false,
    outerDeclar: scope.getBindingIdentifier(name),
    references: [],
    name: name
  };
  const binding = scope.getOwnBinding(name);

  if (binding) {
    if (binding.kind === "param") {
      state.selfReference = true;
    } else {}
  } else if (state.outerDeclar || scope.hasGlobal(name)) {
    scope.traverse(node, visitor, state);
  }

  return state;
}

function _default({
  node,
  parent,
  scope,
  id
}, localBinding = false) {
  if (node.id) return;

  if ((t().isObjectProperty(parent) || t().isObjectMethod(parent, {
    kind: "method"
  })) && (!parent.computed || t().isLiteral(parent.key))) {
    id = parent.key;
  } else if (t().isVariableDeclarator(parent)) {
    id = parent.id;

    if (t().isIdentifier(id) && !localBinding) {
      const binding = scope.parent.getBinding(id.name);

      if (binding && binding.constant && scope.getBinding(id.name) === binding) {
        node.id = t().cloneNode(id);
        node.id[t().NOT_LOCAL_BINDING] = true;
        return;
      }
    }
  } else if (t().isAssignmentExpression(parent)) {
    id = parent.left;
  } else if (!id) {
    return;
  }

  let name;

  if (id && t().isLiteral(id)) {
    name = getNameFromLiteralId(id);
  } else if (id && t().isIdentifier(id)) {
    name = id.name;
  }

  if (name === undefined) {
    return;
  }

  name = t().toBindingIdentifierName(name);
  id = t().identifier(name);
  id[t().NOT_LOCAL_BINDING] = true;
  const state = visit(node, name, scope);
  return wrap(state, node, id, scope) || node;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvaGVscGVyLWZ1bmN0aW9uLW5hbWUvbGliL2luZGV4LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVmYXVsdCIsIl9kZWZhdWx0IiwiX2hlbHBlckdldEZ1bmN0aW9uQXJpdHkiLCJkYXRhIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfdGVtcGxhdGUiLCJ0IiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImdldCIsInNldCIsImJ1aWxkUHJvcGVydHlNZXRob2RBc3NpZ25tZW50V3JhcHBlciIsImJ1aWxkR2VuZXJhdG9yUHJvcGVydHlNZXRob2RBc3NpZ25tZW50V3JhcHBlciIsInZpc2l0b3IiLCJwYXRoIiwic3RhdGUiLCJub2RlIiwibmFtZSIsImxvY2FsRGVjbGFyIiwic2NvcGUiLCJnZXRCaW5kaW5nSWRlbnRpZmllciIsIm91dGVyRGVjbGFyIiwic2VsZlJlZmVyZW5jZSIsInN0b3AiLCJnZXROYW1lRnJvbUxpdGVyYWxJZCIsImlkIiwiaXNOdWxsTGl0ZXJhbCIsImlzUmVnRXhwTGl0ZXJhbCIsInBhdHRlcm4iLCJmbGFncyIsImlzVGVtcGxhdGVMaXRlcmFsIiwicXVhc2lzIiwibWFwIiwicXVhc2kiLCJyYXciLCJqb2luIiwidW5kZWZpbmVkIiwid3JhcCIsIm1ldGhvZCIsImhhc0JpbmRpbmciLCJoYXNHbG9iYWwiLCJyZW5hbWUiLCJpc0Z1bmN0aW9uIiwiYnVpbGQiLCJnZW5lcmF0b3IiLCJ0ZW1wbGF0ZSIsIkZVTkNUSU9OIiwiRlVOQ1RJT05fSUQiLCJGVU5DVElPTl9LRVkiLCJnZW5lcmF0ZVVpZElkZW50aWZpZXIiLCJleHByZXNzaW9uIiwicGFyYW1zIiwiY2FsbGVlIiwiYm9keSIsImkiLCJsZW4iLCJwdXNoIiwiZ2V0UHJvZ3JhbVBhcmVudCIsInJlZmVyZW5jZXMiLCJ2aXNpdCIsInNlbGZBc3NpZ25tZW50IiwiYmluZGluZyIsImdldE93bkJpbmRpbmciLCJraW5kIiwidHJhdmVyc2UiLCJwYXJlbnQiLCJsb2NhbEJpbmRpbmciLCJpc09iamVjdFByb3BlcnR5IiwiaXNPYmplY3RNZXRob2QiLCJjb21wdXRlZCIsImlzTGl0ZXJhbCIsImlzVmFyaWFibGVEZWNsYXJhdG9yIiwiaXNJZGVudGlmaWVyIiwiZ2V0QmluZGluZyIsImNvbnN0YW50IiwiY2xvbmVOb2RlIiwiTk9UX0xPQ0FMX0JJTkRJTkciLCJpc0Fzc2lnbm1lbnRFeHByZXNzaW9uIiwibGVmdCIsInRvQmluZGluZ0lkZW50aWZpZXJOYW1lIiwiaWRlbnRpZmllciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFDM0NDLEVBQUFBLEtBQUssRUFBRTtBQURvQyxDQUE3QztBQUdBRCxPQUFPLENBQUNFLE9BQVIsR0FBa0JDLFFBQWxCOztBQUVBLFNBQVNDLHVCQUFULEdBQW1DO0FBQ2pDLFFBQU1DLElBQUksR0FBR0Msc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxrQ0FBRCxDQUFSLENBQW5DOztBQUVBSCxFQUFBQSx1QkFBdUIsR0FBRyxZQUFZO0FBQ3BDLFdBQU9DLElBQVA7QUFDRCxHQUZEOztBQUlBLFNBQU9BLElBQVA7QUFDRDs7QUFFRCxTQUFTRyxTQUFULEdBQXFCO0FBQ25CLFFBQU1ILElBQUksR0FBR0Msc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxpQkFBRCxDQUFSLENBQW5DOztBQUVBQyxFQUFBQSxTQUFTLEdBQUcsWUFBWTtBQUN0QixXQUFPSCxJQUFQO0FBQ0QsR0FGRDs7QUFJQSxTQUFPQSxJQUFQO0FBQ0Q7O0FBRUQsU0FBU0ksQ0FB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LENBQUMzQyxJQUFELEVBQU9DLElBQVAsRUFBYUUsS0FBYixDQUFuQjtBQUNBLFNBQU9rQixJQUFJLENBQUN0QixLQUFELEVBQVFDLElBQVIsRUFBY1MsRUFBZCxFQUFrQk4sS0FBbEIsQ0FBSixJQUFnQ0gsSUFBdkM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7XG5cbmZ1bmN0aW9uIF9oZWxwZXJHZXRGdW5jdGlvbkFyaXR5KCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiQGJhYmVsL2hlbHBlci1nZXQtZnVuY3Rpb24tYXJpdHlcIikpO1xuXG4gIF9oZWxwZXJHZXRGdW5jdGlvbkFyaXR5ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfdGVtcGxhdGUoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJAYmFiZWwvdGVtcGxhdGVcIikpO1xuXG4gIF90ZW1wbGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gdCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCJAYmFiZWwvdHlwZXNcIikpO1xuXG4gIHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaikgeyBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7IHJldHVybiBvYmo7IH0gZWxzZSB7IHZhciBuZXdPYmogPSB7fTsgaWYgKG9iaiAhPSBudWxsKSB7IGZvciAodmFyIGtleSBpbiBvYmopIHsgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsgdmFyIGRlc2MgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDoge307IGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSB9IG5ld09iai5kZWZhdWx0ID0gb2JqOyByZXR1cm4gbmV3T2JqOyB9IH1cblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuY29uc3QgYnVpbGRQcm9wZXJ0eU1ldGhvZEFzc2lnbm1lbnRXcmFwcGVyID0gKDAsIF90ZW1wbGF0ZSgpLmRlZmF1bHQpKGBcbiAgKGZ1bmN0aW9uIChGVU5DVElPTl9LRVkpIHtcbiAgICBmdW5jdGlvbiBGVU5DVElPTl9JRCgpIHtcbiAgICAgIHJldHVybiBGVU5DVElPTl9LRVkuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9XG5cbiAgICBGVU5DVElPTl9JRC50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBGVU5DVElPTl9LRVkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gRlVOQ1RJT05fSUQ7XG4gIH0pKEZVTkNUSU9OKVxuYCk7XG5jb25zdCBidWlsZEdlbmVyYXRvclByb3BlcnR5TWV0aG9kQXNzaWdubWVudFdyYXBwZXIgPSAoMCwgX3RlbXBsYXRlKCkuZGVmYXVsdCkoYFxuICAoZnVuY3Rpb24gKEZVTkNUSU9OX0tFWSkge1xuICAgIGZ1bmN0aW9uKiBGVU5DVElPTl9JRCgpIHtcbiAgICAgIHJldHVybiB5aWVsZCogRlVOQ1RJT05fS0VZLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgRlVOQ1RJT05fSUQudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7XG4gICAgICByZXR1cm4gRlVOQ1RJT05fS0VZLnRvU3RyaW5nKCk7XG4gICAgfTtcblxuICAgIHJldHVybiBGVU5DVElPTl9JRDtcbiAgfSkoRlVOQ1RJT04pXG5gKTtcbmNvbnN0IHZpc2l0b3IgPSB7XG4gIFwiUmVmZXJlbmNlZElkZW50aWZpZXJ8QmluZGluZ0lkZW50aWZpZXJcIihwYXRoLCBzdGF0ZSkge1xuICAgIGlmIChwYXRoLm5vZGUubmFtZSAhPT0gc3RhdGUubmFtZSkgcmV0dXJuO1xuICAgIGNvbnN0IGxvY2FsRGVjbGFyID0gcGF0aC5zY29wZS5nZXRCaW5kaW5nSWRlbnRpZmllcihzdGF0ZS5uYW1lKTtcbiAgICBpZiAobG9jYWxEZWNsYXIgIT09IHN0YXRlLm91dGVyRGVjbGFyKSByZXR1cm47XG4gICAgc3RhdGUuc2VsZlJlZmVyZW5jZSA9IHRydWU7XG4gICAgcGF0aC5zdG9wKCk7XG4gIH1cblxufTtcblxuZnVuY3Rpb24gZ2V0TmFtZUZyb21MaXRlcmFsSWQoaWQpIHtcbiAgaWYgKHQoKS5pc051bGxMaXRlcmFsKGlkKSkge1xuICAgIHJldHVybiBcIm51bGxcIjtcbiAgfVxuXG4gIGlmICh0KCkuaXNSZWdFeHBMaXRlcmFsKGlkKSkge1xuICAgIHJldHVybiBgXyR7aWQucGF0dGVybn1fJHtpZC5mbGFnc31gO1xuICB9XG5cbiAgaWYgKHQoKS5pc1RlbXBsYXRlTGl0ZXJhbChpZCkpIHtcbiAgICByZXR1cm4gaWQucXVhc2lzLm1hcChxdWFzaSA9PiBxdWFzaS52YWx1ZS5yYXcpLmpvaW4oXCJcIik7XG4gIH1cblxuICBpZiAoaWQudmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBpZC52YWx1ZSArIFwiXCI7XG4gIH1cblxuICByZXR1cm4gXCJcIjtcbn1cblxuZnVuY3Rpb24gd3JhcChzdGF0ZSwgbWV0aG9kLCBpZCwgc2NvcGUpIHtcbiAgaWYgKHN0YXRlLnNlbGZSZWZlcmVuY2UpIHtcbiAgICBpZiAoc2NvcGUuaGFzQmluZGluZyhpZC5uYW1lKSAmJiAhc2NvcGUuaGFzR2xvYmFsKGlkLm5hbWUpKSB7XG4gICAgICBzY29wZS5yZW5hbWUoaWQubmFtZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdCgpLmlzRnVuY3Rpb24obWV0aG9kKSkgcmV0dXJuO1xuICAgICAgbGV0IGJ1aWxkID0gYnVpbGRQcm9wZXJ0eU1ldGhvZEFzc2lnbm1lbnRXcmFwcGVyO1xuXG4gICAgICBpZiAobWV0aG9kLmdlbmVyYXRvcikge1xuICAgICAgICBidWlsZCA9IGJ1aWxkR2VuZXJhdG9yUHJvcGVydHlNZXRob2RBc3NpZ25tZW50V3JhcHBlcjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdGVtcGxhdGUgPSBidWlsZCh7XG4gICAgICAgIEZVTkNUSU9OOiBtZXRob2QsXG4gICAgICAgIEZVTkNUSU9OX0lEOiBpZCxcbiAgICAgICAgRlVOQ1RJT05fS0VZOiBzY29wZS5nZW5lcmF0ZVVpZElkZW50aWZpZXIoaWQubmFtZSlcbiAgICAgIH0pLmV4cHJlc3Npb247XG4gICAgICBjb25zdCBwYXJhbXMgPSB0ZW1wbGF0ZS5jYWxsZWUuYm9keS5ib2R5WzBdLnBhcmFtcztcblxuICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9ICgwLCBfaGVscGVyR2V0RnVuY3Rpb25Bcml0eSgpLmRlZmF1bHQpKG1ldGhvZCk7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBwYXJhbXMucHVzaChzY29wZS5nZW5lcmF0ZVVpZElkZW50aWZpZXIoXCJ4XCIpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRlbXBsYXRlO1xuICAgIH1cbiAgfVxuXG4gIG1ldGhvZC5pZCA9IGlkO1xuICBzY29wZS5nZXRQcm9ncmFtUGFyZW50KCkucmVmZXJlbmNlc1tpZC5uYW1lXSA9IHRydWU7XG59XG5cbmZ1bmN0aW9uIHZpc2l0KG5vZGUsIG5hbWUsIHNjb3BlKSB7XG4gIGNvbnN0IHN0YXRlID0ge1xuICAgIHNlbGZBc3NpZ25tZW50OiBmYWxzZSxcbiAgICBzZWxmUmVmZXJlbmNlOiBmYWxzZSxcbiAgICBvdXRlckRlY2xhcjogc2NvcGUuZ2V0QmluZGluZ0lkZW50aWZpZXIobmFtZSksXG4gICAgcmVmZXJlbmNlczogW10sXG4gICAgbmFtZTogbmFtZVxuICB9O1xuICBjb25zdCBiaW5kaW5nID0gc2NvcGUuZ2V0T3duQmluZGluZyhuYW1lKTtcblxuICBpZiAoYmluZGluZykge1xuICAgIGlmIChiaW5kaW5nLmtpbmQgPT09IFwicGFyYW1cIikge1xuICAgICAgc3RhdGUuc2VsZlJlZmVyZW5jZSA9IHRydWU7XG4gICAgfSBlbHNlIHt9XG4gIH0gZWxzZSBpZiAoc3RhdGUub3V0ZXJEZWNsYXIgfHwgc2NvcGUuaGFzR2xvYmFsKG5hbWUpKSB7XG4gICAgc2NvcGUudHJhdmVyc2Uobm9kZSwgdmlzaXRvciwgc3RhdGUpO1xuICB9XG5cbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBfZGVmYXVsdCh7XG4gIG5vZGUsXG4gIHBhcmVudCxcbiAgc2NvcGUsXG4gIGlkXG59LCBsb2NhbEJpbmRpbmcgPSBmYWxzZSkge1xuICBpZiAobm9kZS5pZCkgcmV0dXJuO1xuXG4gIGlmICgodCgpLmlzT2JqZWN0UHJvcGVydHkocGFyZW50KSB8fCB0KCkuaXNPYmplY3RNZXRob2QocGFyZW50LCB7XG4gICAga2luZDogXCJtZXRob2RcIlxuICB9KSkgJiYgKCFwYXJlbnQuY29tcHV0ZWQgfHwgdCgpLmlzTGl0ZXJhbChwYXJlbnQua2V5KSkpIHtcbiAgICBpZCA9IHBhcmVudC5rZXk7XG4gIH0gZWxzZSBpZiAodCgpLmlzVmFyaWFibGVEZWNsYXJhdG9yKHBhcmVudCkpIHtcbiAgICBpZCA9IHBhcmVudC5pZDtcblxuICAgIGlmICh0KCkuaXNJZGVudGlmaWVyKGlkKSAmJiAhbG9jYWxCaW5kaW5nKSB7XG4gICAgICBjb25zdCBiaW5kaW5nID0gc2NvcGUucGFyZW50LmdldEJpbmRpbmcoaWQubmFtZSk7XG5cbiAgICAgIGlmIChiaW5kaW5nICYmIGJpbmRpbmcuY29uc3RhbnQgJiYgc2NvcGUuZ2V0QmluZGluZyhpZC5uYW1lKSA9PT0gYmluZGluZykge1xuICAgICAgICBub2RlLmlkID0gdCgpLmNsb25lTm9kZShpZCk7XG4gICAgICAgIG5vZGUuaWRbdCgpLk5PVF9MT0NBTF9CSU5ESU5HXSA9IHRydWU7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSBpZiAodCgpLmlzQXNzaWdubWVudEV4cHJlc3Npb24ocGFyZW50KSkge1xuICAgIGlkID0gcGFyZW50LmxlZnQ7XG4gIH0gZWxzZSBpZiAoIWlkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IG5hbWU7XG5cbiAgaWYgKGlkICYmIHQoKS5pc0xpdGVyYWwoaWQpKSB7XG4gICAgbmFtZSA9IGdldE5hbWVGcm9tTGl0ZXJhbElkKGlkKTtcbiAgfSBlbHNlIGlmIChpZCAmJiB0KCkuaXNJZGVudGlmaWVyKGlkKSkge1xuICAgIG5hbWUgPSBpZC5uYW1lO1xuICB9XG5cbiAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIG5hbWUgPSB0KCkudG9CaW5kaW5nSWRlbnRpZmllck5hbWUobmFtZSk7XG4gIGlkID0gdCgpLmlkZW50aWZpZXIobmFtZSk7XG4gIGlkW3QoKS5OT1RfTE9DQUxfQklORElOR10gPSB0cnVlO1xuICBjb25zdCBzdGF0ZSA9IHZpc2l0KG5vZGUsIG5hbWUsIHNjb3BlKTtcbiAgcmV0dXJuIHdyYXAoc3RhdGUsIG5vZGUsIGlkLCBzY29wZSkgfHwgbm9kZTtcbn0iXX0=