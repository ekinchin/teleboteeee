"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.runAsync = runAsync;
exports.runSync = runSync;

function _traverse() {
  const data = _interopRequireDefault(require("@babel/traverse"));

  _traverse = function () {
    return data;
  };

  return data;
}

var _pluginPass = _interopRequireDefault(require("./plugin-pass"));

var _blockHoistPlugin = _interopRequireDefault(require("./block-hoist-plugin"));

var _normalizeOpts = _interopRequireDefault(require("./normalize-opts"));

var _normalizeFile = _interopRequireDefault(require("./normalize-file"));

var _generate = _interopRequireDefault(require("./file/generate"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function runAsync(config, code, ast, callback) {
  let result;

  try {
    result = runSync(config, code, ast);
  } catch (err) {
    return callback(err);
  }

  return callback(null, result);
}

function runSync(config, code, ast) {
  const file = (0, _normalizeFile.default)(config.passes, (0, _normalizeOpts.default)(config), code, ast);
  transformFile(file, config.passes);
  const opts = file.opts;
  const {
    outputCode,
    outputMap
  } = opts.code !== false ? (0, _generate.default)(config.passes, file) : {};
  return {
    metadata: file.metadata,
    options: opts,
    ast: opts.ast === true ? file.ast : null,
    code: outputCode === undefined ? null : outputCode,
    map: outputMap === undefined ? null : outputMap,
    sourceType: file.ast.program.sourceType
  };
}

function transformFile(file, pluginPasses) {
  for (const pluginPairs of pluginPasses) {
    const passPairs = [];
    const passes = [];
    const visitors = [];

    for (const plugin of pluginPairs.concat([(0, _blockHoistPlugin.default)()])) {
      const pass = new _pluginPass.default(file, plugin.key, plugin.options);
      passPairs.push([plugin, pass]);
      passes.push(pass);
      visitors.push(plugin.visitor);
    }

    for (const [plugin, pass] of passPairs) {
      const fn = plugin.pre;

      if (fn) {
        const result = fn.call(pass, file);

        if (isThenable(result)) {
          throw new Error(`You appear to be using an plugin with an async .pre, ` + `which your current version of Babel does not support.` + `If you're using a published plugin, you may need to upgrade ` + `your @babel/core version.`);
        }
      }
    }

    const visitor = _traverse().default.visitors.merge(visitors, passes, file.opts.wrapPluginVisitorMethod);

    (0, _traverse().default)(file.ast, visitor, file.scope);

    for (const [plugin, pass] of passPairs) {
      const fn = plugin.post;

      if (fn) {
        const result = fn.call(pass, file);

        if (isThenable(result)) {
          throw new Error(`You appear to be using an plugin with an async .post, ` + `which your current version of Babel does not support.` + `If you're using a published plugin, you may need to upgrade ` + `your @babel/core version.`);
        }
      }
    }
  }
}

function isThenable(val) {
  return !!val && (typeof val === "object" || typeof val === "function") && typeof val.then === "function";
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29yZS9saWIvdHJhbnNmb3JtYXRpb24vaW5kZXguanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJydW5Bc3luYyIsInJ1blN5bmMiLCJfdHJhdmVyc2UiLCJkYXRhIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfcGx1Z2luUGFzcyIsIl9ibG9ja0hvaXN0UGx1Z2luIiwiX25vcm1hbGl6ZU9wdHMiLCJfbm9ybWFsaXplRmlsZSIsIl9nZW5lcmF0ZSIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiY29uZmlnIiwiY29kZSIsImFzdCIsImNhbGxiYWNrIiwicmVzdWx0IiwiZXJyIiwiZmlsZSIsInBhc3NlcyIsInRyYW5zZm9ybUZpbGUiLCJvcHRzIiwib3V0cHV0Q29kZSIsIm91dHB1dE1hcCIsIm1ldGFkYXRhIiwib3B0aW9ucyIsInVuZGVmaW5lZCIsIm1hcCIsInNvdXJjZVR5cGUiLCJwcm9ncmFtIiwicGx1Z2luUGFzc2VzIiwicGx1Z2luUGFpcnMiLCJwYXNzUGFpcnMiLCJ2aXNpdG9ycyIsInBsdWdpbiIsImNvbmNhdCIsInBhc3MiLCJrZXkiLCJwdXNoIiwidmlzaXRvciIsImZuIiwicHJlIiwiY2FsbCIsImlzVGhlbmFibGUiLCJFcnJvciIsIm1lcmdlIiwid3JhcFBsdWdpblZpc2l0b3JNZXRob2QiLCJzY29wZSIsInBvc3QiLCJ2YWwiLCJ0aGVuIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsUUFBUixHQUFtQkEsUUFBbkI7QUFDQUYsT0FBTyxDQUFDRyxPQUFSLEdBQWtCQSxPQUFsQjs7QUFFQSxTQUFTQyxT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QyxFQUFxREQsSUFBSSxDQUFDRyxJQUFMLENBQVV5Qix1QkFBL0QsQ0FBaEI7O0FBRUEsS0FBQyxHQUFHOUMsU0FBUyxHQUFHVyxPQUFoQixFQUF5Qk8sSUFBSSxDQUFDSixHQUE5QixFQUFtQ3lCLE9BQW5DLEVBQTRDckIsSUFBSSxDQUFDNkIsS0FBakQ7O0FBRUEsU0FBSyxNQUFNLENBQUNiLE1BQUQsRUFBU0UsSUFBVCxDQUFYLElBQTZCSixTQUE3QixFQUF3QztBQUN0QyxZQUFNUSxFQUFFLEdBQUdOLE1BQU0sQ0FBQ2MsSUFBbEI7O0FBRUEsVUFBSVIsRUFBSixFQUFRO0FBQ04sY0FBTXhCLE1BQU0sR0FBR3dCLEVBQUUsQ0FBQ0UsSUFBSCxDQUFRTixJQUFSLEVBQWNsQixJQUFkLENBQWY7O0FBRUEsWUFBSXlCLFVBQVUsQ0FBQzNCLE1BQUQsQ0FBZCxFQUF3QjtBQUN0QixnQkFBTSxJQUFJNEIsS0FBSixDQUFXLHdEQUFELEdBQTRELHVEQUE1RCxHQUFzSCw4REFBdEgsR0FBdUwsMkJBQWpNLENBQU47QUFDRDtBQUNGO0FBQ0Y7QUFDRjtBQUNGOztBQUVELFNBQVNELFVBQVQsQ0FBb0JNLEdBQXBCLEVBQXlCO0FBQ3ZCLFNBQU8sQ0FBQyxDQUFDQSxHQUFGLEtBQVUsT0FBT0EsR0FBUCxLQUFlLFFBQWYsSUFBMkIsT0FBT0EsR0FBUCxLQUFlLFVBQXBELEtBQW1FLE9BQU9BLEdBQUcsQ0FBQ0MsSUFBWCxLQUFvQixVQUE5RjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLnJ1bkFzeW5jID0gcnVuQXN5bmM7XG5leHBvcnRzLnJ1blN5bmMgPSBydW5TeW5jO1xuXG5mdW5jdGlvbiBfdHJhdmVyc2UoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJAYmFiZWwvdHJhdmVyc2VcIikpO1xuXG4gIF90cmF2ZXJzZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxudmFyIF9wbHVnaW5QYXNzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9wbHVnaW4tcGFzc1wiKSk7XG5cbnZhciBfYmxvY2tIb2lzdFBsdWdpbiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vYmxvY2staG9pc3QtcGx1Z2luXCIpKTtcblxudmFyIF9ub3JtYWxpemVPcHRzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9ub3JtYWxpemUtb3B0c1wiKSk7XG5cbnZhciBfbm9ybWFsaXplRmlsZSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vbm9ybWFsaXplLWZpbGVcIikpO1xuXG52YXIgX2dlbmVyYXRlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9maWxlL2dlbmVyYXRlXCIpKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuZnVuY3Rpb24gcnVuQXN5bmMoY29uZmlnLCBjb2RlLCBhc3QsIGNhbGxiYWNrKSB7XG4gIGxldCByZXN1bHQ7XG5cbiAgdHJ5IHtcbiAgICByZXN1bHQgPSBydW5TeW5jKGNvbmZpZywgY29kZSwgYXN0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gIH1cblxuICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzdWx0KTtcbn1cblxuZnVuY3Rpb24gcnVuU3luYyhjb25maWcsIGNvZGUsIGFzdCkge1xuICBjb25zdCBmaWxlID0gKDAsIF9ub3JtYWxpemVGaWxlLmRlZmF1bHQpKGNvbmZpZy5wYXNzZXMsICgwLCBfbm9ybWFsaXplT3B0cy5kZWZhdWx0KShjb25maWcpLCBjb2RlLCBhc3QpO1xuICB0cmFuc2Zvcm1GaWxlKGZpbGUsIGNvbmZpZy5wYXNzZXMpO1xuICBjb25zdCBvcHRzID0gZmlsZS5vcHRzO1xuICBjb25zdCB7XG4gICAgb3V0cHV0Q29kZSxcbiAgICBvdXRwdXRNYXBcbiAgfSA9IG9wdHMuY29kZSAhPT0gZmFsc2UgPyAoMCwgX2dlbmVyYXRlLmRlZmF1bHQpKGNvbmZpZy5wYXNzZXMsIGZpbGUpIDoge307XG4gIHJldHVybiB7XG4gICAgbWV0YWRhdGE6IGZpbGUubWV0YWRhdGEsXG4gICAgb3B0aW9uczogb3B0cyxcbiAgICBhc3Q6IG9wdHMuYXN0ID09PSB0cnVlID8gZmlsZS5hc3QgOiBudWxsLFxuICAgIGNvZGU6IG91dHB1dENvZGUgPT09IHVuZGVmaW5lZCA/IG51bGwgOiBvdXRwdXRDb2RlLFxuICAgIG1hcDogb3V0cHV0TWFwID09PSB1bmRlZmluZWQgPyBudWxsIDogb3V0cHV0TWFwLFxuICAgIHNvdXJjZVR5cGU6IGZpbGUuYXN0LnByb2dyYW0uc291cmNlVHlwZVxuICB9O1xufVxuXG5mdW5jdGlvbiB0cmFuc2Zvcm1GaWxlKGZpbGUsIHBsdWdpblBhc3Nlcykge1xuICBmb3IgKGNvbnN0IHBsdWdpblBhaXJzIG9mIHBsdWdpblBhc3Nlcykge1xuICAgIGNvbnN0IHBhc3NQYWlycyA9IFtdO1xuICAgIGNvbnN0IHBhc3NlcyA9IFtdO1xuICAgIGNvbnN0IHZpc2l0b3JzID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHBsdWdpbiBvZiBwbHVnaW5QYWlycy5jb25jYXQoWygwLCBfYmxvY2tIb2lzdFBsdWdpbi5kZWZhdWx0KSgpXSkpIHtcbiAgICAgIGNvbnN0IHBhc3MgPSBuZXcgX3BsdWdpblBhc3MuZGVmYXVsdChmaWxlLCBwbHVnaW4ua2V5LCBwbHVnaW4ub3B0aW9ucyk7XG4gICAgICBwYXNzUGFpcnMucHVzaChbcGx1Z2luLCBwYXNzXSk7XG4gICAgICBwYXNzZXMucHVzaChwYXNzKTtcbiAgICAgIHZpc2l0b3JzLnB1c2gocGx1Z2luLnZpc2l0b3IpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgW3BsdWdpbiwgcGFzc10gb2YgcGFzc1BhaXJzKSB7XG4gICAgICBjb25zdCBmbiA9IHBsdWdpbi5wcmU7XG5cbiAgICAgIGlmIChmbikge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBmbi5jYWxsKHBhc3MsIGZpbGUpO1xuXG4gICAgICAgIGlmIChpc1RoZW5hYmxlKHJlc3VsdCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFlvdSBhcHBlYXIgdG8gYmUgdXNpbmcgYW4gcGx1Z2luIHdpdGggYW4gYXN5bmMgLnByZSwgYCArIGB3aGljaCB5b3VyIGN1cnJlbnQgdmVyc2lvbiBvZiBCYWJlbCBkb2VzIG5vdCBzdXBwb3J0LmAgKyBgSWYgeW91J3JlIHVzaW5nIGEgcHVibGlzaGVkIHBsdWdpbiwgeW91IG1heSBuZWVkIHRvIHVwZ3JhZGUgYCArIGB5b3VyIEBiYWJlbC9jb3JlIHZlcnNpb24uYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB2aXNpdG9yID0gX3RyYXZlcnNlKCkuZGVmYXVsdC52aXNpdG9ycy5tZXJnZSh2aXNpdG9ycywgcGFzc2VzLCBmaWxlLm9wdHMud3JhcFBsdWdpblZpc2l0b3JNZXRob2QpO1xuXG4gICAgKDAsIF90cmF2ZXJzZSgpLmRlZmF1bHQpKGZpbGUuYXN0LCB2aXNpdG9yLCBmaWxlLnNjb3BlKTtcblxuICAgIGZvciAoY29uc3QgW3BsdWdpbiwgcGFzc10gb2YgcGFzc1BhaXJzKSB7XG4gICAgICBjb25zdCBmbiA9IHBsdWdpbi5wb3N0O1xuXG4gICAgICBpZiAoZm4pIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gZm4uY2FsbChwYXNzLCBmaWxlKTtcblxuICAgICAgICBpZiAoaXNUaGVuYWJsZShyZXN1bHQpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBZb3UgYXBwZWFyIHRvIGJlIHVzaW5nIGFuIHBsdWdpbiB3aXRoIGFuIGFzeW5jIC5wb3N0LCBgICsgYHdoaWNoIHlvdXIgY3VycmVudCB2ZXJzaW9uIG9mIEJhYmVsIGRvZXMgbm90IHN1cHBvcnQuYCArIGBJZiB5b3UncmUgdXNpbmcgYSBwdWJsaXNoZWQgcGx1Z2luLCB5b3UgbWF5IG5lZWQgdG8gdXBncmFkZSBgICsgYHlvdXIgQGJhYmVsL2NvcmUgdmVyc2lvbi5gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpc1RoZW5hYmxlKHZhbCkge1xuICByZXR1cm4gISF2YWwgJiYgKHR5cGVvZiB2YWwgPT09IFwib2JqZWN0XCIgfHwgdHlwZW9mIHZhbCA9PT0gXCJmdW5jdGlvblwiKSAmJiB0eXBlb2YgdmFsLnRoZW4gPT09IFwiZnVuY3Rpb25cIjtcbn0iXX0=