"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = normalizeFile;

function _path() {
  const data = _interopRequireDefault(require("path"));

  _path = function () {
    return data;
  };

  return data;
}

function _debug() {
  const data = _interopRequireDefault(require("debug"));

  _debug = function () {
    return data;
  };

  return data;
}

function _cloneDeep() {
  const data = _interopRequireDefault(require("lodash/cloneDeep"));

  _cloneDeep = function () {
    return data;
  };

  return data;
}

function t() {
  const data = _interopRequireWildcard(require("@babel/types"));

  t = function () {
    return data;
  };

  return data;
}

function _convertSourceMap() {
  const data = _interopRequireDefault(require("convert-source-map"));

  _convertSourceMap = function () {
    return data;
  };

  return data;
}

function _parser() {
  const data = require("@babel/parser");

  _parser = function () {
    return data;
  };

  return data;
}

function _codeFrame() {
  const data = require("@babel/code-frame");

  _codeFrame = function () {
    return data;
  };

  return data;
}

var _file = _interopRequireDefault(require("./file/file"));

var _missingPluginHelper = _interopRequireDefault(require("./util/missing-plugin-helper"));

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

const debug = (0, _debug().default)("babel:transform:file");

function normalizeFile(pluginPasses, options, code, ast) {
  code = `${code || ""}`;
  let inputMap = null;

  if (options.inputSourceMap !== false) {
    if (typeof options.inputSourceMap === "object") {
      inputMap = _convertSourceMap().default.fromObject(options.inputSourceMap);
    }

    if (!inputMap) {
      try {
        inputMap = _convertSourceMap().default.fromSource(code);

        if (inputMap) {
          code = _convertSourceMap().default.removeComments(code);
        }
      } catch (err) {
        debug("discarding unknown inline input sourcemap", err);
        code = _convertSourceMap().default.removeComments(code);
      }
    }

    if (!inputMap) {
      if (typeof options.filename === "string") {
        try {
          inputMap = _convertSourceMap().default.fromMapFileSource(code, _path().default.dirname(options.filename));

          if (inputMap) {
            code = _convertSourceMap().default.removeMapFileComments(code);
          }
        } catch (err) {
          debug("discarding unknown file input sourcemap", err);
          code = _convertSourceMap().default.removeMapFileComments(code);
        }
      } else {
        debug("discarding un-loadable file input sourcemap");
        code = _convertSourceMap().default.removeMapFileComments(code);
      }
    }
  }

  if (ast) {
    if (ast.type === "Program") {
      ast = t().file(ast, [], []);
    } else if (ast.type !== "File") {
      throw new Error("AST root must be a Program or File node");
    }

    ast = (0, _cloneDeep().default)(ast);
  } else {
    ast = parser(pluginPasses, options, code);
  }

  return new _file.default(options, {
    code,
    ast,
    inputMap
  });
}

function parser(pluginPasses, {
  parserOpts,
  highlightCode = true,
  filename = "unknown"
}, code) {
  try {
    const results = [];

    for (const plugins of pluginPasses) {
      for (const plugin of plugins) {
        const {
          parserOverride
        } = plugin;

        if (parserOverride) {
          const ast = parserOverride(code, parserOpts, _parser().parse);
          if (ast !== undefined) results.push(ast);
        }
      }
    }

    if (results.length === 0) {
      return (0, _parser().parse)(code, parserOpts);
    } else if (results.length === 1) {
      if (typeof results[0].then === "function") {
        throw new Error(`You appear to be using an async codegen plugin, ` + `which your current version of Babel does not support. ` + `If you're using a published plugin, you may need to upgrade ` + `your @babel/core version.`);
      }

      return results[0];
    }

    throw new Error("More than one plugin attempted to override parsing.");
  } catch (err) {
    if (err.code === "BABEL_PARSER_SOURCETYPE_MODULE_REQUIRED") {
      err.message += "\nConsider renaming the file to '.mjs', or setting sourceType:module " + "or sourceType:unambiguous in your Babel config for this file.";
    }

    const {
      loc,
      missingPlugin
    } = err;

    if (loc) {
      const codeFrame = (0, _codeFrame().codeFrameColumns)(code, {
        start: {
          line: loc.line,
          column: loc.column + 1
        }
      }, {
        highlightCode
      });

      if (missingPlugin) {
        err.message = `${filename}: ` + (0, _missingPluginHelper.default)(missingPlugin[0], loc, codeFrame);
      } else {
        err.message = `${filename}: ${err.message}\n\n` + codeFrame;
      }

      err.code = "BABEL_PARSE_ERROR";
    }

    throw err;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29yZS9saWIvdHJhbnNmb3JtYXRpb24vbm9ybWFsaXplLWZpbGUuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0Iiwibm9ybWFsaXplRmlsZSIsIl9wYXRoIiwiZGF0YSIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX2RlYnVnIiwiX2Nsb25lRGVlcCIsInQiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsIl9jb252ZXJ0U291cmNlTWFwIiwiX3BhcnNlciIsIl9jb2RlRnJhbWUiLCJfZmlsZSIsIl9taXNzaW5nUGx1Z2luSGVscGVyIiwib2JqIiwiX19lc01vZHVsZSIsIm5ld09iaiIsImtleSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImRlc2MiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJnZXQiLCJzZXQiLCJkZWJ1ZyIsInBsdWdpblBhc3NlcyIsIm9wdGlvbnMiLCJjb2RlIiwiYXN0IiwiaW5wdXRNYXAiLCJpbnB1dFNvdXJjZU1hcCIsImZyb21PYmplY3QiLCJmcm9tU291cmNlIiwicmVtb3ZlQ29tbWVudHMiLCJlcnIiLCJmaWxlbmFtZSIsImZyb21NYXBGaWxlU291cmNlIiwiZGlybmFtZSIsInJlbW92ZU1hcEZpbGVDb21tZW50cyIsInR5cGUiLCJmaWxlIiwiRXJyb3IiLCJwYXJzZXIiLCJwYXJzZXJPcHRzIiwiaGlnaGxpZ2h0Q29kZSIsInJlc3VsdHMiLCJwbHVnaW5zIiwicGx1Z2luIiwicGFyc2VyT3ZlcnJpZGUiLCJwYXJzZSIsInVuZGVmaW5lZCIsInB1c2giLCJsZW5ndGgiLCJ0aGVuIiwibWVzc2FnZSIsImxvYyIsIm1pc3NpbmdQbHVnaW4iLCJjb2RlRnJhbWUiLCJjb2RlRnJhbWVDb2x1bW5zIiwic3RhcnQiLCJsaW5lIiwiY29sdW1u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QUFJLEVBQUVMLEdBQUcsQ0FBQ0ssSUFETDtBQUVMQyxVQUFBQSxNQUFNLEVBQUVOLEdBQUcsQ0FBQ00sTUFBSixHQUFhO0FBRmhCO0FBRGtELE9BQXpDLEVBS2Y7QUFDRGpCLFFBQUFBO0FBREMsT0FMZSxDQUFsQjs7QUFTQSxVQUFJWSxhQUFKLEVBQW1CO0FBQ2pCdEIsUUFBQUEsR0FBRyxDQUFDb0IsT0FBSixHQUFlLEdBQUVuQixRQUFTLElBQVosR0FBa0IsQ0FBQyxHQUFHdkIsb0JBQW9CLENBQUNkLE9BQXpCLEVBQWtDMEQsYUFBYSxDQUFDLENBQUQsQ0FBL0MsRUFBb0RELEdBQXBELEVBQXlERSxTQUF6RCxDQUFoQztBQUNELE9BRkQsTUFFTztBQUNMdkIsUUFBQUEsR0FBRyxDQUFDb0IsT0FBSixHQUFlLEdBQUVuQixRQUFTLEtBQUlELEdBQUcsQ0FBQ29CLE9BQVEsTUFBNUIsR0FBb0NHLFNBQWxEO0FBQ0Q7O0FBRUR2QixNQUFBQSxHQUFHLENBQUNQLElBQUosR0FBVyxtQkFBWDtBQUNEOztBQUVELFVBQU1PLEdBQU47QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLmRlZmF1bHQgPSBub3JtYWxpemVGaWxlO1xuXG5mdW5jdGlvbiBfcGF0aCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcInBhdGhcIikpO1xuXG4gIF9wYXRoID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfZGVidWcoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJkZWJ1Z1wiKSk7XG5cbiAgX2RlYnVnID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfY2xvbmVEZWVwKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwibG9kYXNoL2Nsb25lRGVlcFwiKSk7XG5cbiAgX2Nsb25lRGVlcCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gdCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCJAYmFiZWwvdHlwZXNcIikpO1xuXG4gIHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9jb252ZXJ0U291cmNlTWFwKCkge1xuICBjb25zdCBkYXRhID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiY29udmVydC1zb3VyY2UtbWFwXCIpKTtcblxuICBfY29udmVydFNvdXJjZU1hcCA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxuZnVuY3Rpb24gX3BhcnNlcigpIHtcbiAgY29uc3QgZGF0YSA9IHJlcXVpcmUoXCJAYmFiZWwvcGFyc2VyXCIpO1xuXG4gIF9wYXJzZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH07XG5cbiAgcmV0dXJuIGRhdGE7XG59XG5cbmZ1bmN0aW9uIF9jb2RlRnJhbWUoKSB7XG4gIGNvbnN0IGRhdGEgPSByZXF1aXJlKFwiQGJhYmVsL2NvZGUtZnJhbWVcIik7XG5cbiAgX2NvZGVGcmFtZSA9IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfTtcblxuICByZXR1cm4gZGF0YTtcbn1cblxudmFyIF9maWxlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi9maWxlL2ZpbGVcIikpO1xuXG52YXIgX21pc3NpbmdQbHVnaW5IZWxwZXIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL3V0aWwvbWlzc2luZy1wbHVnaW4taGVscGVyXCIpKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQob2JqKSB7IGlmIChvYmogJiYgb2JqLl9fZXNNb2R1bGUpIHsgcmV0dXJuIG9iajsgfSBlbHNlIHsgdmFyIG5ld09iaiA9IHt9OyBpZiAob2JqICE9IG51bGwpIHsgZm9yICh2YXIga2V5IGluIG9iaikgeyBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgeyB2YXIgZGVzYyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAmJiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yID8gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSkgOiB7fTsgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShuZXdPYmosIGtleSwgZGVzYyk7IH0gZWxzZSB7IG5ld09ialtrZXldID0gb2JqW2tleV07IH0gfSB9IH0gbmV3T2JqLmRlZmF1bHQgPSBvYmo7IHJldHVybiBuZXdPYmo7IH0gfVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfVxuXG5jb25zdCBkZWJ1ZyA9ICgwLCBfZGVidWcoKS5kZWZhdWx0KShcImJhYmVsOnRyYW5zZm9ybTpmaWxlXCIpO1xuXG5mdW5jdGlvbiBub3JtYWxpemVGaWxlKHBsdWdpblBhc3Nlcywgb3B0aW9ucywgY29kZSwgYXN0KSB7XG4gIGNvZGUgPSBgJHtjb2RlIHx8IFwiXCJ9YDtcbiAgbGV0IGlucHV0TWFwID0gbnVsbDtcblxuICBpZiAob3B0aW9ucy5pbnB1dFNvdXJjZU1hcCAhPT0gZmFsc2UpIHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuaW5wdXRTb3VyY2VNYXAgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIGlucHV0TWFwID0gX2NvbnZlcnRTb3VyY2VNYXAoKS5kZWZhdWx0LmZyb21PYmplY3Qob3B0aW9ucy5pbnB1dFNvdXJjZU1hcCk7XG4gICAgfVxuXG4gICAgaWYgKCFpbnB1dE1hcCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgaW5wdXRNYXAgPSBfY29udmVydFNvdXJjZU1hcCgpLmRlZmF1bHQuZnJvbVNvdXJjZShjb2RlKTtcblxuICAgICAgICBpZiAoaW5wdXRNYXApIHtcbiAgICAgICAgICBjb2RlID0gX2NvbnZlcnRTb3VyY2VNYXAoKS5kZWZhdWx0LnJlbW92ZUNvbW1lbnRzKGNvZGUpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZGVidWcoXCJkaXNjYXJkaW5nIHVua25vd24gaW5saW5lIGlucHV0IHNvdXJjZW1hcFwiLCBlcnIpO1xuICAgICAgICBjb2RlID0gX2NvbnZlcnRTb3VyY2VNYXAoKS5kZWZhdWx0LnJlbW92ZUNvbW1lbnRzKGNvZGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghaW5wdXRNYXApIHtcbiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5maWxlbmFtZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlucHV0TWFwID0gX2NvbnZlcnRTb3VyY2VNYXAoKS5kZWZhdWx0LmZyb21NYXBGaWxlU291cmNlKGNvZGUsIF9wYXRoKCkuZGVmYXVsdC5kaXJuYW1lKG9wdGlvbnMuZmlsZW5hbWUpKTtcblxuICAgICAgICAgIGlmIChpbnB1dE1hcCkge1xuICAgICAgICAgICAgY29kZSA9IF9jb252ZXJ0U291cmNlTWFwKCkuZGVmYXVsdC5yZW1vdmVNYXBGaWxlQ29tbWVudHMoY29kZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBkZWJ1ZyhcImRpc2NhcmRpbmcgdW5rbm93biBmaWxlIGlucHV0IHNvdXJjZW1hcFwiLCBlcnIpO1xuICAgICAgICAgIGNvZGUgPSBfY29udmVydFNvdXJjZU1hcCgpLmRlZmF1bHQucmVtb3ZlTWFwRmlsZUNvbW1lbnRzKGNvZGUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkZWJ1ZyhcImRpc2NhcmRpbmcgdW4tbG9hZGFibGUgZmlsZSBpbnB1dCBzb3VyY2VtYXBcIik7XG4gICAgICAgIGNvZGUgPSBfY29udmVydFNvdXJjZU1hcCgpLmRlZmF1bHQucmVtb3ZlTWFwRmlsZUNvbW1lbnRzKGNvZGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChhc3QpIHtcbiAgICBpZiAoYXN0LnR5cGUgPT09IFwiUHJvZ3JhbVwiKSB7XG4gICAgICBhc3QgPSB0KCkuZmlsZShhc3QsIFtdLCBbXSk7XG4gICAgfSBlbHNlIGlmIChhc3QudHlwZSAhPT0gXCJGaWxlXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFTVCByb290IG11c3QgYmUgYSBQcm9ncmFtIG9yIEZpbGUgbm9kZVwiKTtcbiAgICB9XG5cbiAgICBhc3QgPSAoMCwgX2Nsb25lRGVlcCgpLmRlZmF1bHQpKGFzdCk7XG4gIH0gZWxzZSB7XG4gICAgYXN0ID0gcGFyc2VyKHBsdWdpblBhc3Nlcywgb3B0aW9ucywgY29kZSk7XG4gIH1cblxuICByZXR1cm4gbmV3IF9maWxlLmRlZmF1bHQob3B0aW9ucywge1xuICAgIGNvZGUsXG4gICAgYXN0LFxuICAgIGlucHV0TWFwXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBwYXJzZXIocGx1Z2luUGFzc2VzLCB7XG4gIHBhcnNlck9wdHMsXG4gIGhpZ2hsaWdodENvZGUgPSB0cnVlLFxuICBmaWxlbmFtZSA9IFwidW5rbm93blwiXG59LCBjb2RlKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzdWx0cyA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBwbHVnaW5zIG9mIHBsdWdpblBhc3Nlcykge1xuICAgICAgZm9yIChjb25zdCBwbHVnaW4gb2YgcGx1Z2lucykge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgcGFyc2VyT3ZlcnJpZGVcbiAgICAgICAgfSA9IHBsdWdpbjtcblxuICAgICAgICBpZiAocGFyc2VyT3ZlcnJpZGUpIHtcbiAgICAgICAgICBjb25zdCBhc3QgPSBwYXJzZXJPdmVycmlkZShjb2RlLCBwYXJzZXJPcHRzLCBfcGFyc2VyKCkucGFyc2UpO1xuICAgICAgICAgIGlmIChhc3QgIT09IHVuZGVmaW5lZCkgcmVzdWx0cy5wdXNoKGFzdCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVzdWx0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiAoMCwgX3BhcnNlcigpLnBhcnNlKShjb2RlLCBwYXJzZXJPcHRzKTtcbiAgICB9IGVsc2UgaWYgKHJlc3VsdHMubGVuZ3RoID09PSAxKSB7XG4gICAgICBpZiAodHlwZW9mIHJlc3VsdHNbMF0udGhlbiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgWW91IGFwcGVhciB0byBiZSB1c2luZyBhbiBhc3luYyBjb2RlZ2VuIHBsdWdpbiwgYCArIGB3aGljaCB5b3VyIGN1cnJlbnQgdmVyc2lvbiBvZiBCYWJlbCBkb2VzIG5vdCBzdXBwb3J0LiBgICsgYElmIHlvdSdyZSB1c2luZyBhIHB1Ymxpc2hlZCBwbHVnaW4sIHlvdSBtYXkgbmVlZCB0byB1cGdyYWRlIGAgKyBgeW91ciBAYmFiZWwvY29yZSB2ZXJzaW9uLmApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0c1swXTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gb3ZlcnJpZGUgcGFyc2luZy5cIik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIuY29kZSA9PT0gXCJCQUJFTF9QQVJTRVJfU09VUkNFVFlQRV9NT0RVTEVfUkVRVUlSRURcIikge1xuICAgICAgZXJyLm1lc3NhZ2UgKz0gXCJcXG5Db25zaWRlciByZW5hbWluZyB0aGUgZmlsZSB0byAnLm1qcycsIG9yIHNldHRpbmcgc291cmNlVHlwZTptb2R1bGUgXCIgKyBcIm9yIHNvdXJjZVR5cGU6dW5hbWJpZ3VvdXMgaW4geW91ciBCYWJlbCBjb25maWcgZm9yIHRoaXMgZmlsZS5cIjtcbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICBsb2MsXG4gICAgICBtaXNzaW5nUGx1Z2luXG4gICAgfSA9IGVycjtcblxuICAgIGlmIChsb2MpIHtcbiAgICAgIGNvbnN0IGNvZGVGcmFtZSA9ICgwLCBfY29kZUZyYW1lKCkuY29kZUZyYW1lQ29sdW1ucykoY29kZSwge1xuICAgICAgICBzdGFydDoge1xuICAgICAgICAgIGxpbmU6IGxvYy5saW5lLFxuICAgICAgICAgIGNvbHVtbjogbG9jLmNvbHVtbiArIDFcbiAgICAgICAgfVxuICAgICAgfSwge1xuICAgICAgICBoaWdobGlnaHRDb2RlXG4gICAgICB9KTtcblxuICAgICAgaWYgKG1pc3NpbmdQbHVnaW4pIHtcbiAgICAgICAgZXJyLm1lc3NhZ2UgPSBgJHtmaWxlbmFtZX06IGAgKyAoMCwgX21pc3NpbmdQbHVnaW5IZWxwZXIuZGVmYXVsdCkobWlzc2luZ1BsdWdpblswXSwgbG9jLCBjb2RlRnJhbWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXJyLm1lc3NhZ2UgPSBgJHtmaWxlbmFtZX06ICR7ZXJyLm1lc3NhZ2V9XFxuXFxuYCArIGNvZGVGcmFtZTtcbiAgICAgIH1cblxuICAgICAgZXJyLmNvZGUgPSBcIkJBQkVMX1BBUlNFX0VSUk9SXCI7XG4gICAgfVxuXG4gICAgdGhyb3cgZXJyO1xuICB9XG59Il19