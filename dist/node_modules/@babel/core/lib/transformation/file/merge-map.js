"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = mergeSourceMap;

function _sourceMap() {
  const data = _interopRequireDefault(require("source-map"));

  _sourceMap = function () {
    return data;
  };

  return data;
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function mergeSourceMap(inputMap, map) {
  const input = buildMappingData(inputMap);
  const output = buildMappingData(map);
  const mergedGenerator = new (_sourceMap().default.SourceMapGenerator)();

  for (const _ref of input.sources) {
    const {
      source
    } = _ref;

    if (typeof source.content === "string") {
      mergedGenerator.setSourceContent(source.path, source.content);
    }
  }

  if (output.sources.length === 1) {
    const defaultSource = output.sources[0];
    const insertedMappings = new Map();
    eachInputGeneratedRange(input, (generated, original, source) => {
      eachOverlappingGeneratedOutputRange(defaultSource, generated, item => {
        const key = makeMappingKey(item);
        if (insertedMappings.has(key)) return;
        insertedMappings.set(key, item);
        mergedGenerator.addMapping({
          source: source.path,
          original: {
            line: original.line,
            column: original.columnStart
          },
          generated: {
            line: item.line,
            column: item.columnStart
          },
          name: original.name
        });
      });
    });

    for (const item of insertedMappings.values()) {
      if (item.columnEnd === Infinity) {
        continue;
      }

      const clearItem = {
        line: item.line,
        columnStart: item.columnEnd
      };
      const key = makeMappingKey(clearItem);

      if (insertedMappings.has(key)) {
        continue;
      }

      mergedGenerator.addMapping({
        generated: {
          line: clearItem.line,
          column: clearItem.columnStart
        }
      });
    }
  }

  const result = mergedGenerator.toJSON();

  if (typeof input.sourceRoot === "string") {
    result.sourceRoot = input.sourceRoot;
  }

  return result;
}

function makeMappingKey(item) {
  return `${item.line}/${item.columnStart}`;
}

function eachOverlappingGeneratedOutputRange(outputFile, inputGeneratedRange, callback) {
  const overlappingOriginal = filterApplicableOriginalRanges(outputFile, inputGeneratedRange);

  for (const _ref2 of overlappingOriginal) {
    const {
      generated
    } = _ref2;

    for (const item of generated) {
      callback(item);
    }
  }
}

function filterApplicableOriginalRanges({
  mappings
}, {
  line,
  columnStart,
  columnEnd
}) {
  return filterSortedArray(mappings, ({
    original: outOriginal
  }) => {
    if (line > outOriginal.line) return -1;
    if (line < outOriginal.line) return 1;
    if (columnStart >= outOriginal.columnEnd) return -1;
    if (columnEnd <= outOriginal.columnStart) return 1;
    return 0;
  });
}

function eachInputGeneratedRange(map, callback) {
  for (const _ref3 of map.sources) {
    const {
      source,
      mappings
    } = _ref3;

    for (const _ref4 of mappings) {
      const {
        original,
        generated
      } = _ref4;

      for (const item of generated) {
        callback(item, original, source);
      }
    }
  }
}

function buildMappingData(map) {
  const consumer = new (_sourceMap().default.SourceMapConsumer)(Object.assign({}, map, {
    sourceRoot: null
  }));
  const sources = new Map();
  const mappings = new Map();
  let last = null;
  consumer.computeColumnSpans();
  consumer.eachMapping(m => {
    if (m.originalLine === null) return;
    let source = sources.get(m.source);

    if (!source) {
      source = {
        path: m.source,
        content: consumer.sourceContentFor(m.source, true)
      };
      sources.set(m.source, source);
    }

    let sourceData = mappings.get(source);

    if (!sourceData) {
      sourceData = {
        source,
        mappings: []
      };
      mappings.set(source, sourceData);
    }

    const obj = {
      line: m.originalLine,
      columnStart: m.originalColumn,
      columnEnd: Infinity,
      name: m.name
    };

    if (last && last.source === source && last.mapping.line === m.originalLine) {
      last.mapping.columnEnd = m.originalColumn;
    }

    last = {
      source,
      mapping: obj
    };
    sourceData.mappings.push({
      original: obj,
      generated: consumer.allGeneratedPositionsFor({
        source: m.source,
        line: m.originalLine,
        column: m.originalColumn
      }).map(item => ({
        line: item.line,
        columnStart: item.column,
        columnEnd: item.lastColumn + 1
      }))
    });
  }, null, _sourceMap().default.SourceMapConsumer.ORIGINAL_ORDER);
  return {
    file: map.file,
    sourceRoot: map.sourceRoot,
    sources: Array.from(mappings.values())
  };
}

function findInsertionLocation(array, callback) {
  let left = 0;
  let right = array.length;

  while (left < right) {
    const mid = Math.floor((left + right) / 2);
    const item = array[mid];
    const result = callback(item);

    if (result === 0) {
      left = mid;
      break;
    }

    if (result >= 0) {
      right = mid;
    } else {
      left = mid + 1;
    }
  }

  let i = left;

  if (i < array.length) {
    while (i >= 0 && callback(array[i]) >= 0) {
      i--;
    }

    return i + 1;
  }

  return i;
}

function filterSortedArray(array, callback) {
  const start = findInsertionLocation(array, callback);
  const results = [];

  for (let i = start; i < array.length && callback(array[i]) === 0; i++) {
    results.push(array[i]);
  }

  return results;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29yZS9saWIvdHJhbnNmb3JtYXRpb24vZmlsZS9tZXJnZS1tYXAuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0IiwibWVyZ2VTb3VyY2VNYXAiLCJfc291cmNlTWFwIiwiZGF0YSIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwib2JqIiwiX19lc01vZHVsZSIsImlucHV0TWFwIiwibWFwIiwiaW5wdXQiLCJidWlsZE1hcHBpbmdEYXRhIiwib3V0cHV0IiwibWVyZ2VkR2VuZXJhdG9yIiwiU291cmNlTWFwR2VuZXJhdG9yIiwiX3JlZiIsInNvdXJjZXMiLCJzb3VyY2UiLCJjb250ZW50Iiwic2V0U291cmNlQ29udGVudCIsInBhdGgiLCJsZW5ndGgiLCJkZWZhdWx0U291cmNlIiwiaW5zZXJ0ZWRNYXBwaW5ncyIsIk1hcCIsImVhY2hJbnB1dEdlbmVyYXRlZFJhbmdlIiwiZ2VuZXJhdGVkIiwib3JpZ2luYWwiLCJlYWNoT3ZlcmxhcHBpbmdHZW5lcmF0ZWRPdXRwdXRSYW5nZSIsIml0ZW0iLCJrZXkiLCJtYWtlTWFwcGluZ0tleSIsImhhcyIsInNldCIsImFkZE1hcHBpbmciLCJsaW5lIiwiY29sdW1uIiwiY29sdW1uU3RhcnQiLCJuYW1lIiwidmFsdWVzIiwiY29sdW1uRW5kIiwiSW5maW5pdHkiLCJjbGVhckl0ZW0iLCJyZXN1bHQiLCJ0b0pTT04iLCJzb3VyY2VSb290Iiwib3V0cHV0RmlsZSIsImlucHV0R2VuZXJhdGVkUmFuZ2UiLCJjYWxsYmFjayIsIm92ZXJsYXBwaW5nT3JpZ2luYWwiLCJmaWx0ZXJBcHBsaWNhYmxlT3JpZ2luYWxSYW5nZXMiLCJfcmVmMiIsIm1hcHBpbmdzIiwiZmlsdGVyU29ydGVkQXJyYXkiLCJvdXRPcmlnaW5hbCIsIl9yZWYzIiwiX3JlZjQiLCJjb25zdW1lciIsIlNvdXJjZU1hcENvbnN1bWVyIiwiYXNzaWduIiwibGFzdCIsImNvbXB1dGVDb2x1bW5TcGFucyIsImVhY2hNYXBwaW5nIiwibSIsIm9yaWdpbmFsTGluZSIsImdldCIsInNvdXJjZUNvbnRlbnRGb3IiLCJzb3VyY2VEYXRhIiwib3JpZ2luYWxDb2x1bW4iLCJtYXBwaW5nIiwicHVzaCIsImFsbEdlbmVyYXRlZFBvc2l0aW9uc0ZvciIsImxhc3RDb2x1bW4iLCJPUklHSU5BTF9PUkRFUiIsImZpbGUiLCJBcnJheSIsImZyb20iLCJmaW5kSW5zZXJ0aW9uTG9jYXRpb24iLCJhcnJheSIsImxlZnQiLCJyaWdodCIsIm1pZCIsIk1hdGgiLCJmbG9vciIsImkiLCJzdGFydCIsInJlc3VsdHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQzNDQyxFQUFBQSxLQUFLLEVBQUU7QUFEb0MsQ0FBN0M7QUFHQUQsT0FBTyxDQUFDRSxPQUFSLEdBQWtCQyxjQUFsQjs7QUFFQSxTQUFTQyxVQUFULEdBQXNCO0FBQ3BCLFFBQU1DLElBQUksR0FBR0Msc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxZQUFELENBQVIsQ0FBbkM7O0FBRUFILEVBQUFBLFVBQVUsR0FBRyxZQUFZO0FBQ3ZCLFdBQU9DLElBQVA7QUFDRCxHQUZEOztBQUlBLFNBQU9BLElBQVA7QUFDRDs7QUFFRCxTQUFTQyxzQkFBVCxDQUFnQ0UsR0FBaEMsRUFBcUM7QUFBRSxTQUFPQSxHQUFHLElBQUlBLEdBQUcsQ0FBQ0MsVUFBWCxHQUF3QkQsR0FBeEIsR0FBOEI7QUFBRU4sSUFBQUEsT0FBTyxFQUFFTTtBQUFYLEdBQXJDO0FBQXdEOztBQUUvRixTQUFTTCxjQUFULENBQXdCTyxRQUF4QixFQUFrQ0MsR0FBbEMsRUFBdUM7QUFDckMsUUFBTUMsS0FBSyxHQUFHQyxnQkFBZ0IsQ0FBQ0gsUUFBRCxDQUE5QjtBQUNBLFFBQU1JLE1BQU0sR0FBR0QsZ0JBQWdCLENB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QUFsQjtBQUNEOztBQUVELFNBQU9FLE9BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gbWVyZ2VTb3VyY2VNYXA7XG5cbmZ1bmN0aW9uIF9zb3VyY2VNYXAoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJzb3VyY2UtbWFwXCIpKTtcblxuICBfc291cmNlTWFwID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfVxuXG5mdW5jdGlvbiBtZXJnZVNvdXJjZU1hcChpbnB1dE1hcCwgbWFwKSB7XG4gIGNvbnN0IGlucHV0ID0gYnVpbGRNYXBwaW5nRGF0YShpbnB1dE1hcCk7XG4gIGNvbnN0IG91dHB1dCA9IGJ1aWxkTWFwcGluZ0RhdGEobWFwKTtcbiAgY29uc3QgbWVyZ2VkR2VuZXJhdG9yID0gbmV3IChfc291cmNlTWFwKCkuZGVmYXVsdC5Tb3VyY2VNYXBHZW5lcmF0b3IpKCk7XG5cbiAgZm9yIChjb25zdCBfcmVmIG9mIGlucHV0LnNvdXJjZXMpIHtcbiAgICBjb25zdCB7XG4gICAgICBzb3VyY2VcbiAgICB9ID0gX3JlZjtcblxuICAgIGlmICh0eXBlb2Ygc291cmNlLmNvbnRlbnQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIG1lcmdlZEdlbmVyYXRvci5zZXRTb3VyY2VDb250ZW50KHNvdXJjZS5wYXRoLCBzb3VyY2UuY29udGVudCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKG91dHB1dC5zb3VyY2VzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IGRlZmF1bHRTb3VyY2UgPSBvdXRwdXQuc291cmNlc1swXTtcbiAgICBjb25zdCBpbnNlcnRlZE1hcHBpbmdzID0gbmV3IE1hcCgpO1xuICAgIGVhY2hJbnB1dEdlbmVyYXRlZFJhbmdlKGlucHV0LCAoZ2VuZXJhdGVkLCBvcmlnaW5hbCwgc291cmNlKSA9PiB7XG4gICAgICBlYWNoT3ZlcmxhcHBpbmdHZW5lcmF0ZWRPdXRwdXRSYW5nZShkZWZhdWx0U291cmNlLCBnZW5lcmF0ZWQsIGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBrZXkgPSBtYWtlTWFwcGluZ0tleShpdGVtKTtcbiAgICAgICAgaWYgKGluc2VydGVkTWFwcGluZ3MuaGFzKGtleSkpIHJldHVybjtcbiAgICAgICAgaW5zZXJ0ZWRNYXBwaW5ncy5zZXQoa2V5LCBpdGVtKTtcbiAgICAgICAgbWVyZ2VkR2VuZXJhdG9yLmFkZE1hcHBpbmcoe1xuICAgICAgICAgIHNvdXJjZTogc291cmNlLnBhdGgsXG4gICAgICAgICAgb3JpZ2luYWw6IHtcbiAgICAgICAgICAgIGxpbmU6IG9yaWdpbmFsLmxpbmUsXG4gICAgICAgICAgICBjb2x1bW46IG9yaWdpbmFsLmNvbHVtblN0YXJ0XG4gICAgICAgICAgfSxcbiAgICAgICAgICBnZW5lcmF0ZWQ6IHtcbiAgICAgICAgICAgIGxpbmU6IGl0ZW0ubGluZSxcbiAgICAgICAgICAgIGNvbHVtbjogaXRlbS5jb2x1bW5TdGFydFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbmFtZTogb3JpZ2luYWwubmFtZVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGluc2VydGVkTWFwcGluZ3MudmFsdWVzKCkpIHtcbiAgICAgIGlmIChpdGVtLmNvbHVtbkVuZCA9PT0gSW5maW5pdHkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNsZWFySXRlbSA9IHtcbiAgICAgICAgbGluZTogaXRlbS5saW5lLFxuICAgICAgICBjb2x1bW5TdGFydDogaXRlbS5jb2x1bW5FbmRcbiAgICAgIH07XG4gICAgICBjb25zdCBrZXkgPSBtYWtlTWFwcGluZ0tleShjbGVhckl0ZW0pO1xuXG4gICAgICBpZiAoaW5zZXJ0ZWRNYXBwaW5ncy5oYXMoa2V5KSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgbWVyZ2VkR2VuZXJhdG9yLmFkZE1hcHBpbmcoe1xuICAgICAgICBnZW5lcmF0ZWQ6IHtcbiAgICAgICAgICBsaW5lOiBjbGVhckl0ZW0ubGluZSxcbiAgICAgICAgICBjb2x1bW46IGNsZWFySXRlbS5jb2x1bW5TdGFydFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBtZXJnZWRHZW5lcmF0b3IudG9KU09OKCk7XG5cbiAgaWYgKHR5cGVvZiBpbnB1dC5zb3VyY2VSb290ID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmVzdWx0LnNvdXJjZVJvb3QgPSBpbnB1dC5zb3VyY2VSb290O1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gbWFrZU1hcHBpbmdLZXkoaXRlbSkge1xuICByZXR1cm4gYCR7aXRlbS5saW5lfS8ke2l0ZW0uY29sdW1uU3RhcnR9YDtcbn1cblxuZnVuY3Rpb24gZWFjaE92ZXJsYXBwaW5nR2VuZXJhdGVkT3V0cHV0UmFuZ2Uob3V0cHV0RmlsZSwgaW5wdXRHZW5lcmF0ZWRSYW5nZSwgY2FsbGJhY2spIHtcbiAgY29uc3Qgb3ZlcmxhcHBpbmdPcmlnaW5hbCA9IGZpbHRlckFwcGxpY2FibGVPcmlnaW5hbFJhbmdlcyhvdXRwdXRGaWxlLCBpbnB1dEdlbmVyYXRlZFJhbmdlKTtcblxuICBmb3IgKGNvbnN0IF9yZWYyIG9mIG92ZXJsYXBwaW5nT3JpZ2luYWwpIHtcbiAgICBjb25zdCB7XG4gICAgICBnZW5lcmF0ZWRcbiAgICB9ID0gX3JlZjI7XG5cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZ2VuZXJhdGVkKSB7XG4gICAgICBjYWxsYmFjayhpdGVtKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gZmlsdGVyQXBwbGljYWJsZU9yaWdpbmFsUmFuZ2VzKHtcbiAgbWFwcGluZ3Ncbn0sIHtcbiAgbGluZSxcbiAgY29sdW1uU3RhcnQsXG4gIGNvbHVtbkVuZFxufSkge1xuICByZXR1cm4gZmlsdGVyU29ydGVkQXJyYXkobWFwcGluZ3MsICh7XG4gICAgb3JpZ2luYWw6IG91dE9yaWdpbmFsXG4gIH0pID0+IHtcbiAgICBpZiAobGluZSA+IG91dE9yaWdpbmFsLmxpbmUpIHJldHVybiAtMTtcbiAgICBpZiAobGluZSA8IG91dE9yaWdpbmFsLmxpbmUpIHJldHVybiAxO1xuICAgIGlmIChjb2x1bW5TdGFydCA+PSBvdXRPcmlnaW5hbC5jb2x1bW5FbmQpIHJldHVybiAtMTtcbiAgICBpZiAoY29sdW1uRW5kIDw9IG91dE9yaWdpbmFsLmNvbHVtblN0YXJ0KSByZXR1cm4gMTtcbiAgICByZXR1cm4gMDtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGVhY2hJbnB1dEdlbmVyYXRlZFJhbmdlKG1hcCwgY2FsbGJhY2spIHtcbiAgZm9yIChjb25zdCBfcmVmMyBvZiBtYXAuc291cmNlcykge1xuICAgIGNvbnN0IHtcbiAgICAgIHNvdXJjZSxcbiAgICAgIG1hcHBpbmdzXG4gICAgfSA9IF9yZWYzO1xuXG4gICAgZm9yIChjb25zdCBfcmVmNCBvZiBtYXBwaW5ncykge1xuICAgICAgY29uc3Qge1xuICAgICAgICBvcmlnaW5hbCxcbiAgICAgICAgZ2VuZXJhdGVkXG4gICAgICB9ID0gX3JlZjQ7XG5cbiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBnZW5lcmF0ZWQpIHtcbiAgICAgICAgY2FsbGJhY2soaXRlbSwgb3JpZ2luYWwsIHNvdXJjZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGJ1aWxkTWFwcGluZ0RhdGEobWFwKSB7XG4gIGNvbnN0IGNvbnN1bWVyID0gbmV3IChfc291cmNlTWFwKCkuZGVmYXVsdC5Tb3VyY2VNYXBDb25zdW1lcikoT2JqZWN0LmFzc2lnbih7fSwgbWFwLCB7XG4gICAgc291cmNlUm9vdDogbnVsbFxuICB9KSk7XG4gIGNvbnN0IHNvdXJjZXMgPSBuZXcgTWFwKCk7XG4gIGNvbnN0IG1hcHBpbmdzID0gbmV3IE1hcCgpO1xuICBsZXQgbGFzdCA9IG51bGw7XG4gIGNvbnN1bWVyLmNvbXB1dGVDb2x1bW5TcGFucygpO1xuICBjb25zdW1lci5lYWNoTWFwcGluZyhtID0+IHtcbiAgICBpZiAobS5vcmlnaW5hbExpbmUgPT09IG51bGwpIHJldHVybjtcbiAgICBsZXQgc291cmNlID0gc291cmNlcy5nZXQobS5zb3VyY2UpO1xuXG4gICAgaWYgKCFzb3VyY2UpIHtcbiAgICAgIHNvdXJjZSA9IHtcbiAgICAgICAgcGF0aDogbS5zb3VyY2UsXG4gICAgICAgIGNvbnRlbnQ6IGNvbnN1bWVyLnNvdXJjZUNvbnRlbnRGb3IobS5zb3VyY2UsIHRydWUpXG4gICAgICB9O1xuICAgICAgc291cmNlcy5zZXQobS5zb3VyY2UsIHNvdXJjZSk7XG4gICAgfVxuXG4gICAgbGV0IHNvdXJjZURhdGEgPSBtYXBwaW5ncy5nZXQoc291cmNlKTtcblxuICAgIGlmICghc291cmNlRGF0YSkge1xuICAgICAgc291cmNlRGF0YSA9IHtcbiAgICAgICAgc291cmNlLFxuICAgICAgICBtYXBwaW5nczogW11cbiAgICAgIH07XG4gICAgICBtYXBwaW5ncy5zZXQoc291cmNlLCBzb3VyY2VEYXRhKTtcbiAgICB9XG5cbiAgICBjb25zdCBvYmogPSB7XG4gICAgICBsaW5lOiBtLm9yaWdpbmFsTGluZSxcbiAgICAgIGNvbHVtblN0YXJ0OiBtLm9yaWdpbmFsQ29sdW1uLFxuICAgICAgY29sdW1uRW5kOiBJbmZpbml0eSxcbiAgICAgIG5hbWU6IG0ubmFtZVxuICAgIH07XG5cbiAgICBpZiAobGFzdCAmJiBsYXN0LnNvdXJjZSA9PT0gc291cmNlICYmIGxhc3QubWFwcGluZy5saW5lID09PSBtLm9yaWdpbmFsTGluZSkge1xuICAgICAgbGFzdC5tYXBwaW5nLmNvbHVtbkVuZCA9IG0ub3JpZ2luYWxDb2x1bW47XG4gICAgfVxuXG4gICAgbGFzdCA9IHtcbiAgICAgIHNvdXJjZSxcbiAgICAgIG1hcHBpbmc6IG9ialxuICAgIH07XG4gICAgc291cmNlRGF0YS5tYXBwaW5ncy5wdXNoKHtcbiAgICAgIG9yaWdpbmFsOiBvYmosXG4gICAgICBnZW5lcmF0ZWQ6IGNvbnN1bWVyLmFsbEdlbmVyYXRlZFBvc2l0aW9uc0Zvcih7XG4gICAgICAgIHNvdXJjZTogbS5zb3VyY2UsXG4gICAgICAgIGxpbmU6IG0ub3JpZ2luYWxMaW5lLFxuICAgICAgICBjb2x1bW46IG0ub3JpZ2luYWxDb2x1bW5cbiAgICAgIH0pLm1hcChpdGVtID0+ICh7XG4gICAgICAgIGxpbmU6IGl0ZW0ubGluZSxcbiAgICAgICAgY29sdW1uU3RhcnQ6IGl0ZW0uY29sdW1uLFxuICAgICAgICBjb2x1bW5FbmQ6IGl0ZW0ubGFzdENvbHVtbiArIDFcbiAgICAgIH0pKVxuICAgIH0pO1xuICB9LCBudWxsLCBfc291cmNlTWFwKCkuZGVmYXVsdC5Tb3VyY2VNYXBDb25zdW1lci5PUklHSU5BTF9PUkRFUik7XG4gIHJldHVybiB7XG4gICAgZmlsZTogbWFwLmZpbGUsXG4gICAgc291cmNlUm9vdDogbWFwLnNvdXJjZVJvb3QsXG4gICAgc291cmNlczogQXJyYXkuZnJvbShtYXBwaW5ncy52YWx1ZXMoKSlcbiAgfTtcbn1cblxuZnVuY3Rpb24gZmluZEluc2VydGlvbkxvY2F0aW9uKGFycmF5LCBjYWxsYmFjaykge1xuICBsZXQgbGVmdCA9IDA7XG4gIGxldCByaWdodCA9IGFycmF5Lmxlbmd0aDtcblxuICB3aGlsZSAobGVmdCA8IHJpZ2h0KSB7XG4gICAgY29uc3QgbWlkID0gTWF0aC5mbG9vcigobGVmdCArIHJpZ2h0KSAvIDIpO1xuICAgIGNvbnN0IGl0ZW0gPSBhcnJheVttaWRdO1xuICAgIGNvbnN0IHJlc3VsdCA9IGNhbGxiYWNrKGl0ZW0pO1xuXG4gICAgaWYgKHJlc3VsdCA9PT0gMCkge1xuICAgICAgbGVmdCA9IG1pZDtcbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGlmIChyZXN1bHQgPj0gMCkge1xuICAgICAgcmlnaHQgPSBtaWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxlZnQgPSBtaWQgKyAxO1xuICAgIH1cbiAgfVxuXG4gIGxldCBpID0gbGVmdDtcblxuICBpZiAoaSA8IGFycmF5Lmxlbmd0aCkge1xuICAgIHdoaWxlIChpID49IDAgJiYgY2FsbGJhY2soYXJyYXlbaV0pID49IDApIHtcbiAgICAgIGktLTtcbiAgICB9XG5cbiAgICByZXR1cm4gaSArIDE7XG4gIH1cblxuICByZXR1cm4gaTtcbn1cblxuZnVuY3Rpb24gZmlsdGVyU29ydGVkQXJyYXkoYXJyYXksIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHN0YXJ0ID0gZmluZEluc2VydGlvbkxvY2F0aW9uKGFycmF5LCBjYWxsYmFjayk7XG4gIGNvbnN0IHJlc3VsdHMgPSBbXTtcblxuICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBhcnJheS5sZW5ndGggJiYgY2FsbGJhY2soYXJyYXlbaV0pID09PSAwOyBpKyspIHtcbiAgICByZXN1bHRzLnB1c2goYXJyYXlbaV0pO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdHM7XG59Il19