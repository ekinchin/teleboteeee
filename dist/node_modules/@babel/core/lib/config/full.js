"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = loadFullConfig;

var _util = require("./util");

var context = _interopRequireWildcard(require("../index"));

var _plugin = _interopRequireDefault(require("./plugin"));

var _item = require("./item");

var _configChain = require("./config-chain");

function _traverse() {
  const data = _interopRequireDefault(require("@babel/traverse"));

  _traverse = function () {
    return data;
  };

  return data;
}

var _caching = require("./caching");

var _options = require("./validation/options");

var _plugins = require("./validation/plugins");

var _configApi = _interopRequireDefault(require("./helpers/config-api"));

var _partial = _interopRequireDefault(require("./partial"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

function loadFullConfig(inputOpts) {
  const result = (0, _partial.default)(inputOpts);

  if (!result) {
    return null;
  }

  const {
    options,
    context
  } = result;
  const optionDefaults = {};
  const passes = [[]];

  try {
    const {
      plugins,
      presets
    } = options;

    if (!plugins || !presets) {
      throw new Error("Assertion failure - plugins and presets exist");
    }

    const ignored = function recurseDescriptors(config, pass) {
      const plugins = config.plugins.reduce((acc, descriptor) => {
        if (descriptor.options !== false) {
          acc.push(loadPluginDescriptor(descriptor, context));
        }

        return acc;
      }, []);
      const presets = config.presets.reduce((acc, descriptor) => {
        if (descriptor.options !== false) {
          acc.push({
            preset: loadPresetDescriptor(descriptor, context),
            pass: descriptor.ownPass ? [] : pass
          });
        }

        return acc;
      }, []);

      if (presets.length > 0) {
        passes.splice(1, 0, ...presets.map(o => o.pass).filter(p => p !== pass));

        for (const _ref of presets) {
          const {
            preset,
            pass
          } = _ref;
          if (!preset) return true;
          const ignored = recurseDescriptors({
            plugins: preset.plugins,
            presets: preset.presets
          }, pass);
          if (ignored) return true;
          preset.options.forEach(opts => {
            (0, _util.mergeOptions)(optionDefaults, opts);
          });
        }
      }

      if (plugins.length > 0) {
        pass.unshift(...plugins);
      }
    }({
      plugins: plugins.map(item => {
        const desc = (0, _item.getItemDescriptor)(item);

        if (!desc) {
          throw new Error("Assertion failure - must be config item");
        }

        return desc;
      }),
      presets: presets.map(item => {
        const desc = (0, _item.getItemDescriptor)(item);

        if (!desc) {
          throw new Error("Assertion failure - must be config item");
        }

        return desc;
      })
    }, passes[0]);

    if (ignored) return null;
  } catch (e) {
    if (!/^\[BABEL\]/.test(e.message)) {
      e.message = `[BABEL] ${context.filename || "unknown"}: ${e.message}`;
    }

    throw e;
  }

  const opts = optionDefaults;
  (0, _util.mergeOptions)(opts, options);
  opts.plugins = passes[0];
  opts.presets = passes.slice(1).filter(plugins => plugins.length > 0).map(plugins => ({
    plugins
  }));
  opts.passPerPreset = opts.presets.length > 0;
  return {
    options: opts,
    passes: passes
  };
}

const loadDescriptor = (0, _caching.makeWeakCache)(({
  value,
  options,
  dirname,
  alias
}, cache) => {
  if (options === false) throw new Error("Assertion failure");
  options = options || {};
  let item = value;

  if (typeof value === "function") {
    const api = Object.assign({}, context, (0, _configApi.default)(cache));

    try {
      item = value(api, options, dirname);
    } catch (e) {
      if (alias) {
        e.message += ` (While processing: ${JSON.stringify(alias)})`;
      }

      throw e;
    }
  }

  if (!item || typeof item !== "object") {
    throw new Error("Plugin/Preset did not return an object.");
  }

  if (typeof item.then === "function") {
    throw new Error(`You appear to be using an async plugin, ` + `which your current version of Babel does not support.` + `If you're using a published plugin, ` + `you may need to upgrade your @babel/core version.`);
  }

  return {
    value: item,
    options,
    dirname,
    alias
  };
});

function loadPluginDescriptor(descriptor, context) {
  if (descriptor.value instanceof _plugin.default) {
    if (descriptor.options) {
      throw new Error("Passed options to an existing Plugin instance will not work.");
    }

    return descriptor.value;
  }

  return instantiatePlugin(loadDescriptor(descriptor, context), context);
}

const instantiatePlugin = (0, _caching.makeWeakCache)(({
  value,
  options,
  dirname,
  alias
}, cache) => {
  const pluginObj = (0, _plugins.validatePluginObject)(value);
  const plugin = Object.assign({}, pluginObj);

  if (plugin.visitor) {
    plugin.visitor = _traverse().default.explode(Object.assign({}, plugin.visitor));
  }

  if (plugin.inherits) {
    const inheritsDescriptor = {
      name: undefined,
      alias: `${alias}$inherits`,
      value: plugin.inherits,
      options,
      dirname
    };
    const inherits = cache.invalidate(data => loadPluginDescriptor(inheritsDescriptor, data));
    plugin.pre = chain(inherits.pre, plugin.pre);
    plugin.post = chain(inherits.post, plugin.post);
    plugin.manipulateOptions = chain(inherits.manipulateOptions, plugin.manipulateOptions);
    plugin.visitor = _traverse().default.visitors.merge([inherits.visitor || {}, plugin.visitor || {}]);
  }

  return new _plugin.default(plugin, options, alias);
});

const loadPresetDescriptor = (descriptor, context) => {
  return (0, _configChain.buildPresetChain)(instantiatePreset(loadDescriptor(descriptor, context)), context);
};

const instantiatePreset = (0, _caching.makeWeakCache)(({
  value,
  dirname,
  alias
}) => {
  return {
    options: (0, _options.validate)("preset", value),
    alias,
    dirname
  };
});

function chain(a, b) {
  const fns = [a, b].filter(Boolean);
  if (fns.length <= 1) return fns[0];
  return function (...args) {
    for (const fn of fns) {
      fn.apply(this, args);
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29yZS9saWIvY29uZmlnL2Z1bGwuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJkZWZhdWx0IiwibG9hZEZ1bGxDb25maWciLCJfdXRpbCIsInJlcXVpcmUiLCJjb250ZXh0IiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJfcGx1Z2luIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9pdGVtIiwiX2NvbmZpZ0NoYWluIiwiX3RyYXZlcnNlIiwiZGF0YSIsIl9jYWNoaW5nIiwiX29wdGlvbnMiLCJfcGx1Z2lucyIsIl9jb25maWdBcGkiLCJfcGFydGlhbCIsIm9iaiIsIl9fZXNNb2R1bGUiLCJuZXdPYmoiLCJrZXkiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJkZXNjIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZ2V0Iiwic2V0IiwiaW5wdXRPcHRzIiwicmVzdWx0Iiwib3B0aW9ucyIsIm9wdGlvbkRlZmF1bHRzIiwicGFzc2VzIiwicGx1Z2lucyIsInByZXNldHMiLCJFcnJvciIsImlnbm9yZWQiLCJyZWN1cnNlRGVzY3JpcHRvcnMiLCJjb25maWciLCJwYXNzIiwicmVkdWNlIiwiYWNjIiwiZGVzY3JpcHRvciIsInB1c2giLCJsb2FkUGx1Z2luRGVzY3JpcHRvciIsInByZXNldCIsImxvYWRQcmVzZXREZXNjcmlwdG9yIiwib3duUGFzcyIsImxlbmd0aCIsInNwbGljZSIsIm1hcCIsIm8iLCJmaWx0ZXIiLCJwIiwiX3JlZiIsImZvckVhY2giLCJvcHRzIiwibWVyZ2VPcHRpb25zIiwidW5zaGlmdCIsIml0ZW0iLCJnZXRJdGVtRGVzY3JpcHRvciIsImUiLCJ0ZXN0IiwibWVzc2FnZSIsImZpbGVuYW1lIiwic2xpY2UiLCJwYXNzUGVyUHJlc2V0IiwibG9hZERlc2NyaXB0b3IiLCJtYWtlV2Vha0NhY2hlIiwiZGlybmFtZSIsImFsaWFzIiwiY2FjaGUiLCJhcGkiLCJhc3NpZ24iLCJKU09OIiwic3RyaW5naWZ5IiwidGhlbiIsImluc3RhbnRpYXRlUGx1Z2luIiwicGx1Z2luT2JqIiwidmFsaWRhdGVQbHVnaW5PYmplY3QiLCJwbHVnaW4iLCJ2aXNpdG9yIiwiZXhwbG9kZSIsImluaGVyaXRzIiwiaW5oZXJpdHNEZXNjcmlwdG9yIiwibmFtZSIsInVuZGVmaW5lZCIsImludmFsaWRhdGUiLCJwcmUiLCJjaGFpbiIsInBvc3QiLCJtYW5pcHVsYXRlT3B0aW9ucyIsInZpc2l0b3JzIiwibWVyZ2UiLCJidWlsZFByZXNldENoYWluIiwiaW5zdGFudGlhdGVQcmVzZXQiLCJ2YWxpZGF0ZSIsImEiLCJiIiwiZm5zIiwiQm9vbGVhbiIsImFyZ3MiLCJmbiIsImFwcGx5Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsT0FBUixHQUFrQkMsY0FBbEI7O0FBRUEsSUFBSUMsS0FBSyxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUFuQjs7QUFFQSxJQUFJQyxPQUFPLEdBQUdDLHVCQUF1QixDQUFDRixPQUFPLENBQUMsVUFBRCxDQUFSLENBQXJDOztBQUVBLElBQUlHLE9BQU8sR0FBR0Msc0JBQXNCLENBQUNKLE9BQU8sQ0FBQyxVQUFELENBQVIsQ0FBcEM7O0FBRUEsSUFBSUssS0FBSyxHQUFHTCxPQUFPLENBQUMsUUFBRCxDQUFuQjs7QUFFQSxJQUFJTSxZQUFZLEdBQUdOLE9BQU8sQ0FBQyxnQkFBRCxDQUExQjs7QUFFQSxTQUFTTyxTQUFULEdBQXFCO0FBQ25CLFFBQU1DLElBQUksR0FBR0osc0JBQXNCLENBQUNKLE9BQU8sQ0FBQyxpQkFBRCxDQUFSLENBQW5DOztBQUVBTyxFQUFBQSxTQUFTLEdBQUcsWUFBWTtBQUN0QixX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QUlBLE1BQU0yRixpQkFBaUIsR0FBRyxDQUFDLEdBQUduRixRQUFRLENBQUN3RCxhQUFiLEVBQTRCLENBQUM7QUFDckRyRSxFQUFBQSxLQURxRDtBQUVyRHNFLEVBQUFBLE9BRnFEO0FBR3JEQyxFQUFBQTtBQUhxRCxDQUFELEtBSWhEO0FBQ0osU0FBTztBQUNMeEMsSUFBQUEsT0FBTyxFQUFFLENBQUMsR0FBR2pCLFFBQVEsQ0FBQ21GLFFBQWIsRUFBdUIsUUFBdkIsRUFBaUNqRyxLQUFqQyxDQURKO0FBRUx1RSxJQUFBQSxLQUZLO0FBR0xELElBQUFBO0FBSEssR0FBUDtBQUtELENBVnlCLENBQTFCOztBQVlBLFNBQVNvQixLQUFULENBQWVRLENBQWYsRUFBa0JDLENBQWxCLEVBQXFCO0FBQ25CLFFBQU1DLEdBQUcsR0FBRyxDQUFDRixDQUFELEVBQUlDLENBQUosRUFBTzlDLE1BQVAsQ0FBY2dELE9BQWQsQ0FBWjtBQUNBLE1BQUlELEdBQUcsQ0FBQ25ELE1BQUosSUFBYyxDQUFsQixFQUFxQixPQUFPbUQsR0FBRyxDQUFDLENBQUQsQ0FBVjtBQUNyQixTQUFPLFVBQVUsR0FBR0UsSUFBYixFQUFtQjtBQUN4QixTQUFLLE1BQU1DLEVBQVgsSUFBaUJILEdBQWpCLEVBQXNCO0FBQ3BCRyxNQUFBQSxFQUFFLENBQUNDLEtBQUgsQ0FBUyxJQUFULEVBQWVGLElBQWY7QUFDRDtBQUNGLEdBSkQ7QUFLRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5kZWZhdWx0ID0gbG9hZEZ1bGxDb25maWc7XG5cbnZhciBfdXRpbCA9IHJlcXVpcmUoXCIuL3V0aWxcIik7XG5cbnZhciBjb250ZXh0ID0gX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQocmVxdWlyZShcIi4uL2luZGV4XCIpKTtcblxudmFyIF9wbHVnaW4gPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL3BsdWdpblwiKSk7XG5cbnZhciBfaXRlbSA9IHJlcXVpcmUoXCIuL2l0ZW1cIik7XG5cbnZhciBfY29uZmlnQ2hhaW4gPSByZXF1aXJlKFwiLi9jb25maWctY2hhaW5cIik7XG5cbmZ1bmN0aW9uIF90cmF2ZXJzZSgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIkBiYWJlbC90cmF2ZXJzZVwiKSk7XG5cbiAgX3RyYXZlcnNlID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG52YXIgX2NhY2hpbmcgPSByZXF1aXJlKFwiLi9jYWNoaW5nXCIpO1xuXG52YXIgX29wdGlvbnMgPSByZXF1aXJlKFwiLi92YWxpZGF0aW9uL29wdGlvbnNcIik7XG5cbnZhciBfcGx1Z2lucyA9IHJlcXVpcmUoXCIuL3ZhbGlkYXRpb24vcGx1Z2luc1wiKTtcblxudmFyIF9jb25maWdBcGkgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuL2hlbHBlcnMvY29uZmlnLWFwaVwiKSk7XG5cbnZhciBfcGFydGlhbCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vcGFydGlhbFwiKSk7XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKG9iaikgeyBpZiAob2JqICYmIG9iai5fX2VzTW9kdWxlKSB7IHJldHVybiBvYmo7IH0gZWxzZSB7IHZhciBuZXdPYmogPSB7fTsgaWYgKG9iaiAhPSBudWxsKSB7IGZvciAodmFyIGtleSBpbiBvYmopIHsgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsgdmFyIGRlc2MgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpIDoge307IGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkobmV3T2JqLCBrZXksIGRlc2MpOyB9IGVsc2UgeyBuZXdPYmpba2V5XSA9IG9ialtrZXldOyB9IH0gfSB9IG5ld09iai5kZWZhdWx0ID0gb2JqOyByZXR1cm4gbmV3T2JqOyB9IH1cblxuZnVuY3Rpb24gbG9hZEZ1bGxDb25maWcoaW5wdXRPcHRzKSB7XG4gIGNvbnN0IHJlc3VsdCA9ICgwLCBfcGFydGlhbC5kZWZhdWx0KShpbnB1dE9wdHMpO1xuXG4gIGlmICghcmVzdWx0KSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCB7XG4gICAgb3B0aW9ucyxcbiAgICBjb250ZXh0XG4gIH0gPSByZXN1bHQ7XG4gIGNvbnN0IG9wdGlvbkRlZmF1bHRzID0ge307XG4gIGNvbnN0IHBhc3NlcyA9IFtbXV07XG5cbiAgdHJ5IHtcbiAgICBjb25zdCB7XG4gICAgICBwbHVnaW5zLFxuICAgICAgcHJlc2V0c1xuICAgIH0gPSBvcHRpb25zO1xuXG4gICAgaWYgKCFwbHVnaW5zIHx8ICFwcmVzZXRzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBc3NlcnRpb24gZmFpbHVyZSAtIHBsdWdpbnMgYW5kIHByZXNldHMgZXhpc3RcIik7XG4gICAgfVxuXG4gICAgY29uc3QgaWdub3JlZCA9IGZ1bmN0aW9uIHJlY3Vyc2VEZXNjcmlwdG9ycyhjb25maWcsIHBhc3MpIHtcbiAgICAgIGNvbnN0IHBsdWdpbnMgPSBjb25maWcucGx1Z2lucy5yZWR1Y2UoKGFjYywgZGVzY3JpcHRvcikgPT4ge1xuICAgICAgICBpZiAoZGVzY3JpcHRvci5vcHRpb25zICE9PSBmYWxzZSkge1xuICAgICAgICAgIGFjYy5wdXNoKGxvYWRQbHVnaW5EZXNjcmlwdG9yKGRlc2NyaXB0b3IsIGNvbnRleHQpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCBbXSk7XG4gICAgICBjb25zdCBwcmVzZXRzID0gY29uZmlnLnByZXNldHMucmVkdWNlKChhY2MsIGRlc2NyaXB0b3IpID0+IHtcbiAgICAgICAgaWYgKGRlc2NyaXB0b3Iub3B0aW9ucyAhPT0gZmFsc2UpIHtcbiAgICAgICAgICBhY2MucHVzaCh7XG4gICAgICAgICAgICBwcmVzZXQ6IGxvYWRQcmVzZXREZXNjcmlwdG9yKGRlc2NyaXB0b3IsIGNvbnRleHQpLFxuICAgICAgICAgICAgcGFzczogZGVzY3JpcHRvci5vd25QYXNzID8gW10gOiBwYXNzXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwgW10pO1xuXG4gICAgICBpZiAocHJlc2V0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHBhc3Nlcy5zcGxpY2UoMSwgMCwgLi4ucHJlc2V0cy5tYXAobyA9PiBvLnBhc3MpLmZpbHRlcihwID0+IHAgIT09IHBhc3MpKTtcblxuICAgICAgICBmb3IgKGNvbnN0IF9yZWYgb2YgcHJlc2V0cykge1xuICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIHByZXNldCxcbiAgICAgICAgICAgIHBhc3NcbiAgICAgICAgICB9ID0gX3JlZjtcbiAgICAgICAgICBpZiAoIXByZXNldCkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgY29uc3QgaWdub3JlZCA9IHJlY3Vyc2VEZXNjcmlwdG9ycyh7XG4gICAgICAgICAgICBwbHVnaW5zOiBwcmVzZXQucGx1Z2lucyxcbiAgICAgICAgICAgIHByZXNldHM6IHByZXNldC5wcmVzZXRzXG4gICAgICAgICAgfSwgcGFzcyk7XG4gICAgICAgICAgaWYgKGlnbm9yZWQpIHJldHVybiB0cnVlO1xuICAgICAgICAgIHByZXNldC5vcHRpb25zLmZvckVhY2gob3B0cyA9PiB7XG4gICAgICAgICAgICAoMCwgX3V0aWwubWVyZ2VPcHRpb25zKShvcHRpb25EZWZhdWx0cywgb3B0cyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHBsdWdpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICBwYXNzLnVuc2hpZnQoLi4ucGx1Z2lucyk7XG4gICAgICB9XG4gICAgfSh7XG4gICAgICBwbHVnaW5zOiBwbHVnaW5zLm1hcChpdGVtID0+IHtcbiAgICAgICAgY29uc3QgZGVzYyA9ICgwLCBfaXRlbS5nZXRJdGVtRGVzY3JpcHRvcikoaXRlbSk7XG5cbiAgICAgICAgaWYgKCFkZXNjKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXNzZXJ0aW9uIGZhaWx1cmUgLSBtdXN0IGJlIGNvbmZpZyBpdGVtXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGRlc2M7XG4gICAgICB9KSxcbiAgICAgIHByZXNldHM6IHByZXNldHMubWFwKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBkZXNjID0gKDAsIF9pdGVtLmdldEl0ZW1EZXNjcmlwdG9yKShpdGVtKTtcblxuICAgICAgICBpZiAoIWRlc2MpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBc3NlcnRpb24gZmFpbHVyZSAtIG11c3QgYmUgY29uZmlnIGl0ZW1cIik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGVzYztcbiAgICAgIH0pXG4gICAgfSwgcGFzc2VzWzBdKTtcblxuICAgIGlmIChpZ25vcmVkKSByZXR1cm4gbnVsbDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL15cXFtCQUJFTFxcXS8udGVzdChlLm1lc3NhZ2UpKSB7XG4gICAgICBlLm1lc3NhZ2UgPSBgW0JBQkVMXSAke2NvbnRleHQuZmlsZW5hbWUgfHwgXCJ1bmtub3duXCJ9OiAke2UubWVzc2FnZX1gO1xuICAgIH1cblxuICAgIHRocm93IGU7XG4gIH1cblxuICBjb25zdCBvcHRzID0gb3B0aW9uRGVmYXVsdHM7XG4gICgwLCBfdXRpbC5tZXJnZU9wdGlvbnMpKG9wdHMsIG9wdGlvbnMpO1xuICBvcHRzLnBsdWdpbnMgPSBwYXNzZXNbMF07XG4gIG9wdHMucHJlc2V0cyA9IHBhc3Nlcy5zbGljZSgxKS5maWx0ZXIocGx1Z2lucyA9PiBwbHVnaW5zLmxlbmd0aCA+IDApLm1hcChwbHVnaW5zID0+ICh7XG4gICAgcGx1Z2luc1xuICB9KSk7XG4gIG9wdHMucGFzc1BlclByZXNldCA9IG9wdHMucHJlc2V0cy5sZW5ndGggPiAwO1xuICByZXR1cm4ge1xuICAgIG9wdGlvbnM6IG9wdHMsXG4gICAgcGFzc2VzOiBwYXNzZXNcbiAgfTtcbn1cblxuY29uc3QgbG9hZERlc2NyaXB0b3IgPSAoMCwgX2NhY2hpbmcubWFrZVdlYWtDYWNoZSkoKHtcbiAgdmFsdWUsXG4gIG9wdGlvbnMsXG4gIGRpcm5hbWUsXG4gIGFsaWFzXG59LCBjYWNoZSkgPT4ge1xuICBpZiAob3B0aW9ucyA9PT0gZmFsc2UpIHRocm93IG5ldyBFcnJvcihcIkFzc2VydGlvbiBmYWlsdXJlXCIpO1xuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgbGV0IGl0ZW0gPSB2YWx1ZTtcblxuICBpZiAodHlwZW9mIHZhbHVlID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBjb25zdCBhcGkgPSBPYmplY3QuYXNzaWduKHt9LCBjb250ZXh0LCAoMCwgX2NvbmZpZ0FwaS5kZWZhdWx0KShjYWNoZSkpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGl0ZW0gPSB2YWx1ZShhcGksIG9wdGlvbnMsIGRpcm5hbWUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChhbGlhcykge1xuICAgICAgICBlLm1lc3NhZ2UgKz0gYCAoV2hpbGUgcHJvY2Vzc2luZzogJHtKU09OLnN0cmluZ2lmeShhbGlhcyl9KWA7XG4gICAgICB9XG5cbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFpdGVtIHx8IHR5cGVvZiBpdGVtICE9PSBcIm9iamVjdFwiKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUGx1Z2luL1ByZXNldCBkaWQgbm90IHJldHVybiBhbiBvYmplY3QuXCIpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBpdGVtLnRoZW4gPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHRocm93IG5ldyBFcnJvcihgWW91IGFwcGVhciB0byBiZSB1c2luZyBhbiBhc3luYyBwbHVnaW4sIGAgKyBgd2hpY2ggeW91ciBjdXJyZW50IHZlcnNpb24gb2YgQmFiZWwgZG9lcyBub3Qgc3VwcG9ydC5gICsgYElmIHlvdSdyZSB1c2luZyBhIHB1Ymxpc2hlZCBwbHVnaW4sIGAgKyBgeW91IG1heSBuZWVkIHRvIHVwZ3JhZGUgeW91ciBAYmFiZWwvY29yZSB2ZXJzaW9uLmApO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICB2YWx1ZTogaXRlbSxcbiAgICBvcHRpb25zLFxuICAgIGRpcm5hbWUsXG4gICAgYWxpYXNcbiAgfTtcbn0pO1xuXG5mdW5jdGlvbiBsb2FkUGx1Z2luRGVzY3JpcHRvcihkZXNjcmlwdG9yLCBjb250ZXh0KSB7XG4gIGlmIChkZXNjcmlwdG9yLnZhbHVlIGluc3RhbmNlb2YgX3BsdWdpbi5kZWZhdWx0KSB7XG4gICAgaWYgKGRlc2NyaXB0b3Iub3B0aW9ucykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUGFzc2VkIG9wdGlvbnMgdG8gYW4gZXhpc3RpbmcgUGx1Z2luIGluc3RhbmNlIHdpbGwgbm90IHdvcmsuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiBkZXNjcmlwdG9yLnZhbHVlO1xuICB9XG5cbiAgcmV0dXJuIGluc3RhbnRpYXRlUGx1Z2luKGxvYWREZXNjcmlwdG9yKGRlc2NyaXB0b3IsIGNvbnRleHQpLCBjb250ZXh0KTtcbn1cblxuY29uc3QgaW5zdGFudGlhdGVQbHVnaW4gPSAoMCwgX2NhY2hpbmcubWFrZVdlYWtDYWNoZSkoKHtcbiAgdmFsdWUsXG4gIG9wdGlvbnMsXG4gIGRpcm5hbWUsXG4gIGFsaWFzXG59LCBjYWNoZSkgPT4ge1xuICBjb25zdCBwbHVnaW5PYmogPSAoMCwgX3BsdWdpbnMudmFsaWRhdGVQbHVnaW5PYmplY3QpKHZhbHVlKTtcbiAgY29uc3QgcGx1Z2luID0gT2JqZWN0LmFzc2lnbih7fSwgcGx1Z2luT2JqKTtcblxuICBpZiAocGx1Z2luLnZpc2l0b3IpIHtcbiAgICBwbHVnaW4udmlzaXRvciA9IF90cmF2ZXJzZSgpLmRlZmF1bHQuZXhwbG9kZShPYmplY3QuYXNzaWduKHt9LCBwbHVnaW4udmlzaXRvcikpO1xuICB9XG5cbiAgaWYgKHBsdWdpbi5pbmhlcml0cykge1xuICAgIGNvbnN0IGluaGVyaXRzRGVzY3JpcHRvciA9IHtcbiAgICAgIG5hbWU6IHVuZGVmaW5lZCxcbiAgICAgIGFsaWFzOiBgJHthbGlhc30kaW5oZXJpdHNgLFxuICAgICAgdmFsdWU6IHBsdWdpbi5pbmhlcml0cyxcbiAgICAgIG9wdGlvbnMsXG4gICAgICBkaXJuYW1lXG4gICAgfTtcbiAgICBjb25zdCBpbmhlcml0cyA9IGNhY2hlLmludmFsaWRhdGUoZGF0YSA9PiBsb2FkUGx1Z2luRGVzY3JpcHRvcihpbmhlcml0c0Rlc2NyaXB0b3IsIGRhdGEpKTtcbiAgICBwbHVnaW4ucHJlID0gY2hhaW4oaW5oZXJpdHMucHJlLCBwbHVnaW4ucHJlKTtcbiAgICBwbHVnaW4ucG9zdCA9IGNoYWluKGluaGVyaXRzLnBvc3QsIHBsdWdpbi5wb3N0KTtcbiAgICBwbHVnaW4ubWFuaXB1bGF0ZU9wdGlvbnMgPSBjaGFpbihpbmhlcml0cy5tYW5pcHVsYXRlT3B0aW9ucywgcGx1Z2luLm1hbmlwdWxhdGVPcHRpb25zKTtcbiAgICBwbHVnaW4udmlzaXRvciA9IF90cmF2ZXJzZSgpLmRlZmF1bHQudmlzaXRvcnMubWVyZ2UoW2luaGVyaXRzLnZpc2l0b3IgfHwge30sIHBsdWdpbi52aXNpdG9yIHx8IHt9XSk7XG4gIH1cblxuICByZXR1cm4gbmV3IF9wbHVnaW4uZGVmYXVsdChwbHVnaW4sIG9wdGlvbnMsIGFsaWFzKTtcbn0pO1xuXG5jb25zdCBsb2FkUHJlc2V0RGVzY3JpcHRvciA9IChkZXNjcmlwdG9yLCBjb250ZXh0KSA9PiB7XG4gIHJldHVybiAoMCwgX2NvbmZpZ0NoYWluLmJ1aWxkUHJlc2V0Q2hhaW4pKGluc3RhbnRpYXRlUHJlc2V0KGxvYWREZXNjcmlwdG9yKGRlc2NyaXB0b3IsIGNvbnRleHQpKSwgY29udGV4dCk7XG59O1xuXG5jb25zdCBpbnN0YW50aWF0ZVByZXNldCA9ICgwLCBfY2FjaGluZy5tYWtlV2Vha0NhY2hlKSgoe1xuICB2YWx1ZSxcbiAgZGlybmFtZSxcbiAgYWxpYXNcbn0pID0+IHtcbiAgcmV0dXJuIHtcbiAgICBvcHRpb25zOiAoMCwgX29wdGlvbnMudmFsaWRhdGUpKFwicHJlc2V0XCIsIHZhbHVlKSxcbiAgICBhbGlhcyxcbiAgICBkaXJuYW1lXG4gIH07XG59KTtcblxuZnVuY3Rpb24gY2hhaW4oYSwgYikge1xuICBjb25zdCBmbnMgPSBbYSwgYl0uZmlsdGVyKEJvb2xlYW4pO1xuICBpZiAoZm5zLmxlbmd0aCA8PSAxKSByZXR1cm4gZm5zWzBdO1xuICByZXR1cm4gZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICBmb3IgKGNvbnN0IGZuIG9mIGZucykge1xuICAgICAgZm4uYXBwbHkodGhpcywgYXJncyk7XG4gICAgfVxuICB9O1xufSJdfQ==