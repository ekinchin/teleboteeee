"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeStaticFileCache = makeStaticFileCache;

function _fs() {
  const data = _interopRequireDefault(require("fs"));

  _fs = function () {
    return data;
  };

  return data;
}

var _caching = require("../caching");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function makeStaticFileCache(fn) {
  return (0, _caching.makeStrongCache)((filepath, cache) => {
    if (cache.invalidate(() => fileMtime(filepath)) === null) {
      cache.forever();
      return null;
    }

    return fn(filepath, _fs().default.readFileSync(filepath, "utf8"));
  });
}

function fileMtime(filepath) {
  try {
    return +_fs().default.statSync(filepath).mtime;
  } catch (e) {
    if (e.code !== "ENOENT" && e.code !== "ENOTDIR") throw e;
  }

  return null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29yZS9saWIvY29uZmlnL2ZpbGVzL3V0aWxzLmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwibWFrZVN0YXRpY0ZpbGVDYWNoZSIsIl9mcyIsImRhdGEiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9jYWNoaW5nIiwib2JqIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJmbiIsIm1ha2VTdHJvbmdDYWNoZSIsImZpbGVwYXRoIiwiY2FjaGUiLCJpbnZhbGlkYXRlIiwiZmlsZU10aW1lIiwiZm9yZXZlciIsInJlYWRGaWxlU3luYyIsInN0YXRTeW5jIiwibXRpbWUiLCJlIiwiY29kZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFDM0NDLEVBQUFBLEtBQUssRUFBRTtBQURvQyxDQUE3QztBQUdBRCxPQUFPLENBQUNFLG1CQUFSLEdBQThCQSxtQkFBOUI7O0FBRUEsU0FBU0MsR0FBVCxHQUFlO0FBQ2IsUUFBTUMsSUFBSSxHQUFHQyxzQkFBc0IsQ0FBQ0MsT0FBTyxDQUFDLElBQUQsQ0FBUixDQUFuQzs7QUFFQUgsRUFBQUEsR0FBRyxHQUFHLFlBQVk7QUFDaEIsV0FBT0MsSUFBUDtBQUNELEdBRkQ7O0FBSUEsU0FBT0EsSUFBUDtBQUNEOztBQUVELElBQUlHLFFBQVEsR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBdEI7O0FBRUEsU0FBU0Qsc0JBQVQsQ0FBZ0NHLEdBQWhDLEVBQXFDO0FBQUUsU0FBT0EsR0FBRyxJQUFJQSxHQUFHLENBQUNDLFVBQVgsR0FBd0JELEdBQXhCLEdBQThCO0FBQUVFLElBQUFBLE9BQU8sRUFBRUY7QUFBWCxHQUFyQztBQUF3RDs7QUFFL0YsU0FBU04sbUJBQVQsQ0FBNkJTLEVBQTdCLEVBQWlDO0FBQy9CLFNBQU8sQ0FBQyxHQUFHSixRQUFRLENBQUNLLGVBQWIsRUFBOEIsQ0FBQ0MsUUFBRCxFQUFXQyxLQUFYLEtBQXFCO0FBQ3hELFFBQUlBLEtBQUssQ0FBQ0MsVUFBTixDQUFpQixNQUFNQyxTQUFTLENBQUNILFFBQUQsQ0FBaEMsTUFBZ0QsSUFBcEQsRUFBMEQ7QUFDeERDLE1BQUFBLEtBQUssQ0FBQ0csT0FBTjtBQUNBLGFBQU8sSUFBUDtBQUNEOztBQUVELFdBQU9OLEVBQUUsQ0FBQ0UsUUFBRCxFQUFXVixHQUFHLEdBQUdPLE9BQU4sQ0FBY1EsWUFBZCxDQUEyQkwsUUFBM0IsRUFBcUMsTUFBckMsQ0FBWCxDQUFUO0FBQ0QsR0FQTSxDQUFQO0FBUUQ7O0FBRUQsU0FBU0csU0FBVCxDQUFtQkgsUUFBbkIsRUFBNkI7QUFDM0IsTUFBSTtBQUNGLFdBQU8sQ0FBQ1YsR0FBRyxHQUFHTyxPQUFOLENBQWNTLFFBQWQsQ0FBdUJOLFFBQXZCLEVBQWlDTyxLQUF6QztBQUNELEdBRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDVixRQUFJQSxDQUFDLENBQUNDLElBQUYsS0FBVyxRQUFYLElBQXVCRCxDQUFDLENBQUNDLElBQUYsS0FBVyxTQUF0QyxFQUFpRCxNQUFNRCxDQUFOO0FBQ2xEOztBQUVELFNBQU8sSUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLm1ha2VTdGF0aWNGaWxlQ2FjaGUgPSBtYWtlU3RhdGljRmlsZUNhY2hlO1xuXG5mdW5jdGlvbiBfZnMoKSB7XG4gIGNvbnN0IGRhdGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJmc1wiKSk7XG5cbiAgX2ZzID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG52YXIgX2NhY2hpbmcgPSByZXF1aXJlKFwiLi4vY2FjaGluZ1wiKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuZnVuY3Rpb24gbWFrZVN0YXRpY0ZpbGVDYWNoZShmbikge1xuICByZXR1cm4gKDAsIF9jYWNoaW5nLm1ha2VTdHJvbmdDYWNoZSkoKGZpbGVwYXRoLCBjYWNoZSkgPT4ge1xuICAgIGlmIChjYWNoZS5pbnZhbGlkYXRlKCgpID0+IGZpbGVNdGltZShmaWxlcGF0aCkpID09PSBudWxsKSB7XG4gICAgICBjYWNoZS5mb3JldmVyKCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gZm4oZmlsZXBhdGgsIF9mcygpLmRlZmF1bHQucmVhZEZpbGVTeW5jKGZpbGVwYXRoLCBcInV0ZjhcIikpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gZmlsZU10aW1lKGZpbGVwYXRoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuICtfZnMoKS5kZWZhdWx0LnN0YXRTeW5jKGZpbGVwYXRoKS5tdGltZTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUgIT09IFwiRU5PRU5UXCIgJiYgZS5jb2RlICE9PSBcIkVOT1RESVJcIikgdGhyb3cgZTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufSJdfQ==