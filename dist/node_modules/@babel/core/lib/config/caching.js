"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeStrongCache = makeStrongCache;
exports.makeWeakCache = makeWeakCache;
exports.assertSimpleType = assertSimpleType;

function makeStrongCache(handler) {
  return makeCachedFunction(new Map(), handler);
}

function makeWeakCache(handler) {
  return makeCachedFunction(new WeakMap(), handler);
}

function makeCachedFunction(callCache, handler) {
  return function cachedFunction(arg, data) {
    let cachedValue = callCache.get(arg);

    if (cachedValue) {
      for (const _ref of cachedValue) {
        const {
          value,
          valid
        } = _ref;
        if (valid(data)) return value;
      }
    }

    const cache = new CacheConfigurator(data);
    const value = handler(arg, cache);
    if (!cache.configured()) cache.forever();
    cache.deactivate();

    switch (cache.mode()) {
      case "forever":
        cachedValue = [{
          value,
          valid: () => true
        }];
        callCache.set(arg, cachedValue);
        break;

      case "invalidate":
        cachedValue = [{
          value,
          valid: cache.validator()
        }];
        callCache.set(arg, cachedValue);
        break;

      case "valid":
        if (cachedValue) {
          cachedValue.push({
            value,
            valid: cache.validator()
          });
        } else {
          cachedValue = [{
            value,
            valid: cache.validator()
          }];
          callCache.set(arg, cachedValue);
        }

    }

    return value;
  };
}

class CacheConfigurator {
  constructor(data) {
    this._active = true;
    this._never = false;
    this._forever = false;
    this._invalidate = false;
    this._configured = false;
    this._pairs = [];
    this._data = data;
  }

  simple() {
    return makeSimpleConfigurator(this);
  }

  mode() {
    if (this._never) return "never";
    if (this._forever) return "forever";
    if (this._invalidate) return "invalidate";
    return "valid";
  }

  forever() {
    if (!this._active) {
      throw new Error("Cannot change caching after evaluation has completed.");
    }

    if (this._never) {
      throw new Error("Caching has already been configured with .never()");
    }

    this._forever = true;
    this._configured = true;
  }

  never() {
    if (!this._active) {
      throw new Error("Cannot change caching after evaluation has completed.");
    }

    if (this._forever) {
      throw new Error("Caching has already been configured with .forever()");
    }

    this._never = true;
    this._configured = true;
  }

  using(handler) {
    if (!this._active) {
      throw new Error("Cannot change caching after evaluation has completed.");
    }

    if (this._never || this._forever) {
      throw new Error("Caching has already been configured with .never or .forever()");
    }

    this._configured = true;
    const key = handler(this._data);

    this._pairs.push([key, handler]);

    return key;
  }

  invalidate(handler) {
    if (!this._active) {
      throw new Error("Cannot change caching after evaluation has completed.");
    }

    if (this._never || this._forever) {
      throw new Error("Caching has already been configured with .never or .forever()");
    }

    this._invalidate = true;
    this._configured = true;
    const key = handler(this._data);

    this._pairs.push([key, handler]);

    return key;
  }

  validator() {
    const pairs = this._pairs;
    return data => pairs.every(([key, fn]) => key === fn(data));
  }

  deactivate() {
    this._active = false;
  }

  configured() {
    return this._configured;
  }

}

function makeSimpleConfigurator(cache) {
  function cacheFn(val) {
    if (typeof val === "boolean") {
      if (val) cache.forever();else cache.never();
      return;
    }

    return cache.using(() => assertSimpleType(val()));
  }

  cacheFn.forever = () => cache.forever();

  cacheFn.never = () => cache.never();

  cacheFn.using = cb => cache.using(() => assertSimpleType(cb()));

  cacheFn.invalidate = cb => cache.invalidate(() => assertSimpleType(cb()));

  return cacheFn;
}

function assertSimpleType(value) {
  if (value != null && typeof value !== "string" && typeof value !== "boolean" && typeof value !== "number") {
    throw new Error("Cache keys must be either string, boolean, number, null, or undefined.");
  }

  return value;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29yZS9saWIvY29uZmlnL2NhY2hpbmcuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJtYWtlU3Ryb25nQ2FjaGUiLCJtYWtlV2Vha0NhY2hlIiwiYXNzZXJ0U2ltcGxlVHlwZSIsImhhbmRsZXIiLCJtYWtlQ2FjaGVkRnVuY3Rpb24iLCJNYXAiLCJXZWFrTWFwIiwiY2FsbENhY2hlIiwiY2FjaGVkRnVuY3Rpb24iLCJhcmciLCJkYXRhIiwiY2FjaGVkVmFsdWUiLCJnZXQiLCJfcmVmIiwidmFsaWQiLCJjYWNoZSIsIkNhY2hlQ29uZmlndXJhdG9yIiwiY29uZmlndXJlZCIsImZvcmV2ZXIiLCJkZWFjdGl2YXRlIiwibW9kZSIsInNldCIsInZhbGlkYXRvciIsInB1c2giLCJjb25zdHJ1Y3RvciIsIl9hY3RpdmUiLCJfbmV2ZXIiLCJfZm9yZXZlciIsIl9pbnZhbGlkYXRlIiwiX2NvbmZpZ3VyZWQiLCJfcGFpcnMiLCJfZGF0YSIsInNpbXBsZSIsIm1ha2VTaW1wbGVDb25maWd1cmF0b3IiLCJFcnJvciIsIm5ldmVyIiwidXNpbmciLCJrZXkiLCJpbnZhbGlkYXRlIiwicGFpcnMiLCJldmVyeSIsImZuIiwiY2FjaGVGbiIsInZhbCIsImNiIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsZUFBUixHQUEwQkEsZUFBMUI7QUFDQUYsT0FBTyxDQUFDRyxhQUFSLEdBQXdCQSxhQUF4QjtBQUNBSCxPQUFPLENBQUNJLGdCQUFSLEdBQTJCQSxnQkFBM0I7O0FBRUEsU0FBU0YsZUFBVCxDQUF5QkcsT0FBekIsRUFBa0M7QUFDaEMsU0FBT0Msa0JBQWtCLENBQUMs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TixDQUFZLE1BQU1sQyxnQkFBZ0IsQ0FBQ3lDLEdBQUcsRUFBSixDQUFsQyxDQUFQO0FBQ0Q7O0FBRURELEVBQUFBLE9BQU8sQ0FBQ3hCLE9BQVIsR0FBa0IsTUFBTUgsS0FBSyxDQUFDRyxPQUFOLEVBQXhCOztBQUVBd0IsRUFBQUEsT0FBTyxDQUFDUCxLQUFSLEdBQWdCLE1BQU1wQixLQUFLLENBQUNvQixLQUFOLEVBQXRCOztBQUVBTyxFQUFBQSxPQUFPLENBQUNOLEtBQVIsR0FBZ0JRLEVBQUUsSUFBSTdCLEtBQUssQ0FBQ3FCLEtBQU4sQ0FBWSxNQUFNbEMsZ0JBQWdCLENBQUMwQyxFQUFFLEVBQUgsQ0FBbEMsQ0FBdEI7O0FBRUFGLEVBQUFBLE9BQU8sQ0FBQ0osVUFBUixHQUFxQk0sRUFBRSxJQUFJN0IsS0FBSyxDQUFDdUIsVUFBTixDQUFpQixNQUFNcEMsZ0JBQWdCLENBQUMwQyxFQUFFLEVBQUgsQ0FBdkMsQ0FBM0I7O0FBRUEsU0FBT0YsT0FBUDtBQUNEOztBQUVELFNBQVN4QyxnQkFBVCxDQUEwQkgsS0FBMUIsRUFBaUM7QUFDL0IsTUFBSUEsS0FBSyxJQUFJLElBQVQsSUFBaUIsT0FBT0EsS0FBUCxLQUFpQixRQUFsQyxJQUE4QyxPQUFPQSxLQUFQLEtBQWlCLFNBQS9ELElBQTRFLE9BQU9BLEtBQVAsS0FBaUIsUUFBakcsRUFBMkc7QUFDekcsVUFBTSxJQUFJbUMsS0FBSixDQUFVLHdFQUFWLENBQU47QUFDRDs7QUFFRCxTQUFPbkMsS0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLm1ha2VTdHJvbmdDYWNoZSA9IG1ha2VTdHJvbmdDYWNoZTtcbmV4cG9ydHMubWFrZVdlYWtDYWNoZSA9IG1ha2VXZWFrQ2FjaGU7XG5leHBvcnRzLmFzc2VydFNpbXBsZVR5cGUgPSBhc3NlcnRTaW1wbGVUeXBlO1xuXG5mdW5jdGlvbiBtYWtlU3Ryb25nQ2FjaGUoaGFuZGxlcikge1xuICByZXR1cm4gbWFrZUNhY2hlZEZ1bmN0aW9uKG5ldyBNYXAoKSwgaGFuZGxlcik7XG59XG5cbmZ1bmN0aW9uIG1ha2VXZWFrQ2FjaGUoaGFuZGxlcikge1xuICByZXR1cm4gbWFrZUNhY2hlZEZ1bmN0aW9uKG5ldyBXZWFrTWFwKCksIGhhbmRsZXIpO1xufVxuXG5mdW5jdGlvbiBtYWtlQ2FjaGVkRnVuY3Rpb24oY2FsbENhY2hlLCBoYW5kbGVyKSB7XG4gIHJldHVybiBmdW5jdGlvbiBjYWNoZWRGdW5jdGlvbihhcmcsIGRhdGEpIHtcbiAgICBsZXQgY2FjaGVkVmFsdWUgPSBjYWxsQ2FjaGUuZ2V0KGFyZyk7XG5cbiAgICBpZiAoY2FjaGVkVmFsdWUpIHtcbiAgICAgIGZvciAoY29uc3QgX3JlZiBvZiBjYWNoZWRWYWx1ZSkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgdmFsaWRcbiAgICAgICAgfSA9IF9yZWY7XG4gICAgICAgIGlmICh2YWxpZChkYXRhKSkgcmV0dXJuIHZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGNhY2hlID0gbmV3IENhY2hlQ29uZmlndXJhdG9yKGRhdGEpO1xuICAgIGNvbnN0IHZhbHVlID0gaGFuZGxlcihhcmcsIGNhY2hlKTtcbiAgICBpZiAoIWNhY2hlLmNvbmZpZ3VyZWQoKSkgY2FjaGUuZm9yZXZlcigpO1xuICAgIGNhY2hlLmRlYWN0aXZhdGUoKTtcblxuICAgIHN3aXRjaCAoY2FjaGUubW9kZSgpKSB7XG4gICAgICBjYXNlIFwiZm9yZXZlclwiOlxuICAgICAgICBjYWNoZWRWYWx1ZSA9IFt7XG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgdmFsaWQ6ICgpID0+IHRydWVcbiAgICAgICAgfV07XG4gICAgICAgIGNhbGxDYWNoZS5zZXQoYXJnLCBjYWNoZWRWYWx1ZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIFwiaW52YWxpZGF0ZVwiOlxuICAgICAgICBjYWNoZWRWYWx1ZSA9IFt7XG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgdmFsaWQ6IGNhY2hlLnZhbGlkYXRvcigpXG4gICAgICAgIH1dO1xuICAgICAgICBjYWxsQ2FjaGUuc2V0KGFyZywgY2FjaGVkVmFsdWUpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBcInZhbGlkXCI6XG4gICAgICAgIGlmIChjYWNoZWRWYWx1ZSkge1xuICAgICAgICAgIGNhY2hlZFZhbHVlLnB1c2goe1xuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgICB2YWxpZDogY2FjaGUudmFsaWRhdG9yKClcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjYWNoZWRWYWx1ZSA9IFt7XG4gICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgIHZhbGlkOiBjYWNoZS52YWxpZGF0b3IoKVxuICAgICAgICAgIH1dO1xuICAgICAgICAgIGNhbGxDYWNoZS5zZXQoYXJnLCBjYWNoZWRWYWx1ZSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfTtcbn1cblxuY2xhc3MgQ2FjaGVDb25maWd1cmF0b3Ige1xuICBjb25zdHJ1Y3RvcihkYXRhKSB7XG4gICAgdGhpcy5fYWN0aXZlID0gdHJ1ZTtcbiAgICB0aGlzLl9uZXZlciA9IGZhbHNlO1xuICAgIHRoaXMuX2ZvcmV2ZXIgPSBmYWxzZTtcbiAgICB0aGlzLl9pbnZhbGlkYXRlID0gZmFsc2U7XG4gICAgdGhpcy5fY29uZmlndXJlZCA9IGZhbHNlO1xuICAgIHRoaXMuX3BhaXJzID0gW107XG4gICAgdGhpcy5fZGF0YSA9IGRhdGE7XG4gIH1cblxuICBzaW1wbGUoKSB7XG4gICAgcmV0dXJuIG1ha2VTaW1wbGVDb25maWd1cmF0b3IodGhpcyk7XG4gIH1cblxuICBtb2RlKCkge1xuICAgIGlmICh0aGlzLl9uZXZlcikgcmV0dXJuIFwibmV2ZXJcIjtcbiAgICBpZiAodGhpcy5fZm9yZXZlcikgcmV0dXJuIFwiZm9yZXZlclwiO1xuICAgIGlmICh0aGlzLl9pbnZhbGlkYXRlKSByZXR1cm4gXCJpbnZhbGlkYXRlXCI7XG4gICAgcmV0dXJuIFwidmFsaWRcIjtcbiAgfVxuXG4gIGZvcmV2ZXIoKSB7XG4gICAgaWYgKCF0aGlzLl9hY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjaGFuZ2UgY2FjaGluZyBhZnRlciBldmFsdWF0aW9uIGhhcyBjb21wbGV0ZWQuXCIpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9uZXZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FjaGluZyBoYXMgYWxyZWFkeSBiZWVuIGNvbmZpZ3VyZWQgd2l0aCAubmV2ZXIoKVwiKTtcbiAgICB9XG5cbiAgICB0aGlzLl9mb3JldmVyID0gdHJ1ZTtcbiAgICB0aGlzLl9jb25maWd1cmVkID0gdHJ1ZTtcbiAgfVxuXG4gIG5ldmVyKCkge1xuICAgIGlmICghdGhpcy5fYWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY2hhbmdlIGNhY2hpbmcgYWZ0ZXIgZXZhbHVhdGlvbiBoYXMgY29tcGxldGVkLlwiKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fZm9yZXZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FjaGluZyBoYXMgYWxyZWFkeSBiZWVuIGNvbmZpZ3VyZWQgd2l0aCAuZm9yZXZlcigpXCIpO1xuICAgIH1cblxuICAgIHRoaXMuX25ldmVyID0gdHJ1ZTtcbiAgICB0aGlzLl9jb25maWd1cmVkID0gdHJ1ZTtcbiAgfVxuXG4gIHVzaW5nKGhhbmRsZXIpIHtcbiAgICBpZiAoIXRoaXMuX2FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGNoYW5nZSBjYWNoaW5nIGFmdGVyIGV2YWx1YXRpb24gaGFzIGNvbXBsZXRlZC5cIik7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX25ldmVyIHx8IHRoaXMuX2ZvcmV2ZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhY2hpbmcgaGFzIGFscmVhZHkgYmVlbiBjb25maWd1cmVkIHdpdGggLm5ldmVyIG9yIC5mb3JldmVyKClcIik7XG4gICAgfVxuXG4gICAgdGhpcy5fY29uZmlndXJlZCA9IHRydWU7XG4gICAgY29uc3Qga2V5ID0gaGFuZGxlcih0aGlzLl9kYXRhKTtcblxuICAgIHRoaXMuX3BhaXJzLnB1c2goW2tleSwgaGFuZGxlcl0pO1xuXG4gICAgcmV0dXJuIGtleTtcbiAgfVxuXG4gIGludmFsaWRhdGUoaGFuZGxlcikge1xuICAgIGlmICghdGhpcy5fYWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY2hhbmdlIGNhY2hpbmcgYWZ0ZXIgZXZhbHVhdGlvbiBoYXMgY29tcGxldGVkLlwiKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fbmV2ZXIgfHwgdGhpcy5fZm9yZXZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FjaGluZyBoYXMgYWxyZWFkeSBiZWVuIGNvbmZpZ3VyZWQgd2l0aCAubmV2ZXIgb3IgLmZvcmV2ZXIoKVwiKTtcbiAgICB9XG5cbiAgICB0aGlzLl9pbnZhbGlkYXRlID0gdHJ1ZTtcbiAgICB0aGlzLl9jb25maWd1cmVkID0gdHJ1ZTtcbiAgICBjb25zdCBrZXkgPSBoYW5kbGVyKHRoaXMuX2RhdGEpO1xuXG4gICAgdGhpcy5fcGFpcnMucHVzaChba2V5LCBoYW5kbGVyXSk7XG5cbiAgICByZXR1cm4ga2V5O1xuICB9XG5cbiAgdmFsaWRhdG9yKCkge1xuICAgIGNvbnN0IHBhaXJzID0gdGhpcy5fcGFpcnM7XG4gICAgcmV0dXJuIGRhdGEgPT4gcGFpcnMuZXZlcnkoKFtrZXksIGZuXSkgPT4ga2V5ID09PSBmbihkYXRhKSk7XG4gIH1cblxuICBkZWFjdGl2YXRlKCkge1xuICAgIHRoaXMuX2FjdGl2ZSA9IGZhbHNlO1xuICB9XG5cbiAgY29uZmlndXJlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5fY29uZmlndXJlZDtcbiAgfVxuXG59XG5cbmZ1bmN0aW9uIG1ha2VTaW1wbGVDb25maWd1cmF0b3IoY2FjaGUpIHtcbiAgZnVuY3Rpb24gY2FjaGVGbih2YWwpIHtcbiAgICBpZiAodHlwZW9mIHZhbCA9PT0gXCJib29sZWFuXCIpIHtcbiAgICAgIGlmICh2YWwpIGNhY2hlLmZvcmV2ZXIoKTtlbHNlIGNhY2hlLm5ldmVyKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhY2hlLnVzaW5nKCgpID0+IGFzc2VydFNpbXBsZVR5cGUodmFsKCkpKTtcbiAgfVxuXG4gIGNhY2hlRm4uZm9yZXZlciA9ICgpID0+IGNhY2hlLmZvcmV2ZXIoKTtcblxuICBjYWNoZUZuLm5ldmVyID0gKCkgPT4gY2FjaGUubmV2ZXIoKTtcblxuICBjYWNoZUZuLnVzaW5nID0gY2IgPT4gY2FjaGUudXNpbmcoKCkgPT4gYXNzZXJ0U2ltcGxlVHlwZShjYigpKSk7XG5cbiAgY2FjaGVGbi5pbnZhbGlkYXRlID0gY2IgPT4gY2FjaGUuaW52YWxpZGF0ZSgoKSA9PiBhc3NlcnRTaW1wbGVUeXBlKGNiKCkpKTtcblxuICByZXR1cm4gY2FjaGVGbjtcbn1cblxuZnVuY3Rpb24gYXNzZXJ0U2ltcGxlVHlwZSh2YWx1ZSkge1xuICBpZiAodmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIHZhbHVlICE9PSBcImJvb2xlYW5cIiAmJiB0eXBlb2YgdmFsdWUgIT09IFwibnVtYmVyXCIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYWNoZSBrZXlzIG11c3QgYmUgZWl0aGVyIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyLCBudWxsLCBvciB1bmRlZmluZWQuXCIpO1xuICB9XG5cbiAgcmV0dXJuIHZhbHVlO1xufSJdfQ==