"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.codeFrameColumns = codeFrameColumns;
exports.default = _default;

function _highlight() {
  const data = _interopRequireWildcard(require("@babel/highlight"));

  _highlight = function () {
    return data;
  };

  return data;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  } else {
    var newObj = {};

    if (obj != null) {
      for (var key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
          var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {};

          if (desc.get || desc.set) {
            Object.defineProperty(newObj, key, desc);
          } else {
            newObj[key] = obj[key];
          }
        }
      }
    }

    newObj.default = obj;
    return newObj;
  }
}

let deprecationWarningShown = false;

function getDefs(chalk) {
  return {
    gutter: chalk.grey,
    marker: chalk.red.bold,
    message: chalk.red.bold
  };
}

const NEWLINE = /\r\n|[\n\r\u2028\u2029]/;

function getMarkerLines(loc, source, opts) {
  const startLoc = Object.assign({
    column: 0,
    line: -1
  }, loc.start);
  const endLoc = Object.assign({}, startLoc, loc.end);
  const {
    linesAbove = 2,
    linesBelow = 3
  } = opts || {};
  const startLine = startLoc.line;
  const startColumn = startLoc.column;
  const endLine = endLoc.line;
  const endColumn = endLoc.column;
  let start = Math.max(startLine - (linesAbove + 1), 0);
  let end = Math.min(source.length, endLine + linesBelow);

  if (startLine === -1) {
    start = 0;
  }

  if (endLine === -1) {
    end = source.length;
  }

  const lineDiff = endLine - startLine;
  const markerLines = {};

  if (lineDiff) {
    for (let i = 0; i <= lineDiff; i++) {
      const lineNumber = i + startLine;

      if (!startColumn) {
        markerLines[lineNumber] = true;
      } else if (i === 0) {
        const sourceLength = source[lineNumber - 1].length;
        markerLines[lineNumber] = [startColumn, sourceLength - startColumn];
      } else if (i === lineDiff) {
        markerLines[lineNumber] = [0, endColumn];
      } else {
        const sourceLength = source[lineNumber - i].length;
        markerLines[lineNumber] = [0, sourceLength];
      }
    }
  } else {
    if (startColumn === endColumn) {
      if (startColumn) {
        markerLines[startLine] = [startColumn, 0];
      } else {
        markerLines[startLine] = true;
      }
    } else {
      markerLines[startLine] = [startColumn, endColumn - startColumn];
    }
  }

  return {
    start,
    end,
    markerLines
  };
}

function codeFrameColumns(rawLines, loc, opts = {}) {
  const highlighted = (opts.highlightCode || opts.forceColor) && (0, _highlight().shouldHighlight)(opts);
  const chalk = (0, _highlight().getChalk)(opts);
  const defs = getDefs(chalk);

  const maybeHighlight = (chalkFn, string) => {
    return highlighted ? chalkFn(string) : string;
  };

  if (highlighted) rawLines = (0, _highlight().default)(rawLines, opts);
  const lines = rawLines.split(NEWLINE);
  const {
    start,
    end,
    markerLines
  } = getMarkerLines(loc, lines, opts);
  const hasColumns = loc.start && typeof loc.start.column === "number";
  const numberMaxWidth = String(end).length;
  let frame = lines.slice(start, end).map((line, index) => {
    const number = start + 1 + index;
    const paddedNumber = ` ${number}`.slice(-numberMaxWidth);
    const gutter = ` ${paddedNumber} | `;
    const hasMarker = markerLines[number];
    const lastMarkerLine = !markerLines[number + 1];

    if (hasMarker) {
      let markerLine = "";

      if (Array.isArray(hasMarker)) {
        const markerSpacing = line.slice(0, Math.max(hasMarker[0] - 1, 0)).replace(/[^\t]/g, " ");
        const numberOfMarkers = hasMarker[1] || 1;
        markerLine = ["\n ", maybeHighlight(defs.gutter, gutter.replace(/\d/g, " ")), markerSpacing, maybeHighlight(defs.marker, "^").repeat(numberOfMarkers)].join("");

        if (lastMarkerLine && opts.message) {
          markerLine += " " + maybeHighlight(defs.message, opts.message);
        }
      }

      return [maybeHighlight(defs.marker, ">"), maybeHighlight(defs.gutter, gutter), line, markerLine].join("");
    } else {
      return ` ${maybeHighlight(defs.gutter, gutter)}${line}`;
    }
  }).join("\n");

  if (opts.message && !hasColumns) {
    frame = `${" ".repeat(numberMaxWidth + 1)}${opts.message}\n${frame}`;
  }

  if (highlighted) {
    return chalk.reset(frame);
  } else {
    return frame;
  }
}

function _default(rawLines, lineNumber, colNumber, opts = {}) {
  if (!deprecationWarningShown) {
    deprecationWarningShown = true;
    const message = "Passing lineNumber and colNumber is deprecated to @babel/code-frame. Please use `codeFrameColumns`.";

    if (process.emitWarning) {
      process.emitWarning(message, "DeprecationWarning");
    } else {
      const deprecationError = new Error(message);
      deprecationError.name = "DeprecationWarning";
      console.warn(new Error(message));
    }
  }

  colNumber = Math.max(colNumber, 0);
  const location = {
    start: {
      column: colNumber,
      line: lineNumber
    }
  };
  return codeFrameColumns(rawLines, location, opts);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL25vZGVfbW9kdWxlcy9AYmFiZWwvY29kZS1mcmFtZS9saWIvaW5kZXguanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJjb2RlRnJhbWVDb2x1bW5zIiwiZGVmYXVsdCIsIl9kZWZhdWx0IiwiX2hpZ2hsaWdodCIsImRhdGEiLCJfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZCIsInJlcXVpcmUiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImdldCIsInNldCIsImRlcHJlY2F0aW9uV2FybmluZ1Nob3duIiwiZ2V0RGVmcyIsImNoYWxrIiwiZ3V0dGVyIiwiZ3JleSIsIm1hcmtlciIsInJlZCIsImJvbGQiLCJtZXNzYWdlIiwiTkVXTElORSIsImdldE1hcmtlckxpbmVzIiwibG9jIiwic291cmNlIiwib3B0cyIsInN0YXJ0TG9jIiwiYXNzaWduIiwiY29sdW1uIiwibGluZSIsInN0YXJ0IiwiZW5kTG9jIiwiZW5kIiwibGluZXNBYm92ZSIsImxpbmVzQmVsb3ciLCJzdGFydExpbmUiLCJzdGFydENvbHVtbiIsImVuZExpbmUiLCJlbmRDb2x1bW4iLCJNYXRoIiwibWF4IiwibWluIiwibGVuZ3RoIiwibGluZURpZmYiLCJtYXJrZXJMaW5lcyIsImkiLCJsaW5lTnVtYmVyIiwic291cmNlTGVuZ3RoIiwicmF3TGluZXMiLCJoaWdobGlnaHRlZCIsImhpZ2hsaWdodENvZGUiLCJmb3JjZUNvbG9yIiwic2hvdWxkSGlnaGxpZ2h0IiwiZ2V0Q2hhbGsiLCJkZWZzIiwibWF5YmVIaWdobGlnaHQiLCJjaGFsa0ZuIiwic3RyaW5nIiwibGluZXMiLCJzcGxpdCIsImhhc0NvbHVtbnMiLCJudW1iZXJNYXhXaWR0aCIsIlN0cmluZyIsImZyYW1lIiwic2xpY2UiLCJtYXAiLCJpbmRleCIsIm51bWJlciIsInBhZGRlZE51bWJlciIsImhhc01hcmtlciIsImxhc3RNYXJrZXJMaW5lIiwibWFya2VyTGluZSIsIkFycmF5IiwiaXNBcnJheSIsIm1hcmtlclNwYWNpbmciLCJyZXBsYWNlIiwibnVtYmVyT2ZNYXJrZXJzIiwicmVwZWF0Iiwiam9pbiIsInJlc2V0IiwiY29sTnVtYmVyIiwicHJvY2VzcyIsImVtaXRXYXJuaW5nIiwiZGVwcmVjYXRpb25FcnJvciIsIkVycm9yIiwibmFtZSIsImNvbnNvbGUiLCJ3YXJuIiwibG9jYXRpb24iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQzNDQyxFQUFBQSxLQUFLLEVBQUU7QUFEb0MsQ0FBN0M7QUFHQUQsT0FBTyxDQUFDRSxnQkFBUixHQUEyQkEsZ0JBQTNCO0FBQ0FGLE9BQU8sQ0FBQ0csT0FBUixHQUFrQkMsUUFBbEI7O0FBRUEsU0FBU0MsVUFBVCxHQUFzQjtBQUNwQixRQUFNQyxJQUFJLEdBQUdDLHVCQUF1QixDQUFDQyxPQUFPLENBQUMsa0JBQUQsQ0FBUixDQUFwQzs7QUFFQUgsRUFBQUEsVUFBVSxHQUFHLFlBQVk7QUFDdkIsV0FBT0MsSUFBUDtBQUNELEdBRkQ7O0FBSUEsU0FBT0EsSUFBUDtBQUNEOztBQUVELFNBQVNDLHVCQUFULENBQWlDRSxHQUFqQyxFQUFzQztBQUFFLE1BQUlBLEdBQUcsSUFBSUEsR0FBRyxDQUFDQyxVQUFmLEVBQTJCO0FBQUUsV0FBT0QsR0FBUDtBQUFhLEdBQTFDLE1BQWdEO0FBQUUsUUFBSUUsTUFBTSxHQUFHLEVBQWI7O0FBQWlCLFFBQUlGLEdBQUcsSUFBSSxJQUFYLEVBQWlCO0FBQUUsV0FBSyxJQUFJRyxHQUFULElBQWdCSCxHQUFoQixFQUFxQjtBQUFFLFlBQUlYLE1BQU0sQ0FBQ2UsU0FBUCxDQUFpQkMsY0FBakIsQ0FBZ0NDLElBQWhDLENBQXFDTixHQUFyQyxFQUEwQ0cs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QUExQjtBQUNBLFVBQU1RLE9BQU8sR0FBRyxxR0FBaEI7O0FBRUEsUUFBSTZELE9BQU8sQ0FBQ0MsV0FBWixFQUF5QjtBQUN2QkQsTUFBQUEsT0FBTyxDQUFDQyxXQUFSLENBQW9COUQsT0FBcEIsRUFBNkIsb0JBQTdCO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsWUFBTStELGdCQUFnQixHQUFHLElBQUlDLEtBQUosQ0FBVWhFLE9BQVYsQ0FBekI7QUFDQStELE1BQUFBLGdCQUFnQixDQUFDRSxJQUFqQixHQUF3QixvQkFBeEI7QUFDQUMsTUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQWEsSUFBSUgsS0FBSixDQUFVaEUsT0FBVixDQUFiO0FBQ0Q7QUFDRjs7QUFFRDRELEVBQUFBLFNBQVMsR0FBR3pDLElBQUksQ0FBQ0MsR0FBTCxDQUFTd0MsU0FBVCxFQUFvQixDQUFwQixDQUFaO0FBQ0EsUUFBTVEsUUFBUSxHQUFHO0FBQ2YxRCxJQUFBQSxLQUFLLEVBQUU7QUFDTEYsTUFBQUEsTUFBTSxFQUFFb0QsU0FESDtBQUVMbkQsTUFBQUEsSUFBSSxFQUFFaUI7QUFGRDtBQURRLEdBQWpCO0FBTUEsU0FBT3BELGdCQUFnQixDQUFDc0QsUUFBRCxFQUFXd0MsUUFBWCxFQUFxQi9ELElBQXJCLENBQXZCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMuY29kZUZyYW1lQ29sdW1ucyA9IGNvZGVGcmFtZUNvbHVtbnM7XG5leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDtcblxuZnVuY3Rpb24gX2hpZ2hsaWdodCgpIHtcbiAgY29uc3QgZGF0YSA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKHJlcXVpcmUoXCJAYmFiZWwvaGlnaGxpZ2h0XCIpKTtcblxuICBfaGlnaGxpZ2h0ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBkYXRhO1xuICB9O1xuXG4gIHJldHVybiBkYXRhO1xufVxuXG5mdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgeyByZXR1cm4gb2JqOyB9IGVsc2UgeyB2YXIgbmV3T2JqID0ge307IGlmIChvYmogIT0gbnVsbCkgeyBmb3IgKHZhciBrZXkgaW4gb2JqKSB7IGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7IHZhciBkZXNjID0gT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KSA6IHt9OyBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5ld09iaiwga2V5LCBkZXNjKTsgfSBlbHNlIHsgbmV3T2JqW2tleV0gPSBvYmpba2V5XTsgfSB9IH0gfSBuZXdPYmouZGVmYXVsdCA9IG9iajsgcmV0dXJuIG5ld09iajsgfSB9XG5cbmxldCBkZXByZWNhdGlvbldhcm5pbmdTaG93biA9IGZhbHNlO1xuXG5mdW5jdGlvbiBnZXREZWZzKGNoYWxrKSB7XG4gIHJldHVybiB7XG4gICAgZ3V0dGVyOiBjaGFsay5ncmV5LFxuICAgIG1hcmtlcjogY2hhbGsucmVkLmJvbGQsXG4gICAgbWVzc2FnZTogY2hhbGsucmVkLmJvbGRcbiAgfTtcbn1cblxuY29uc3QgTkVXTElORSA9IC9cXHJcXG58W1xcblxcclxcdTIwMjhcXHUyMDI5XS87XG5cbmZ1bmN0aW9uIGdldE1hcmtlckxpbmVzKGxvYywgc291cmNlLCBvcHRzKSB7XG4gIGNvbnN0IHN0YXJ0TG9jID0gT2JqZWN0LmFzc2lnbih7XG4gICAgY29sdW1uOiAwLFxuICAgIGxpbmU6IC0xXG4gIH0sIGxvYy5zdGFydCk7XG4gIGNvbnN0IGVuZExvYyA9IE9iamVjdC5hc3NpZ24oe30sIHN0YXJ0TG9jLCBsb2MuZW5kKTtcbiAgY29uc3Qge1xuICAgIGxpbmVzQWJvdmUgPSAyLFxuICAgIGxpbmVzQmVsb3cgPSAzXG4gIH0gPSBvcHRzIHx8IHt9O1xuICBjb25zdCBzdGFydExpbmUgPSBzdGFydExvYy5saW5lO1xuICBjb25zdCBzdGFydENvbHVtbiA9IHN0YXJ0TG9jLmNvbHVtbjtcbiAgY29uc3QgZW5kTGluZSA9IGVuZExvYy5saW5lO1xuICBjb25zdCBlbmRDb2x1bW4gPSBlbmRMb2MuY29sdW1uO1xuICBsZXQgc3RhcnQgPSBNYXRoLm1heChzdGFydExpbmUgLSAobGluZXNBYm92ZSArIDEpLCAwKTtcbiAgbGV0IGVuZCA9IE1hdGgubWluKHNvdXJjZS5sZW5ndGgsIGVuZExpbmUgKyBsaW5lc0JlbG93KTtcblxuICBpZiAoc3RhcnRMaW5lID09PSAtMSkge1xuICAgIHN0YXJ0ID0gMDtcbiAgfVxuXG4gIGlmIChlbmRMaW5lID09PSAtMSkge1xuICAgIGVuZCA9IHNvdXJjZS5sZW5ndGg7XG4gIH1cblxuICBjb25zdCBsaW5lRGlmZiA9IGVuZExpbmUgLSBzdGFydExpbmU7XG4gIGNvbnN0IG1hcmtlckxpbmVzID0ge307XG5cbiAgaWYgKGxpbmVEaWZmKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbGluZURpZmY7IGkrKykge1xuICAgICAgY29uc3QgbGluZU51bWJlciA9IGkgKyBzdGFydExpbmU7XG5cbiAgICAgIGlmICghc3RhcnRDb2x1bW4pIHtcbiAgICAgICAgbWFya2VyTGluZXNbbGluZU51bWJlcl0gPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7XG4gICAgICAgIGNvbnN0IHNvdXJjZUxlbmd0aCA9IHNvdXJjZVtsaW5lTnVtYmVyIC0gMV0ubGVuZ3RoO1xuICAgICAgICBtYXJrZXJMaW5lc1tsaW5lTnVtYmVyXSA9IFtzdGFydENvbHVtbiwgc291cmNlTGVuZ3RoIC0gc3RhcnRDb2x1bW5dO1xuICAgICAgfSBlbHNlIGlmIChpID09PSBsaW5lRGlmZikge1xuICAgICAgICBtYXJrZXJMaW5lc1tsaW5lTnVtYmVyXSA9IFswLCBlbmRDb2x1bW5dO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgc291cmNlTGVuZ3RoID0gc291cmNlW2xpbmVOdW1iZXIgLSBpXS5sZW5ndGg7XG4gICAgICAgIG1hcmtlckxpbmVzW2xpbmVOdW1iZXJdID0gWzAsIHNvdXJjZUxlbmd0aF07XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChzdGFydENvbHVtbiA9PT0gZW5kQ29sdW1uKSB7XG4gICAgICBpZiAoc3RhcnRDb2x1bW4pIHtcbiAgICAgICAgbWFya2VyTGluZXNbc3RhcnRMaW5lXSA9IFtzdGFydENvbHVtbiwgMF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtYXJrZXJMaW5lc1tzdGFydExpbmVdID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbWFya2VyTGluZXNbc3RhcnRMaW5lXSA9IFtzdGFydENvbHVtbiwgZW5kQ29sdW1uIC0gc3RhcnRDb2x1bW5dO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3RhcnQsXG4gICAgZW5kLFxuICAgIG1hcmtlckxpbmVzXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvZGVGcmFtZUNvbHVtbnMocmF3TGluZXMsIGxvYywgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IGhpZ2hsaWdodGVkID0gKG9wdHMuaGlnaGxpZ2h0Q29kZSB8fCBvcHRzLmZvcmNlQ29sb3IpICYmICgwLCBfaGlnaGxpZ2h0KCkuc2hvdWxkSGlnaGxpZ2h0KShvcHRzKTtcbiAgY29uc3QgY2hhbGsgPSAoMCwgX2hpZ2hsaWdodCgpLmdldENoYWxrKShvcHRzKTtcbiAgY29uc3QgZGVmcyA9IGdldERlZnMoY2hhbGspO1xuXG4gIGNvbnN0IG1heWJlSGlnaGxpZ2h0ID0gKGNoYWxrRm4sIHN0cmluZykgPT4ge1xuICAgIHJldHVybiBoaWdobGlnaHRlZCA/IGNoYWxrRm4oc3RyaW5nKSA6IHN0cmluZztcbiAgfTtcblxuICBpZiAoaGlnaGxpZ2h0ZWQpIHJhd0xpbmVzID0gKDAsIF9oaWdobGlnaHQoKS5kZWZhdWx0KShyYXdMaW5lcywgb3B0cyk7XG4gIGNvbnN0IGxpbmVzID0gcmF3TGluZXMuc3BsaXQoTkVXTElORSk7XG4gIGNvbnN0IHtcbiAgICBzdGFydCxcbiAgICBlbmQsXG4gICAgbWFya2VyTGluZXNcbiAgfSA9IGdldE1hcmtlckxpbmVzKGxvYywgbGluZXMsIG9wdHMpO1xuICBjb25zdCBoYXNDb2x1bW5zID0gbG9jLnN0YXJ0ICYmIHR5cGVvZiBsb2Muc3RhcnQuY29sdW1uID09PSBcIm51bWJlclwiO1xuICBjb25zdCBudW1iZXJNYXhXaWR0aCA9IFN0cmluZyhlbmQpLmxlbmd0aDtcbiAgbGV0IGZyYW1lID0gbGluZXMuc2xpY2Uoc3RhcnQsIGVuZCkubWFwKChsaW5lLCBpbmRleCkgPT4ge1xuICAgIGNvbnN0IG51bWJlciA9IHN0YXJ0ICsgMSArIGluZGV4O1xuICAgIGNvbnN0IHBhZGRlZE51bWJlciA9IGAgJHtudW1iZXJ9YC5zbGljZSgtbnVtYmVyTWF4V2lkdGgpO1xuICAgIGNvbnN0IGd1dHRlciA9IGAgJHtwYWRkZWROdW1iZXJ9IHwgYDtcbiAgICBjb25zdCBoYXNNYXJrZXIgPSBtYXJrZXJMaW5lc1tudW1iZXJdO1xuICAgIGNvbnN0IGxhc3RNYXJrZXJMaW5lID0gIW1hcmtlckxpbmVzW251bWJlciArIDFdO1xuXG4gICAgaWYgKGhhc01hcmtlcikge1xuICAgICAgbGV0IG1hcmtlckxpbmUgPSBcIlwiO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShoYXNNYXJrZXIpKSB7XG4gICAgICAgIGNvbnN0IG1hcmtlclNwYWNpbmcgPSBsaW5lLnNsaWNlKDAsIE1hdGgubWF4KGhhc01hcmtlclswXSAtIDEsIDApKS5yZXBsYWNlKC9bXlxcdF0vZywgXCIgXCIpO1xuICAgICAgICBjb25zdCBudW1iZXJPZk1hcmtlcnMgPSBoYXNNYXJrZXJbMV0gfHwgMTtcbiAgICAgICAgbWFya2VyTGluZSA9IFtcIlxcbiBcIiwgbWF5YmVIaWdobGlnaHQoZGVmcy5ndXR0ZXIsIGd1dHRlci5yZXBsYWNlKC9cXGQvZywgXCIgXCIpKSwgbWFya2VyU3BhY2luZywgbWF5YmVIaWdobGlnaHQoZGVmcy5tYXJrZXIsIFwiXlwiKS5yZXBlYXQobnVtYmVyT2ZNYXJrZXJzKV0uam9pbihcIlwiKTtcblxuICAgICAgICBpZiAobGFzdE1hcmtlckxpbmUgJiYgb3B0cy5tZXNzYWdlKSB7XG4gICAgICAgICAgbWFya2VyTGluZSArPSBcIiBcIiArIG1heWJlSGlnaGxpZ2h0KGRlZnMubWVzc2FnZSwgb3B0cy5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gW21heWJlSGlnaGxpZ2h0KGRlZnMubWFya2VyLCBcIj5cIiksIG1heWJlSGlnaGxpZ2h0KGRlZnMuZ3V0dGVyLCBndXR0ZXIpLCBsaW5lLCBtYXJrZXJMaW5lXS5qb2luKFwiXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYCAke21heWJlSGlnaGxpZ2h0KGRlZnMuZ3V0dGVyLCBndXR0ZXIpfSR7bGluZX1gO1xuICAgIH1cbiAgfSkuam9pbihcIlxcblwiKTtcblxuICBpZiAob3B0cy5tZXNzYWdlICYmICFoYXNDb2x1bW5zKSB7XG4gICAgZnJhbWUgPSBgJHtcIiBcIi5yZXBlYXQobnVtYmVyTWF4V2lkdGggKyAxKX0ke29wdHMubWVzc2FnZX1cXG4ke2ZyYW1lfWA7XG4gIH1cblxuICBpZiAoaGlnaGxpZ2h0ZWQpIHtcbiAgICByZXR1cm4gY2hhbGsucmVzZXQoZnJhbWUpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBmcmFtZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBfZGVmYXVsdChyYXdMaW5lcywgbGluZU51bWJlciwgY29sTnVtYmVyLCBvcHRzID0ge30pIHtcbiAgaWYgKCFkZXByZWNhdGlvbldhcm5pbmdTaG93bikge1xuICAgIGRlcHJlY2F0aW9uV2FybmluZ1Nob3duID0gdHJ1ZTtcbiAgICBjb25zdCBtZXNzYWdlID0gXCJQYXNzaW5nIGxpbmVOdW1iZXIgYW5kIGNvbE51bWJlciBpcyBkZXByZWNhdGVkIHRvIEBiYWJlbC9jb2RlLWZyYW1lLiBQbGVhc2UgdXNlIGBjb2RlRnJhbWVDb2x1bW5zYC5cIjtcblxuICAgIGlmIChwcm9jZXNzLmVtaXRXYXJuaW5nKSB7XG4gICAgICBwcm9jZXNzLmVtaXRXYXJuaW5nKG1lc3NhZ2UsIFwiRGVwcmVjYXRpb25XYXJuaW5nXCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBkZXByZWNhdGlvbkVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgZGVwcmVjYXRpb25FcnJvci5uYW1lID0gXCJEZXByZWNhdGlvbldhcm5pbmdcIjtcbiAgICAgIGNvbnNvbGUud2FybihuZXcgRXJyb3IobWVzc2FnZSkpO1xuICAgIH1cbiAgfVxuXG4gIGNvbE51bWJlciA9IE1hdGgubWF4KGNvbE51bWJlciwgMCk7XG4gIGNvbnN0IGxvY2F0aW9uID0ge1xuICAgIHN0YXJ0OiB7XG4gICAgICBjb2x1bW46IGNvbE51bWJlcixcbiAgICAgIGxpbmU6IGxpbmVOdW1iZXJcbiAgICB9XG4gIH07XG4gIHJldHVybiBjb2RlRnJhbWVDb2x1bW5zKHJhd0xpbmVzLCBsb2NhdGlvbiwgb3B0cyk7XG59Il19